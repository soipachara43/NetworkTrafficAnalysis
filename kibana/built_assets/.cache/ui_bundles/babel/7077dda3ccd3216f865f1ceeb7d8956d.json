{"remainingRequest":"node_modules/thread-loader/dist/cjs.js??ref--8-1!node_modules/babel-loader/lib/index.js??ref--8-2!src/legacy/ui/public/flot-charts/jquery.flot.js","dependencies":[{"path":"src/legacy/ui/public/flot-charts/jquery.flot.js","mtime":1589249550323},{"path":"node_modules/cache-loader/dist/cjs.js","mtime":1589249605183},{"path":"node_modules/thread-loader/dist/cjs.js","mtime":1589249608558},{"path":"node_modules/babel-loader/lib/index.js","mtime":1589249591025}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:InVzZSBzdHJpY3QiOwoKZnVuY3Rpb24gX3R5cGVvZihvYmopIHsgaWYgKHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIFN5bWJvbC5pdGVyYXRvciA9PT0gInN5bWJvbCIpIHsgX3R5cGVvZiA9IGZ1bmN0aW9uIF90eXBlb2Yob2JqKSB7IHJldHVybiB0eXBlb2Ygb2JqOyB9OyB9IGVsc2UgeyBfdHlwZW9mID0gZnVuY3Rpb24gX3R5cGVvZihvYmopIHsgcmV0dXJuIG9iaiAmJiB0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIG9iai5jb25zdHJ1Y3RvciA9PT0gU3ltYm9sICYmIG9iaiAhPT0gU3ltYm9sLnByb3RvdHlwZSA/ICJzeW1ib2wiIDogdHlwZW9mIG9iajsgfTsgfSByZXR1cm4gX3R5cGVvZihvYmopOyB9CgovKiBKYXZhU2NyaXB0IHBsb3R0aW5nIGxpYnJhcnkgZm9yIGpRdWVyeSwgdmVyc2lvbiAwLjguMy4KCkNvcHlyaWdodCAoYykgMjAwNy0yMDE0IElPTEEgYW5kIE9sZSBMYXVyc2VuLgpMaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCgoqLwovLyBmaXJzdCBhbiBpbmxpbmUgZGVwZW5kZW5jeSwganF1ZXJ5LmNvbG9yaGVscGVycy5qcywgd2UgaW5saW5lIGl0IGhlcmUKLy8gZm9yIGNvbnZlbmllbmNlCgovKiBQbHVnaW4gZm9yIGpRdWVyeSBmb3Igd29ya2luZyB3aXRoIGNvbG9ycy4KICoKICogVmVyc2lvbiAxLjEuCiAqCiAqIEluc3BpcmF0aW9uIGZyb20galF1ZXJ5IGNvbG9yIGFuaW1hdGlvbiBwbHVnaW4gYnkgSm9obiBSZXNpZy4KICoKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGJ5IE9sZSBMYXVyc2VuLCBPY3RvYmVyIDIwMDkuCiAqCiAqIEV4YW1wbGVzOgogKgogKiAgICQuY29sb3IucGFyc2UoIiNmZmYiKS5zY2FsZSgncmdiJywgMC4yNSkuYWRkKCdhJywgLTAuNSkudG9TdHJpbmcoKQogKiAgIHZhciBjID0gJC5jb2xvci5leHRyYWN0KCQoIiNteWRpdiIpLCAnYmFja2dyb3VuZC1jb2xvcicpOwogKiAgIGNvbnNvbGUubG9nKGMuciwgYy5nLCBjLmIsIGMuYSk7CiAqICAgJC5jb2xvci5tYWtlKDEwMCwgNTAsIDI1LCAwLjQpLnRvU3RyaW5nKCkgLy8gcmV0dXJucyAicmdiYSgxMDAsNTAsMjUsMC40KSIKICoKICogTm90ZSB0aGF0IC5zY2FsZSgpIGFuZCAuYWRkKCkgcmV0dXJuIHRoZSBzYW1lIG1vZGlmaWVkIG9iamVjdAogKiBpbnN0ZWFkIG9mIG1ha2luZyBhIG5ldyBvbmUuCiAqCiAqIFYuIDEuMTogRml4IGVycm9yIGhhbmRsaW5nIHNvIGUuZy4gcGFyc2luZyBhbiBlbXB0eSBzdHJpbmcgZG9lcwogKiBwcm9kdWNlIGEgY29sb3IgcmF0aGVyIHRoYW4ganVzdCBjcmFzaGluZy4KICovCihmdW5jdGlvbiAoJCkgewogICQuY29sb3IgPSB7fTsKCiAgJC5jb2xvci5tYWtlID0gZnVuY3Rpb24gKHIsIGcsIGIsIGEpIHsKICAgIHZhciBvID0ge307CiAgICBvLnIgPSByIHx8IDA7CiAgICBvLmcgPSBnIHx8IDA7CiAgICBvLmIgPSBiIHx8IDA7CiAgICBvLmEgPSBhICE9IG51bGwgPyBhIDogMTsKCiAgICBvLmFkZCA9IGZ1bmN0aW9uIChjLCBkKSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYy5sZW5ndGg7ICsraSkgewogICAgICAgIG9bYy5jaGFyQXQoaSldICs9IGQ7CiAgICAgIH0KCiAgICAgIHJldHVybiBvLm5vcm1hbGl6ZSgpOwogICAgfTsKCiAgICBvLnNjYWxlID0gZnVuY3Rpb24gKGMsIGYpIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjLmxlbmd0aDsgKytpKSB7CiAgICAgICAgb1tjLmNoYXJBdChpKV0gKj0gZjsKICAgICAgfQoKICAgICAgcmV0dXJuIG8ubm9ybWFsaXplKCk7CiAgICB9OwoKICAgIG8udG9TdHJpbmcgPSBmdW5jdGlvbiAoKSB7CiAgICAgIGlmIChvLmEgPj0gMSkgewogICAgICAgIHJldHVybiAicmdiKCIgKyBbby5yLCBvLmcsIG8uYl0uam9pbigiLCIpICsgIikiOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiAicmdiYSgiICsgW28uciwgby5nLCBvLmIsIG8uYV0uam9pbigiLCIpICsgIikiOwogICAgICB9CiAgICB9OwoKICAgIG8ubm9ybWFsaXplID0gZnVuY3Rpb24gKCkgewogICAgICBmdW5jdGlvbiBjbGFtcChtaW4sIHZhbHVlLCBtYXgpIHsKICAgICAgICByZXR1cm4gdmFsdWUgPCBtaW4gPyBtaW4gOiB2YWx1ZSA+IG1heCA/IG1heCA6IHZhbHVlOwogICAgICB9CgogICAgICBvLnIgPSBjbGFtcCgwLCBwYXJzZUludChvLnIpLCAyNTUpOwogICAgICBvLmcgPSBjbGFtcCgwLCBwYXJzZUludChvLmcpLCAyNTUpOwogICAgICBvLmIgPSBjbGFtcCgwLCBwYXJzZUludChvLmIpLCAyNTUpOwogICAgICBvLmEgPSBjbGFtcCgwLCBvLmEsIDEpOwogICAgICByZXR1cm4gbzsKICAgIH07CgogICAgby5jbG9uZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuICQuY29sb3IubWFrZShvLnIsIG8uYiwgby5nLCBvLmEpOwogICAgfTsKCiAgICByZXR1cm4gby5ub3JtYWxpemUoKTsKICB9OwoKICAkLmNvbG9yLmV4dHJhY3QgPSBmdW5jdGlvbiAoZWxlbSwgY3NzKSB7CiAgICB2YXIgYzsKCiAgICBkbyB7CiAgICAgIGMgPSBlbGVtLmNzcyhjc3MpLnRvTG93ZXJDYXNlKCk7CiAgICAgIGlmIChjICE9ICIiICYmIGMgIT0gInRyYW5zcGFyZW50IikgYnJlYWs7CiAgICAgIGVsZW0gPSBlbGVtLnBhcmVudCgpOwogICAgfSB3aGlsZSAoZWxlbS5sZW5ndGggJiYgISQubm9kZU5hbWUoZWxlbS5nZXQoMCksICJib2R5IikpOwoKICAgIGlmIChjID09ICJyZ2JhKDAsIDAsIDAsIDApIikgYyA9ICJ0cmFuc3BhcmVudCI7CiAgICByZXR1cm4gJC5jb2xvci5wYXJzZShjKTsKICB9OwoKICAkLmNvbG9yLnBhcnNlID0gZnVuY3Rpb24gKHN0cikgewogICAgdmFyIHJlcywKICAgICAgICBtID0gJC5jb2xvci5tYWtlOwogICAgaWYgKHJlcyA9IC9yZ2JcKFxzKihbMC05XXsxLDN9KVxzKixccyooWzAtOV17MSwzfSlccyosXHMqKFswLTldezEsM30pXHMqXCkvLmV4ZWMoc3RyKSkgcmV0dXJuIG0ocGFyc2VJbnQocmVzWzFdLCAxMCksIHBhcnNlSW50KHJlc1syXSwgMTApLCBwYXJzZUludChyZXNbM10sIDEwKSk7CiAgICBpZiAocmVzID0gL3JnYmFcKFxzKihbMC05XXsxLDN9KVxzKixccyooWzAtOV17MSwzfSlccyosXHMqKFswLTldezEsM30pXHMqLFxzKihbMC05XSsoPzpcLlswLTldKyk/KVxzKlwpLy5leGVjKHN0cikpIHJldHVybiBtKHBhcnNlSW50KHJlc1sxXSwgMTApLCBwYXJzZUludChyZXNbMl0sIDEwKSwgcGFyc2VJbnQocmVzWzNdLCAxMCksIHBhcnNlRmxvYXQocmVzWzRdKSk7CiAgICBpZiAocmVzID0gL3JnYlwoXHMqKFswLTldKyg/OlwuWzAtOV0rKT8pXCVccyosXHMqKFswLTldKyg/OlwuWzAtOV0rKT8pXCVccyosXHMqKFswLTldKyg/OlwuWzAtOV0rKT8pXCVccypcKS8uZXhlYyhzdHIpKSByZXR1cm4gbShwYXJzZUZsb2F0KHJlc1sxXSkgKiAyLjU1LCBwYXJzZUZsb2F0KHJlc1syXSkgKiAyLjU1LCBwYXJzZUZsb2F0KHJlc1szXSkgKiAyLjU1KTsKICAgIGlmIChyZXMgPSAvcmdiYVwoXHMqKFswLTldKyg/OlwuWzAtOV0rKT8pXCVccyosXHMqKFswLTldKyg/OlwuWzAtOV0rKT8pXCVccyosXHMqKFswLTldKyg/OlwuWzAtOV0rKT8pXCVccyosXHMqKFswLTldKyg/OlwuWzAtOV0rKT8pXHMqXCkvLmV4ZWMoc3RyKSkgcmV0dXJuIG0ocGFyc2VGbG9hdChyZXNbMV0pICogMi41NSwgcGFyc2VGbG9hdChyZXNbMl0pICogMi41NSwgcGFyc2VGbG9hdChyZXNbM10pICogMi41NSwgcGFyc2VGbG9hdChyZXNbNF0pKTsKICAgIGlmIChyZXMgPSAvIyhbYS1mQS1GMC05XXsyfSkoW2EtZkEtRjAtOV17Mn0pKFthLWZBLUYwLTldezJ9KS8uZXhlYyhzdHIpKSByZXR1cm4gbShwYXJzZUludChyZXNbMV0sIDE2KSwgcGFyc2VJbnQocmVzWzJdLCAxNiksIHBhcnNlSW50KHJlc1szXSwgMTYpKTsKICAgIGlmIChyZXMgPSAvIyhbYS1mQS1GMC05XSkoW2EtZkEtRjAtOV0pKFthLWZBLUYwLTldKS8uZXhlYyhzdHIpKSByZXR1cm4gbShwYXJzZUludChyZXNbMV0gKyByZXNbMV0sIDE2KSwgcGFyc2VJbnQocmVzWzJdICsgcmVzWzJdLCAxNiksIHBhcnNlSW50KHJlc1szXSArIHJlc1szXSwgMTYpKTsKICAgIHZhciBuYW1lID0gJC50cmltKHN0cikudG9Mb3dlckNhc2UoKTsKICAgIGlmIChuYW1lID09ICJ0cmFuc3BhcmVudCIpIHJldHVybiBtKDI1NSwgMjU1LCAyNTUsIDApO2Vsc2UgewogICAgICByZXMgPSBsb29rdXBDb2xvcnNbbmFtZV0gfHwgWzAsIDAsIDBdOwogICAgICByZXR1cm4gbShyZXNbMF0sIHJlc1sxXSwgcmVzWzJdKTsKICAgIH0KICB9OwoKICB2YXIgbG9va3VwQ29sb3JzID0gewogICAgYXF1YTogWzAsIDI1NSwgMjU1XSwKICAgIGF6dXJlOiBbMjQwLCAyNTUsIDI1NV0sCiAgICBiZWlnZTogWzI0NSwgMjQ1LCAyMjBdLAogICAgYmxhY2s6IFswLCAwLCAwXSwKICAgIGJsdWU6IFswLCAwLCAyNTVdLAogICAgYnJvd246IFsxNjUsIDQyLCA0Ml0sCiAgICBjeWFuOiBbMCwgMjU1LCAyNTVdLAogICAgZGFya2JsdWU6IFswLCAwLCAxMzldLAogICAgZGFya2N5YW46IFswLCAxMzksIDEzOV0sCiAgICBkYXJrZ3JleTogWzE2OSwgMTY5LCAxNjldLAogICAgZGFya2dyZWVuOiBbMCwgMTAwLCAwXSwKICAgIGRhcmtraGFraTogWzE4OSwgMTgzLCAxMDddLAogICAgZGFya21hZ2VudGE6IFsxMzksIDAsIDEzOV0sCiAgICBkYXJrb2xpdmVncmVlbjogWzg1LCAxMDcsIDQ3XSwKICAgIGRhcmtvcmFuZ2U6IFsyNTUsIDE0MCwgMF0sCiAgICBkYXJrb3JjaGlkOiBbMTUzLCA1MCwgMjA0XSwKICAgIGRhcmtyZWQ6IFsxMzksIDAsIDBdLAogICAgZGFya3NhbG1vbjogWzIzMywgMTUwLCAxMjJdLAogICAgZGFya3Zpb2xldDogWzE0OCwgMCwgMjExXSwKICAgIGZ1Y2hzaWE6IFsyNTUsIDAsIDI1NV0sCiAgICBnb2xkOiBbMjU1LCAyMTUsIDBdLAogICAgZ3JlZW46IFswLCAxMjgsIDBdLAogICAgaW5kaWdvOiBbNzUsIDAsIDEzMF0sCiAgICBraGFraTogWzI0MCwgMjMwLCAxNDBdLAogICAgbGlnaHRibHVlOiBbMTczLCAyMTYsIDIzMF0sCiAgICBsaWdodGN5YW46IFsyMjQsIDI1NSwgMjU1XSwKICAgIGxpZ2h0Z3JlZW46IFsxNDQsIDIzOCwgMTQ0XSwKICAgIGxpZ2h0Z3JleTogWzIxMSwgMjExLCAyMTFdLAogICAgbGlnaHRwaW5rOiBbMjU1LCAxODIsIDE5M10sCiAgICBsaWdodHllbGxvdzogWzI1NSwgMjU1LCAyMjRdLAogICAgbGltZTogWzAsIDI1NSwgMF0sCiAgICBtYWdlbnRhOiBbMjU1LCAwLCAyNTVdLAogICAgbWFyb29uOiBbMTI4LCAwLCAwXSwKICAgIG5hdnk6IFswLCAwLCAxMjhdLAogICAgb2xpdmU6IFsxMjgsIDEyOCwgMF0sCiAgICBvcmFuZ2U6IFsyNTUsIDE2NSwgMF0sCiAgICBwaW5rOiBbMjU1LCAxOTIsIDIwM10sCiAgICBwdXJwbGU6IFsxMjgsIDAsIDEyOF0sCiAgICB2aW9sZXQ6IFsxMjgsIDAsIDEyOF0sCiAgICByZWQ6IFsyNTUsIDAsIDBdLAogICAgc2lsdmVyOiBbMTkyLCAxOTIsIDE5Ml0sCiAgICB3aGl0ZTogWzI1NSwgMjU1LCAyNTVdLAogICAgeWVsbG93OiBbMjU1LCAyNTUsIDBdCiAgfTsKfSkoalF1ZXJ5KTsgLy8gdGhlIGFjdHVhbCBGbG90IGNvZGUKCgooZnVuY3Rpb24gKCQpIHsKICAvLyBDYWNoZSB0aGUgcHJvdG90eXBlIGhhc093blByb3BlcnR5IGZvciBmYXN0ZXIgYWNjZXNzCiAgdmFyIGhhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsgLy8gQSBzaGltIHRvIHByb3ZpZGUgJ2RldGFjaCcgdG8galF1ZXJ5IHZlcnNpb25zIHByaW9yIHRvIDEuNC4gIFVzaW5nIGEgRE9NCiAgLy8gb3BlcmF0aW9uIHByb2R1Y2VzIHRoZSBzYW1lIGVmZmVjdCBhcyBkZXRhY2gsIGkuZS4gcmVtb3ZpbmcgdGhlIGVsZW1lbnQKICAvLyB3aXRob3V0IHRvdWNoaW5nIGl0cyBqUXVlcnkgZGF0YS4KICAvLyBEbyBub3QgbWVyZ2UgdGhpcyBpbnRvIEZsb3QgMC45LCBzaW5jZSBpdCByZXF1aXJlcyBqUXVlcnkgMS40LjQrLgoKICBpZiAoISQuZm4uZGV0YWNoKSB7CiAgICAkLmZuLmRldGFjaCA9IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKHRoaXMucGFyZW50Tm9kZSkgewogICAgICAgICAgdGhpcy5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRoaXMpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9OwogIH0gLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgLy8gVGhlIENhbnZhcyBvYmplY3QgaXMgYSB3cmFwcGVyIGFyb3VuZCBhbiBIVE1MNSA8Y2FudmFzPiB0YWcuCiAgLy8KICAvLyBAY29uc3RydWN0b3IKICAvLyBAcGFyYW0ge3N0cmluZ30gY2xzIExpc3Qgb2YgY2xhc3NlcyB0byBhcHBseSB0byB0aGUgY2FudmFzLgogIC8vIEBwYXJhbSB7ZWxlbWVudH0gY29udGFpbmVyIEVsZW1lbnQgb250byB3aGljaCB0byBhcHBlbmQgdGhlIGNhbnZhcy4KICAvLwogIC8vIFJlcXVpcmluZyBhIGNvbnRhaW5lciBpcyBhIGxpdHRsZSBpZmZ5LCBidXQgdW5mb3J0dW5hdGVseSBjYW52YXMKICAvLyBvcGVyYXRpb25zIGRvbid0IHdvcmsgdW5sZXNzIHRoZSBjYW52YXMgaXMgYXR0YWNoZWQgdG8gdGhlIERPTS4KCgogIGZ1bmN0aW9uIENhbnZhcyhjbHMsIGNvbnRhaW5lcikgewogICAgdmFyIGVsZW1lbnQgPSBjb250YWluZXIuY2hpbGRyZW4oIi4iICsgY2xzKVswXTsKCiAgICBpZiAoZWxlbWVudCA9PSBudWxsKSB7CiAgICAgIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJjYW52YXMiKTsKICAgICAgZWxlbWVudC5jbGFzc05hbWUgPSBjbHM7CiAgICAgICQoZWxlbWVudCkuY3NzKHsKICAgICAgICBkaXJlY3Rpb246ICJsdHIiLAogICAgICAgIHBvc2l0aW9uOiAiYWJzb2x1dGUiLAogICAgICAgIGxlZnQ6IDAsCiAgICAgICAgdG9wOiAwCiAgICAgIH0pLmFwcGVuZFRvKGNvbnRhaW5lcik7IC8vIElmIEhUTUw1IENhbnZhcyBpc24ndCBhdmFpbGFibGUsIGZhbGwgYmFjayB0byBbRXh8Rmxhc2hdY2FudmFzCgogICAgICBpZiAoIWVsZW1lbnQuZ2V0Q29udGV4dCkgewogICAgICAgIGlmICh3aW5kb3cuR192bWxDYW52YXNNYW5hZ2VyKSB7CiAgICAgICAgICBlbGVtZW50ID0gd2luZG93Lkdfdm1sQ2FudmFzTWFuYWdlci5pbml0RWxlbWVudChlbGVtZW50KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW52YXMgaXMgbm90IGF2YWlsYWJsZS4gSWYgeW91J3JlIHVzaW5nIElFIHdpdGggYSBmYWxsLWJhY2sgc3VjaCBhcyBFeGNhbnZhcywgdGhlbiB0aGVyZSdzIGVpdGhlciBhIG1pc3Rha2UgaW4geW91ciBjb25kaXRpb25hbCBpbmNsdWRlLCBvciB0aGUgcGFnZSBoYXMgbm8gRE9DVFlQRSBhbmQgaXMgcmVuZGVyaW5nIGluIFF1aXJrcyBNb2RlLiIpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHRoaXMuZWxlbWVudCA9IGVsZW1lbnQ7CiAgICB2YXIgY29udGV4dCA9IHRoaXMuY29udGV4dCA9IGVsZW1lbnQuZ2V0Q29udGV4dCgiMmQiKTsgLy8gRGV0ZXJtaW5lIHRoZSBzY3JlZW4ncyByYXRpbyBvZiBwaHlzaWNhbCB0byBkZXZpY2UtaW5kZXBlbmRlbnQKICAgIC8vIHBpeGVscy4gIFRoaXMgaXMgdGhlIHJhdGlvIGJldHdlZW4gdGhlIGNhbnZhcyB3aWR0aCB0aGF0IHRoZSBicm93c2VyCiAgICAvLyBhZHZlcnRpc2VzIGFuZCB0aGUgbnVtYmVyIG9mIHBpeGVscyBhY3R1YWxseSBwcmVzZW50IGluIHRoYXQgc3BhY2UuCiAgICAvLyBUaGUgaVBob25lIDQsIGZvciBleGFtcGxlLCBoYXMgYSBkZXZpY2UtaW5kZXBlbmRlbnQgd2lkdGggb2YgMzIwcHgsCiAgICAvLyBidXQgaXRzIHNjcmVlbiBpcyBhY3R1YWxseSA2NDBweCB3aWRlLiAgSXQgdGhlcmVmb3JlIGhhcyBhIHBpeGVsCiAgICAvLyByYXRpbyBvZiAyLCB3aGlsZSBtb3N0IG5vcm1hbCBkZXZpY2VzIGhhdmUgYSByYXRpbyBvZiAxLgoKICAgIHZhciBkZXZpY2VQaXhlbFJhdGlvID0gd2luZG93LmRldmljZVBpeGVsUmF0aW8gfHwgMSwKICAgICAgICBiYWNraW5nU3RvcmVSYXRpbyA9IGNvbnRleHQud2Via2l0QmFja2luZ1N0b3JlUGl4ZWxSYXRpbyB8fCBjb250ZXh0Lm1vekJhY2tpbmdTdG9yZVBpeGVsUmF0aW8gfHwgY29udGV4dC5tc0JhY2tpbmdTdG9yZVBpeGVsUmF0aW8gfHwgY29udGV4dC5vQmFja2luZ1N0b3JlUGl4ZWxSYXRpbyB8fCBjb250ZXh0LmJhY2tpbmdTdG9yZVBpeGVsUmF0aW8gfHwgMTsKICAgIHRoaXMucGl4ZWxSYXRpbyA9IGRldmljZVBpeGVsUmF0aW8gLyBiYWNraW5nU3RvcmVSYXRpbzsgLy8gU2l6ZSB0aGUgY2FudmFzIHRvIG1hdGNoIHRoZSBpbnRlcm5hbCBkaW1lbnNpb25zIG9mIGl0cyBjb250YWluZXIKCiAgICB0aGlzLnJlc2l6ZShjb250YWluZXIud2lkdGgoKSwgY29udGFpbmVyLmhlaWdodCgpKTsgLy8gQ29sbGVjdGlvbiBvZiBIVE1MIGRpdiBsYXllcnMgZm9yIHRleHQgb3ZlcmxhaWQgb250byB0aGUgY2FudmFzCgogICAgdGhpcy50ZXh0Q29udGFpbmVyID0gbnVsbDsKICAgIHRoaXMudGV4dCA9IHt9OyAvLyBDYWNoZSBvZiB0ZXh0IGZyYWdtZW50cyBhbmQgbWV0cmljcywgc28gd2UgY2FuIGF2b2lkIGV4cGVuc2l2ZWx5CiAgICAvLyByZS1jYWxjdWxhdGluZyB0aGVtIHdoZW4gdGhlIHBsb3QgaXMgcmUtcmVuZGVyZWQgaW4gYSBsb29wLgoKICAgIHRoaXMuX3RleHRDYWNoZSA9IHt9OwogIH0gLy8gUmVzaXplcyB0aGUgY2FudmFzIHRvIHRoZSBnaXZlbiBkaW1lbnNpb25zLgogIC8vCiAgLy8gQHBhcmFtIHtudW1iZXJ9IHdpZHRoIE5ldyB3aWR0aCBvZiB0aGUgY2FudmFzLCBpbiBwaXhlbHMuCiAgLy8gQHBhcmFtIHtudW1iZXJ9IHdpZHRoIE5ldyBoZWlnaHQgb2YgdGhlIGNhbnZhcywgaW4gcGl4ZWxzLgoKCiAgQ2FudmFzLnByb3RvdHlwZS5yZXNpemUgPSBmdW5jdGlvbiAod2lkdGgsIGhlaWdodCkgewogICAgaWYgKHdpZHRoIDw9IDAgfHwgaGVpZ2h0IDw9IDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIGRpbWVuc2lvbnMgZm9yIHBsb3QsIHdpZHRoID0gIiArIHdpZHRoICsgIiwgaGVpZ2h0ID0gIiArIGhlaWdodCk7CiAgICB9CgogICAgdmFyIGVsZW1lbnQgPSB0aGlzLmVsZW1lbnQsCiAgICAgICAgY29udGV4dCA9IHRoaXMuY29udGV4dCwKICAgICAgICBwaXhlbFJhdGlvID0gdGhpcy5waXhlbFJhdGlvOyAvLyBSZXNpemUgdGhlIGNhbnZhcywgaW5jcmVhc2luZyBpdHMgZGVuc2l0eSBiYXNlZCBvbiB0aGUgZGlzcGxheSdzCiAgICAvLyBwaXhlbCByYXRpbzsgYmFzaWNhbGx5IGdpdmluZyBpdCBtb3JlIHBpeGVscyB3aXRob3V0IGluY3JlYXNpbmcgdGhlCiAgICAvLyBzaXplIG9mIGl0cyBlbGVtZW50LCB0byB0YWtlIGFkdmFudGFnZSBvZiB0aGUgZmFjdCB0aGF0IHJldGluYQogICAgLy8gZGlzcGxheXMgaGF2ZSB0aGF0IG1hbnkgbW9yZSBwaXhlbHMgaW4gdGhlIHNhbWUgYWR2ZXJ0aXNlZCBzcGFjZS4KICAgIC8vIFJlc2l6aW5nIHNob3VsZCByZXNldCB0aGUgc3RhdGUgKGV4Y2FudmFzIHNlZW1zIHRvIGJlIGJ1Z2d5IHRob3VnaCkKCiAgICBpZiAodGhpcy53aWR0aCAhPSB3aWR0aCkgewogICAgICBlbGVtZW50LndpZHRoID0gd2lkdGggKiBwaXhlbFJhdGlvOwogICAgICBlbGVtZW50LnN0eWxlLndpZHRoID0gd2lkdGggKyAicHgiOwogICAgICB0aGlzLndpZHRoID0gd2lkdGg7CiAgICB9CgogICAgaWYgKHRoaXMuaGVpZ2h0ICE9IGhlaWdodCkgewogICAgICBlbGVtZW50LmhlaWdodCA9IGhlaWdodCAqIHBpeGVsUmF0aW87CiAgICAgIGVsZW1lbnQuc3R5bGUuaGVpZ2h0ID0gaGVpZ2h0ICsgInB4IjsKICAgICAgdGhpcy5oZWlnaHQgPSBoZWlnaHQ7CiAgICB9IC8vIFNhdmUgdGhlIGNvbnRleHQsIHNvIHdlIGNhbiByZXNldCBpbiBjYXNlIHdlIGdldCByZXBsb3R0ZWQuICBUaGUKICAgIC8vIHJlc3RvcmUgZW5zdXJlIHRoYXQgd2UncmUgcmVhbGx5IGJhY2sgYXQgdGhlIGluaXRpYWwgc3RhdGUsIGFuZAogICAgLy8gc2hvdWxkIGJlIHNhZmUgZXZlbiBpZiB3ZSBoYXZlbid0IHNhdmVkIHRoZSBpbml0aWFsIHN0YXRlIHlldC4KCgogICAgY29udGV4dC5yZXN0b3JlKCk7CiAgICBjb250ZXh0LnNhdmUoKTsgLy8gU2NhbGUgdGhlIGNvb3JkaW5hdGUgc3BhY2UgdG8gbWF0Y2ggdGhlIGRpc3BsYXkgZGVuc2l0eTsgc28gZXZlbiB0aG91Z2ggd2UKICAgIC8vIG1heSBoYXZlIHR3aWNlIGFzIG1hbnkgcGl4ZWxzLCB3ZSBzdGlsbCB3YW50IGxpbmVzIGFuZCBvdGhlciBkcmF3aW5nIHRvCiAgICAvLyBhcHBlYXIgYXQgdGhlIHNhbWUgc2l6ZTsgdGhlIGV4dHJhIHBpeGVscyB3aWxsIGp1c3QgbWFrZSB0aGVtIGNyaXNwZXIuCgogICAgY29udGV4dC5zY2FsZShwaXhlbFJhdGlvLCBwaXhlbFJhdGlvKTsKICB9OyAvLyBDbGVhcnMgdGhlIGVudGlyZSBjYW52YXMgYXJlYSwgbm90IGluY2x1ZGluZyBhbnkgb3ZlcmxhaWQgSFRNTCB0ZXh0CgoKICBDYW52YXMucHJvdG90eXBlLmNsZWFyID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5jb250ZXh0LmNsZWFyUmVjdCgwLCAwLCB0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7CiAgfTsgLy8gRmluaXNoZXMgcmVuZGVyaW5nIHRoZSBjYW52YXMsIGluY2x1ZGluZyBtYW5hZ2luZyB0aGUgdGV4dCBvdmVybGF5LgoKCiAgQ2FudmFzLnByb3RvdHlwZS5yZW5kZXIgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgY2FjaGUgPSB0aGlzLl90ZXh0Q2FjaGU7IC8vIEZvciBlYWNoIHRleHQgbGF5ZXIsIGFkZCBlbGVtZW50cyBtYXJrZWQgYXMgYWN0aXZlIHRoYXQgaGF2ZW4ndAogICAgLy8gYWxyZWFkeSBiZWVuIHJlbmRlcmVkLCBhbmQgcmVtb3ZlIHRob3NlIHRoYXQgYXJlIG5vIGxvbmdlciBhY3RpdmUuCgogICAgZm9yICh2YXIgbGF5ZXJLZXkgaW4gY2FjaGUpIHsKICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoY2FjaGUsIGxheWVyS2V5KSkgewogICAgICAgIHZhciBsYXllciA9IHRoaXMuZ2V0VGV4dExheWVyKGxheWVyS2V5KSwKICAgICAgICAgICAgbGF5ZXJDYWNoZSA9IGNhY2hlW2xheWVyS2V5XTsKICAgICAgICBsYXllci5oaWRlKCk7CgogICAgICAgIGZvciAodmFyIHN0eWxlS2V5IGluIGxheWVyQ2FjaGUpIHsKICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGxheWVyQ2FjaGUsIHN0eWxlS2V5KSkgewogICAgICAgICAgICB2YXIgc3R5bGVDYWNoZSA9IGxheWVyQ2FjaGVbc3R5bGVLZXldOwoKICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIHN0eWxlQ2FjaGUpIHsKICAgICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChzdHlsZUNhY2hlLCBrZXkpKSB7CiAgICAgICAgICAgICAgICB2YXIgcG9zaXRpb25zID0gc3R5bGVDYWNoZVtrZXldLnBvc2l0aW9uczsKCiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgcG9zaXRpb247IHBvc2l0aW9uID0gcG9zaXRpb25zW2ldOyBpKyspIHsKICAgICAgICAgICAgICAgICAgaWYgKHBvc2l0aW9uLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgIGlmICghcG9zaXRpb24ucmVuZGVyZWQpIHsKICAgICAgICAgICAgICAgICAgICAgIGxheWVyLmFwcGVuZChwb3NpdGlvbi5lbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uLnJlbmRlcmVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb25zLnNwbGljZShpLS0sIDEpOwoKICAgICAgICAgICAgICAgICAgICBpZiAocG9zaXRpb24ucmVuZGVyZWQpIHsKICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uLmVsZW1lbnQuZGV0YWNoKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHBvc2l0aW9ucy5sZW5ndGggPT0gMCkgewogICAgICAgICAgICAgICAgICBkZWxldGUgc3R5bGVDYWNoZVtrZXldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgbGF5ZXIuc2hvdygpOwogICAgICB9CiAgICB9CiAgfTsgLy8gQ3JlYXRlcyAoaWYgbmVjZXNzYXJ5KSBhbmQgcmV0dXJucyB0aGUgdGV4dCBvdmVybGF5IGNvbnRhaW5lci4KICAvLwogIC8vIEBwYXJhbSB7c3RyaW5nfSBjbGFzc2VzIFN0cmluZyBvZiBzcGFjZS1zZXBhcmF0ZWQgQ1NTIGNsYXNzZXMgdXNlZCB0bwogIC8vICAgICB1bmlxdWVseSBpZGVudGlmeSB0aGUgdGV4dCBsYXllci4KICAvLyBAcmV0dXJuIHtvYmplY3R9IFRoZSBqUXVlcnktd3JhcHBlZCB0ZXh0LWxheWVyIGRpdi4KCgogIENhbnZhcy5wcm90b3R5cGUuZ2V0VGV4dExheWVyID0gZnVuY3Rpb24gKGNsYXNzZXMpIHsKICAgIHZhciBsYXllciA9IHRoaXMudGV4dFtjbGFzc2VzXTsgLy8gQ3JlYXRlIHRoZSB0ZXh0IGxheWVyIGlmIGl0IGRvZXNuJ3QgZXhpc3QKCiAgICBpZiAobGF5ZXIgPT0gbnVsbCkgewogICAgICAvLyBDcmVhdGUgdGhlIHRleHQgbGF5ZXIgY29udGFpbmVyLCBpZiBpdCBkb2Vzbid0IGV4aXN0CiAgICAgIGlmICh0aGlzLnRleHRDb250YWluZXIgPT0gbnVsbCkgewogICAgICAgIHRoaXMudGV4dENvbnRhaW5lciA9ICQoIjxkaXYgY2xhc3M9J2Zsb3QtdGV4dCc+PC9kaXY+IikuY3NzKHsKICAgICAgICAgIHBvc2l0aW9uOiAiYWJzb2x1dGUiLAogICAgICAgICAgdG9wOiAwLAogICAgICAgICAgbGVmdDogMCwKICAgICAgICAgIGJvdHRvbTogMCwKICAgICAgICAgIHJpZ2h0OiAwLAogICAgICAgICAgJ2ZvbnQtc2l6ZSc6ICJzbWFsbGVyIiwKICAgICAgICAgIGNvbG9yOiAiIzU0NTQ1NCIKICAgICAgICB9KS5pbnNlcnRBZnRlcih0aGlzLmVsZW1lbnQpOwogICAgICB9CgogICAgICBsYXllciA9IHRoaXMudGV4dFtjbGFzc2VzXSA9ICQoIjxkaXY+PC9kaXY+IikuYWRkQ2xhc3MoY2xhc3NlcykuY3NzKHsKICAgICAgICBwb3NpdGlvbjogImFic29sdXRlIiwKICAgICAgICB0b3A6IDAsCiAgICAgICAgbGVmdDogMCwKICAgICAgICBib3R0b206IDAsCiAgICAgICAgcmlnaHQ6IDAKICAgICAgfSkuYXBwZW5kVG8odGhpcy50ZXh0Q29udGFpbmVyKTsKICAgIH0KCiAgICByZXR1cm4gbGF5ZXI7CiAgfTsgLy8gQ3JlYXRlcyAoaWYgbmVjZXNzYXJ5KSBhbmQgcmV0dXJucyBhIHRleHQgaW5mbyBvYmplY3QuCiAgLy8KICAvLyBUaGUgb2JqZWN0IGxvb2tzIGxpa2UgdGhpczoKICAvLwogIC8vIHsKICAvLyAgICAgd2lkdGg6IFdpZHRoIG9mIHRoZSB0ZXh0J3Mgd3JhcHBlciBkaXYuCiAgLy8gICAgIGhlaWdodDogSGVpZ2h0IG9mIHRoZSB0ZXh0J3Mgd3JhcHBlciBkaXYuCiAgLy8gICAgIGVsZW1lbnQ6IFRoZSBqUXVlcnktd3JhcHBlZCBIVE1MIGRpdiBjb250YWluaW5nIHRoZSB0ZXh0LgogIC8vICAgICBwb3NpdGlvbnM6IEFycmF5IG9mIHBvc2l0aW9ucyBhdCB3aGljaCB0aGlzIHRleHQgaXMgZHJhd24uCiAgLy8gfQogIC8vCiAgLy8gVGhlIHBvc2l0aW9ucyBhcnJheSBjb250YWlucyBvYmplY3RzIHRoYXQgbG9vayBsaWtlIHRoaXM6CiAgLy8KICAvLyB7CiAgLy8gICAgIGFjdGl2ZTogRmxhZyBpbmRpY2F0aW5nIHdoZXRoZXIgdGhlIHRleHQgc2hvdWxkIGJlIHZpc2libGUuCiAgLy8gICAgIHJlbmRlcmVkOiBGbGFnIGluZGljYXRpbmcgd2hldGhlciB0aGUgdGV4dCBpcyBjdXJyZW50bHkgdmlzaWJsZS4KICAvLyAgICAgZWxlbWVudDogVGhlIGpRdWVyeS13cmFwcGVkIEhUTUwgZGl2IGNvbnRhaW5pbmcgdGhlIHRleHQuCiAgLy8gICAgIHg6IFggY29vcmRpbmF0ZSBhdCB3aGljaCB0byBkcmF3IHRoZSB0ZXh0LgogIC8vICAgICB5OiBZIGNvb3JkaW5hdGUgYXQgd2hpY2ggdG8gZHJhdyB0aGUgdGV4dC4KICAvLyB9CiAgLy8KICAvLyBFYWNoIHBvc2l0aW9uIGFmdGVyIHRoZSBmaXJzdCByZWNlaXZlcyBhIGNsb25lIG9mIHRoZSBvcmlnaW5hbCBlbGVtZW50LgogIC8vCiAgLy8gVGhlIGlkZWEgaXMgdGhhdCB0aGF0IHRoZSB3aWR0aCwgaGVpZ2h0LCBhbmQgZ2VuZXJhbCAnaWRlbnRpdHknIG9mIHRoZQogIC8vIHRleHQgaXMgY29uc3RhbnQgbm8gbWF0dGVyIHdoZXJlIGl0IGlzIHBsYWNlZDsgdGhlIHBsYWNlbWVudHMgYXJlIGEKICAvLyBzZWNvbmRhcnkgcHJvcGVydHkuCiAgLy8KICAvLyBDYW52YXMgbWFpbnRhaW5zIGEgY2FjaGUgb2YgcmVjZW50bHktdXNlZCB0ZXh0IGluZm8gb2JqZWN0czsgZ2V0VGV4dEluZm8KICAvLyBlaXRoZXIgcmV0dXJucyB0aGUgY2FjaGVkIGVsZW1lbnQgb3IgY3JlYXRlcyBhIG5ldyBlbnRyeS4KICAvLwogIC8vIEBwYXJhbSB7c3RyaW5nfSBsYXllciBBIHN0cmluZyBvZiBzcGFjZS1zZXBhcmF0ZWQgQ1NTIGNsYXNzZXMgdW5pcXVlbHkKICAvLyAgICAgaWRlbnRpZnlpbmcgdGhlIGxheWVyIGNvbnRhaW5pbmcgdGhpcyB0ZXh0LgogIC8vIEBwYXJhbSB7c3RyaW5nfSB0ZXh0IFRleHQgc3RyaW5nIHRvIHJldHJpZXZlIGluZm8gZm9yLgogIC8vIEBwYXJhbSB7KHN0cmluZ3xvYmplY3QpPX0gZm9udCBFaXRoZXIgYSBzdHJpbmcgb2Ygc3BhY2Utc2VwYXJhdGVkIENTUwogIC8vICAgICBjbGFzc2VzIG9yIGEgZm9udC1zcGVjIG9iamVjdCwgZGVmaW5pbmcgdGhlIHRleHQncyBmb250IGFuZCBzdHlsZS4KICAvLyBAcGFyYW0ge251bWJlcj19IGFuZ2xlIEFuZ2xlIGF0IHdoaWNoIHRvIHJvdGF0ZSB0aGUgdGV4dCwgaW4gZGVncmVlcy4KICAvLyAgICAgQW5nbGUgaXMgY3VycmVudGx5IHVudXNlZCwgaXQgd2lsbCBiZSBpbXBsZW1lbnRlZCBpbiB0aGUgZnV0dXJlLgogIC8vIEBwYXJhbSB7bnVtYmVyPX0gd2lkdGggTWF4aW11bSB3aWR0aCBvZiB0aGUgdGV4dCBiZWZvcmUgaXQgd3JhcHMuCiAgLy8gQHJldHVybiB7b2JqZWN0fSBhIHRleHQgaW5mbyBvYmplY3QuCgoKICBDYW52YXMucHJvdG90eXBlLmdldFRleHRJbmZvID0gZnVuY3Rpb24gKGxheWVyLCB0ZXh0LCBmb250LCBhbmdsZSwgd2lkdGgpIHsKICAgIHZhciB0ZXh0U3R5bGUsIGxheWVyQ2FjaGUsIHN0eWxlQ2FjaGUsIGluZm87IC8vIENhc3QgdGhlIHZhbHVlIHRvIGEgc3RyaW5nLCBpbiBjYXNlIHdlIHdlcmUgZ2l2ZW4gYSBudW1iZXIgb3Igc3VjaAoKICAgIHRleHQgPSAiIiArIHRleHQ7IC8vIElmIHRoZSBmb250IGlzIGEgZm9udC1zcGVjIG9iamVjdCwgZ2VuZXJhdGUgYSBDU1MgZm9udCBkZWZpbml0aW9uCgogICAgaWYgKF90eXBlb2YoZm9udCkgPT09ICJvYmplY3QiKSB7CiAgICAgIHRleHRTdHlsZSA9IGZvbnQuc3R5bGUgKyAiICIgKyBmb250LnZhcmlhbnQgKyAiICIgKyBmb250LndlaWdodCArICIgIiArIGZvbnQuc2l6ZSArICJweC8iICsgZm9udC5saW5lSGVpZ2h0ICsgInB4ICIgKyBmb250LmZhbWlseTsKICAgIH0gZWxzZSB7CiAgICAgIHRleHRTdHlsZSA9IGZvbnQ7CiAgICB9IC8vIFJldHJpZXZlIChvciBjcmVhdGUpIHRoZSBjYWNoZSBmb3IgdGhlIHRleHQncyBsYXllciBhbmQgc3R5bGVzCgoKICAgIGxheWVyQ2FjaGUgPSB0aGlzLl90ZXh0Q2FjaGVbbGF5ZXJdOwoKICAgIGlmIChsYXllckNhY2hlID09IG51bGwpIHsKICAgICAgbGF5ZXJDYWNoZSA9IHRoaXMuX3RleHRDYWNoZVtsYXllcl0gPSB7fTsKICAgIH0KCiAgICBzdHlsZUNhY2hlID0gbGF5ZXJDYWNoZVt0ZXh0U3R5bGVdOwoKICAgIGlmIChzdHlsZUNhY2hlID09IG51bGwpIHsKICAgICAgc3R5bGVDYWNoZSA9IGxheWVyQ2FjaGVbdGV4dFN0eWxlXSA9IHt9OwogICAgfQoKICAgIGluZm8gPSBzdHlsZUNhY2hlW3RleHRdOyAvLyBJZiB3ZSBjYW4ndCBmaW5kIGEgbWF0Y2hpbmcgZWxlbWVudCBpbiBvdXIgY2FjaGUsIGNyZWF0ZSBhIG5ldyBvbmUKCiAgICBpZiAoaW5mbyA9PSBudWxsKSB7CiAgICAgIHZhciBlbGVtZW50ID0gJCgiPGRpdj48L2Rpdj4iKS5odG1sKHRleHQpLmNzcyh7CiAgICAgICAgcG9zaXRpb246ICJhYnNvbHV0ZSIsCiAgICAgICAgJ21heC13aWR0aCc6IHdpZHRoLAogICAgICAgIHRvcDogLTk5OTkKICAgICAgfSkuYXBwZW5kVG8odGhpcy5nZXRUZXh0TGF5ZXIobGF5ZXIpKTsKCiAgICAgIGlmIChfdHlwZW9mKGZvbnQpID09PSAib2JqZWN0IikgewogICAgICAgIGVsZW1lbnQuY3NzKHsKICAgICAgICAgIGZvbnQ6IHRleHRTdHlsZSwKICAgICAgICAgIGNvbG9yOiBmb250LmNvbG9yCiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGZvbnQgPT09ICJzdHJpbmciKSB7CiAgICAgICAgZWxlbWVudC5hZGRDbGFzcyhmb250KTsKICAgICAgfQoKICAgICAgaW5mbyA9IHN0eWxlQ2FjaGVbdGV4dF0gPSB7CiAgICAgICAgd2lkdGg6IGVsZW1lbnQub3V0ZXJXaWR0aCh0cnVlKSwKICAgICAgICBoZWlnaHQ6IGVsZW1lbnQub3V0ZXJIZWlnaHQodHJ1ZSksCiAgICAgICAgZWxlbWVudDogZWxlbWVudCwKICAgICAgICBwb3NpdGlvbnM6IFtdCiAgICAgIH07CiAgICAgIGVsZW1lbnQuZGV0YWNoKCk7CiAgICB9CgogICAgcmV0dXJuIGluZm87CiAgfTsgLy8gQWRkcyBhIHRleHQgc3RyaW5nIHRvIHRoZSBjYW52YXMgdGV4dCBvdmVybGF5LgogIC8vCiAgLy8gVGhlIHRleHQgaXNuJ3QgZHJhd24gaW1tZWRpYXRlbHk7IGl0IGlzIG1hcmtlZCBhcyByZW5kZXJpbmcsIHdoaWNoIHdpbGwKICAvLyByZXN1bHQgaW4gaXRzIGFkZGl0aW9uIHRvIHRoZSBjYW52YXMgb24gdGhlIG5leHQgcmVuZGVyIHBhc3MuCiAgLy8KICAvLyBAcGFyYW0ge3N0cmluZ30gbGF5ZXIgQSBzdHJpbmcgb2Ygc3BhY2Utc2VwYXJhdGVkIENTUyBjbGFzc2VzIHVuaXF1ZWx5CiAgLy8gICAgIGlkZW50aWZ5aW5nIHRoZSBsYXllciBjb250YWluaW5nIHRoaXMgdGV4dC4KICAvLyBAcGFyYW0ge251bWJlcn0geCBYIGNvb3JkaW5hdGUgYXQgd2hpY2ggdG8gZHJhdyB0aGUgdGV4dC4KICAvLyBAcGFyYW0ge251bWJlcn0geSBZIGNvb3JkaW5hdGUgYXQgd2hpY2ggdG8gZHJhdyB0aGUgdGV4dC4KICAvLyBAcGFyYW0ge3N0cmluZ30gdGV4dCBUZXh0IHN0cmluZyB0byBkcmF3LgogIC8vIEBwYXJhbSB7KHN0cmluZ3xvYmplY3QpPX0gZm9udCBFaXRoZXIgYSBzdHJpbmcgb2Ygc3BhY2Utc2VwYXJhdGVkIENTUwogIC8vICAgICBjbGFzc2VzIG9yIGEgZm9udC1zcGVjIG9iamVjdCwgZGVmaW5pbmcgdGhlIHRleHQncyBmb250IGFuZCBzdHlsZS4KICAvLyBAcGFyYW0ge251bWJlcj19IGFuZ2xlIEFuZ2xlIGF0IHdoaWNoIHRvIHJvdGF0ZSB0aGUgdGV4dCwgaW4gZGVncmVlcy4KICAvLyAgICAgQW5nbGUgaXMgY3VycmVudGx5IHVudXNlZCwgaXQgd2lsbCBiZSBpbXBsZW1lbnRlZCBpbiB0aGUgZnV0dXJlLgogIC8vIEBwYXJhbSB7bnVtYmVyPX0gd2lkdGggTWF4aW11bSB3aWR0aCBvZiB0aGUgdGV4dCBiZWZvcmUgaXQgd3JhcHMuCiAgLy8gQHBhcmFtIHtzdHJpbmc9fSBoYWxpZ24gSG9yaXpvbnRhbCBhbGlnbm1lbnQgb2YgdGhlIHRleHQ7IGVpdGhlciAibGVmdCIsCiAgLy8gICAgICJjZW50ZXIiIG9yICJyaWdodCIuCiAgLy8gQHBhcmFtIHtzdHJpbmc9fSB2YWxpZ24gVmVydGljYWwgYWxpZ25tZW50IG9mIHRoZSB0ZXh0OyBlaXRoZXIgInRvcCIsCiAgLy8gICAgICJtaWRkbGUiIG9yICJib3R0b20iLgoKCiAgQ2FudmFzLnByb3RvdHlwZS5hZGRUZXh0ID0gZnVuY3Rpb24gKGxheWVyLCB4LCB5LCB0ZXh0LCBmb250LCBhbmdsZSwgd2lkdGgsIGhhbGlnbiwgdmFsaWduKSB7CiAgICB2YXIgaW5mbyA9IHRoaXMuZ2V0VGV4dEluZm8obGF5ZXIsIHRleHQsIGZvbnQsIGFuZ2xlLCB3aWR0aCksCiAgICAgICAgcG9zaXRpb25zID0gaW5mby5wb3NpdGlvbnM7IC8vIFR3ZWFrIHRoZSBkaXYncyBwb3NpdGlvbiB0byBtYXRjaCB0aGUgdGV4dCdzIGFsaWdubWVudAoKICAgIGlmIChoYWxpZ24gPT0gImNlbnRlciIpIHsKICAgICAgeCAtPSBpbmZvLndpZHRoIC8gMjsKICAgIH0gZWxzZSBpZiAoaGFsaWduID09ICJyaWdodCIpIHsKICAgICAgeCAtPSBpbmZvLndpZHRoOwogICAgfQoKICAgIGlmICh2YWxpZ24gPT0gIm1pZGRsZSIpIHsKICAgICAgeSAtPSBpbmZvLmhlaWdodCAvIDI7CiAgICB9IGVsc2UgaWYgKHZhbGlnbiA9PSAiYm90dG9tIikgewogICAgICB5IC09IGluZm8uaGVpZ2h0OwogICAgfSAvLyBEZXRlcm1pbmUgd2hldGhlciB0aGlzIHRleHQgYWxyZWFkeSBleGlzdHMgYXQgdGhpcyBwb3NpdGlvbi4KICAgIC8vIElmIHNvLCBtYXJrIGl0IGZvciBpbmNsdXNpb24gaW4gdGhlIG5leHQgcmVuZGVyIHBhc3MuCgoKICAgIGZvciAodmFyIGkgPSAwLCBwb3NpdGlvbjsgcG9zaXRpb24gPSBwb3NpdGlvbnNbaV07IGkrKykgewogICAgICBpZiAocG9zaXRpb24ueCA9PSB4ICYmIHBvc2l0aW9uLnkgPT0geSkgewogICAgICAgIHBvc2l0aW9uLmFjdGl2ZSA9IHRydWU7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9IC8vIElmIHRoZSB0ZXh0IGRvZXNuJ3QgZXhpc3QgYXQgdGhpcyBwb3NpdGlvbiwgY3JlYXRlIGEgbmV3IGVudHJ5CiAgICAvLyBGb3IgdGhlIHZlcnkgZmlyc3QgcG9zaXRpb24gd2UnbGwgcmUtdXNlIHRoZSBvcmlnaW5hbCBlbGVtZW50LAogICAgLy8gd2hpbGUgZm9yIHN1YnNlcXVlbnQgb25lcyB3ZSdsbCBjbG9uZSBpdC4KCgogICAgcG9zaXRpb24gPSB7CiAgICAgIGFjdGl2ZTogdHJ1ZSwKICAgICAgcmVuZGVyZWQ6IGZhbHNlLAogICAgICBlbGVtZW50OiBwb3NpdGlvbnMubGVuZ3RoID8gaW5mby5lbGVtZW50LmNsb25lKCkgOiBpbmZvLmVsZW1lbnQsCiAgICAgIHg6IHgsCiAgICAgIHk6IHkKICAgIH07CiAgICBwb3NpdGlvbnMucHVzaChwb3NpdGlvbik7IC8vIE1vdmUgdGhlIGVsZW1lbnQgdG8gaXRzIGZpbmFsIHBvc2l0aW9uIHdpdGhpbiB0aGUgY29udGFpbmVyCgogICAgcG9zaXRpb24uZWxlbWVudC5jc3MoewogICAgICB0b3A6IE1hdGgucm91bmQoeSksCiAgICAgIGxlZnQ6IE1hdGgucm91bmQoeCksCiAgICAgICd0ZXh0LWFsaWduJzogaGFsaWduIC8vIEluIGNhc2UgdGhlIHRleHQgd3JhcHMKCiAgICB9KTsKICB9OyAvLyBSZW1vdmVzIG9uZSBvciBtb3JlIHRleHQgc3RyaW5ncyBmcm9tIHRoZSBjYW52YXMgdGV4dCBvdmVybGF5LgogIC8vCiAgLy8gSWYgbm8gcGFyYW1ldGVycyBhcmUgZ2l2ZW4sIGFsbCB0ZXh0IHdpdGhpbiB0aGUgbGF5ZXIgaXMgcmVtb3ZlZC4KICAvLwogIC8vIE5vdGUgdGhhdCB0aGUgdGV4dCBpcyBub3QgaW1tZWRpYXRlbHkgcmVtb3ZlZDsgaXQgaXMgc2ltcGx5IG1hcmtlZCBhcwogIC8vIGluYWN0aXZlLCB3aGljaCB3aWxsIHJlc3VsdCBpbiBpdHMgcmVtb3ZhbCBvbiB0aGUgbmV4dCByZW5kZXIgcGFzcy4KICAvLyBUaGlzIGF2b2lkcyB0aGUgcGVyZm9ybWFuY2UgcGVuYWx0eSBmb3IgJ2NsZWFyIGFuZCByZWRyYXcnIGJlaGF2aW9yLAogIC8vIHdoZXJlIHdlIHBvdGVudGlhbGx5IGdldCByaWQgb2YgYWxsIHRleHQgb24gYSBsYXllciwgYnV0IHdpbGwgbGlrZWx5CiAgLy8gYWRkIGJhY2sgbW9zdCBvciBhbGwgb2YgaXQgbGF0ZXIsIGFzIHdoZW4gcmVkcmF3aW5nIGF4ZXMsIGZvciBleGFtcGxlLgogIC8vCiAgLy8gQHBhcmFtIHtzdHJpbmd9IGxheWVyIEEgc3RyaW5nIG9mIHNwYWNlLXNlcGFyYXRlZCBDU1MgY2xhc3NlcyB1bmlxdWVseQogIC8vICAgICBpZGVudGlmeWluZyB0aGUgbGF5ZXIgY29udGFpbmluZyB0aGlzIHRleHQuCiAgLy8gQHBhcmFtIHtudW1iZXI9fSB4IFggY29vcmRpbmF0ZSBvZiB0aGUgdGV4dC4KICAvLyBAcGFyYW0ge251bWJlcj19IHkgWSBjb29yZGluYXRlIG9mIHRoZSB0ZXh0LgogIC8vIEBwYXJhbSB7c3RyaW5nPX0gdGV4dCBUZXh0IHN0cmluZyB0byByZW1vdmUuCiAgLy8gQHBhcmFtIHsoc3RyaW5nfG9iamVjdCk9fSBmb250IEVpdGhlciBhIHN0cmluZyBvZiBzcGFjZS1zZXBhcmF0ZWQgQ1NTCiAgLy8gICAgIGNsYXNzZXMgb3IgYSBmb250LXNwZWMgb2JqZWN0LCBkZWZpbmluZyB0aGUgdGV4dCdzIGZvbnQgYW5kIHN0eWxlLgogIC8vIEBwYXJhbSB7bnVtYmVyPX0gYW5nbGUgQW5nbGUgYXQgd2hpY2ggdGhlIHRleHQgaXMgcm90YXRlZCwgaW4gZGVncmVlcy4KICAvLyAgICAgQW5nbGUgaXMgY3VycmVudGx5IHVudXNlZCwgaXQgd2lsbCBiZSBpbXBsZW1lbnRlZCBpbiB0aGUgZnV0dXJlLgoKCiAgQ2FudmFzLnByb3RvdHlwZS5yZW1vdmVUZXh0ID0gZnVuY3Rpb24gKGxheWVyLCB4LCB5LCB0ZXh0LCBmb250LCBhbmdsZSkgewogICAgaWYgKHRleHQgPT0gbnVsbCkgewogICAgICB2YXIgbGF5ZXJDYWNoZSA9IHRoaXMuX3RleHRDYWNoZVtsYXllcl07CgogICAgICBpZiAobGF5ZXJDYWNoZSAhPSBudWxsKSB7CiAgICAgICAgZm9yICh2YXIgc3R5bGVLZXkgaW4gbGF5ZXJDYWNoZSkgewogICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwobGF5ZXJDYWNoZSwgc3R5bGVLZXkpKSB7CiAgICAgICAgICAgIHZhciBzdHlsZUNhY2hlID0gbGF5ZXJDYWNoZVtzdHlsZUtleV07CgogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gc3R5bGVDYWNoZSkgewogICAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHN0eWxlQ2FjaGUsIGtleSkpIHsKICAgICAgICAgICAgICAgIHZhciBwb3NpdGlvbnMgPSBzdHlsZUNhY2hlW2tleV0ucG9zaXRpb25zOwoKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBwb3NpdGlvbjsgcG9zaXRpb24gPSBwb3NpdGlvbnNbaV07IGkrKykgewogICAgICAgICAgICAgICAgICBwb3NpdGlvbi5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHZhciBwb3NpdGlvbnMgPSB0aGlzLmdldFRleHRJbmZvKGxheWVyLCB0ZXh0LCBmb250LCBhbmdsZSkucG9zaXRpb25zOwoKICAgICAgZm9yICh2YXIgaSA9IDAsIHBvc2l0aW9uOyBwb3NpdGlvbiA9IHBvc2l0aW9uc1tpXTsgaSsrKSB7CiAgICAgICAgaWYgKHBvc2l0aW9uLnggPT0geCAmJiBwb3NpdGlvbi55ID09IHkpIHsKICAgICAgICAgIHBvc2l0aW9uLmFjdGl2ZSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH07IC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogIC8vIFRoZSB0b3AtbGV2ZWwgY29udGFpbmVyIGZvciB0aGUgZW50aXJlIHBsb3QuCgoKICBmdW5jdGlvbiBQbG90KHBsYWNlaG9sZGVyLCBkYXRhXywgb3B0aW9uc18sIHBsdWdpbnMpIHsKICAgIC8vIGRhdGEgaXMgb24gdGhlIGZvcm06CiAgICAvLyAgIFsgc2VyaWVzMSwgc2VyaWVzMiAuLi4gXQogICAgLy8gd2hlcmUgc2VyaWVzIGlzIGVpdGhlciBqdXN0IHRoZSBkYXRhIGFzIFsgW3gxLCB5MV0sIFt4MiwgeTJdLCAuLi4gXQogICAgLy8gb3IgeyBkYXRhOiBbIFt4MSwgeTFdLCBbeDIsIHkyXSwgLi4uIF0sIGxhYmVsOiAic29tZSBsYWJlbCIsIC4uLiB9CiAgICB2YXIgc2VyaWVzID0gW10sCiAgICAgICAgb3B0aW9ucyA9IHsKICAgICAgLy8gdGhlIGNvbG9yIHRoZW1lIHVzZWQgZm9yIGdyYXBocwogICAgICBjb2xvcnM6IFsiI2VkYzI0MCIsICIjYWZkOGY4IiwgIiNjYjRiNGIiLCAiIzRkYTc0ZCIsICIjOTQ0MGVkIl0sCiAgICAgIGxlZ2VuZDogewogICAgICAgIHNob3c6IHRydWUsCiAgICAgICAgbm9Db2x1bW5zOiAxLAogICAgICAgIC8vIG51bWJlciBvZiBjb2x1bW5zIGluIGxlZ2VuZCB0YWJsZQogICAgICAgIGxhYmVsRm9ybWF0dGVyOiBudWxsLAogICAgICAgIC8vIGZuOiBzdHJpbmcgLT4gc3RyaW5nCiAgICAgICAgbGFiZWxCb3hCb3JkZXJDb2xvcjogIiNjY2MiLAogICAgICAgIC8vIGJvcmRlciBjb2xvciBmb3IgdGhlIGxpdHRsZSBsYWJlbCBib3hlcwogICAgICAgIGNvbnRhaW5lcjogbnVsbCwKICAgICAgICAvLyBjb250YWluZXIgKGFzIGpRdWVyeSBvYmplY3QpIHRvIHB1dCBsZWdlbmQgaW4sIG51bGwgbWVhbnMgZGVmYXVsdCBvbiB0b3Agb2YgZ3JhcGgKICAgICAgICBwb3NpdGlvbjogIm5lIiwKICAgICAgICAvLyBwb3NpdGlvbiBvZiBkZWZhdWx0IGxlZ2VuZCBjb250YWluZXIgd2l0aGluIHBsb3QKICAgICAgICBtYXJnaW46IDUsCiAgICAgICAgLy8gZGlzdGFuY2UgZnJvbSBncmlkIGVkZ2UgdG8gZGVmYXVsdCBsZWdlbmQgY29udGFpbmVyIHdpdGhpbiBwbG90CiAgICAgICAgYmFja2dyb3VuZENvbG9yOiBudWxsLAogICAgICAgIC8vIG51bGwgbWVhbnMgYXV0by1kZXRlY3QKICAgICAgICBiYWNrZ3JvdW5kT3BhY2l0eTogMC44NSwKICAgICAgICAvLyBzZXQgdG8gMCB0byBhdm9pZCBiYWNrZ3JvdW5kCiAgICAgICAgc29ydGVkOiBudWxsIC8vIGRlZmF1bHQgdG8gbm8gbGVnZW5kIHNvcnRpbmcKCiAgICAgIH0sCiAgICAgIHhheGlzOiB7CiAgICAgICAgc2hvdzogbnVsbCwKICAgICAgICAvLyBudWxsID0gYXV0by1kZXRlY3QsIHRydWUgPSBhbHdheXMsIGZhbHNlID0gbmV2ZXIKICAgICAgICBwb3NpdGlvbjogImJvdHRvbSIsCiAgICAgICAgLy8gb3IgInRvcCIKICAgICAgICBtb2RlOiBudWxsLAogICAgICAgIC8vIG51bGwgb3IgInRpbWUiCiAgICAgICAgZm9udDogbnVsbCwKICAgICAgICAvLyBudWxsIChkZXJpdmVkIGZyb20gQ1NTIGluIHBsYWNlaG9sZGVyKSBvciBvYmplY3QgbGlrZSB7IHNpemU6IDExLCBsaW5lSGVpZ2h0OiAxMywgc3R5bGU6ICJpdGFsaWMiLCB3ZWlnaHQ6ICJib2xkIiwgZmFtaWx5OiAic2Fucy1zZXJpZiIsIHZhcmlhbnQ6ICJzbWFsbC1jYXBzIiB9CiAgICAgICAgY29sb3I6IG51bGwsCiAgICAgICAgLy8gYmFzZSBjb2xvciwgbGFiZWxzLCB0aWNrcwogICAgICAgIHRpY2tDb2xvcjogbnVsbCwKICAgICAgICAvLyBwb3NzaWJseSBkaWZmZXJlbnQgY29sb3Igb2YgdGlja3MsIGUuZy4gInJnYmEoMCwwLDAsMC4xNSkiCiAgICAgICAgdHJhbnNmb3JtOiBudWxsLAogICAgICAgIC8vIG51bGwgb3IgZjogbnVtYmVyIC0+IG51bWJlciB0byB0cmFuc2Zvcm0gYXhpcwogICAgICAgIGludmVyc2VUcmFuc2Zvcm06IG51bGwsCiAgICAgICAgLy8gaWYgdHJhbnNmb3JtIGlzIHNldCwgdGhpcyBzaG91bGQgYmUgdGhlIGludmVyc2UgZnVuY3Rpb24KICAgICAgICBtaW46IG51bGwsCiAgICAgICAgLy8gbWluLiB2YWx1ZSB0byBzaG93LCBudWxsIG1lYW5zIHNldCBhdXRvbWF0aWNhbGx5CiAgICAgICAgbWF4OiBudWxsLAogICAgICAgIC8vIG1heC4gdmFsdWUgdG8gc2hvdywgbnVsbCBtZWFucyBzZXQgYXV0b21hdGljYWxseQogICAgICAgIGF1dG9zY2FsZU1hcmdpbjogbnVsbCwKICAgICAgICAvLyBtYXJnaW4gaW4gJSB0byBhZGQgaWYgYXV0by1zZXR0aW5nIG1pbi9tYXgKICAgICAgICB0aWNrczogbnVsbCwKICAgICAgICAvLyBlaXRoZXIgWzEsIDNdIG9yIFtbMSwgImEiXSwgM10gb3IgKGZuOiBheGlzIGluZm8gLT4gdGlja3MpIG9yIGFwcC4gbnVtYmVyIG9mIHRpY2tzIGZvciBhdXRvLXRpY2tzCiAgICAgICAgdGlja0Zvcm1hdHRlcjogbnVsbCwKICAgICAgICAvLyBmbjogbnVtYmVyIC0+IHN0cmluZwogICAgICAgIGxhYmVsV2lkdGg6IG51bGwsCiAgICAgICAgLy8gc2l6ZSBvZiB0aWNrIGxhYmVscyBpbiBwaXhlbHMKICAgICAgICBsYWJlbEhlaWdodDogbnVsbCwKICAgICAgICByZXNlcnZlU3BhY2U6IG51bGwsCiAgICAgICAgLy8gd2hldGhlciB0byByZXNlcnZlIHNwYWNlIGV2ZW4gaWYgYXhpcyBpc24ndCBzaG93bgogICAgICAgIHRpY2tMZW5ndGg6IG51bGwsCiAgICAgICAgLy8gc2l6ZSBpbiBwaXhlbHMgb2YgdGlja3MsIG9yICJmdWxsIiBmb3Igd2hvbGUgbGluZQogICAgICAgIGFsaWduVGlja3NXaXRoQXhpczogbnVsbCwKICAgICAgICAvLyBheGlzIG51bWJlciBvciBudWxsIGZvciBubyBzeW5jCiAgICAgICAgdGlja0RlY2ltYWxzOiBudWxsLAogICAgICAgIC8vIG5vLiBvZiBkZWNpbWFscywgbnVsbCBtZWFucyBhdXRvCiAgICAgICAgdGlja1NpemU6IG51bGwsCiAgICAgICAgLy8gbnVtYmVyIG9yIFtudW1iZXIsICJ1bml0Il0KICAgICAgICBtaW5UaWNrU2l6ZTogbnVsbCAvLyBudW1iZXIgb3IgW251bWJlciwgInVuaXQiXQoKICAgICAgfSwKICAgICAgeWF4aXM6IHsKICAgICAgICBhdXRvc2NhbGVNYXJnaW46IDAuMDIsCiAgICAgICAgcG9zaXRpb246ICJsZWZ0IiAvLyBvciAicmlnaHQiCgogICAgICB9LAogICAgICB4YXhlczogW10sCiAgICAgIHlheGVzOiBbXSwKICAgICAgc2VyaWVzOiB7CiAgICAgICAgcG9pbnRzOiB7CiAgICAgICAgICBzaG93OiBmYWxzZSwKICAgICAgICAgIHJhZGl1czogMywKICAgICAgICAgIGxpbmVXaWR0aDogMiwKICAgICAgICAgIC8vIGluIHBpeGVscwogICAgICAgICAgZmlsbDogdHJ1ZSwKICAgICAgICAgIGZpbGxDb2xvcjogIiNmZmZmZmYiLAogICAgICAgICAgc3ltYm9sOiAiY2lyY2xlIiAvLyBvciBjYWxsYmFjawoKICAgICAgICB9LAogICAgICAgIGxpbmVzOiB7CiAgICAgICAgICAvLyB3ZSBkb24ndCBwdXQgaW4gc2hvdzogZmFsc2Ugc28gd2UgY2FuIHNlZQogICAgICAgICAgLy8gd2hldGhlciBsaW5lcyB3ZXJlIGFjdGl2ZWx5IGRpc2FibGVkCiAgICAgICAgICBsaW5lV2lkdGg6IDIsCiAgICAgICAgICAvLyBpbiBwaXhlbHMKICAgICAgICAgIGZpbGw6IGZhbHNlLAogICAgICAgICAgZmlsbENvbG9yOiBudWxsLAogICAgICAgICAgc3RlcHM6IGZhbHNlIC8vIE9taXQgJ3plcm8nLCBzbyB3ZSBjYW4gbGF0ZXIgZGVmYXVsdCBpdHMgdmFsdWUgdG8KICAgICAgICAgIC8vIG1hdGNoIHRoYXQgb2YgdGhlICdmaWxsJyBvcHRpb24uCgogICAgICAgIH0sCiAgICAgICAgYmFyczogewogICAgICAgICAgc2hvdzogZmFsc2UsCiAgICAgICAgICBsaW5lV2lkdGg6IDIsCiAgICAgICAgICAvLyBpbiBwaXhlbHMKICAgICAgICAgIGJhcldpZHRoOiAxLAogICAgICAgICAgLy8gaW4gdW5pdHMgb2YgdGhlIHggYXhpcwogICAgICAgICAgZmlsbDogdHJ1ZSwKICAgICAgICAgIGZpbGxDb2xvcjogbnVsbCwKICAgICAgICAgIGFsaWduOiAibGVmdCIsCiAgICAgICAgICAvLyAibGVmdCIsICJyaWdodCIsIG9yICJjZW50ZXIiCiAgICAgICAgICBob3Jpem9udGFsOiBmYWxzZSwKICAgICAgICAgIHplcm86IHRydWUKICAgICAgICB9LAogICAgICAgIHNoYWRvd1NpemU6IDMsCiAgICAgICAgaGlnaGxpZ2h0Q29sb3I6IG51bGwKICAgICAgfSwKICAgICAgZ3JpZDogewogICAgICAgIHNob3c6IHRydWUsCiAgICAgICAgYWJvdmVEYXRhOiBmYWxzZSwKICAgICAgICBjb2xvcjogIiM1NDU0NTQiLAogICAgICAgIC8vIHByaW1hcnkgY29sb3IgdXNlZCBmb3Igb3V0bGluZSBhbmQgbGFiZWxzCiAgICAgICAgYmFja2dyb3VuZENvbG9yOiBudWxsLAogICAgICAgIC8vIG51bGwgZm9yIHRyYW5zcGFyZW50LCBlbHNlIGNvbG9yCiAgICAgICAgYm9yZGVyQ29sb3I6IG51bGwsCiAgICAgICAgLy8gc2V0IGlmIGRpZmZlcmVudCBmcm9tIHRoZSBncmlkIGNvbG9yCiAgICAgICAgdGlja0NvbG9yOiBudWxsLAogICAgICAgIC8vIGNvbG9yIGZvciB0aGUgdGlja3MsIGUuZy4gInJnYmEoMCwwLDAsMC4xNSkiCiAgICAgICAgbWFyZ2luOiAwLAogICAgICAgIC8vIGRpc3RhbmNlIGZyb20gdGhlIGNhbnZhcyBlZGdlIHRvIHRoZSBncmlkCiAgICAgICAgbGFiZWxNYXJnaW46IDUsCiAgICAgICAgLy8gaW4gcGl4ZWxzCiAgICAgICAgYXhpc01hcmdpbjogOCwKICAgICAgICAvLyBpbiBwaXhlbHMKICAgICAgICBib3JkZXJXaWR0aDogMiwKICAgICAgICAvLyBpbiBwaXhlbHMKICAgICAgICBtaW5Cb3JkZXJNYXJnaW46IG51bGwsCiAgICAgICAgLy8gaW4gcGl4ZWxzLCBudWxsIG1lYW5zIHRha2VuIGZyb20gcG9pbnRzIHJhZGl1cwogICAgICAgIG1hcmtpbmdzOiBudWxsLAogICAgICAgIC8vIGFycmF5IG9mIHJhbmdlcyBvciBmbjogYXhlcyAtPiBhcnJheSBvZiByYW5nZXMKICAgICAgICBtYXJraW5nc0NvbG9yOiAiI2Y0ZjRmNCIsCiAgICAgICAgbWFya2luZ3NMaW5lV2lkdGg6IDIsCiAgICAgICAgLy8gaW50ZXJhY3RpdmUgc3R1ZmYKICAgICAgICBjbGlja2FibGU6IGZhbHNlLAogICAgICAgIGhvdmVyYWJsZTogZmFsc2UsCiAgICAgICAgYXV0b0hpZ2hsaWdodDogdHJ1ZSwKICAgICAgICAvLyBoaWdobGlnaHQgaW4gY2FzZSBtb3VzZSBpcyBuZWFyCiAgICAgICAgbW91c2VBY3RpdmVSYWRpdXM6IDEwIC8vIGhvdyBmYXIgdGhlIG1vdXNlIGNhbiBiZSBhd2F5IHRvIGFjdGl2YXRlIGFuIGl0ZW0KCiAgICAgIH0sCiAgICAgIGludGVyYWN0aW9uOiB7CiAgICAgICAgcmVkcmF3T3ZlcmxheUludGVydmFsOiAxMDAwIC8gNjAgLy8gdGltZSBiZXR3ZWVuIHVwZGF0ZXMsIC0xIG1lYW5zIGluIHNhbWUgZmxvdwoKICAgICAgfSwKICAgICAgaG9va3M6IHt9CiAgICB9LAogICAgICAgIHN1cmZhY2UgPSBudWxsLAogICAgICAgIC8vIHRoZSBjYW52YXMgZm9yIHRoZSBwbG90IGl0c2VsZgogICAgb3ZlcmxheSA9IG51bGwsCiAgICAgICAgLy8gY2FudmFzIGZvciBpbnRlcmFjdGl2ZSBzdHVmZiBvbiB0b3Agb2YgcGxvdAogICAgZXZlbnRIb2xkZXIgPSBudWxsLAogICAgICAgIC8vIGpRdWVyeSBvYmplY3QgdGhhdCBldmVudHMgc2hvdWxkIGJlIGJvdW5kIHRvCiAgICBjdHggPSBudWxsLAogICAgICAgIG9jdHggPSBudWxsLAogICAgICAgIHhheGVzID0gW10sCiAgICAgICAgeWF4ZXMgPSBbXSwKICAgICAgICBwbG90T2Zmc2V0ID0gewogICAgICBsZWZ0OiAwLAogICAgICByaWdodDogMCwKICAgICAgdG9wOiAwLAogICAgICBib3R0b206IDAKICAgIH0sCiAgICAgICAgcGxvdFdpZHRoID0gMCwKICAgICAgICBwbG90SGVpZ2h0ID0gMCwKICAgICAgICBob29rcyA9IHsKICAgICAgcHJvY2Vzc09wdGlvbnM6IFtdLAogICAgICBwcm9jZXNzUmF3RGF0YTogW10sCiAgICAgIHByb2Nlc3NEYXRhcG9pbnRzOiBbXSwKICAgICAgcHJvY2Vzc09mZnNldDogW10sCiAgICAgIGRyYXdCYWNrZ3JvdW5kOiBbXSwKICAgICAgZHJhd1NlcmllczogW10sCiAgICAgIGRyYXc6IFtdLAogICAgICBiaW5kRXZlbnRzOiBbXSwKICAgICAgZHJhd092ZXJsYXk6IFtdLAogICAgICBzaHV0ZG93bjogW10KICAgIH0sCiAgICAgICAgcGxvdCA9IHRoaXM7IC8vIHB1YmxpYyBmdW5jdGlvbnMKCiAgICBwbG90LnNldERhdGEgPSBzZXREYXRhOwogICAgcGxvdC5zZXR1cEdyaWQgPSBzZXR1cEdyaWQ7CiAgICBwbG90LmRyYXcgPSBkcmF3OwoKICAgIHBsb3QuZ2V0UGxhY2Vob2xkZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBwbGFjZWhvbGRlcjsKICAgIH07CgogICAgcGxvdC5nZXRDYW52YXMgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBzdXJmYWNlLmVsZW1lbnQ7CiAgICB9OwoKICAgIHBsb3QuZ2V0UGxvdE9mZnNldCA9IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHBsb3RPZmZzZXQ7CiAgICB9OwoKICAgIHBsb3Qud2lkdGggPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBwbG90V2lkdGg7CiAgICB9OwoKICAgIHBsb3QuaGVpZ2h0ID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gcGxvdEhlaWdodDsKICAgIH07CgogICAgcGxvdC5vZmZzZXQgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBvID0gZXZlbnRIb2xkZXIub2Zmc2V0KCk7CiAgICAgIG8ubGVmdCArPSBwbG90T2Zmc2V0LmxlZnQ7CiAgICAgIG8udG9wICs9IHBsb3RPZmZzZXQudG9wOwogICAgICByZXR1cm4gbzsKICAgIH07CgogICAgcGxvdC5nZXREYXRhID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gc2VyaWVzOwogICAgfTsKCiAgICBwbG90LmdldEF4ZXMgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciByZXMgPSB7fSwKICAgICAgICAgIGk7CiAgICAgICQuZWFjaCh4YXhlcy5jb25jYXQoeWF4ZXMpLCBmdW5jdGlvbiAoXywgYXhpcykgewogICAgICAgIGlmIChheGlzKSByZXNbYXhpcy5kaXJlY3Rpb24gKyAoYXhpcy5uICE9IDEgPyBheGlzLm4gOiAiIikgKyAiYXhpcyJdID0gYXhpczsKICAgICAgfSk7CiAgICAgIHJldHVybiByZXM7CiAgICB9OwoKICAgIHBsb3QuZ2V0WEF4ZXMgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB4YXhlczsKICAgIH07CgogICAgcGxvdC5nZXRZQXhlcyA9IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHlheGVzOwogICAgfTsKCiAgICBwbG90LmMycCA9IGNhbnZhc1RvQXhpc0Nvb3JkczsKICAgIHBsb3QucDJjID0gYXhpc1RvQ2FudmFzQ29vcmRzOwoKICAgIHBsb3QuZ2V0T3B0aW9ucyA9IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIG9wdGlvbnM7CiAgICB9OwoKICAgIHBsb3QuaGlnaGxpZ2h0ID0gaGlnaGxpZ2h0OwogICAgcGxvdC51bmhpZ2hsaWdodCA9IHVuaGlnaGxpZ2h0OwogICAgcGxvdC50cmlnZ2VyUmVkcmF3T3ZlcmxheSA9IHRyaWdnZXJSZWRyYXdPdmVybGF5OwoKICAgIHBsb3QucG9pbnRPZmZzZXQgPSBmdW5jdGlvbiAocG9pbnQpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBsZWZ0OiBwYXJzZUludCh4YXhlc1theGlzTnVtYmVyKHBvaW50LCAieCIpIC0gMV0ucDJjKCtwb2ludC54KSArIHBsb3RPZmZzZXQubGVmdCwgMTApLAogICAgICAgIHRvcDogcGFyc2VJbnQoeWF4ZXNbYXhpc051bWJlcihwb2ludCwgInkiKSAtIDFdLnAyYygrcG9pbnQueSkgKyBwbG90T2Zmc2V0LnRvcCwgMTApCiAgICAgIH07CiAgICB9OwoKICAgIHBsb3Quc2h1dGRvd24gPSBzaHV0ZG93bjsKCiAgICBwbG90LmRlc3Ryb3kgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHNodXRkb3duKCk7CiAgICAgIHBsYWNlaG9sZGVyLnJlbW92ZURhdGEoInBsb3QiKS5lbXB0eSgpOwogICAgICBzZXJpZXMgPSBbXTsKICAgICAgb3B0aW9ucyA9IG51bGw7CiAgICAgIHN1cmZhY2UgPSBudWxsOwogICAgICBvdmVybGF5ID0gbnVsbDsKICAgICAgZXZlbnRIb2xkZXIgPSBudWxsOwogICAgICBjdHggPSBudWxsOwogICAgICBvY3R4ID0gbnVsbDsKICAgICAgeGF4ZXMgPSBbXTsKICAgICAgeWF4ZXMgPSBbXTsKICAgICAgaG9va3MgPSBudWxsOwogICAgICBoaWdobGlnaHRzID0gW107CiAgICAgIHBsb3QgPSBudWxsOwogICAgfTsKCiAgICBwbG90LnJlc2l6ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHdpZHRoID0gcGxhY2Vob2xkZXIud2lkdGgoKSwKICAgICAgICAgIGhlaWdodCA9IHBsYWNlaG9sZGVyLmhlaWdodCgpOwogICAgICBzdXJmYWNlLnJlc2l6ZSh3aWR0aCwgaGVpZ2h0KTsKICAgICAgb3ZlcmxheS5yZXNpemUod2lkdGgsIGhlaWdodCk7CiAgICB9OyAvLyBwdWJsaWMgYXR0cmlidXRlcwoKCiAgICBwbG90Lmhvb2tzID0gaG9va3M7IC8vIGluaXRpYWxpemUKCiAgICBpbml0UGx1Z2lucyhwbG90KTsKICAgIHBhcnNlT3B0aW9ucyhvcHRpb25zXyk7CiAgICBzZXR1cENhbnZhc2VzKCk7CiAgICBzZXREYXRhKGRhdGFfKTsKICAgIHNldHVwR3JpZCgpOwogICAgZHJhdygpOwogICAgYmluZEV2ZW50cygpOwoKICAgIGZ1bmN0aW9uIGV4ZWN1dGVIb29rcyhob29rLCBhcmdzKSB7CiAgICAgIGFyZ3MgPSBbcGxvdF0uY29uY2F0KGFyZ3MpOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBob29rLmxlbmd0aDsgKytpKSB7CiAgICAgICAgaG9va1tpXS5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGluaXRQbHVnaW5zKCkgewogICAgICAvLyBSZWZlcmVuY2VzIHRvIGtleSBjbGFzc2VzLCBhbGxvd2luZyBwbHVnaW5zIHRvIG1vZGlmeSB0aGVtCiAgICAgIHZhciBjbGFzc2VzID0gewogICAgICAgIENhbnZhczogQ2FudmFzCiAgICAgIH07CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBsdWdpbnMubGVuZ3RoOyArK2kpIHsKICAgICAgICB2YXIgcCA9IHBsdWdpbnNbaV07CiAgICAgICAgcC5pbml0KHBsb3QsIGNsYXNzZXMpOwogICAgICAgIGlmIChwLm9wdGlvbnMpICQuZXh0ZW5kKHRydWUsIG9wdGlvbnMsIHAub3B0aW9ucyk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBwYXJzZU9wdGlvbnMob3B0cykgewogICAgICAkLmV4dGVuZCh0cnVlLCBvcHRpb25zLCBvcHRzKTsgLy8gJC5leHRlbmQgbWVyZ2VzIGFycmF5cywgcmF0aGVyIHRoYW4gcmVwbGFjaW5nIHRoZW0uICBXaGVuIGxlc3MKICAgICAgLy8gY29sb3JzIGFyZSBwcm92aWRlZCB0aGFuIHRoZSBzaXplIG9mIHRoZSBkZWZhdWx0IHBhbGV0dGUsIHdlCiAgICAgIC8vIGVuZCB1cCB3aXRoIHRob3NlIGNvbG9ycyBwbHVzIHRoZSByZW1haW5pbmcgZGVmYXVsdHMsIHdoaWNoIGlzCiAgICAgIC8vIG5vdCBleHBlY3RlZCBiZWhhdmlvcjsgYXZvaWQgaXQgYnkgcmVwbGFjaW5nIHRoZW0gaGVyZS4KCiAgICAgIGlmIChvcHRzICYmIG9wdHMuY29sb3JzKSB7CiAgICAgICAgb3B0aW9ucy5jb2xvcnMgPSBvcHRzLmNvbG9yczsKICAgICAgfQoKICAgICAgaWYgKG9wdGlvbnMueGF4aXMuY29sb3IgPT0gbnVsbCkgb3B0aW9ucy54YXhpcy5jb2xvciA9ICQuY29sb3IucGFyc2Uob3B0aW9ucy5ncmlkLmNvbG9yKS5zY2FsZSgnYScsIDAuMjIpLnRvU3RyaW5nKCk7CiAgICAgIGlmIChvcHRpb25zLnlheGlzLmNvbG9yID09IG51bGwpIG9wdGlvbnMueWF4aXMuY29sb3IgPSAkLmNvbG9yLnBhcnNlKG9wdGlvbnMuZ3JpZC5jb2xvcikuc2NhbGUoJ2EnLCAwLjIyKS50b1N0cmluZygpOwogICAgICBpZiAob3B0aW9ucy54YXhpcy50aWNrQ29sb3IgPT0gbnVsbCkgLy8gZ3JpZC50aWNrQ29sb3IgZm9yIGJhY2stY29tcGF0aWJpbGl0eQogICAgICAgIG9wdGlvbnMueGF4aXMudGlja0NvbG9yID0gb3B0aW9ucy5ncmlkLnRpY2tDb2xvciB8fCBvcHRpb25zLnhheGlzLmNvbG9yOwogICAgICBpZiAob3B0aW9ucy55YXhpcy50aWNrQ29sb3IgPT0gbnVsbCkgLy8gZ3JpZC50aWNrQ29sb3IgZm9yIGJhY2stY29tcGF0aWJpbGl0eQogICAgICAgIG9wdGlvbnMueWF4aXMudGlja0NvbG9yID0gb3B0aW9ucy5ncmlkLnRpY2tDb2xvciB8fCBvcHRpb25zLnlheGlzLmNvbG9yOwogICAgICBpZiAob3B0aW9ucy5ncmlkLmJvcmRlckNvbG9yID09IG51bGwpIG9wdGlvbnMuZ3JpZC5ib3JkZXJDb2xvciA9IG9wdGlvbnMuZ3JpZC5jb2xvcjsKICAgICAgaWYgKG9wdGlvbnMuZ3JpZC50aWNrQ29sb3IgPT0gbnVsbCkgb3B0aW9ucy5ncmlkLnRpY2tDb2xvciA9ICQuY29sb3IucGFyc2Uob3B0aW9ucy5ncmlkLmNvbG9yKS5zY2FsZSgnYScsIDAuMjIpLnRvU3RyaW5nKCk7IC8vIEZpbGwgaW4gZGVmYXVsdHMgZm9yIGF4aXMgb3B0aW9ucywgaW5jbHVkaW5nIGFueSB1bnNwZWNpZmllZAogICAgICAvLyBmb250LXNwZWMgZmllbGRzLCBpZiBhIGZvbnQtc3BlYyB3YXMgcHJvdmlkZWQuCiAgICAgIC8vIElmIG5vIHgveSBheGlzIG9wdGlvbnMgd2VyZSBwcm92aWRlZCwgY3JlYXRlIG9uZSBvZiBlYWNoIGFueXdheSwKICAgICAgLy8gc2luY2UgdGhlIHJlc3Qgb2YgdGhlIGNvZGUgYXNzdW1lcyB0aGF0IHRoZXkgZXhpc3QuCgogICAgICB2YXIgaSwKICAgICAgICAgIGF4aXNPcHRpb25zLAogICAgICAgICAgYXhpc0NvdW50LAogICAgICAgICAgZm9udFNpemUgPSBwbGFjZWhvbGRlci5jc3MoImZvbnQtc2l6ZSIpLAogICAgICAgICAgZm9udFNpemVEZWZhdWx0ID0gZm9udFNpemUgPyArZm9udFNpemUucmVwbGFjZSgicHgiLCAiIikgOiAxMywKICAgICAgICAgIGZvbnREZWZhdWx0cyA9IHsKICAgICAgICBzdHlsZTogcGxhY2Vob2xkZXIuY3NzKCJmb250LXN0eWxlIiksCiAgICAgICAgc2l6ZTogTWF0aC5yb3VuZCgwLjggKiBmb250U2l6ZURlZmF1bHQpLAogICAgICAgIHZhcmlhbnQ6IHBsYWNlaG9sZGVyLmNzcygiZm9udC12YXJpYW50IiksCiAgICAgICAgd2VpZ2h0OiBwbGFjZWhvbGRlci5jc3MoImZvbnQtd2VpZ2h0IiksCiAgICAgICAgZmFtaWx5OiBwbGFjZWhvbGRlci5jc3MoImZvbnQtZmFtaWx5IikKICAgICAgfTsKICAgICAgYXhpc0NvdW50ID0gb3B0aW9ucy54YXhlcy5sZW5ndGggfHwgMTsKCiAgICAgIGZvciAoaSA9IDA7IGkgPCBheGlzQ291bnQ7ICsraSkgewogICAgICAgIGF4aXNPcHRpb25zID0gb3B0aW9ucy54YXhlc1tpXTsKCiAgICAgICAgaWYgKGF4aXNPcHRpb25zICYmICFheGlzT3B0aW9ucy50aWNrQ29sb3IpIHsKICAgICAgICAgIGF4aXNPcHRpb25zLnRpY2tDb2xvciA9IGF4aXNPcHRpb25zLmNvbG9yOwogICAgICAgIH0KCiAgICAgICAgYXhpc09wdGlvbnMgPSAkLmV4dGVuZCh0cnVlLCB7fSwgb3B0aW9ucy54YXhpcywgYXhpc09wdGlvbnMpOwogICAgICAgIG9wdGlvbnMueGF4ZXNbaV0gPSBheGlzT3B0aW9uczsKCiAgICAgICAgaWYgKGF4aXNPcHRpb25zLmZvbnQpIHsKICAgICAgICAgIGF4aXNPcHRpb25zLmZvbnQgPSAkLmV4dGVuZCh7fSwgZm9udERlZmF1bHRzLCBheGlzT3B0aW9ucy5mb250KTsKCiAgICAgICAgICBpZiAoIWF4aXNPcHRpb25zLmZvbnQuY29sb3IpIHsKICAgICAgICAgICAgYXhpc09wdGlvbnMuZm9udC5jb2xvciA9IGF4aXNPcHRpb25zLmNvbG9yOwogICAgICAgICAgfQoKICAgICAgICAgIGlmICghYXhpc09wdGlvbnMuZm9udC5saW5lSGVpZ2h0KSB7CiAgICAgICAgICAgIGF4aXNPcHRpb25zLmZvbnQubGluZUhlaWdodCA9IE1hdGgucm91bmQoYXhpc09wdGlvbnMuZm9udC5zaXplICogMS4xNSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBheGlzQ291bnQgPSBvcHRpb25zLnlheGVzLmxlbmd0aCB8fCAxOwoKICAgICAgZm9yIChpID0gMDsgaSA8IGF4aXNDb3VudDsgKytpKSB7CiAgICAgICAgYXhpc09wdGlvbnMgPSBvcHRpb25zLnlheGVzW2ldOwoKICAgICAgICBpZiAoYXhpc09wdGlvbnMgJiYgIWF4aXNPcHRpb25zLnRpY2tDb2xvcikgewogICAgICAgICAgYXhpc09wdGlvbnMudGlja0NvbG9yID0gYXhpc09wdGlvbnMuY29sb3I7CiAgICAgICAgfQoKICAgICAgICBheGlzT3B0aW9ucyA9ICQuZXh0ZW5kKHRydWUsIHt9LCBvcHRpb25zLnlheGlzLCBheGlzT3B0aW9ucyk7CiAgICAgICAgb3B0aW9ucy55YXhlc1tpXSA9IGF4aXNPcHRpb25zOwoKICAgICAgICBpZiAoYXhpc09wdGlvbnMuZm9udCkgewogICAgICAgICAgYXhpc09wdGlvbnMuZm9udCA9ICQuZXh0ZW5kKHt9LCBmb250RGVmYXVsdHMsIGF4aXNPcHRpb25zLmZvbnQpOwoKICAgICAgICAgIGlmICghYXhpc09wdGlvbnMuZm9udC5jb2xvcikgewogICAgICAgICAgICBheGlzT3B0aW9ucy5mb250LmNvbG9yID0gYXhpc09wdGlvbnMuY29sb3I7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKCFheGlzT3B0aW9ucy5mb250LmxpbmVIZWlnaHQpIHsKICAgICAgICAgICAgYXhpc09wdGlvbnMuZm9udC5saW5lSGVpZ2h0ID0gTWF0aC5yb3VuZChheGlzT3B0aW9ucy5mb250LnNpemUgKiAxLjE1KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gLy8gYmFja3dhcmRzIGNvbXBhdGliaWxpdHksIHRvIGJlIHJlbW92ZWQgaW4gZnV0dXJlCgoKICAgICAgaWYgKG9wdGlvbnMueGF4aXMubm9UaWNrcyAmJiBvcHRpb25zLnhheGlzLnRpY2tzID09IG51bGwpIG9wdGlvbnMueGF4aXMudGlja3MgPSBvcHRpb25zLnhheGlzLm5vVGlja3M7CiAgICAgIGlmIChvcHRpb25zLnlheGlzLm5vVGlja3MgJiYgb3B0aW9ucy55YXhpcy50aWNrcyA9PSBudWxsKSBvcHRpb25zLnlheGlzLnRpY2tzID0gb3B0aW9ucy55YXhpcy5ub1RpY2tzOwoKICAgICAgaWYgKG9wdGlvbnMueDJheGlzKSB7CiAgICAgICAgb3B0aW9ucy54YXhlc1sxXSA9ICQuZXh0ZW5kKHRydWUsIHt9LCBvcHRpb25zLnhheGlzLCBvcHRpb25zLngyYXhpcyk7CiAgICAgICAgb3B0aW9ucy54YXhlc1sxXS5wb3NpdGlvbiA9ICJ0b3AiOyAvLyBPdmVycmlkZSB0aGUgaW5oZXJpdCB0byBhbGxvdyB0aGUgYXhpcyB0byBhdXRvLXNjYWxlCgogICAgICAgIGlmIChvcHRpb25zLngyYXhpcy5taW4gPT0gbnVsbCkgewogICAgICAgICAgb3B0aW9ucy54YXhlc1sxXS5taW4gPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgaWYgKG9wdGlvbnMueDJheGlzLm1heCA9PSBudWxsKSB7CiAgICAgICAgICBvcHRpb25zLnhheGVzWzFdLm1heCA9IG51bGw7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAob3B0aW9ucy55MmF4aXMpIHsKICAgICAgICBvcHRpb25zLnlheGVzWzFdID0gJC5leHRlbmQodHJ1ZSwge30sIG9wdGlvbnMueWF4aXMsIG9wdGlvbnMueTJheGlzKTsKICAgICAgICBvcHRpb25zLnlheGVzWzFdLnBvc2l0aW9uID0gInJpZ2h0IjsgLy8gT3ZlcnJpZGUgdGhlIGluaGVyaXQgdG8gYWxsb3cgdGhlIGF4aXMgdG8gYXV0by1zY2FsZQoKICAgICAgICBpZiAob3B0aW9ucy55MmF4aXMubWluID09IG51bGwpIHsKICAgICAgICAgIG9wdGlvbnMueWF4ZXNbMV0ubWluID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIGlmIChvcHRpb25zLnkyYXhpcy5tYXggPT0gbnVsbCkgewogICAgICAgICAgb3B0aW9ucy55YXhlc1sxXS5tYXggPSBudWxsOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKG9wdGlvbnMuZ3JpZC5jb2xvcmVkQXJlYXMpIG9wdGlvbnMuZ3JpZC5tYXJraW5ncyA9IG9wdGlvbnMuZ3JpZC5jb2xvcmVkQXJlYXM7CiAgICAgIGlmIChvcHRpb25zLmdyaWQuY29sb3JlZEFyZWFzQ29sb3IpIG9wdGlvbnMuZ3JpZC5tYXJraW5nc0NvbG9yID0gb3B0aW9ucy5ncmlkLmNvbG9yZWRBcmVhc0NvbG9yOwogICAgICBpZiAob3B0aW9ucy5saW5lcykgJC5leHRlbmQodHJ1ZSwgb3B0aW9ucy5zZXJpZXMubGluZXMsIG9wdGlvbnMubGluZXMpOwogICAgICBpZiAob3B0aW9ucy5wb2ludHMpICQuZXh0ZW5kKHRydWUsIG9wdGlvbnMuc2VyaWVzLnBvaW50cywgb3B0aW9ucy5wb2ludHMpOwogICAgICBpZiAob3B0aW9ucy5iYXJzKSAkLmV4dGVuZCh0cnVlLCBvcHRpb25zLnNlcmllcy5iYXJzLCBvcHRpb25zLmJhcnMpOwogICAgICBpZiAob3B0aW9ucy5zaGFkb3dTaXplICE9IG51bGwpIG9wdGlvbnMuc2VyaWVzLnNoYWRvd1NpemUgPSBvcHRpb25zLnNoYWRvd1NpemU7CiAgICAgIGlmIChvcHRpb25zLmhpZ2hsaWdodENvbG9yICE9IG51bGwpIG9wdGlvbnMuc2VyaWVzLmhpZ2hsaWdodENvbG9yID0gb3B0aW9ucy5oaWdobGlnaHRDb2xvcjsgLy8gc2F2ZSBvcHRpb25zIG9uIGF4ZXMgZm9yIGZ1dHVyZSByZWZlcmVuY2UKCiAgICAgIGZvciAoaSA9IDA7IGkgPCBvcHRpb25zLnhheGVzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgZ2V0T3JDcmVhdGVBeGlzKHhheGVzLCBpICsgMSkub3B0aW9ucyA9IG9wdGlvbnMueGF4ZXNbaV07CiAgICAgIH0KCiAgICAgIGZvciAoaSA9IDA7IGkgPCBvcHRpb25zLnlheGVzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgZ2V0T3JDcmVhdGVBeGlzKHlheGVzLCBpICsgMSkub3B0aW9ucyA9IG9wdGlvbnMueWF4ZXNbaV07CiAgICAgIH0gLy8gYWRkIGhvb2tzIGZyb20gb3B0aW9ucwoKCiAgICAgIGZvciAodmFyIG4gaW4gaG9va3MpIHsKICAgICAgICBpZiAob3B0aW9ucy5ob29rc1tuXSAmJiBvcHRpb25zLmhvb2tzW25dLmxlbmd0aCkgaG9va3Nbbl0gPSBob29rc1tuXS5jb25jYXQob3B0aW9ucy5ob29rc1tuXSk7CiAgICAgIH0KCiAgICAgIGV4ZWN1dGVIb29rcyhob29rcy5wcm9jZXNzT3B0aW9ucywgW29wdGlvbnNdKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXREYXRhKGQpIHsKICAgICAgc2VyaWVzID0gcGFyc2VEYXRhKGQpOwogICAgICBmaWxsSW5TZXJpZXNPcHRpb25zKCk7CiAgICAgIHByb2Nlc3NEYXRhKCk7CiAgICB9CgogICAgZnVuY3Rpb24gcGFyc2VEYXRhKGQpIHsKICAgICAgdmFyIHJlcyA9IFtdOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkLmxlbmd0aDsgKytpKSB7CiAgICAgICAgdmFyIHMgPSAkLmV4dGVuZCh0cnVlLCB7fSwgb3B0aW9ucy5zZXJpZXMpOwoKICAgICAgICBpZiAoZFtpXS5kYXRhICE9IG51bGwpIHsKICAgICAgICAgIHMuZGF0YSA9IGRbaV0uZGF0YTsgLy8gbW92ZSB0aGUgZGF0YSBpbnN0ZWFkIG9mIGRlZXAtY29weQoKICAgICAgICAgIGRlbGV0ZSBkW2ldLmRhdGE7CiAgICAgICAgICAkLmV4dGVuZCh0cnVlLCBzLCBkW2ldKTsKICAgICAgICAgIGRbaV0uZGF0YSA9IHMuZGF0YTsKICAgICAgICB9IGVsc2Ugcy5kYXRhID0gZFtpXTsKCiAgICAgICAgcmVzLnB1c2gocyk7CiAgICAgIH0KCiAgICAgIHJldHVybiByZXM7CiAgICB9CgogICAgZnVuY3Rpb24gYXhpc051bWJlcihvYmosIGNvb3JkKSB7CiAgICAgIHZhciBhID0gb2JqW2Nvb3JkICsgImF4aXMiXTsKICAgICAgaWYgKF90eXBlb2YoYSkgPT0gIm9iamVjdCIpIC8vIGlmIHdlIGdvdCBhIHJlYWwgYXhpcywgZXh0cmFjdCBudW1iZXIKICAgICAgICBhID0gYS5uOwogICAgICBpZiAodHlwZW9mIGEgIT0gIm51bWJlciIpIGEgPSAxOyAvLyBkZWZhdWx0IHRvIGZpcnN0IGF4aXMKCiAgICAgIHJldHVybiBhOwogICAgfQoKICAgIGZ1bmN0aW9uIGFsbEF4ZXMoKSB7CiAgICAgIC8vIHJldHVybiBmbGF0IGFycmF5IHdpdGhvdXQgYW5ub3lpbmcgbnVsbCBlbnRyaWVzCiAgICAgIHJldHVybiAkLmdyZXAoeGF4ZXMuY29uY2F0KHlheGVzKSwgZnVuY3Rpb24gKGEpIHsKICAgICAgICByZXR1cm4gYTsKICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gY2FudmFzVG9BeGlzQ29vcmRzKHBvcykgewogICAgICAvLyByZXR1cm4gYW4gb2JqZWN0IHdpdGggeC95IGNvcnJlc3BvbmRpbmcgdG8gYWxsIHVzZWQgYXhlcwogICAgICB2YXIgcmVzID0ge30sCiAgICAgICAgICBpLAogICAgICAgICAgYXhpczsKCiAgICAgIGZvciAoaSA9IDA7IGkgPCB4YXhlcy5sZW5ndGg7ICsraSkgewogICAgICAgIGF4aXMgPSB4YXhlc1tpXTsKICAgICAgICBpZiAoYXhpcyAmJiBheGlzLnVzZWQpIHJlc1sieCIgKyBheGlzLm5dID0gYXhpcy5jMnAocG9zLmxlZnQpOwogICAgICB9CgogICAgICBmb3IgKGkgPSAwOyBpIDwgeWF4ZXMubGVuZ3RoOyArK2kpIHsKICAgICAgICBheGlzID0geWF4ZXNbaV07CiAgICAgICAgaWYgKGF4aXMgJiYgYXhpcy51c2VkKSByZXNbInkiICsgYXhpcy5uXSA9IGF4aXMuYzJwKHBvcy50b3ApOwogICAgICB9CgogICAgICBpZiAocmVzLngxICE9PSB1bmRlZmluZWQpIHJlcy54ID0gcmVzLngxOwogICAgICBpZiAocmVzLnkxICE9PSB1bmRlZmluZWQpIHJlcy55ID0gcmVzLnkxOwogICAgICByZXR1cm4gcmVzOwogICAgfQoKICAgIGZ1bmN0aW9uIGF4aXNUb0NhbnZhc0Nvb3Jkcyhwb3MpIHsKICAgICAgLy8gZ2V0IGNhbnZhcyBjb29yZHMgZnJvbSB0aGUgZmlyc3QgcGFpciBvZiB4L3kgZm91bmQgaW4gcG9zCiAgICAgIHZhciByZXMgPSB7fSwKICAgICAgICAgIGksCiAgICAgICAgICBheGlzLAogICAgICAgICAga2V5OwoKICAgICAgZm9yIChpID0gMDsgaSA8IHhheGVzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgYXhpcyA9IHhheGVzW2ldOwoKICAgICAgICBpZiAoYXhpcyAmJiBheGlzLnVzZWQpIHsKICAgICAgICAgIGtleSA9ICJ4IiArIGF4aXMubjsKICAgICAgICAgIGlmIChwb3Nba2V5XSA9PSBudWxsICYmIGF4aXMubiA9PSAxKSBrZXkgPSAieCI7CgogICAgICAgICAgaWYgKHBvc1trZXldICE9IG51bGwpIHsKICAgICAgICAgICAgcmVzLmxlZnQgPSBheGlzLnAyYyhwb3Nba2V5XSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgZm9yIChpID0gMDsgaSA8IHlheGVzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgYXhpcyA9IHlheGVzW2ldOwoKICAgICAgICBpZiAoYXhpcyAmJiBheGlzLnVzZWQpIHsKICAgICAgICAgIGtleSA9ICJ5IiArIGF4aXMubjsKICAgICAgICAgIGlmIChwb3Nba2V5XSA9PSBudWxsICYmIGF4aXMubiA9PSAxKSBrZXkgPSAieSI7CgogICAgICAgICAgaWYgKHBvc1trZXldICE9IG51bGwpIHsKICAgICAgICAgICAgcmVzLnRvcCA9IGF4aXMucDJjKHBvc1trZXldKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gcmVzOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldE9yQ3JlYXRlQXhpcyhheGVzLCBudW1iZXIpIHsKICAgICAgaWYgKCFheGVzW251bWJlciAtIDFdKSBheGVzW251bWJlciAtIDFdID0gewogICAgICAgIG46IG51bWJlciwKICAgICAgICAvLyBzYXZlIHRoZSBudW1iZXIgZm9yIGZ1dHVyZSByZWZlcmVuY2UKICAgICAgICBkaXJlY3Rpb246IGF4ZXMgPT0geGF4ZXMgPyAieCIgOiAieSIsCiAgICAgICAgb3B0aW9uczogJC5leHRlbmQodHJ1ZSwge30sIGF4ZXMgPT0geGF4ZXMgPyBvcHRpb25zLnhheGlzIDogb3B0aW9ucy55YXhpcykKICAgICAgfTsKICAgICAgcmV0dXJuIGF4ZXNbbnVtYmVyIC0gMV07CiAgICB9CgogICAgZnVuY3Rpb24gZmlsbEluU2VyaWVzT3B0aW9ucygpIHsKICAgICAgdmFyIG5lZWRlZENvbG9ycyA9IHNlcmllcy5sZW5ndGgsCiAgICAgICAgICBtYXhJbmRleCA9IC0xLAogICAgICAgICAgaTsgLy8gU3VidHJhY3QgdGhlIG51bWJlciBvZiBzZXJpZXMgdGhhdCBhbHJlYWR5IGhhdmUgZml4ZWQgY29sb3JzIG9yCiAgICAgIC8vIGNvbG9yIGluZGV4ZXMgZnJvbSB0aGUgbnVtYmVyIHRoYXQgd2Ugc3RpbGwgbmVlZCB0byBnZW5lcmF0ZS4KCiAgICAgIGZvciAoaSA9IDA7IGkgPCBzZXJpZXMubGVuZ3RoOyArK2kpIHsKICAgICAgICB2YXIgc2MgPSBzZXJpZXNbaV0uY29sb3I7CgogICAgICAgIGlmIChzYyAhPSBudWxsKSB7CiAgICAgICAgICBuZWVkZWRDb2xvcnMtLTsKCiAgICAgICAgICBpZiAodHlwZW9mIHNjID09ICJudW1iZXIiICYmIHNjID4gbWF4SW5kZXgpIHsKICAgICAgICAgICAgbWF4SW5kZXggPSBzYzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gLy8gSWYgYW55IG9mIHRoZSBzZXJpZXMgaGF2ZSBmaXhlZCBjb2xvciBpbmRleGVzLCB0aGVuIHdlIG5lZWQgdG8KICAgICAgLy8gZ2VuZXJhdGUgYXQgbGVhc3QgYXMgbWFueSBjb2xvcnMgYXMgdGhlIGhpZ2hlc3QgaW5kZXguCgoKICAgICAgaWYgKG5lZWRlZENvbG9ycyA8PSBtYXhJbmRleCkgewogICAgICAgIG5lZWRlZENvbG9ycyA9IG1heEluZGV4ICsgMTsKICAgICAgfSAvLyBHZW5lcmF0ZSBhbGwgdGhlIGNvbG9ycywgdXNpbmcgZmlyc3QgdGhlIG9wdGlvbiBjb2xvcnMgYW5kIHRoZW4KICAgICAgLy8gdmFyaWF0aW9ucyBvbiB0aG9zZSBjb2xvcnMgb25jZSB0aGV5J3JlIGV4aGF1c3RlZC4KCgogICAgICB2YXIgYywKICAgICAgICAgIGNvbG9ycyA9IFtdLAogICAgICAgICAgY29sb3JQb29sID0gb3B0aW9ucy5jb2xvcnMsCiAgICAgICAgICBjb2xvclBvb2xTaXplID0gY29sb3JQb29sLmxlbmd0aCwKICAgICAgICAgIHZhcmlhdGlvbiA9IDA7CgogICAgICBmb3IgKGkgPSAwOyBpIDwgbmVlZGVkQ29sb3JzOyBpKyspIHsKICAgICAgICBjID0gJC5jb2xvci5wYXJzZShjb2xvclBvb2xbaSAlIGNvbG9yUG9vbFNpemVdIHx8ICIjNjY2Iik7IC8vIEVhY2ggdGltZSB3ZSBleGhhdXN0IHRoZSBjb2xvcnMgaW4gdGhlIHBvb2wgd2UgYWRqdXN0CiAgICAgICAgLy8gYSBzY2FsaW5nIGZhY3RvciB1c2VkIHRvIHByb2R1Y2UgbW9yZSB2YXJpYXRpb25zIG9uCiAgICAgICAgLy8gdGhvc2UgY29sb3JzLiBUaGUgZmFjdG9yIGFsdGVybmF0ZXMgbmVnYXRpdmUvcG9zaXRpdmUKICAgICAgICAvLyB0byBwcm9kdWNlIGxpZ2h0ZXIvZGFya2VyIGNvbG9ycy4KICAgICAgICAvLyBSZXNldCB0aGUgdmFyaWF0aW9uIGFmdGVyIGV2ZXJ5IGZldyBjeWNsZXMsIG9yIGVsc2UKICAgICAgICAvLyBpdCB3aWxsIGVuZCB1cCBwcm9kdWNpbmcgb25seSB3aGl0ZSBvciBibGFjayBjb2xvcnMuCgogICAgICAgIGlmIChpICUgY29sb3JQb29sU2l6ZSA9PSAwICYmIGkpIHsKICAgICAgICAgIGlmICh2YXJpYXRpb24gPj0gMCkgewogICAgICAgICAgICBpZiAodmFyaWF0aW9uIDwgMC41KSB7CiAgICAgICAgICAgICAgdmFyaWF0aW9uID0gLXZhcmlhdGlvbiAtIDAuMjsKICAgICAgICAgICAgfSBlbHNlIHZhcmlhdGlvbiA9IDA7CiAgICAgICAgICB9IGVsc2UgdmFyaWF0aW9uID0gLXZhcmlhdGlvbjsKICAgICAgICB9CgogICAgICAgIGNvbG9yc1tpXSA9IGMuc2NhbGUoJ3JnYicsIDEgKyB2YXJpYXRpb24pOwogICAgICB9IC8vIEZpbmFsaXplIHRoZSBzZXJpZXMgb3B0aW9ucywgZmlsbGluZyBpbiB0aGVpciBjb2xvcnMKCgogICAgICB2YXIgY29sb3JpID0gMCwKICAgICAgICAgIHM7CgogICAgICBmb3IgKGkgPSAwOyBpIDwgc2VyaWVzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgcyA9IHNlcmllc1tpXTsgLy8gYXNzaWduIGNvbG9ycwoKICAgICAgICBpZiAocy5jb2xvciA9PSBudWxsKSB7CiAgICAgICAgICBzLmNvbG9yID0gY29sb3JzW2NvbG9yaV0udG9TdHJpbmcoKTsKICAgICAgICAgICsrY29sb3JpOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHMuY29sb3IgPT0gIm51bWJlciIpIHMuY29sb3IgPSBjb2xvcnNbcy5jb2xvcl0udG9TdHJpbmcoKTsgLy8gdHVybiBvbiBsaW5lcyBhdXRvbWF0aWNhbGx5IGluIGNhc2Ugbm90aGluZyBpcyBzZXQKCgogICAgICAgIGlmIChzLmxpbmVzLnNob3cgPT0gbnVsbCkgewogICAgICAgICAgdmFyIHYsCiAgICAgICAgICAgICAgc2hvdyA9IHRydWU7CgogICAgICAgICAgZm9yICh2IGluIHMpIHsKICAgICAgICAgICAgaWYgKHNbdl0gJiYgc1t2XS5zaG93KSB7CiAgICAgICAgICAgICAgc2hvdyA9IGZhbHNlOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHNob3cpIHMubGluZXMuc2hvdyA9IHRydWU7CiAgICAgICAgfSAvLyBJZiBub3RoaW5nIHdhcyBwcm92aWRlZCBmb3IgbGluZXMuemVybywgZGVmYXVsdCBpdCB0byBtYXRjaAogICAgICAgIC8vIGxpbmVzLmZpbGwsIHNpbmNlIGFyZWFzIGJ5IGRlZmF1bHQgc2hvdWxkIGV4dGVuZCB0byB6ZXJvLgoKCiAgICAgICAgaWYgKHMubGluZXMuemVybyA9PSBudWxsKSB7CiAgICAgICAgICBzLmxpbmVzLnplcm8gPSAhIXMubGluZXMuZmlsbDsKICAgICAgICB9IC8vIHNldHVwIGF4ZXMKCgogICAgICAgIHMueGF4aXMgPSBnZXRPckNyZWF0ZUF4aXMoeGF4ZXMsIGF4aXNOdW1iZXIocywgIngiKSk7CiAgICAgICAgcy55YXhpcyA9IGdldE9yQ3JlYXRlQXhpcyh5YXhlcywgYXhpc051bWJlcihzLCAieSIpKTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHByb2Nlc3NEYXRhKCkgewogICAgICB2YXIgdG9wU2VudHJ5ID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZLAogICAgICAgICAgYm90dG9tU2VudHJ5ID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZLAogICAgICAgICAgZmFrZUluZmluaXR5ID0gTnVtYmVyLk1BWF9WQUxVRSwKICAgICAgICAgIGksCiAgICAgICAgICBqLAogICAgICAgICAgaywKICAgICAgICAgIG0sCiAgICAgICAgICBsZW5ndGgsCiAgICAgICAgICBzLAogICAgICAgICAgcG9pbnRzLAogICAgICAgICAgcHMsCiAgICAgICAgICB4LAogICAgICAgICAgeSwKICAgICAgICAgIGF4aXMsCiAgICAgICAgICB2YWwsCiAgICAgICAgICBmLAogICAgICAgICAgcCwKICAgICAgICAgIGRhdGEsCiAgICAgICAgICBmb3JtYXQ7CgogICAgICBmdW5jdGlvbiB1cGRhdGVBeGlzKGF4aXMsIG1pbiwgbWF4KSB7CiAgICAgICAgaWYgKG1pbiA8IGF4aXMuZGF0YW1pbiAmJiBtaW4gIT0gLWZha2VJbmZpbml0eSkgYXhpcy5kYXRhbWluID0gbWluOwogICAgICAgIGlmIChtYXggPiBheGlzLmRhdGFtYXggJiYgbWF4ICE9IGZha2VJbmZpbml0eSkgYXhpcy5kYXRhbWF4ID0gbWF4OwogICAgICB9CgogICAgICAkLmVhY2goYWxsQXhlcygpLCBmdW5jdGlvbiAoXywgYXhpcykgewogICAgICAgIC8vIGluaXQgYXhpcwogICAgICAgIGF4aXMuZGF0YW1pbiA9IHRvcFNlbnRyeTsKICAgICAgICBheGlzLmRhdGFtYXggPSBib3R0b21TZW50cnk7CiAgICAgICAgYXhpcy51c2VkID0gZmFsc2U7CiAgICAgIH0pOwoKICAgICAgZm9yIChpID0gMDsgaSA8IHNlcmllcy5sZW5ndGg7ICsraSkgewogICAgICAgIHMgPSBzZXJpZXNbaV07CiAgICAgICAgcy5kYXRhcG9pbnRzID0gewogICAgICAgICAgcG9pbnRzOiBbXQogICAgICAgIH07CiAgICAgICAgZXhlY3V0ZUhvb2tzKGhvb2tzLnByb2Nlc3NSYXdEYXRhLCBbcywgcy5kYXRhLCBzLmRhdGFwb2ludHNdKTsKICAgICAgfSAvLyBmaXJzdCBwYXNzOiBjbGVhbiBhbmQgY29weSBkYXRhCgoKICAgICAgZm9yIChpID0gMDsgaSA8IHNlcmllcy5sZW5ndGg7ICsraSkgewogICAgICAgIHMgPSBzZXJpZXNbaV07CiAgICAgICAgZGF0YSA9IHMuZGF0YTsKICAgICAgICBmb3JtYXQgPSBzLmRhdGFwb2ludHMuZm9ybWF0OwoKICAgICAgICBpZiAoIWZvcm1hdCkgewogICAgICAgICAgZm9ybWF0ID0gW107IC8vIGZpbmQgb3V0IGhvdyB0byBjb3B5CgogICAgICAgICAgZm9ybWF0LnB1c2goewogICAgICAgICAgICB4OiB0cnVlLAogICAgICAgICAgICBudW1iZXI6IHRydWUsCiAgICAgICAgICAgIHJlcXVpcmVkOiB0cnVlCiAgICAgICAgICB9KTsKICAgICAgICAgIGZvcm1hdC5wdXNoKHsKICAgICAgICAgICAgeTogdHJ1ZSwKICAgICAgICAgICAgbnVtYmVyOiB0cnVlLAogICAgICAgICAgICByZXF1aXJlZDogdHJ1ZQogICAgICAgICAgfSk7CgogICAgICAgICAgaWYgKHMuYmFycy5zaG93IHx8IHMubGluZXMuc2hvdyAmJiBzLmxpbmVzLmZpbGwpIHsKICAgICAgICAgICAgdmFyIGF1dG9zY2FsZSA9ICEhKHMuYmFycy5zaG93ICYmIHMuYmFycy56ZXJvIHx8IHMubGluZXMuc2hvdyAmJiBzLmxpbmVzLnplcm8pOwogICAgICAgICAgICBmb3JtYXQucHVzaCh7CiAgICAgICAgICAgICAgeTogdHJ1ZSwKICAgICAgICAgICAgICBudW1iZXI6IHRydWUsCiAgICAgICAgICAgICAgcmVxdWlyZWQ6IGZhbHNlLAogICAgICAgICAgICAgIGRlZmF1bHRWYWx1ZTogMCwKICAgICAgICAgICAgICBhdXRvc2NhbGU6IGF1dG9zY2FsZQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGlmIChzLmJhcnMuaG9yaXpvbnRhbCkgewogICAgICAgICAgICAgIGRlbGV0ZSBmb3JtYXRbZm9ybWF0Lmxlbmd0aCAtIDFdLnk7CiAgICAgICAgICAgICAgZm9ybWF0W2Zvcm1hdC5sZW5ndGggLSAxXS54ID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIHMuZGF0YXBvaW50cy5mb3JtYXQgPSBmb3JtYXQ7CiAgICAgICAgfQoKICAgICAgICBpZiAocy5kYXRhcG9pbnRzLnBvaW50c2l6ZSAhPSBudWxsKSBjb250aW51ZTsgLy8gYWxyZWFkeSBmaWxsZWQgaW4KCiAgICAgICAgcy5kYXRhcG9pbnRzLnBvaW50c2l6ZSA9IGZvcm1hdC5sZW5ndGg7CiAgICAgICAgcHMgPSBzLmRhdGFwb2ludHMucG9pbnRzaXplOwogICAgICAgIHBvaW50cyA9IHMuZGF0YXBvaW50cy5wb2ludHM7CiAgICAgICAgdmFyIGluc2VydFN0ZXBzID0gcy5saW5lcy5zaG93ICYmIHMubGluZXMuc3RlcHM7CiAgICAgICAgcy54YXhpcy51c2VkID0gcy55YXhpcy51c2VkID0gdHJ1ZTsKCiAgICAgICAgZm9yIChqID0gayA9IDA7IGogPCBkYXRhLmxlbmd0aDsgKytqLCBrICs9IHBzKSB7CiAgICAgICAgICBwID0gZGF0YVtqXTsKICAgICAgICAgIHZhciBudWxsaWZ5ID0gcCA9PSBudWxsOwoKICAgICAgICAgIGlmICghbnVsbGlmeSkgewogICAgICAgICAgICBmb3IgKG0gPSAwOyBtIDwgcHM7ICsrbSkgewogICAgICAgICAgICAgIHZhbCA9IHBbbV07CiAgICAgICAgICAgICAgZiA9IGZvcm1hdFttXTsKCiAgICAgICAgICAgICAgaWYgKGYpIHsKICAgICAgICAgICAgICAgIGlmIChmLm51bWJlciAmJiB2YWwgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YWwgPSArdmFsOyAvLyBjb252ZXJ0IHRvIG51bWJlcgoKICAgICAgICAgICAgICAgICAgaWYgKGlzTmFOKHZhbCkpIHZhbCA9IG51bGw7ZWxzZSBpZiAodmFsID09IEluZmluaXR5KSB2YWwgPSBmYWtlSW5maW5pdHk7ZWxzZSBpZiAodmFsID09IC1JbmZpbml0eSkgdmFsID0gLWZha2VJbmZpbml0eTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAodmFsID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgaWYgKGYucmVxdWlyZWQpIG51bGxpZnkgPSB0cnVlOwogICAgICAgICAgICAgICAgICBpZiAoZi5kZWZhdWx0VmFsdWUgIT0gbnVsbCkgdmFsID0gZi5kZWZhdWx0VmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBwb2ludHNbayArIG1dID0gdmFsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKG51bGxpZnkpIHsKICAgICAgICAgICAgZm9yIChtID0gMDsgbSA8IHBzOyArK20pIHsKICAgICAgICAgICAgICB2YWwgPSBwb2ludHNbayArIG1dOwoKICAgICAgICAgICAgICBpZiAodmFsICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGYgPSBmb3JtYXRbbV07IC8vIGV4dHJhY3QgbWluL21heCBpbmZvCgogICAgICAgICAgICAgICAgaWYgKGYuYXV0b3NjYWxlICE9PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICBpZiAoZi54KSB7CiAgICAgICAgICAgICAgICAgICAgdXBkYXRlQXhpcyhzLnhheGlzLCB2YWwsIHZhbCk7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIGlmIChmLnkpIHsKICAgICAgICAgICAgICAgICAgICB1cGRhdGVBeGlzKHMueWF4aXMsIHZhbCwgdmFsKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgcG9pbnRzW2sgKyBtXSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIGEgbGl0dGxlIGJpdCBvZiBsaW5lIHNwZWNpZmljIHN0dWZmIHRoYXQKICAgICAgICAgICAgLy8gcGVyaGFwcyBzaG91bGRuJ3QgYmUgaGVyZSwgYnV0IGxhY2tpbmcKICAgICAgICAgICAgLy8gYmV0dGVyIG1lYW5zLi4uCiAgICAgICAgICAgIGlmIChpbnNlcnRTdGVwcyAmJiBrID4gMCAmJiBwb2ludHNbayAtIHBzXSAhPSBudWxsICYmIHBvaW50c1trIC0gcHNdICE9IHBvaW50c1trXSAmJiBwb2ludHNbayAtIHBzICsgMV0gIT0gcG9pbnRzW2sgKyAxXSkgewogICAgICAgICAgICAgIC8vIGNvcHkgdGhlIHBvaW50IHRvIG1ha2Ugcm9vbSBmb3IgYSBtaWRkbGUgcG9pbnQKICAgICAgICAgICAgICBmb3IgKG0gPSAwOyBtIDwgcHM7ICsrbSkgewogICAgICAgICAgICAgICAgcG9pbnRzW2sgKyBwcyArIG1dID0gcG9pbnRzW2sgKyBtXTsKICAgICAgICAgICAgICB9IC8vIG1pZGRsZSBwb2ludCBoYXMgc2FtZSB5CgoKICAgICAgICAgICAgICBwb2ludHNbayArIDFdID0gcG9pbnRzW2sgLSBwcyArIDFdOyAvLyB3ZSd2ZSBhZGRlZCBhIHBvaW50LCBiZXR0ZXIgcmVmbGVjdCB0aGF0CgogICAgICAgICAgICAgIGsgKz0gcHM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gLy8gZ2l2ZSB0aGUgaG9va3MgYSBjaGFuY2UgdG8gcnVuCgoKICAgICAgZm9yIChpID0gMDsgaSA8IHNlcmllcy5sZW5ndGg7ICsraSkgewogICAgICAgIHMgPSBzZXJpZXNbaV07CiAgICAgICAgZXhlY3V0ZUhvb2tzKGhvb2tzLnByb2Nlc3NEYXRhcG9pbnRzLCBbcywgcy5kYXRhcG9pbnRzXSk7CiAgICAgIH0gLy8gc2Vjb25kIHBhc3M6IGZpbmQgZGF0YW1heC9kYXRhbWluIGZvciBhdXRvLXNjYWxpbmcKCgogICAgICBmb3IgKGkgPSAwOyBpIDwgc2VyaWVzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgcyA9IHNlcmllc1tpXTsKICAgICAgICBwb2ludHMgPSBzLmRhdGFwb2ludHMucG9pbnRzOwogICAgICAgIHBzID0gcy5kYXRhcG9pbnRzLnBvaW50c2l6ZTsKICAgICAgICBmb3JtYXQgPSBzLmRhdGFwb2ludHMuZm9ybWF0OwogICAgICAgIHZhciB4bWluID0gdG9wU2VudHJ5LAogICAgICAgICAgICB5bWluID0gdG9wU2VudHJ5LAogICAgICAgICAgICB4bWF4ID0gYm90dG9tU2VudHJ5LAogICAgICAgICAgICB5bWF4ID0gYm90dG9tU2VudHJ5OwoKICAgICAgICBmb3IgKGogPSAwOyBqIDwgcG9pbnRzLmxlbmd0aDsgaiArPSBwcykgewogICAgICAgICAgaWYgKHBvaW50c1tqXSA9PSBudWxsKSBjb250aW51ZTsKCiAgICAgICAgICBmb3IgKG0gPSAwOyBtIDwgcHM7ICsrbSkgewogICAgICAgICAgICB2YWwgPSBwb2ludHNbaiArIG1dOwogICAgICAgICAgICBmID0gZm9ybWF0W21dOwogICAgICAgICAgICBpZiAoIWYgfHwgZi5hdXRvc2NhbGUgPT09IGZhbHNlIHx8IHZhbCA9PSBmYWtlSW5maW5pdHkgfHwgdmFsID09IC1mYWtlSW5maW5pdHkpIGNvbnRpbnVlOwoKICAgICAgICAgICAgaWYgKGYueCkgewogICAgICAgICAgICAgIGlmICh2YWwgPCB4bWluKSB4bWluID0gdmFsOwogICAgICAgICAgICAgIGlmICh2YWwgPiB4bWF4KSB4bWF4ID0gdmFsOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZi55KSB7CiAgICAgICAgICAgICAgaWYgKHZhbCA8IHltaW4pIHltaW4gPSB2YWw7CiAgICAgICAgICAgICAgaWYgKHZhbCA+IHltYXgpIHltYXggPSB2YWw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChzLmJhcnMuc2hvdykgewogICAgICAgICAgLy8gbWFrZSBzdXJlIHdlIGdvdCByb29tIGZvciB0aGUgYmFyIG9uIHRoZSBkYW5jaW5nIGZsb29yCiAgICAgICAgICB2YXIgZGVsdGE7CgogICAgICAgICAgc3dpdGNoIChzLmJhcnMuYWxpZ24pIHsKICAgICAgICAgICAgY2FzZSAibGVmdCI6CiAgICAgICAgICAgICAgZGVsdGEgPSAwOwogICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSAicmlnaHQiOgogICAgICAgICAgICAgIGRlbHRhID0gLXMuYmFycy5iYXJXaWR0aDsKICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgZGVsdGEgPSAtcy5iYXJzLmJhcldpZHRoIC8gMjsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAocy5iYXJzLmhvcml6b250YWwpIHsKICAgICAgICAgICAgeW1pbiArPSBkZWx0YTsKICAgICAgICAgICAgeW1heCArPSBkZWx0YSArIHMuYmFycy5iYXJXaWR0aDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHhtaW4gKz0gZGVsdGE7CiAgICAgICAgICAgIHhtYXggKz0gZGVsdGEgKyBzLmJhcnMuYmFyV2lkdGg7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVBeGlzKHMueGF4aXMsIHhtaW4sIHhtYXgpOwogICAgICAgIHVwZGF0ZUF4aXMocy55YXhpcywgeW1pbiwgeW1heCk7CiAgICAgIH0KCiAgICAgICQuZWFjaChhbGxBeGVzKCksIGZ1bmN0aW9uIChfLCBheGlzKSB7CiAgICAgICAgaWYgKGF4aXMuZGF0YW1pbiA9PSB0b3BTZW50cnkpIGF4aXMuZGF0YW1pbiA9IG51bGw7CiAgICAgICAgaWYgKGF4aXMuZGF0YW1heCA9PSBib3R0b21TZW50cnkpIGF4aXMuZGF0YW1heCA9IG51bGw7CiAgICAgIH0pOwogICAgfQoKICAgIGZ1bmN0aW9uIHNldHVwQ2FudmFzZXMoKSB7CiAgICAgIC8vIE1ha2Ugc3VyZSB0aGUgcGxhY2Vob2xkZXIgaXMgY2xlYXIgb2YgZXZlcnl0aGluZyBleGNlcHQgY2FudmFzZXMKICAgICAgLy8gZnJvbSBhIHByZXZpb3VzIHBsb3QgaW4gdGhpcyBjb250YWluZXIgdGhhdCB3ZSdsbCB0cnkgdG8gcmUtdXNlLgogICAgICBwbGFjZWhvbGRlci5jc3MoInBhZGRpbmciLCAwKSAvLyBwYWRkaW5nIG1lc3NlcyB1cCB0aGUgcG9zaXRpb25pbmcKICAgICAgLmNoaWxkcmVuKCkuZmlsdGVyKGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gISQodGhpcykuaGFzQ2xhc3MoImZsb3Qtb3ZlcmxheSIpICYmICEkKHRoaXMpLmhhc0NsYXNzKCdmbG90LWJhc2UnKTsKICAgICAgfSkucmVtb3ZlKCk7CiAgICAgIGlmIChwbGFjZWhvbGRlci5jc3MoInBvc2l0aW9uIikgPT0gJ3N0YXRpYycpIHBsYWNlaG9sZGVyLmNzcygicG9zaXRpb24iLCAicmVsYXRpdmUiKTsgLy8gZm9yIHBvc2l0aW9uaW5nIGxhYmVscyBhbmQgb3ZlcmxheQoKICAgICAgc3VyZmFjZSA9IG5ldyBDYW52YXMoImZsb3QtYmFzZSIsIHBsYWNlaG9sZGVyKTsKICAgICAgb3ZlcmxheSA9IG5ldyBDYW52YXMoImZsb3Qtb3ZlcmxheSIsIHBsYWNlaG9sZGVyKTsgLy8gb3ZlcmxheSBjYW52YXMgZm9yIGludGVyYWN0aXZlIGZlYXR1cmVzCgogICAgICBjdHggPSBzdXJmYWNlLmNvbnRleHQ7CiAgICAgIG9jdHggPSBvdmVybGF5LmNvbnRleHQ7IC8vIGRlZmluZSB3aGljaCBlbGVtZW50IHdlJ3JlIGxpc3RlbmluZyBmb3IgZXZlbnRzIG9uCgogICAgICBldmVudEhvbGRlciA9ICQob3ZlcmxheS5lbGVtZW50KS51bmJpbmQoKTsgLy8gSWYgd2UncmUgcmUtdXNpbmcgYSBwbG90IG9iamVjdCwgc2h1dCBkb3duIHRoZSBvbGQgb25lCgogICAgICB2YXIgZXhpc3RpbmcgPSBwbGFjZWhvbGRlci5kYXRhKCJwbG90Iik7CgogICAgICBpZiAoZXhpc3RpbmcpIHsKICAgICAgICBleGlzdGluZy5zaHV0ZG93bigpOwogICAgICAgIG92ZXJsYXkuY2xlYXIoKTsKICAgICAgfSAvLyBzYXZlIGluIGNhc2Ugd2UgZ2V0IHJlcGxvdHRlZAoKCiAgICAgIHBsYWNlaG9sZGVyLmRhdGEoInBsb3QiLCBwbG90KTsKICAgIH0KCiAgICBmdW5jdGlvbiBiaW5kRXZlbnRzKCkgewogICAgICAvLyBiaW5kIGV2ZW50cwogICAgICBpZiAob3B0aW9ucy5ncmlkLmhvdmVyYWJsZSkgewogICAgICAgIGV2ZW50SG9sZGVyLm1vdXNlbW92ZShvbk1vdXNlTW92ZSk7IC8vIFVzZSBiaW5kLCByYXRoZXIgdGhhbiAubW91c2VsZWF2ZSwgYmVjYXVzZSB3ZSBvZmZpY2lhbGx5CiAgICAgICAgLy8gc3RpbGwgc3VwcG9ydCBqUXVlcnkgMS4yLjYsIHdoaWNoIGRvZXNuJ3QgZGVmaW5lIGEgc2hvcnRjdXQKICAgICAgICAvLyBmb3IgbW91c2VlbnRlciBvciBtb3VzZWxlYXZlLiAgVGhpcyB3YXMgYSBidWcvb3ZlcnNpZ2h0IHRoYXQKICAgICAgICAvLyB3YXMgZml4ZWQgc29tZXdoZXJlIGFyb3VuZCAxLjMueC4gIFdlIGNhbiByZXR1cm4gdG8gdXNpbmcKICAgICAgICAvLyAubW91c2VsZWF2ZSB3aGVuIHdlIGRyb3Agc3VwcG9ydCBmb3IgMS4yLjYuCgogICAgICAgIGV2ZW50SG9sZGVyLmJpbmQoIm1vdXNlbGVhdmUiLCBvbk1vdXNlTGVhdmUpOwogICAgICB9CgogICAgICBpZiAob3B0aW9ucy5ncmlkLmNsaWNrYWJsZSkgZXZlbnRIb2xkZXIuY2xpY2sob25DbGljayk7CiAgICAgIGV4ZWN1dGVIb29rcyhob29rcy5iaW5kRXZlbnRzLCBbZXZlbnRIb2xkZXJdKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzaHV0ZG93bigpIHsKICAgICAgaWYgKHJlZHJhd1RpbWVvdXQpIGNsZWFyVGltZW91dChyZWRyYXdUaW1lb3V0KTsKICAgICAgZXZlbnRIb2xkZXIudW5iaW5kKCJtb3VzZW1vdmUiLCBvbk1vdXNlTW92ZSk7CiAgICAgIGV2ZW50SG9sZGVyLnVuYmluZCgibW91c2VsZWF2ZSIsIG9uTW91c2VMZWF2ZSk7CiAgICAgIGV2ZW50SG9sZGVyLnVuYmluZCgiY2xpY2siLCBvbkNsaWNrKTsKICAgICAgZXhlY3V0ZUhvb2tzKGhvb2tzLnNodXRkb3duLCBbZXZlbnRIb2xkZXJdKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXRUcmFuc2Zvcm1hdGlvbkhlbHBlcnMoYXhpcykgewogICAgICAvLyBzZXQgaGVscGVyIGZ1bmN0aW9ucyBvbiB0aGUgYXhpcywgYXNzdW1lcyBwbG90IGFyZWEKICAgICAgLy8gaGFzIGJlZW4gY29tcHV0ZWQgYWxyZWFkeQogICAgICBmdW5jdGlvbiBpZGVudGl0eSh4KSB7CiAgICAgICAgcmV0dXJuIHg7CiAgICAgIH0KCiAgICAgIHZhciBzLAogICAgICAgICAgbSwKICAgICAgICAgIHQgPSBheGlzLm9wdGlvbnMudHJhbnNmb3JtIHx8IGlkZW50aXR5LAogICAgICAgICAgaXQgPSBheGlzLm9wdGlvbnMuaW52ZXJzZVRyYW5zZm9ybTsgLy8gcHJlY29tcHV0ZSBob3cgbXVjaCB0aGUgYXhpcyBpcyBzY2FsaW5nIGEgcG9pbnQKICAgICAgLy8gaW4gY2FudmFzIHNwYWNlCgogICAgICBpZiAoYXhpcy5kaXJlY3Rpb24gPT0gIngiKSB7CiAgICAgICAgcyA9IGF4aXMuc2NhbGUgPSBwbG90V2lkdGggLyBNYXRoLmFicyh0KGF4aXMubWF4KSAtIHQoYXhpcy5taW4pKTsKICAgICAgICBtID0gTWF0aC5taW4odChheGlzLm1heCksIHQoYXhpcy5taW4pKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzID0gYXhpcy5zY2FsZSA9IHBsb3RIZWlnaHQgLyBNYXRoLmFicyh0KGF4aXMubWF4KSAtIHQoYXhpcy5taW4pKTsKICAgICAgICBzID0gLXM7CiAgICAgICAgbSA9IE1hdGgubWF4KHQoYXhpcy5tYXgpLCB0KGF4aXMubWluKSk7CiAgICAgIH0gLy8gZGF0YSBwb2ludCB0byBjYW52YXMgY29vcmRpbmF0ZQoKCiAgICAgIGlmICh0ID09IGlkZW50aXR5KSAvLyBzbGlnaHQgb3B0aW1pemF0aW9uCiAgICAgICAgYXhpcy5wMmMgPSBmdW5jdGlvbiAocCkgewogICAgICAgICAgcmV0dXJuIChwIC0gbSkgKiBzOwogICAgICAgIH07ZWxzZSBheGlzLnAyYyA9IGZ1bmN0aW9uIChwKSB7CiAgICAgICAgcmV0dXJuICh0KHApIC0gbSkgKiBzOwogICAgICB9OyAvLyBjYW52YXMgY29vcmRpbmF0ZSB0byBkYXRhIHBvaW50CgogICAgICBpZiAoIWl0KSBheGlzLmMycCA9IGZ1bmN0aW9uIChjKSB7CiAgICAgICAgcmV0dXJuIG0gKyBjIC8gczsKICAgICAgfTtlbHNlIGF4aXMuYzJwID0gZnVuY3Rpb24gKGMpIHsKICAgICAgICByZXR1cm4gaXQobSArIGMgLyBzKTsKICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiBtZWFzdXJlVGlja0xhYmVscyhheGlzKSB7CiAgICAgIHZhciBvcHRzID0gYXhpcy5vcHRpb25zLAogICAgICAgICAgdGlja3MgPSBheGlzLnRpY2tzIHx8IFtdLAogICAgICAgICAgbGFiZWxXaWR0aCA9IG9wdHMubGFiZWxXaWR0aCB8fCAwLAogICAgICAgICAgbGFiZWxIZWlnaHQgPSBvcHRzLmxhYmVsSGVpZ2h0IHx8IDAsCiAgICAgICAgICBtYXhXaWR0aCA9IGxhYmVsV2lkdGggfHwgKGF4aXMuZGlyZWN0aW9uID09ICJ4IiA/IE1hdGguZmxvb3Ioc3VyZmFjZS53aWR0aCAvICh0aWNrcy5sZW5ndGggfHwgMSkpIDogbnVsbCksCiAgICAgICAgICBsZWdhY3lTdHlsZXMgPSBheGlzLmRpcmVjdGlvbiArICJBeGlzICIgKyBheGlzLmRpcmVjdGlvbiArIGF4aXMubiArICJBeGlzIiwKICAgICAgICAgIGxheWVyID0gImZsb3QtIiArIGF4aXMuZGlyZWN0aW9uICsgIi1heGlzIGZsb3QtIiArIGF4aXMuZGlyZWN0aW9uICsgYXhpcy5uICsgIi1heGlzICIgKyBsZWdhY3lTdHlsZXMsCiAgICAgICAgICBmb250ID0gb3B0cy5mb250IHx8ICJmbG90LXRpY2stbGFiZWwgdGlja0xhYmVsIjsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGlja3MubGVuZ3RoOyArK2kpIHsKICAgICAgICB2YXIgdCA9IHRpY2tzW2ldOwogICAgICAgIGlmICghdC5sYWJlbCkgY29udGludWU7CiAgICAgICAgdmFyIGluZm8gPSBzdXJmYWNlLmdldFRleHRJbmZvKGxheWVyLCB0LmxhYmVsLCBmb250LCBudWxsLCBtYXhXaWR0aCk7CiAgICAgICAgbGFiZWxXaWR0aCA9IE1hdGgubWF4KGxhYmVsV2lkdGgsIGluZm8ud2lkdGgpOwogICAgICAgIGxhYmVsSGVpZ2h0ID0gTWF0aC5tYXgobGFiZWxIZWlnaHQsIGluZm8uaGVpZ2h0KTsKICAgICAgfQoKICAgICAgYXhpcy5sYWJlbFdpZHRoID0gb3B0cy5sYWJlbFdpZHRoIHx8IGxhYmVsV2lkdGg7CiAgICAgIGF4aXMubGFiZWxIZWlnaHQgPSBvcHRzLmxhYmVsSGVpZ2h0IHx8IGxhYmVsSGVpZ2h0OwogICAgfQoKICAgIGZ1bmN0aW9uIGFsbG9jYXRlQXhpc0JveEZpcnN0UGhhc2UoYXhpcykgewogICAgICAvLyBmaW5kIHRoZSBib3VuZGluZyBib3ggb2YgdGhlIGF4aXMgYnkgbG9va2luZyBhdCBsYWJlbAogICAgICAvLyB3aWR0aHMvaGVpZ2h0cyBhbmQgdGlja3MsIG1ha2Ugcm9vbSBieSBkaW1pbmlzaGluZyB0aGUKICAgICAgLy8gcGxvdE9mZnNldDsgdGhpcyBmaXJzdCBwaGFzZSBvbmx5IGxvb2tzIGF0IG9uZQogICAgICAvLyBkaW1lbnNpb24gcGVyIGF4aXMsIHRoZSBvdGhlciBkaW1lbnNpb24gZGVwZW5kcyBvbiB0aGUKICAgICAgLy8gb3RoZXIgYXhlcyBzbyB3aWxsIGhhdmUgdG8gd2FpdAogICAgICB2YXIgbHcgPSBheGlzLmxhYmVsV2lkdGgsCiAgICAgICAgICBsaCA9IGF4aXMubGFiZWxIZWlnaHQsCiAgICAgICAgICBwb3MgPSBheGlzLm9wdGlvbnMucG9zaXRpb24sCiAgICAgICAgICBpc1hBeGlzID0gYXhpcy5kaXJlY3Rpb24gPT09ICJ4IiwKICAgICAgICAgIHRpY2tMZW5ndGggPSBheGlzLm9wdGlvbnMudGlja0xlbmd0aCwKICAgICAgICAgIGF4aXNNYXJnaW4gPSBvcHRpb25zLmdyaWQuYXhpc01hcmdpbiwKICAgICAgICAgIHBhZGRpbmcgPSBvcHRpb25zLmdyaWQubGFiZWxNYXJnaW4sCiAgICAgICAgICBpbm5lcm1vc3QgPSB0cnVlLAogICAgICAgICAgb3V0ZXJtb3N0ID0gdHJ1ZSwKICAgICAgICAgIGZpcnN0ID0gdHJ1ZSwKICAgICAgICAgIGZvdW5kID0gZmFsc2U7IC8vIERldGVybWluZSB0aGUgYXhpcydzIHBvc2l0aW9uIGluIGl0cyBkaXJlY3Rpb24gYW5kIG9uIGl0cyBzaWRlCgogICAgICAkLmVhY2goaXNYQXhpcyA/IHhheGVzIDogeWF4ZXMsIGZ1bmN0aW9uIChpLCBhKSB7CiAgICAgICAgaWYgKGEgJiYgKGEuc2hvdyB8fCBhLnJlc2VydmVTcGFjZSkpIHsKICAgICAgICAgIGlmIChhID09PSBheGlzKSB7CiAgICAgICAgICAgIGZvdW5kID0gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSBpZiAoYS5vcHRpb25zLnBvc2l0aW9uID09PSBwb3MpIHsKICAgICAgICAgICAgaWYgKGZvdW5kKSB7CiAgICAgICAgICAgICAgb3V0ZXJtb3N0ID0gZmFsc2U7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaW5uZXJtb3N0ID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoIWZvdW5kKSB7CiAgICAgICAgICAgIGZpcnN0ID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsgLy8gVGhlIG91dGVybW9zdCBheGlzIG9uIGVhY2ggc2lkZSBoYXMgbm8gbWFyZ2luCgogICAgICBpZiAob3V0ZXJtb3N0KSB7CiAgICAgICAgYXhpc01hcmdpbiA9IDA7CiAgICAgIH0gLy8gVGhlIHRpY2tzIGZvciB0aGUgZmlyc3QgYXhpcyBpbiBlYWNoIGRpcmVjdGlvbiBzdHJldGNoIGFjcm9zcwoKCiAgICAgIGlmICh0aWNrTGVuZ3RoID09IG51bGwpIHsKICAgICAgICB0aWNrTGVuZ3RoID0gZmlyc3QgPyAiZnVsbCIgOiA1OwogICAgICB9CgogICAgICBpZiAoIWlzTmFOKCt0aWNrTGVuZ3RoKSkgcGFkZGluZyArPSArdGlja0xlbmd0aDsKCiAgICAgIGlmIChpc1hBeGlzKSB7CiAgICAgICAgbGggKz0gcGFkZGluZzsKCiAgICAgICAgaWYgKHBvcyA9PSAiYm90dG9tIikgewogICAgICAgICAgcGxvdE9mZnNldC5ib3R0b20gKz0gbGggKyBheGlzTWFyZ2luOwogICAgICAgICAgYXhpcy5ib3ggPSB7CiAgICAgICAgICAgIHRvcDogc3VyZmFjZS5oZWlnaHQgLSBwbG90T2Zmc2V0LmJvdHRvbSwKICAgICAgICAgICAgaGVpZ2h0OiBsaAogICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYXhpcy5ib3ggPSB7CiAgICAgICAgICAgIHRvcDogcGxvdE9mZnNldC50b3AgKyBheGlzTWFyZ2luLAogICAgICAgICAgICBoZWlnaHQ6IGxoCiAgICAgICAgICB9OwogICAgICAgICAgcGxvdE9mZnNldC50b3AgKz0gbGggKyBheGlzTWFyZ2luOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBsdyArPSBwYWRkaW5nOwoKICAgICAgICBpZiAocG9zID09ICJsZWZ0IikgewogICAgICAgICAgYXhpcy5ib3ggPSB7CiAgICAgICAgICAgIGxlZnQ6IHBsb3RPZmZzZXQubGVmdCArIGF4aXNNYXJnaW4sCiAgICAgICAgICAgIHdpZHRoOiBsdwogICAgICAgICAgfTsKICAgICAgICAgIHBsb3RPZmZzZXQubGVmdCArPSBsdyArIGF4aXNNYXJnaW47CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHBsb3RPZmZzZXQucmlnaHQgKz0gbHcgKyBheGlzTWFyZ2luOwogICAgICAgICAgYXhpcy5ib3ggPSB7CiAgICAgICAgICAgIGxlZnQ6IHN1cmZhY2Uud2lkdGggLSBwbG90T2Zmc2V0LnJpZ2h0LAogICAgICAgICAgICB3aWR0aDogbHcKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9IC8vIHNhdmUgZm9yIGZ1dHVyZSByZWZlcmVuY2UKCgogICAgICBheGlzLnBvc2l0aW9uID0gcG9zOwogICAgICBheGlzLnRpY2tMZW5ndGggPSB0aWNrTGVuZ3RoOwogICAgICBheGlzLmJveC5wYWRkaW5nID0gcGFkZGluZzsKICAgICAgYXhpcy5pbm5lcm1vc3QgPSBpbm5lcm1vc3Q7CiAgICB9CgogICAgZnVuY3Rpb24gYWxsb2NhdGVBeGlzQm94U2Vjb25kUGhhc2UoYXhpcykgewogICAgICAvLyBub3cgdGhhdCBhbGwgYXhpcyBib3hlcyBoYXZlIGJlZW4gcGxhY2VkIGluIG9uZQogICAgICAvLyBkaW1lbnNpb24sIHdlIGNhbiBzZXQgdGhlIHJlbWFpbmluZyBkaW1lbnNpb24gY29vcmRpbmF0ZXMKICAgICAgaWYgKGF4aXMuZGlyZWN0aW9uID09ICJ4IikgewogICAgICAgIGF4aXMuYm94LmxlZnQgPSBwbG90T2Zmc2V0LmxlZnQgLSBheGlzLmxhYmVsV2lkdGggLyAyOwogICAgICAgIGF4aXMuYm94LndpZHRoID0gc3VyZmFjZS53aWR0aCAtIHBsb3RPZmZzZXQubGVmdCAtIHBsb3RPZmZzZXQucmlnaHQgKyBheGlzLmxhYmVsV2lkdGg7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYXhpcy5ib3gudG9wID0gcGxvdE9mZnNldC50b3AgLSBheGlzLmxhYmVsSGVpZ2h0IC8gMjsKICAgICAgICBheGlzLmJveC5oZWlnaHQgPSBzdXJmYWNlLmhlaWdodCAtIHBsb3RPZmZzZXQuYm90dG9tIC0gcGxvdE9mZnNldC50b3AgKyBheGlzLmxhYmVsSGVpZ2h0OwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gYWRqdXN0TGF5b3V0Rm9yVGhpbmdzU3RpY2tpbmdPdXQoKSB7CiAgICAgIC8vIHBvc3NpYmx5IGFkanVzdCBwbG90IG9mZnNldCB0byBlbnN1cmUgZXZlcnl0aGluZyBzdGF5cwogICAgICAvLyBpbnNpZGUgdGhlIGNhbnZhcyBhbmQgaXNuJ3QgY2xpcHBlZCBvZmYKICAgICAgdmFyIG1pbk1hcmdpbiA9IG9wdGlvbnMuZ3JpZC5taW5Cb3JkZXJNYXJnaW4sCiAgICAgICAgICBheGlzLAogICAgICAgICAgaTsgLy8gY2hlY2sgc3R1ZmYgZnJvbSB0aGUgcGxvdCAoRklYTUU6IHRoaXMgc2hvdWxkIGp1c3QgcmVhZAogICAgICAvLyBhIHZhbHVlIGZyb20gdGhlIHNlcmllcywgb3RoZXJ3aXNlIGl0J3MgaW1wb3NzaWJsZSB0bwogICAgICAvLyBjdXN0b21pemUpCgogICAgICBpZiAobWluTWFyZ2luID09IG51bGwpIHsKICAgICAgICBtaW5NYXJnaW4gPSAwOwoKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc2VyaWVzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICBtaW5NYXJnaW4gPSBNYXRoLm1heChtaW5NYXJnaW4sIDIgKiAoc2VyaWVzW2ldLnBvaW50cy5yYWRpdXMgKyBzZXJpZXNbaV0ucG9pbnRzLmxpbmVXaWR0aCAvIDIpKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHZhciBtYXJnaW5zID0gewogICAgICAgIGxlZnQ6IG1pbk1hcmdpbiwKICAgICAgICByaWdodDogbWluTWFyZ2luLAogICAgICAgIHRvcDogbWluTWFyZ2luLAogICAgICAgIGJvdHRvbTogbWluTWFyZ2luCiAgICAgIH07IC8vIGNoZWNrIGF4aXMgbGFiZWxzLCBub3RlIHdlIGRvbid0IGNoZWNrIHRoZSBhY3R1YWwKICAgICAgLy8gbGFiZWxzIGJ1dCBpbnN0ZWFkIHVzZSB0aGUgb3ZlcmFsbCB3aWR0aC9oZWlnaHQgdG8gbm90CiAgICAgIC8vIGp1bXAgYXMgbXVjaCBhcm91bmQgd2l0aCByZXBsb3RzCgogICAgICAkLmVhY2goYWxsQXhlcygpLCBmdW5jdGlvbiAoXywgYXhpcykgewogICAgICAgIGlmIChheGlzLnJlc2VydmVTcGFjZSAmJiBheGlzLnRpY2tzICYmIGF4aXMudGlja3MubGVuZ3RoKSB7CiAgICAgICAgICBpZiAoYXhpcy5kaXJlY3Rpb24gPT09ICJ4IikgewogICAgICAgICAgICBtYXJnaW5zLmxlZnQgPSBNYXRoLm1heChtYXJnaW5zLmxlZnQsIGF4aXMubGFiZWxXaWR0aCAvIDIpOwogICAgICAgICAgICBtYXJnaW5zLnJpZ2h0ID0gTWF0aC5tYXgobWFyZ2lucy5yaWdodCwgYXhpcy5sYWJlbFdpZHRoIC8gMik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBtYXJnaW5zLmJvdHRvbSA9IE1hdGgubWF4KG1hcmdpbnMuYm90dG9tLCBheGlzLmxhYmVsSGVpZ2h0IC8gMik7CiAgICAgICAgICAgIG1hcmdpbnMudG9wID0gTWF0aC5tYXgobWFyZ2lucy50b3AsIGF4aXMubGFiZWxIZWlnaHQgLyAyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBwbG90T2Zmc2V0LmxlZnQgPSBNYXRoLmNlaWwoTWF0aC5tYXgobWFyZ2lucy5sZWZ0LCBwbG90T2Zmc2V0LmxlZnQpKTsKICAgICAgcGxvdE9mZnNldC5yaWdodCA9IE1hdGguY2VpbChNYXRoLm1heChtYXJnaW5zLnJpZ2h0LCBwbG90T2Zmc2V0LnJpZ2h0KSk7CiAgICAgIHBsb3RPZmZzZXQudG9wID0gTWF0aC5jZWlsKE1hdGgubWF4KG1hcmdpbnMudG9wLCBwbG90T2Zmc2V0LnRvcCkpOwogICAgICBwbG90T2Zmc2V0LmJvdHRvbSA9IE1hdGguY2VpbChNYXRoLm1heChtYXJnaW5zLmJvdHRvbSwgcGxvdE9mZnNldC5ib3R0b20pKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXR1cEdyaWQoKSB7CiAgICAgIHZhciBpLAogICAgICAgICAgYXhlcyA9IGFsbEF4ZXMoKSwKICAgICAgICAgIHNob3dHcmlkID0gb3B0aW9ucy5ncmlkLnNob3c7IC8vIEluaXRpYWxpemUgdGhlIHBsb3QncyBvZmZzZXQgZnJvbSB0aGUgZWRnZSBvZiB0aGUgY2FudmFzCgogICAgICBmb3IgKHZhciBhIGluIHBsb3RPZmZzZXQpIHsKICAgICAgICB2YXIgbWFyZ2luID0gb3B0aW9ucy5ncmlkLm1hcmdpbiB8fCAwOwogICAgICAgIHBsb3RPZmZzZXRbYV0gPSB0eXBlb2YgbWFyZ2luID09ICJudW1iZXIiID8gbWFyZ2luIDogbWFyZ2luW2FdIHx8IDA7CiAgICAgIH0KCiAgICAgIGV4ZWN1dGVIb29rcyhob29rcy5wcm9jZXNzT2Zmc2V0LCBbcGxvdE9mZnNldF0pOyAvLyBJZiB0aGUgZ3JpZCBpcyB2aXNpYmxlLCBhZGQgaXRzIGJvcmRlciB3aWR0aCB0byB0aGUgb2Zmc2V0CgogICAgICBmb3IgKHZhciBhIGluIHBsb3RPZmZzZXQpIHsKICAgICAgICBpZiAoX3R5cGVvZihvcHRpb25zLmdyaWQuYm9yZGVyV2lkdGgpID09ICJvYmplY3QiKSB7CiAgICAgICAgICBwbG90T2Zmc2V0W2FdICs9IHNob3dHcmlkID8gb3B0aW9ucy5ncmlkLmJvcmRlcldpZHRoW2FdIDogMDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcGxvdE9mZnNldFthXSArPSBzaG93R3JpZCA/IG9wdGlvbnMuZ3JpZC5ib3JkZXJXaWR0aCA6IDA7CiAgICAgICAgfQogICAgICB9CgogICAgICAkLmVhY2goYXhlcywgZnVuY3Rpb24gKF8sIGF4aXMpIHsKICAgICAgICB2YXIgYXhpc09wdHMgPSBheGlzLm9wdGlvbnM7CiAgICAgICAgYXhpcy5zaG93ID0gYXhpc09wdHMuc2hvdyA9PSBudWxsID8gYXhpcy51c2VkIDogYXhpc09wdHMuc2hvdzsKICAgICAgICBheGlzLnJlc2VydmVTcGFjZSA9IGF4aXNPcHRzLnJlc2VydmVTcGFjZSA9PSBudWxsID8gYXhpcy5zaG93IDogYXhpc09wdHMucmVzZXJ2ZVNwYWNlOwogICAgICAgIHNldFJhbmdlKGF4aXMpOwogICAgICB9KTsKCiAgICAgIGlmIChzaG93R3JpZCkgewogICAgICAgIHZhciBhbGxvY2F0ZWRBeGVzID0gJC5ncmVwKGF4ZXMsIGZ1bmN0aW9uIChheGlzKSB7CiAgICAgICAgICByZXR1cm4gYXhpcy5zaG93IHx8IGF4aXMucmVzZXJ2ZVNwYWNlOwogICAgICAgIH0pOwogICAgICAgICQuZWFjaChhbGxvY2F0ZWRBeGVzLCBmdW5jdGlvbiAoXywgYXhpcykgewogICAgICAgICAgLy8gbWFrZSB0aGUgdGlja3MKICAgICAgICAgIHNldHVwVGlja0dlbmVyYXRpb24oYXhpcyk7CiAgICAgICAgICBzZXRUaWNrcyhheGlzKTsKICAgICAgICAgIHNuYXBSYW5nZVRvVGlja3MoYXhpcywgYXhpcy50aWNrcyk7IC8vIGZpbmQgbGFiZWxXaWR0aC9IZWlnaHQgZm9yIGF4aXMKCiAgICAgICAgICBtZWFzdXJlVGlja0xhYmVscyhheGlzKTsKICAgICAgICB9KTsgLy8gd2l0aCBhbGwgZGltZW5zaW9ucyBjYWxjdWxhdGVkLCB3ZSBjYW4gY29tcHV0ZSB0aGUKICAgICAgICAvLyBheGlzIGJvdW5kaW5nIGJveGVzLCBzdGFydCBmcm9tIHRoZSBvdXRzaWRlCiAgICAgICAgLy8gKHJldmVyc2Ugb3JkZXIpCgogICAgICAgIGZvciAoaSA9IGFsbG9jYXRlZEF4ZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpIHsKICAgICAgICAgIGFsbG9jYXRlQXhpc0JveEZpcnN0UGhhc2UoYWxsb2NhdGVkQXhlc1tpXSk7CiAgICAgICAgfSAvLyBtYWtlIHN1cmUgd2UndmUgZ290IGVub3VnaCBzcGFjZSBmb3IgdGhpbmdzIHRoYXQKICAgICAgICAvLyBtaWdodCBzdGljayBvdXQKCgogICAgICAgIGFkanVzdExheW91dEZvclRoaW5nc1N0aWNraW5nT3V0KCk7CiAgICAgICAgJC5lYWNoKGFsbG9jYXRlZEF4ZXMsIGZ1bmN0aW9uIChfLCBheGlzKSB7CiAgICAgICAgICBhbGxvY2F0ZUF4aXNCb3hTZWNvbmRQaGFzZShheGlzKTsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgcGxvdFdpZHRoID0gc3VyZmFjZS53aWR0aCAtIHBsb3RPZmZzZXQubGVmdCAtIHBsb3RPZmZzZXQucmlnaHQ7CiAgICAgIHBsb3RIZWlnaHQgPSBzdXJmYWNlLmhlaWdodCAtIHBsb3RPZmZzZXQuYm90dG9tIC0gcGxvdE9mZnNldC50b3A7IC8vIG5vdyB3ZSBnb3QgdGhlIHByb3BlciBwbG90IGRpbWVuc2lvbnMsIHdlIGNhbiBjb21wdXRlIHRoZSBzY2FsaW5nCgogICAgICAkLmVhY2goYXhlcywgZnVuY3Rpb24gKF8sIGF4aXMpIHsKICAgICAgICBzZXRUcmFuc2Zvcm1hdGlvbkhlbHBlcnMoYXhpcyk7CiAgICAgIH0pOwoKICAgICAgaWYgKHNob3dHcmlkKSB7CiAgICAgICAgZHJhd0F4aXNMYWJlbHMoKTsKICAgICAgfQoKICAgICAgaW5zZXJ0TGVnZW5kKCk7CiAgICB9CgogICAgZnVuY3Rpb24gc2V0UmFuZ2UoYXhpcykgewogICAgICB2YXIgb3B0cyA9IGF4aXMub3B0aW9ucywKICAgICAgICAgIG1pbiA9ICsob3B0cy5taW4gIT0gbnVsbCA/IG9wdHMubWluIDogYXhpcy5kYXRhbWluKSwKICAgICAgICAgIG1heCA9ICsob3B0cy5tYXggIT0gbnVsbCA/IG9wdHMubWF4IDogYXhpcy5kYXRhbWF4KSwKICAgICAgICAgIGRlbHRhID0gbWF4IC0gbWluOwoKICAgICAgaWYgKGRlbHRhID09IDAuMCkgewogICAgICAgIC8vIGRlZ2VuZXJhdGUgY2FzZQogICAgICAgIHZhciB3aWRlbiA9IG1heCA9PSAwID8gMSA6IDAuMDE7CiAgICAgICAgaWYgKG9wdHMubWluID09IG51bGwpIG1pbiAtPSB3aWRlbjsgLy8gYWx3YXlzIHdpZGVuIG1heCBpZiB3ZSBjb3VsZG4ndCB3aWRlbiBtaW4gdG8gZW5zdXJlIHdlCiAgICAgICAgLy8gZG9uJ3QgZmFsbCBpbnRvIG1pbiA9PSBtYXggd2hpY2ggZG9lc24ndCB3b3JrCgogICAgICAgIGlmIChvcHRzLm1heCA9PSBudWxsIHx8IG9wdHMubWluICE9IG51bGwpIG1heCArPSB3aWRlbjsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBjb25zaWRlciBhdXRvc2NhbGluZwogICAgICAgIHZhciBtYXJnaW4gPSBvcHRzLmF1dG9zY2FsZU1hcmdpbjsKCiAgICAgICAgaWYgKG1hcmdpbiAhPSBudWxsKSB7CiAgICAgICAgICBpZiAob3B0cy5taW4gPT0gbnVsbCkgewogICAgICAgICAgICBtaW4gLT0gZGVsdGEgKiBtYXJnaW47IC8vIG1ha2Ugc3VyZSB3ZSBkb24ndCBnbyBiZWxvdyB6ZXJvIGlmIGFsbCB2YWx1ZXMKICAgICAgICAgICAgLy8gYXJlIHBvc2l0aXZlCgogICAgICAgICAgICBpZiAobWluIDwgMCAmJiBheGlzLmRhdGFtaW4gIT0gbnVsbCAmJiBheGlzLmRhdGFtaW4gPj0gMCkgbWluID0gMDsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAob3B0cy5tYXggPT0gbnVsbCkgewogICAgICAgICAgICBtYXggKz0gZGVsdGEgKiBtYXJnaW47CiAgICAgICAgICAgIGlmIChtYXggPiAwICYmIGF4aXMuZGF0YW1heCAhPSBudWxsICYmIGF4aXMuZGF0YW1heCA8PSAwKSBtYXggPSAwOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgYXhpcy5taW4gPSBtaW47CiAgICAgIGF4aXMubWF4ID0gbWF4OwogICAgfQoKICAgIGZ1bmN0aW9uIHNldHVwVGlja0dlbmVyYXRpb24oYXhpcykgewogICAgICB2YXIgb3B0cyA9IGF4aXMub3B0aW9uczsgLy8gZXN0aW1hdGUgbnVtYmVyIG9mIHRpY2tzCgogICAgICB2YXIgbm9UaWNrczsKICAgICAgaWYgKHR5cGVvZiBvcHRzLnRpY2tzID09ICJudW1iZXIiICYmIG9wdHMudGlja3MgPiAwKSBub1RpY2tzID0gb3B0cy50aWNrcztlbHNlIC8vIGhldXJpc3RpYyBiYXNlZCBvbiB0aGUgbW9kZWwgYSpzcXJ0KHgpIGZpdHRlZCB0bwogICAgICAgIC8vIHNvbWUgZGF0YSBwb2ludHMgdGhhdCBzZWVtZWQgcmVhc29uYWJsZQogICAgICAgIG5vVGlja3MgPSAwLjMgKiBNYXRoLnNxcnQoYXhpcy5kaXJlY3Rpb24gPT0gIngiID8gc3VyZmFjZS53aWR0aCA6IHN1cmZhY2UuaGVpZ2h0KTsKICAgICAgdmFyIGRlbHRhID0gKGF4aXMubWF4IC0gYXhpcy5taW4pIC8gbm9UaWNrcywKICAgICAgICAgIGRlYyA9IC1NYXRoLmZsb29yKE1hdGgubG9nKGRlbHRhKSAvIE1hdGguTE4xMCksCiAgICAgICAgICBtYXhEZWMgPSBvcHRzLnRpY2tEZWNpbWFsczsKCiAgICAgIGlmIChtYXhEZWMgIT0gbnVsbCAmJiBkZWMgPiBtYXhEZWMpIHsKICAgICAgICBkZWMgPSBtYXhEZWM7CiAgICAgIH0KCiAgICAgIHZhciBtYWduID0gTWF0aC5wb3coMTAsIC1kZWMpLAogICAgICAgICAgbm9ybSA9IGRlbHRhIC8gbWFnbiwKICAgICAgICAgIC8vIG5vcm0gaXMgYmV0d2VlbiAxLjAgYW5kIDEwLjAKICAgICAgc2l6ZTsKCiAgICAgIGlmIChub3JtIDwgMS41KSB7CiAgICAgICAgc2l6ZSA9IDE7CiAgICAgIH0gZWxzZSBpZiAobm9ybSA8IDMpIHsKICAgICAgICBzaXplID0gMjsgLy8gc3BlY2lhbCBjYXNlIGZvciAyLjUsIHJlcXVpcmVzIGFuIGV4dHJhIGRlY2ltYWwKCiAgICAgICAgaWYgKG5vcm0gPiAyLjI1ICYmIChtYXhEZWMgPT0gbnVsbCB8fCBkZWMgKyAxIDw9IG1heERlYykpIHsKICAgICAgICAgIHNpemUgPSAyLjU7CiAgICAgICAgICArK2RlYzsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAobm9ybSA8IDcuNSkgewogICAgICAgIHNpemUgPSA1OwogICAgICB9IGVsc2UgewogICAgICAgIHNpemUgPSAxMDsKICAgICAgfQoKICAgICAgc2l6ZSAqPSBtYWduOwoKICAgICAgaWYgKG9wdHMubWluVGlja1NpemUgIT0gbnVsbCAmJiBzaXplIDwgb3B0cy5taW5UaWNrU2l6ZSkgewogICAgICAgIHNpemUgPSBvcHRzLm1pblRpY2tTaXplOwogICAgICB9CgogICAgICBheGlzLmRlbHRhID0gZGVsdGE7CiAgICAgIGF4aXMudGlja0RlY2ltYWxzID0gTWF0aC5tYXgoMCwgbWF4RGVjICE9IG51bGwgPyBtYXhEZWMgOiBkZWMpOwogICAgICBheGlzLnRpY2tTaXplID0gb3B0cy50aWNrU2l6ZSB8fCBzaXplOyAvLyBUaW1lIG1vZGUgd2FzIG1vdmVkIHRvIGEgcGx1Zy1pbiBpbiAwLjgsIGFuZCBzaW5jZSBzbyBtYW55IHBlb3BsZSB1c2UgaXQKICAgICAgLy8gd2UnbGwgYWRkIGFuIGVzcGVjaWFsbHkgZnJpZW5kbHkgcmVtaW5kZXIgdG8gbWFrZSBzdXJlIHRoZXkgaW5jbHVkZWQgaXQuCgogICAgICBpZiAob3B0cy5tb2RlID09ICJ0aW1lIiAmJiAhYXhpcy50aWNrR2VuZXJhdG9yKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaW1lIG1vZGUgcmVxdWlyZXMgdGhlIGZsb3QudGltZSBwbHVnaW4uIik7CiAgICAgIH0gLy8gRmxvdCBzdXBwb3J0cyBiYXNlLTEwIGF4ZXM7IGFueSBvdGhlciBtb2RlIGVsc2UgaXMgaGFuZGxlZCBieSBhIHBsdWctaW4sCiAgICAgIC8vIGxpa2UgZmxvdC50aW1lLmpzLgoKCiAgICAgIGlmICghYXhpcy50aWNrR2VuZXJhdG9yKSB7CiAgICAgICAgYXhpcy50aWNrR2VuZXJhdG9yID0gZnVuY3Rpb24gKGF4aXMpIHsKICAgICAgICAgIHZhciB0aWNrcyA9IFtdLAogICAgICAgICAgICAgIHN0YXJ0ID0gZmxvb3JJbkJhc2UoYXhpcy5taW4sIGF4aXMudGlja1NpemUpLAogICAgICAgICAgICAgIGkgPSAwLAogICAgICAgICAgICAgIHYgPSBOdW1iZXIuTmFOLAogICAgICAgICAgICAgIHByZXY7CgogICAgICAgICAgZG8gewogICAgICAgICAgICBwcmV2ID0gdjsKICAgICAgICAgICAgdiA9IHN0YXJ0ICsgaSAqIGF4aXMudGlja1NpemU7CiAgICAgICAgICAgIHRpY2tzLnB1c2godik7CiAgICAgICAgICAgICsraTsKICAgICAgICAgIH0gd2hpbGUgKHYgPCBheGlzLm1heCAmJiB2ICE9IHByZXYpOwoKICAgICAgICAgIHJldHVybiB0aWNrczsKICAgICAgICB9OwoKICAgICAgICBheGlzLnRpY2tGb3JtYXR0ZXIgPSBmdW5jdGlvbiAodmFsdWUsIGF4aXMpIHsKICAgICAgICAgIHZhciBmYWN0b3IgPSBheGlzLnRpY2tEZWNpbWFscyA/IE1hdGgucG93KDEwLCBheGlzLnRpY2tEZWNpbWFscykgOiAxOwogICAgICAgICAgdmFyIGZvcm1hdHRlZCA9ICIiICsgTWF0aC5yb3VuZCh2YWx1ZSAqIGZhY3RvcikgLyBmYWN0b3I7IC8vIElmIHRpY2tEZWNpbWFscyB3YXMgc3BlY2lmaWVkLCBlbnN1cmUgdGhhdCB3ZSBoYXZlIGV4YWN0bHkgdGhhdAogICAgICAgICAgLy8gbXVjaCBwcmVjaXNpb247IG90aGVyd2lzZSBkZWZhdWx0IHRvIHRoZSB2YWx1ZSdzIG93biBwcmVjaXNpb24uCgogICAgICAgICAgaWYgKGF4aXMudGlja0RlY2ltYWxzICE9IG51bGwpIHsKICAgICAgICAgICAgdmFyIGRlY2ltYWwgPSBmb3JtYXR0ZWQuaW5kZXhPZigiLiIpOwogICAgICAgICAgICB2YXIgcHJlY2lzaW9uID0gZGVjaW1hbCA9PSAtMSA/IDAgOiBmb3JtYXR0ZWQubGVuZ3RoIC0gZGVjaW1hbCAtIDE7CgogICAgICAgICAgICBpZiAocHJlY2lzaW9uIDwgYXhpcy50aWNrRGVjaW1hbHMpIHsKICAgICAgICAgICAgICByZXR1cm4gKHByZWNpc2lvbiA/IGZvcm1hdHRlZCA6IGZvcm1hdHRlZCArICIuIikgKyAoIiIgKyBmYWN0b3IpLnN1YnN0cigxLCBheGlzLnRpY2tEZWNpbWFscyAtIHByZWNpc2lvbik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gZm9ybWF0dGVkOwogICAgICAgIH07CiAgICAgIH0KCiAgICAgIGlmICgkLmlzRnVuY3Rpb24ob3B0cy50aWNrRm9ybWF0dGVyKSkgYXhpcy50aWNrRm9ybWF0dGVyID0gZnVuY3Rpb24gKHYsIGF4aXMpIHsKICAgICAgICByZXR1cm4gIiIgKyBvcHRzLnRpY2tGb3JtYXR0ZXIodiwgYXhpcyk7CiAgICAgIH07CgogICAgICBpZiAob3B0cy5hbGlnblRpY2tzV2l0aEF4aXMgIT0gbnVsbCkgewogICAgICAgIHZhciBvdGhlckF4aXMgPSAoYXhpcy5kaXJlY3Rpb24gPT0gIngiID8geGF4ZXMgOiB5YXhlcylbb3B0cy5hbGlnblRpY2tzV2l0aEF4aXMgLSAxXTsKCiAgICAgICAgaWYgKG90aGVyQXhpcyAmJiBvdGhlckF4aXMudXNlZCAmJiBvdGhlckF4aXMgIT0gYXhpcykgewogICAgICAgICAgLy8gY29uc2lkZXIgc25hcHBpbmcgbWluL21heCB0byBvdXRlcm1vc3QgbmljZSB0aWNrcwogICAgICAgICAgdmFyIG5pY2VUaWNrcyA9IGF4aXMudGlja0dlbmVyYXRvcihheGlzKTsKCiAgICAgICAgICBpZiAobmljZVRpY2tzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgaWYgKG9wdHMubWluID09IG51bGwpIGF4aXMubWluID0gTWF0aC5taW4oYXhpcy5taW4sIG5pY2VUaWNrc1swXSk7CiAgICAgICAgICAgIGlmIChvcHRzLm1heCA9PSBudWxsICYmIG5pY2VUaWNrcy5sZW5ndGggPiAxKSBheGlzLm1heCA9IE1hdGgubWF4KGF4aXMubWF4LCBuaWNlVGlja3NbbmljZVRpY2tzLmxlbmd0aCAtIDFdKTsKICAgICAgICAgIH0KCiAgICAgICAgICBheGlzLnRpY2tHZW5lcmF0b3IgPSBmdW5jdGlvbiAoYXhpcykgewogICAgICAgICAgICAvLyBjb3B5IHRpY2tzLCBzY2FsZWQgdG8gdGhpcyBheGlzCiAgICAgICAgICAgIHZhciB0aWNrcyA9IFtdLAogICAgICAgICAgICAgICAgdiwKICAgICAgICAgICAgICAgIGk7CgogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgb3RoZXJBeGlzLnRpY2tzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgdiA9IChvdGhlckF4aXMudGlja3NbaV0udiAtIG90aGVyQXhpcy5taW4pIC8gKG90aGVyQXhpcy5tYXggLSBvdGhlckF4aXMubWluKTsKICAgICAgICAgICAgICB2ID0gYXhpcy5taW4gKyB2ICogKGF4aXMubWF4IC0gYXhpcy5taW4pOwogICAgICAgICAgICAgIHRpY2tzLnB1c2godik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0aWNrczsKICAgICAgICAgIH07IC8vIHdlIG1pZ2h0IG5lZWQgYW4gZXh0cmEgZGVjaW1hbCBzaW5jZSBmb3JjZWQKICAgICAgICAgIC8vIHRpY2tzIGRvbid0IG5lY2Vzc2FyaWx5IGZpdCBuYXR1cmFsbHkKCgogICAgICAgICAgaWYgKCFheGlzLm1vZGUgJiYgb3B0cy50aWNrRGVjaW1hbHMgPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZXh0cmFEZWMgPSBNYXRoLm1heCgwLCAtTWF0aC5mbG9vcihNYXRoLmxvZyhheGlzLmRlbHRhKSAvIE1hdGguTE4xMCkgKyAxKSwKICAgICAgICAgICAgICAgIHRzID0gYXhpcy50aWNrR2VuZXJhdG9yKGF4aXMpOyAvLyBvbmx5IHByb2NlZWQgaWYgdGhlIHRpY2sgaW50ZXJ2YWwgcm91bmRlZAogICAgICAgICAgICAvLyB3aXRoIGFuIGV4dHJhIGRlY2ltYWwgZG9lc24ndCBnaXZlIHVzIGEKICAgICAgICAgICAgLy8gemVybyBhdCBlbmQKCiAgICAgICAgICAgIGlmICghKHRzLmxlbmd0aCA+IDEgJiYgL1wuLiowJC8udGVzdCgodHNbMV0gLSB0c1swXSkudG9GaXhlZChleHRyYURlYykpKSkgYXhpcy50aWNrRGVjaW1hbHMgPSBleHRyYURlYzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBzZXRUaWNrcyhheGlzKSB7CiAgICAgIHZhciBvdGlja3MgPSBheGlzLm9wdGlvbnMudGlja3MsCiAgICAgICAgICB0aWNrcyA9IFtdOwogICAgICBpZiAob3RpY2tzID09IG51bGwgfHwgdHlwZW9mIG90aWNrcyA9PSAibnVtYmVyIiAmJiBvdGlja3MgPiAwKSB0aWNrcyA9IGF4aXMudGlja0dlbmVyYXRvcihheGlzKTtlbHNlIGlmIChvdGlja3MpIHsKICAgICAgICBpZiAoJC5pc0Z1bmN0aW9uKG90aWNrcykpIC8vIGdlbmVyYXRlIHRoZSB0aWNrcwogICAgICAgICAgdGlja3MgPSBvdGlja3MoYXhpcyk7ZWxzZSB0aWNrcyA9IG90aWNrczsKICAgICAgfSAvLyBjbGVhbiB1cC9sYWJlbGlmeSB0aGUgc3VwcGxpZWQgdGlja3MsIGNvcHkgdGhlbSBvdmVyCgogICAgICB2YXIgaSwgdjsKICAgICAgYXhpcy50aWNrcyA9IFtdOwoKICAgICAgZm9yIChpID0gMDsgaSA8IHRpY2tzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgdmFyIGxhYmVsID0gbnVsbDsKICAgICAgICB2YXIgdCA9IHRpY2tzW2ldOwoKICAgICAgICBpZiAoX3R5cGVvZih0KSA9PSAib2JqZWN0IikgewogICAgICAgICAgdiA9ICt0WzBdOwogICAgICAgICAgaWYgKHQubGVuZ3RoID4gMSkgbGFiZWwgPSB0WzFdOwogICAgICAgIH0gZWxzZSB2ID0gK3Q7CgogICAgICAgIGlmIChsYWJlbCA9PSBudWxsKSBsYWJlbCA9IGF4aXMudGlja0Zvcm1hdHRlcih2LCBheGlzKTsKICAgICAgICBpZiAoIWlzTmFOKHYpKSBheGlzLnRpY2tzLnB1c2goewogICAgICAgICAgdjogdiwKICAgICAgICAgIGxhYmVsOiBsYWJlbAogICAgICAgIH0pOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gc25hcFJhbmdlVG9UaWNrcyhheGlzLCB0aWNrcykgewogICAgICBpZiAoYXhpcy5vcHRpb25zLmF1dG9zY2FsZU1hcmdpbiAmJiB0aWNrcy5sZW5ndGggPiAwKSB7CiAgICAgICAgLy8gc25hcCB0byB0aWNrcwogICAgICAgIGlmIChheGlzLm9wdGlvbnMubWluID09IG51bGwpIGF4aXMubWluID0gTWF0aC5taW4oYXhpcy5taW4sIHRpY2tzWzBdLnYpOwogICAgICAgIGlmIChheGlzLm9wdGlvbnMubWF4ID09IG51bGwgJiYgdGlja3MubGVuZ3RoID4gMSkgYXhpcy5tYXggPSBNYXRoLm1heChheGlzLm1heCwgdGlja3NbdGlja3MubGVuZ3RoIC0gMV0udik7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBkcmF3KCkgewogICAgICBzdXJmYWNlLmNsZWFyKCk7CiAgICAgIGV4ZWN1dGVIb29rcyhob29rcy5kcmF3QmFja2dyb3VuZCwgW2N0eF0pOwogICAgICB2YXIgZ3JpZCA9IG9wdGlvbnMuZ3JpZDsgLy8gZHJhdyBiYWNrZ3JvdW5kLCBpZiBhbnkKCiAgICAgIGlmIChncmlkLnNob3cgJiYgZ3JpZC5iYWNrZ3JvdW5kQ29sb3IpIGRyYXdCYWNrZ3JvdW5kKCk7CgogICAgICBpZiAoZ3JpZC5zaG93ICYmICFncmlkLmFib3ZlRGF0YSkgewogICAgICAgIGRyYXdHcmlkKCk7CiAgICAgIH0KCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2VyaWVzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgZXhlY3V0ZUhvb2tzKGhvb2tzLmRyYXdTZXJpZXMsIFtjdHgsIHNlcmllc1tpXV0pOwogICAgICAgIGRyYXdTZXJpZXMoc2VyaWVzW2ldKTsKICAgICAgfQoKICAgICAgZXhlY3V0ZUhvb2tzKGhvb2tzLmRyYXcsIFtjdHhdKTsKCiAgICAgIGlmIChncmlkLnNob3cgJiYgZ3JpZC5hYm92ZURhdGEpIHsKICAgICAgICBkcmF3R3JpZCgpOwogICAgICB9CgogICAgICBzdXJmYWNlLnJlbmRlcigpOyAvLyBBIGRyYXcgaW1wbGllcyB0aGF0IGVpdGhlciB0aGUgYXhlcyBvciBkYXRhIGhhdmUgY2hhbmdlZCwgc28gd2UKICAgICAgLy8gc2hvdWxkIHByb2JhYmx5IHVwZGF0ZSB0aGUgb3ZlcmxheSBoaWdobGlnaHRzIGFzIHdlbGwuCgogICAgICB0cmlnZ2VyUmVkcmF3T3ZlcmxheSgpOwogICAgfQoKICAgIGZ1bmN0aW9uIGV4dHJhY3RSYW5nZShyYW5nZXMsIGNvb3JkKSB7CiAgICAgIHZhciBheGlzLAogICAgICAgICAgZnJvbSwKICAgICAgICAgIHRvLAogICAgICAgICAga2V5LAogICAgICAgICAgYXhlcyA9IGFsbEF4ZXMoKTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXhlcy5sZW5ndGg7ICsraSkgewogICAgICAgIGF4aXMgPSBheGVzW2ldOwoKICAgICAgICBpZiAoYXhpcy5kaXJlY3Rpb24gPT0gY29vcmQpIHsKICAgICAgICAgIGtleSA9IGNvb3JkICsgYXhpcy5uICsgImF4aXMiOwogICAgICAgICAgaWYgKCFyYW5nZXNba2V5XSAmJiBheGlzLm4gPT0gMSkga2V5ID0gY29vcmQgKyAiYXhpcyI7IC8vIHN1cHBvcnQgeDFheGlzIGFzIHhheGlzCgogICAgICAgICAgaWYgKHJhbmdlc1trZXldKSB7CiAgICAgICAgICAgIGZyb20gPSByYW5nZXNba2V5XS5mcm9tOwogICAgICAgICAgICB0byA9IHJhbmdlc1trZXldLnRvOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gLy8gYmFja3dhcmRzLWNvbXBhdCBzdHVmZiAtIHRvIGJlIHJlbW92ZWQgaW4gZnV0dXJlCgoKICAgICAgaWYgKCFyYW5nZXNba2V5XSkgewogICAgICAgIGF4aXMgPSBjb29yZCA9PSAieCIgPyB4YXhlc1swXSA6IHlheGVzWzBdOwogICAgICAgIGZyb20gPSByYW5nZXNbY29vcmQgKyAiMSJdOwogICAgICAgIHRvID0gcmFuZ2VzW2Nvb3JkICsgIjIiXTsKICAgICAgfSAvLyBhdXRvLXJldmVyc2UgYXMgYW4gYWRkZWQgYm9udXMKCgogICAgICBpZiAoZnJvbSAhPSBudWxsICYmIHRvICE9IG51bGwgJiYgZnJvbSA+IHRvKSB7CiAgICAgICAgdmFyIHRtcCA9IGZyb207CiAgICAgICAgZnJvbSA9IHRvOwogICAgICAgIHRvID0gdG1wOwogICAgICB9CgogICAgICByZXR1cm4gewogICAgICAgIGZyb206IGZyb20sCiAgICAgICAgdG86IHRvLAogICAgICAgIGF4aXM6IGF4aXMKICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiBkcmF3QmFja2dyb3VuZCgpIHsKICAgICAgY3R4LnNhdmUoKTsKICAgICAgY3R4LnRyYW5zbGF0ZShwbG90T2Zmc2V0LmxlZnQsIHBsb3RPZmZzZXQudG9wKTsKICAgICAgY3R4LmZpbGxTdHlsZSA9IGdldENvbG9yT3JHcmFkaWVudChvcHRpb25zLmdyaWQuYmFja2dyb3VuZENvbG9yLCBwbG90SGVpZ2h0LCAwLCAicmdiYSgyNTUsIDI1NSwgMjU1LCAwKSIpOwogICAgICBjdHguZmlsbFJlY3QoMCwgMCwgcGxvdFdpZHRoLCBwbG90SGVpZ2h0KTsKICAgICAgY3R4LnJlc3RvcmUoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBkcmF3R3JpZCgpIHsKICAgICAgdmFyIGksIGF4ZXMsIGJ3LCBiYzsKICAgICAgY3R4LnNhdmUoKTsKICAgICAgY3R4LnRyYW5zbGF0ZShwbG90T2Zmc2V0LmxlZnQsIHBsb3RPZmZzZXQudG9wKTsgLy8gZHJhdyBtYXJraW5ncwoKICAgICAgdmFyIG1hcmtpbmdzID0gb3B0aW9ucy5ncmlkLm1hcmtpbmdzOwoKICAgICAgaWYgKG1hcmtpbmdzKSB7CiAgICAgICAgaWYgKCQuaXNGdW5jdGlvbihtYXJraW5ncykpIHsKICAgICAgICAgIGF4ZXMgPSBwbG90LmdldEF4ZXMoKTsgLy8geG1pbiBldGMuIGlzIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LCB0byBiZQogICAgICAgICAgLy8gcmVtb3ZlZCBpbiB0aGUgZnV0dXJlCgogICAgICAgICAgYXhlcy54bWluID0gYXhlcy54YXhpcy5taW47CiAgICAgICAgICBheGVzLnhtYXggPSBheGVzLnhheGlzLm1heDsKICAgICAgICAgIGF4ZXMueW1pbiA9IGF4ZXMueWF4aXMubWluOwogICAgICAgICAgYXhlcy55bWF4ID0gYXhlcy55YXhpcy5tYXg7CiAgICAgICAgICBtYXJraW5ncyA9IG1hcmtpbmdzKGF4ZXMpOwogICAgICAgIH0KCiAgICAgICAgZm9yIChpID0gMDsgaSA8IG1hcmtpbmdzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICB2YXIgbSA9IG1hcmtpbmdzW2ldLAogICAgICAgICAgICAgIHhyYW5nZSA9IGV4dHJhY3RSYW5nZShtLCAieCIpLAogICAgICAgICAgICAgIHlyYW5nZSA9IGV4dHJhY3RSYW5nZShtLCAieSIpOyAvLyBmaWxsIGluIG1pc3NpbmcKCiAgICAgICAgICBpZiAoeHJhbmdlLmZyb20gPT0gbnVsbCkgeHJhbmdlLmZyb20gPSB4cmFuZ2UuYXhpcy5taW47CiAgICAgICAgICBpZiAoeHJhbmdlLnRvID09IG51bGwpIHhyYW5nZS50byA9IHhyYW5nZS5heGlzLm1heDsKICAgICAgICAgIGlmICh5cmFuZ2UuZnJvbSA9PSBudWxsKSB5cmFuZ2UuZnJvbSA9IHlyYW5nZS5heGlzLm1pbjsKICAgICAgICAgIGlmICh5cmFuZ2UudG8gPT0gbnVsbCkgeXJhbmdlLnRvID0geXJhbmdlLmF4aXMubWF4OyAvLyBjbGlwCgogICAgICAgICAgaWYgKHhyYW5nZS50byA8IHhyYW5nZS5heGlzLm1pbiB8fCB4cmFuZ2UuZnJvbSA+IHhyYW5nZS5heGlzLm1heCB8fCB5cmFuZ2UudG8gPCB5cmFuZ2UuYXhpcy5taW4gfHwgeXJhbmdlLmZyb20gPiB5cmFuZ2UuYXhpcy5tYXgpIGNvbnRpbnVlOwogICAgICAgICAgeHJhbmdlLmZyb20gPSBNYXRoLm1heCh4cmFuZ2UuZnJvbSwgeHJhbmdlLmF4aXMubWluKTsKICAgICAgICAgIHhyYW5nZS50byA9IE1hdGgubWluKHhyYW5nZS50bywgeHJhbmdlLmF4aXMubWF4KTsKICAgICAgICAgIHlyYW5nZS5mcm9tID0gTWF0aC5tYXgoeXJhbmdlLmZyb20sIHlyYW5nZS5heGlzLm1pbik7CiAgICAgICAgICB5cmFuZ2UudG8gPSBNYXRoLm1pbih5cmFuZ2UudG8sIHlyYW5nZS5heGlzLm1heCk7CiAgICAgICAgICB2YXIgeGVxdWFsID0geHJhbmdlLmZyb20gPT09IHhyYW5nZS50bywKICAgICAgICAgICAgICB5ZXF1YWwgPSB5cmFuZ2UuZnJvbSA9PT0geXJhbmdlLnRvOwoKICAgICAgICAgIGlmICh4ZXF1YWwgJiYgeWVxdWFsKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfSAvLyB0aGVuIGRyYXcKCgogICAgICAgICAgeHJhbmdlLmZyb20gPSBNYXRoLmZsb29yKHhyYW5nZS5heGlzLnAyYyh4cmFuZ2UuZnJvbSkpOwogICAgICAgICAgeHJhbmdlLnRvID0gTWF0aC5mbG9vcih4cmFuZ2UuYXhpcy5wMmMoeHJhbmdlLnRvKSk7CiAgICAgICAgICB5cmFuZ2UuZnJvbSA9IE1hdGguZmxvb3IoeXJhbmdlLmF4aXMucDJjKHlyYW5nZS5mcm9tKSk7CiAgICAgICAgICB5cmFuZ2UudG8gPSBNYXRoLmZsb29yKHlyYW5nZS5heGlzLnAyYyh5cmFuZ2UudG8pKTsKCiAgICAgICAgICBpZiAoeGVxdWFsIHx8IHllcXVhbCkgewogICAgICAgICAgICB2YXIgbGluZVdpZHRoID0gbS5saW5lV2lkdGggfHwgb3B0aW9ucy5ncmlkLm1hcmtpbmdzTGluZVdpZHRoLAogICAgICAgICAgICAgICAgc3ViUGl4ZWwgPSBsaW5lV2lkdGggJSAyID8gMC41IDogMDsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSBtLmNvbG9yIHx8IG9wdGlvbnMuZ3JpZC5tYXJraW5nc0NvbG9yOwogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gbGluZVdpZHRoOwoKICAgICAgICAgICAgaWYgKHhlcXVhbCkgewogICAgICAgICAgICAgIGN0eC5tb3ZlVG8oeHJhbmdlLnRvICsgc3ViUGl4ZWwsIHlyYW5nZS5mcm9tKTsKICAgICAgICAgICAgICBjdHgubGluZVRvKHhyYW5nZS50byArIHN1YlBpeGVsLCB5cmFuZ2UudG8pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGN0eC5tb3ZlVG8oeHJhbmdlLmZyb20sIHlyYW5nZS50byArIHN1YlBpeGVsKTsKICAgICAgICAgICAgICBjdHgubGluZVRvKHhyYW5nZS50bywgeXJhbmdlLnRvICsgc3ViUGl4ZWwpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gbS5jb2xvciB8fCBvcHRpb25zLmdyaWQubWFya2luZ3NDb2xvcjsKICAgICAgICAgICAgY3R4LmZpbGxSZWN0KHhyYW5nZS5mcm9tLCB5cmFuZ2UudG8sIHhyYW5nZS50byAtIHhyYW5nZS5mcm9tLCB5cmFuZ2UuZnJvbSAtIHlyYW5nZS50byk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IC8vIGRyYXcgdGhlIHRpY2tzCgoKICAgICAgYXhlcyA9IGFsbEF4ZXMoKTsKICAgICAgYncgPSBvcHRpb25zLmdyaWQuYm9yZGVyV2lkdGg7CgogICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGF4ZXMubGVuZ3RoOyArK2opIHsKICAgICAgICB2YXIgYXhpcyA9IGF4ZXNbal0sCiAgICAgICAgICAgIGJveCA9IGF4aXMuYm94LAogICAgICAgICAgICB0ID0gYXhpcy50aWNrTGVuZ3RoLAogICAgICAgICAgICB4LAogICAgICAgICAgICB5LAogICAgICAgICAgICB4b2ZmLAogICAgICAgICAgICB5b2ZmOwogICAgICAgIGlmICghYXhpcy5zaG93IHx8IGF4aXMudGlja3MubGVuZ3RoID09IDApIGNvbnRpbnVlOwogICAgICAgIGN0eC5saW5lV2lkdGggPSAxOyAvLyBmaW5kIHRoZSBlZGdlcwoKICAgICAgICBpZiAoYXhpcy5kaXJlY3Rpb24gPT0gIngiKSB7CiAgICAgICAgICB4ID0gMDsKICAgICAgICAgIGlmICh0ID09ICJmdWxsIikgeSA9IGF4aXMucG9zaXRpb24gPT0gInRvcCIgPyAwIDogcGxvdEhlaWdodDtlbHNlIHkgPSBib3gudG9wIC0gcGxvdE9mZnNldC50b3AgKyAoYXhpcy5wb3NpdGlvbiA9PSAidG9wIiA/IGJveC5oZWlnaHQgOiAwKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgeSA9IDA7CiAgICAgICAgICBpZiAodCA9PSAiZnVsbCIpIHggPSBheGlzLnBvc2l0aW9uID09ICJsZWZ0IiA/IDAgOiBwbG90V2lkdGg7ZWxzZSB4ID0gYm94LmxlZnQgLSBwbG90T2Zmc2V0LmxlZnQgKyAoYXhpcy5wb3NpdGlvbiA9PSAibGVmdCIgPyBib3gud2lkdGggOiAwKTsKICAgICAgICB9IC8vIGRyYXcgdGljayBiYXIKCgogICAgICAgIGlmICghYXhpcy5pbm5lcm1vc3QpIHsKICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9IGF4aXMub3B0aW9ucy5jb2xvcjsKICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgIHhvZmYgPSB5b2ZmID0gMDsKICAgICAgICAgIGlmIChheGlzLmRpcmVjdGlvbiA9PSAieCIpIHhvZmYgPSBwbG90V2lkdGggKyAxO2Vsc2UgeW9mZiA9IHBsb3RIZWlnaHQgKyAxOwoKICAgICAgICAgIGlmIChjdHgubGluZVdpZHRoID09IDEpIHsKICAgICAgICAgICAgaWYgKGF4aXMuZGlyZWN0aW9uID09ICJ4IikgewogICAgICAgICAgICAgIHkgPSBNYXRoLmZsb29yKHkpICsgMC41OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHggPSBNYXRoLmZsb29yKHgpICsgMC41OwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgY3R4Lm1vdmVUbyh4LCB5KTsKICAgICAgICAgIGN0eC5saW5lVG8oeCArIHhvZmYsIHkgKyB5b2ZmKTsKICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICB9IC8vIGRyYXcgdGlja3MKCgogICAgICAgIGN0eC5zdHJva2VTdHlsZSA9IGF4aXMub3B0aW9ucy50aWNrQ29sb3I7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwoKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgYXhpcy50aWNrcy5sZW5ndGg7ICsraSkgewogICAgICAgICAgdmFyIHYgPSBheGlzLnRpY2tzW2ldLnY7CiAgICAgICAgICB4b2ZmID0geW9mZiA9IDA7CiAgICAgICAgICBpZiAoaXNOYU4odikgfHwgdiA8IGF4aXMubWluIHx8IHYgPiBheGlzLm1heCAvLyBza2lwIHRob3NlIGx5aW5nIG9uIHRoZSBheGVzIGlmIHdlIGdvdCBhIGJvcmRlcgogICAgICAgICAgfHwgdCA9PSAiZnVsbCIgJiYgKF90eXBlb2YoYncpID09ICJvYmplY3QiICYmIGJ3W2F4aXMucG9zaXRpb25dID4gMCB8fCBidyA+IDApICYmICh2ID09IGF4aXMubWluIHx8IHYgPT0gYXhpcy5tYXgpKSBjb250aW51ZTsKCiAgICAgICAgICBpZiAoYXhpcy5kaXJlY3Rpb24gPT0gIngiKSB7CiAgICAgICAgICAgIHggPSBheGlzLnAyYyh2KTsKICAgICAgICAgICAgeW9mZiA9IHQgPT0gImZ1bGwiID8gLXBsb3RIZWlnaHQgOiB0OwogICAgICAgICAgICBpZiAoYXhpcy5wb3NpdGlvbiA9PSAidG9wIikgeW9mZiA9IC15b2ZmOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgeSA9IGF4aXMucDJjKHYpOwogICAgICAgICAgICB4b2ZmID0gdCA9PSAiZnVsbCIgPyAtcGxvdFdpZHRoIDogdDsKICAgICAgICAgICAgaWYgKGF4aXMucG9zaXRpb24gPT0gImxlZnQiKSB4b2ZmID0gLXhvZmY7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGN0eC5saW5lV2lkdGggPT0gMSkgewogICAgICAgICAgICBpZiAoYXhpcy5kaXJlY3Rpb24gPT0gIngiKSB4ID0gTWF0aC5mbG9vcih4KSArIDAuNTtlbHNlIHkgPSBNYXRoLmZsb29yKHkpICsgMC41OwogICAgICAgICAgfQoKICAgICAgICAgIGN0eC5tb3ZlVG8oeCwgeSk7CiAgICAgICAgICBjdHgubGluZVRvKHggKyB4b2ZmLCB5ICsgeW9mZik7CiAgICAgICAgfQoKICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgIH0gLy8gZHJhdyBib3JkZXIKCgogICAgICBpZiAoYncpIHsKICAgICAgICAvLyBJZiBlaXRoZXIgYm9yZGVyV2lkdGggb3IgYm9yZGVyQ29sb3IgaXMgYW4gb2JqZWN0LCB0aGVuIGRyYXcgdGhlIGJvcmRlcgogICAgICAgIC8vIGxpbmUgYnkgbGluZSBpbnN0ZWFkIG9mIGFzIG9uZSByZWN0YW5nbGUKICAgICAgICBiYyA9IG9wdGlvbnMuZ3JpZC5ib3JkZXJDb2xvcjsKCiAgICAgICAgaWYgKF90eXBlb2YoYncpID09ICJvYmplY3QiIHx8IF90eXBlb2YoYmMpID09ICJvYmplY3QiKSB7CiAgICAgICAgICBpZiAoX3R5cGVvZihidykgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIGJ3ID0gewogICAgICAgICAgICAgIHRvcDogYncsCiAgICAgICAgICAgICAgcmlnaHQ6IGJ3LAogICAgICAgICAgICAgIGJvdHRvbTogYncsCiAgICAgICAgICAgICAgbGVmdDogYncKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoX3R5cGVvZihiYykgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIGJjID0gewogICAgICAgICAgICAgIHRvcDogYmMsCiAgICAgICAgICAgICAgcmlnaHQ6IGJjLAogICAgICAgICAgICAgIGJvdHRvbTogYmMsCiAgICAgICAgICAgICAgbGVmdDogYmMKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoYncudG9wID4gMCkgewogICAgICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSBiYy50b3A7CiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSBidy50b3A7CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4Lm1vdmVUbygwIC0gYncubGVmdCwgMCAtIGJ3LnRvcCAvIDIpOwogICAgICAgICAgICBjdHgubGluZVRvKHBsb3RXaWR0aCwgMCAtIGJ3LnRvcCAvIDIpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGJ3LnJpZ2h0ID4gMCkgewogICAgICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSBiYy5yaWdodDsKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IGJ3LnJpZ2h0OwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5tb3ZlVG8ocGxvdFdpZHRoICsgYncucmlnaHQgLyAyLCAwIC0gYncudG9wKTsKICAgICAgICAgICAgY3R4LmxpbmVUbyhwbG90V2lkdGggKyBidy5yaWdodCAvIDIsIHBsb3RIZWlnaHQpOwogICAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGJ3LmJvdHRvbSA+IDApIHsKICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gYmMuYm90dG9tOwogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gYncuYm90dG9tOwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5tb3ZlVG8ocGxvdFdpZHRoICsgYncucmlnaHQsIHBsb3RIZWlnaHQgKyBidy5ib3R0b20gLyAyKTsKICAgICAgICAgICAgY3R4LmxpbmVUbygwLCBwbG90SGVpZ2h0ICsgYncuYm90dG9tIC8gMik7CiAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoYncubGVmdCA+IDApIHsKICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gYmMubGVmdDsKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IGJ3LmxlZnQ7CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4Lm1vdmVUbygwIC0gYncubGVmdCAvIDIsIHBsb3RIZWlnaHQgKyBidy5ib3R0b20pOwogICAgICAgICAgICBjdHgubGluZVRvKDAgLSBidy5sZWZ0IC8gMiwgMCk7CiAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IGJ3OwogICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gb3B0aW9ucy5ncmlkLmJvcmRlckNvbG9yOwogICAgICAgICAgY3R4LnN0cm9rZVJlY3QoLWJ3IC8gMiwgLWJ3IC8gMiwgcGxvdFdpZHRoICsgYncsIHBsb3RIZWlnaHQgKyBidyk7CiAgICAgICAgfQogICAgICB9CgogICAgICBjdHgucmVzdG9yZSgpOwogICAgfQoKICAgIGZ1bmN0aW9uIGRyYXdBeGlzTGFiZWxzKCkgewogICAgICAkLmVhY2goYWxsQXhlcygpLCBmdW5jdGlvbiAoXywgYXhpcykgewogICAgICAgIHZhciBib3ggPSBheGlzLmJveCwKICAgICAgICAgICAgbGVnYWN5U3R5bGVzID0gYXhpcy5kaXJlY3Rpb24gKyAiQXhpcyAiICsgYXhpcy5kaXJlY3Rpb24gKyBheGlzLm4gKyAiQXhpcyIsCiAgICAgICAgICAgIGxheWVyID0gImZsb3QtIiArIGF4aXMuZGlyZWN0aW9uICsgIi1heGlzIGZsb3QtIiArIGF4aXMuZGlyZWN0aW9uICsgYXhpcy5uICsgIi1heGlzICIgKyBsZWdhY3lTdHlsZXMsCiAgICAgICAgICAgIGZvbnQgPSBheGlzLm9wdGlvbnMuZm9udCB8fCAiZmxvdC10aWNrLWxhYmVsIHRpY2tMYWJlbCIsCiAgICAgICAgICAgIHRpY2ssCiAgICAgICAgICAgIHgsCiAgICAgICAgICAgIHksCiAgICAgICAgICAgIGhhbGlnbiwKICAgICAgICAgICAgdmFsaWduOyAvLyBSZW1vdmUgdGV4dCBiZWZvcmUgY2hlY2tpbmcgZm9yIGF4aXMuc2hvdyBhbmQgdGlja3MubGVuZ3RoOwogICAgICAgIC8vIG90aGVyd2lzZSBwbHVnaW5zLCBsaWtlIGZsb3QtdGlja3JvdG9yLCB0aGF0IGRyYXcgdGhlaXIgb3duCiAgICAgICAgLy8gdGljayBsYWJlbHMgd2lsbCBlbmQgdXAgd2l0aCBib3RoIHRoZWlycyBhbmQgdGhlIGRlZmF1bHRzLgoKICAgICAgICBzdXJmYWNlLnJlbW92ZVRleHQobGF5ZXIpOwogICAgICAgIGlmICghYXhpcy5zaG93IHx8IGF4aXMudGlja3MubGVuZ3RoID09IDApIHJldHVybjsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBheGlzLnRpY2tzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICB0aWNrID0gYXhpcy50aWNrc1tpXTsKICAgICAgICAgIGlmICghdGljay5sYWJlbCB8fCB0aWNrLnYgPCBheGlzLm1pbiB8fCB0aWNrLnYgPiBheGlzLm1heCkgY29udGludWU7CgogICAgICAgICAgaWYgKGF4aXMuZGlyZWN0aW9uID09ICJ4IikgewogICAgICAgICAgICBoYWxpZ24gPSAiY2VudGVyIjsKICAgICAgICAgICAgeCA9IHBsb3RPZmZzZXQubGVmdCArIGF4aXMucDJjKHRpY2sudik7CgogICAgICAgICAgICBpZiAoYXhpcy5wb3NpdGlvbiA9PSAiYm90dG9tIikgewogICAgICAgICAgICAgIHkgPSBib3gudG9wICsgYm94LnBhZGRpbmc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgeSA9IGJveC50b3AgKyBib3guaGVpZ2h0IC0gYm94LnBhZGRpbmc7CiAgICAgICAgICAgICAgdmFsaWduID0gImJvdHRvbSI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhbGlnbiA9ICJtaWRkbGUiOwogICAgICAgICAgICB5ID0gcGxvdE9mZnNldC50b3AgKyBheGlzLnAyYyh0aWNrLnYpOwoKICAgICAgICAgICAgaWYgKGF4aXMucG9zaXRpb24gPT0gImxlZnQiKSB7CiAgICAgICAgICAgICAgeCA9IGJveC5sZWZ0ICsgYm94LndpZHRoIC0gYm94LnBhZGRpbmc7CiAgICAgICAgICAgICAgaGFsaWduID0gInJpZ2h0IjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB4ID0gYm94LmxlZnQgKyBib3gucGFkZGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIHN1cmZhY2UuYWRkVGV4dChsYXllciwgeCwgeSwgdGljay5sYWJlbCwgZm9udCwgbnVsbCwgbnVsbCwgaGFsaWduLCB2YWxpZ24pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gZHJhd1NlcmllcyhzZXJpZXMpIHsKICAgICAgaWYgKHNlcmllcy5saW5lcy5zaG93KSBkcmF3U2VyaWVzTGluZXMoc2VyaWVzKTsKICAgICAgaWYgKHNlcmllcy5iYXJzLnNob3cpIGRyYXdTZXJpZXNCYXJzKHNlcmllcyk7CiAgICAgIGlmIChzZXJpZXMucG9pbnRzLnNob3cpIGRyYXdTZXJpZXNQb2ludHMoc2VyaWVzKTsKICAgIH0KCiAgICBmdW5jdGlvbiBkcmF3U2VyaWVzTGluZXMoc2VyaWVzKSB7CiAgICAgIGZ1bmN0aW9uIHBsb3RMaW5lKGRhdGFwb2ludHMsIHhvZmZzZXQsIHlvZmZzZXQsIGF4aXN4LCBheGlzeSkgewogICAgICAgIHZhciBwb2ludHMgPSBkYXRhcG9pbnRzLnBvaW50cywKICAgICAgICAgICAgcHMgPSBkYXRhcG9pbnRzLnBvaW50c2l6ZSwKICAgICAgICAgICAgcHJldnggPSBudWxsLAogICAgICAgICAgICBwcmV2eSA9IG51bGw7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwoKICAgICAgICBmb3IgKHZhciBpID0gcHM7IGkgPCBwb2ludHMubGVuZ3RoOyBpICs9IHBzKSB7CiAgICAgICAgICB2YXIgeDEgPSBwb2ludHNbaSAtIHBzXSwKICAgICAgICAgICAgICB5MSA9IHBvaW50c1tpIC0gcHMgKyAxXSwKICAgICAgICAgICAgICB4MiA9IHBvaW50c1tpXSwKICAgICAgICAgICAgICB5MiA9IHBvaW50c1tpICsgMV07CiAgICAgICAgICBpZiAoeDEgPT0gbnVsbCB8fCB4MiA9PSBudWxsKSBjb250aW51ZTsgLy8gY2xpcCB3aXRoIHltaW4KCiAgICAgICAgICBpZiAoeTEgPD0geTIgJiYgeTEgPCBheGlzeS5taW4pIHsKICAgICAgICAgICAgaWYgKHkyIDwgYXhpc3kubWluKSBjb250aW51ZTsgLy8gbGluZSBzZWdtZW50IGlzIG91dHNpZGUKICAgICAgICAgICAgLy8gY29tcHV0ZSBuZXcgaW50ZXJzZWN0aW9uIHBvaW50CgogICAgICAgICAgICB4MSA9IChheGlzeS5taW4gLSB5MSkgLyAoeTIgLSB5MSkgKiAoeDIgLSB4MSkgKyB4MTsKICAgICAgICAgICAgeTEgPSBheGlzeS5taW47CiAgICAgICAgICB9IGVsc2UgaWYgKHkyIDw9IHkxICYmIHkyIDwgYXhpc3kubWluKSB7CiAgICAgICAgICAgIGlmICh5MSA8IGF4aXN5Lm1pbikgY29udGludWU7CiAgICAgICAgICAgIHgyID0gKGF4aXN5Lm1pbiAtIHkxKSAvICh5MiAtIHkxKSAqICh4MiAtIHgxKSArIHgxOwogICAgICAgICAgICB5MiA9IGF4aXN5Lm1pbjsKICAgICAgICAgIH0gLy8gY2xpcCB3aXRoIHltYXgKCgogICAgICAgICAgaWYgKHkxID49IHkyICYmIHkxID4gYXhpc3kubWF4KSB7CiAgICAgICAgICAgIGlmICh5MiA+IGF4aXN5Lm1heCkgY29udGludWU7CiAgICAgICAgICAgIHgxID0gKGF4aXN5Lm1heCAtIHkxKSAvICh5MiAtIHkxKSAqICh4MiAtIHgxKSArIHgxOwogICAgICAgICAgICB5MSA9IGF4aXN5Lm1heDsKICAgICAgICAgIH0gZWxzZSBpZiAoeTIgPj0geTEgJiYgeTIgPiBheGlzeS5tYXgpIHsKICAgICAgICAgICAgaWYgKHkxID4gYXhpc3kubWF4KSBjb250aW51ZTsKICAgICAgICAgICAgeDIgPSAoYXhpc3kubWF4IC0geTEpIC8gKHkyIC0geTEpICogKHgyIC0geDEpICsgeDE7CiAgICAgICAgICAgIHkyID0gYXhpc3kubWF4OwogICAgICAgICAgfSAvLyBjbGlwIHdpdGggeG1pbgoKCiAgICAgICAgICBpZiAoeDEgPD0geDIgJiYgeDEgPCBheGlzeC5taW4pIHsKICAgICAgICAgICAgaWYgKHgyIDwgYXhpc3gubWluKSBjb250aW51ZTsKICAgICAgICAgICAgeTEgPSAoYXhpc3gubWluIC0geDEpIC8gKHgyIC0geDEpICogKHkyIC0geTEpICsgeTE7CiAgICAgICAgICAgIHgxID0gYXhpc3gubWluOwogICAgICAgICAgfSBlbHNlIGlmICh4MiA8PSB4MSAmJiB4MiA8IGF4aXN4Lm1pbikgewogICAgICAgICAgICBpZiAoeDEgPCBheGlzeC5taW4pIGNvbnRpbnVlOwogICAgICAgICAgICB5MiA9IChheGlzeC5taW4gLSB4MSkgLyAoeDIgLSB4MSkgKiAoeTIgLSB5MSkgKyB5MTsKICAgICAgICAgICAgeDIgPSBheGlzeC5taW47CiAgICAgICAgICB9IC8vIGNsaXAgd2l0aCB4bWF4CgoKICAgICAgICAgIGlmICh4MSA+PSB4MiAmJiB4MSA+IGF4aXN4Lm1heCkgewogICAgICAgICAgICBpZiAoeDIgPiBheGlzeC5tYXgpIGNvbnRpbnVlOwogICAgICAgICAgICB5MSA9IChheGlzeC5tYXggLSB4MSkgLyAoeDIgLSB4MSkgKiAoeTIgLSB5MSkgKyB5MTsKICAgICAgICAgICAgeDEgPSBheGlzeC5tYXg7CiAgICAgICAgICB9IGVsc2UgaWYgKHgyID49IHgxICYmIHgyID4gYXhpc3gubWF4KSB7CiAgICAgICAgICAgIGlmICh4MSA+IGF4aXN4Lm1heCkgY29udGludWU7CiAgICAgICAgICAgIHkyID0gKGF4aXN4Lm1heCAtIHgxKSAvICh4MiAtIHgxKSAqICh5MiAtIHkxKSArIHkxOwogICAgICAgICAgICB4MiA9IGF4aXN4Lm1heDsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoeDEgIT0gcHJldnggfHwgeTEgIT0gcHJldnkpIGN0eC5tb3ZlVG8oYXhpc3gucDJjKHgxKSArIHhvZmZzZXQsIGF4aXN5LnAyYyh5MSkgKyB5b2Zmc2V0KTsKICAgICAgICAgIHByZXZ4ID0geDI7CiAgICAgICAgICBwcmV2eSA9IHkyOwogICAgICAgICAgY3R4LmxpbmVUbyhheGlzeC5wMmMoeDIpICsgeG9mZnNldCwgYXhpc3kucDJjKHkyKSArIHlvZmZzZXQpOwogICAgICAgIH0KCiAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICB9CgogICAgICBmdW5jdGlvbiBwbG90TGluZUFyZWEoZGF0YXBvaW50cywgYXhpc3gsIGF4aXN5KSB7CiAgICAgICAgdmFyIHBvaW50cyA9IGRhdGFwb2ludHMucG9pbnRzLAogICAgICAgICAgICBwcyA9IGRhdGFwb2ludHMucG9pbnRzaXplLAogICAgICAgICAgICBib3R0b20gPSBNYXRoLm1pbihNYXRoLm1heCgwLCBheGlzeS5taW4pLCBheGlzeS5tYXgpLAogICAgICAgICAgICBpID0gMCwKICAgICAgICAgICAgdG9wLAogICAgICAgICAgICBhcmVhT3BlbiA9IGZhbHNlLAogICAgICAgICAgICB5cG9zID0gMSwKICAgICAgICAgICAgc2VnbWVudFN0YXJ0ID0gMCwKICAgICAgICAgICAgc2VnbWVudEVuZCA9IDA7IC8vIHdlIHByb2Nlc3MgZWFjaCBzZWdtZW50IGluIHR3byB0dXJucywgZmlyc3QgZm9yd2FyZAogICAgICAgIC8vIGRpcmVjdGlvbiB0byBza2V0Y2ggb3V0IHRvcCwgdGhlbiBvbmNlIHdlIGhpdCB0aGUKICAgICAgICAvLyBlbmQgd2UgZ28gYmFja3dhcmRzIHRvIHNrZXRjaCB0aGUgYm90dG9tCgogICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICBpZiAocHMgPiAwICYmIGkgPiBwb2ludHMubGVuZ3RoICsgcHMpIGJyZWFrOwogICAgICAgICAgaSArPSBwczsgLy8gcHMgaXMgbmVnYXRpdmUgaWYgZ29pbmcgYmFja3dhcmRzCgogICAgICAgICAgdmFyIHgxID0gcG9pbnRzW2kgLSBwc10sCiAgICAgICAgICAgICAgeTEgPSBwb2ludHNbaSAtIHBzICsgeXBvc10sCiAgICAgICAgICAgICAgeDIgPSBwb2ludHNbaV0sCiAgICAgICAgICAgICAgeTIgPSBwb2ludHNbaSArIHlwb3NdOwoKICAgICAgICAgIGlmIChhcmVhT3BlbikgewogICAgICAgICAgICBpZiAocHMgPiAwICYmIHgxICE9IG51bGwgJiYgeDIgPT0gbnVsbCkgewogICAgICAgICAgICAgIC8vIGF0IHR1cm5pbmcgcG9pbnQKICAgICAgICAgICAgICBzZWdtZW50RW5kID0gaTsKICAgICAgICAgICAgICBwcyA9IC1wczsKICAgICAgICAgICAgICB5cG9zID0gMjsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHBzIDwgMCAmJiBpID09IHNlZ21lbnRTdGFydCArIHBzKSB7CiAgICAgICAgICAgICAgLy8gZG9uZSB3aXRoIHRoZSByZXZlcnNlIHN3ZWVwCiAgICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgICAgICBhcmVhT3BlbiA9IGZhbHNlOwogICAgICAgICAgICAgIHBzID0gLXBzOwogICAgICAgICAgICAgIHlwb3MgPSAxOwogICAgICAgICAgICAgIGkgPSBzZWdtZW50U3RhcnQgPSBzZWdtZW50RW5kICsgcHM7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoeDEgPT0gbnVsbCB8fCB4MiA9PSBudWxsKSBjb250aW51ZTsgLy8gY2xpcCB4IHZhbHVlcwogICAgICAgICAgLy8gY2xpcCB3aXRoIHhtaW4KCiAgICAgICAgICBpZiAoeDEgPD0geDIgJiYgeDEgPCBheGlzeC5taW4pIHsKICAgICAgICAgICAgaWYgKHgyIDwgYXhpc3gubWluKSBjb250aW51ZTsKICAgICAgICAgICAgeTEgPSAoYXhpc3gubWluIC0geDEpIC8gKHgyIC0geDEpICogKHkyIC0geTEpICsgeTE7CiAgICAgICAgICAgIHgxID0gYXhpc3gubWluOwogICAgICAgICAgfSBlbHNlIGlmICh4MiA8PSB4MSAmJiB4MiA8IGF4aXN4Lm1pbikgewogICAgICAgICAgICBpZiAoeDEgPCBheGlzeC5taW4pIGNvbnRpbnVlOwogICAgICAgICAgICB5MiA9IChheGlzeC5taW4gLSB4MSkgLyAoeDIgLSB4MSkgKiAoeTIgLSB5MSkgKyB5MTsKICAgICAgICAgICAgeDIgPSBheGlzeC5taW47CiAgICAgICAgICB9IC8vIGNsaXAgd2l0aCB4bWF4CgoKICAgICAgICAgIGlmICh4MSA+PSB4MiAmJiB4MSA+IGF4aXN4Lm1heCkgewogICAgICAgICAgICBpZiAoeDIgPiBheGlzeC5tYXgpIGNvbnRpbnVlOwogICAgICAgICAgICB5MSA9IChheGlzeC5tYXggLSB4MSkgLyAoeDIgLSB4MSkgKiAoeTIgLSB5MSkgKyB5MTsKICAgICAgICAgICAgeDEgPSBheGlzeC5tYXg7CiAgICAgICAgICB9IGVsc2UgaWYgKHgyID49IHgxICYmIHgyID4gYXhpc3gubWF4KSB7CiAgICAgICAgICAgIGlmICh4MSA+IGF4aXN4Lm1heCkgY29udGludWU7CiAgICAgICAgICAgIHkyID0gKGF4aXN4Lm1heCAtIHgxKSAvICh4MiAtIHgxKSAqICh5MiAtIHkxKSArIHkxOwogICAgICAgICAgICB4MiA9IGF4aXN4Lm1heDsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoIWFyZWFPcGVuKSB7CiAgICAgICAgICAgIC8vIG9wZW4gYXJlYQogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5tb3ZlVG8oYXhpc3gucDJjKHgxKSwgYXhpc3kucDJjKGJvdHRvbSkpOwogICAgICAgICAgICBhcmVhT3BlbiA9IHRydWU7CiAgICAgICAgICB9IC8vIG5vdyBmaXJzdCBjaGVjayB0aGUgY2FzZSB3aGVyZSBib3RoIGlzIG91dHNpZGUKCgogICAgICAgICAgaWYgKHkxID49IGF4aXN5Lm1heCAmJiB5MiA+PSBheGlzeS5tYXgpIHsKICAgICAgICAgICAgY3R4LmxpbmVUbyhheGlzeC5wMmMoeDEpLCBheGlzeS5wMmMoYXhpc3kubWF4KSk7CiAgICAgICAgICAgIGN0eC5saW5lVG8oYXhpc3gucDJjKHgyKSwgYXhpc3kucDJjKGF4aXN5Lm1heCkpOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0gZWxzZSBpZiAoeTEgPD0gYXhpc3kubWluICYmIHkyIDw9IGF4aXN5Lm1pbikgewogICAgICAgICAgICBjdHgubGluZVRvKGF4aXN4LnAyYyh4MSksIGF4aXN5LnAyYyhheGlzeS5taW4pKTsKICAgICAgICAgICAgY3R4LmxpbmVUbyhheGlzeC5wMmMoeDIpLCBheGlzeS5wMmMoYXhpc3kubWluKSk7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfSAvLyBlbHNlIGl0J3MgYSBiaXQgbW9yZSBjb21wbGljYXRlZCwgdGhlcmUgbWlnaHQKICAgICAgICAgIC8vIGJlIGEgZmxhdCBtYXhlZCBvdXQgcmVjdGFuZ2xlIGZpcnN0LCB0aGVuIGEKICAgICAgICAgIC8vIHRyaWFuZ3VsYXIgY3V0b3V0IG9yIHJldmVyc2U7IHRvIGZpbmQgdGhlc2UKICAgICAgICAgIC8vIGtlZXAgdHJhY2sgb2YgdGhlIGN1cnJlbnQgeCB2YWx1ZXMKCgogICAgICAgICAgdmFyIHgxb2xkID0geDEsCiAgICAgICAgICAgICAgeDJvbGQgPSB4MjsgLy8gY2xpcCB0aGUgeSB2YWx1ZXMsIHdpdGhvdXQgc2hvcnRjdXR0aW5nLCB3ZQogICAgICAgICAgLy8gZ28gdGhyb3VnaCBhbGwgY2FzZXMgaW4gdHVybgogICAgICAgICAgLy8gY2xpcCB3aXRoIHltaW4KCiAgICAgICAgICBpZiAoeTEgPD0geTIgJiYgeTEgPCBheGlzeS5taW4gJiYgeTIgPj0gYXhpc3kubWluKSB7CiAgICAgICAgICAgIHgxID0gKGF4aXN5Lm1pbiAtIHkxKSAvICh5MiAtIHkxKSAqICh4MiAtIHgxKSArIHgxOwogICAgICAgICAgICB5MSA9IGF4aXN5Lm1pbjsKICAgICAgICAgIH0gZWxzZSBpZiAoeTIgPD0geTEgJiYgeTIgPCBheGlzeS5taW4gJiYgeTEgPj0gYXhpc3kubWluKSB7CiAgICAgICAgICAgIHgyID0gKGF4aXN5Lm1pbiAtIHkxKSAvICh5MiAtIHkxKSAqICh4MiAtIHgxKSArIHgxOwogICAgICAgICAgICB5MiA9IGF4aXN5Lm1pbjsKICAgICAgICAgIH0gLy8gY2xpcCB3aXRoIHltYXgKCgogICAgICAgICAgaWYgKHkxID49IHkyICYmIHkxID4gYXhpc3kubWF4ICYmIHkyIDw9IGF4aXN5Lm1heCkgewogICAgICAgICAgICB4MSA9IChheGlzeS5tYXggLSB5MSkgLyAoeTIgLSB5MSkgKiAoeDIgLSB4MSkgKyB4MTsKICAgICAgICAgICAgeTEgPSBheGlzeS5tYXg7CiAgICAgICAgICB9IGVsc2UgaWYgKHkyID49IHkxICYmIHkyID4gYXhpc3kubWF4ICYmIHkxIDw9IGF4aXN5Lm1heCkgewogICAgICAgICAgICB4MiA9IChheGlzeS5tYXggLSB5MSkgLyAoeTIgLSB5MSkgKiAoeDIgLSB4MSkgKyB4MTsKICAgICAgICAgICAgeTIgPSBheGlzeS5tYXg7CiAgICAgICAgICB9IC8vIGlmIHRoZSB4IHZhbHVlIHdhcyBjaGFuZ2VkIHdlIGdvdCBhIHJlY3RhbmdsZQogICAgICAgICAgLy8gdG8gZmlsbAoKCiAgICAgICAgICBpZiAoeDEgIT0geDFvbGQpIHsKICAgICAgICAgICAgY3R4LmxpbmVUbyhheGlzeC5wMmMoeDFvbGQpLCBheGlzeS5wMmMoeTEpKTsgLy8gaXQgZ29lcyB0byAoeDEsIHkxKSwgYnV0IHdlIGZpbGwgdGhhdCBiZWxvdwogICAgICAgICAgfSAvLyBmaWxsIHRyaWFuZ3VsYXIgc2VjdGlvbiwgdGhpcyBzb21ldGltZXMgcmVzdWx0CiAgICAgICAgICAvLyBpbiByZWR1bmRhbnQgcG9pbnRzIGlmICh4MSwgeTEpIGhhc24ndCBjaGFuZ2VkCiAgICAgICAgICAvLyBmcm9tIHByZXZpb3VzIGxpbmUgdG8sIGJ1dCB3ZSBqdXN0IGlnbm9yZSB0aGF0CgoKICAgICAgICAgIGN0eC5saW5lVG8oYXhpc3gucDJjKHgxKSwgYXhpc3kucDJjKHkxKSk7CiAgICAgICAgICBjdHgubGluZVRvKGF4aXN4LnAyYyh4MiksIGF4aXN5LnAyYyh5MikpOyAvLyBmaWxsIHRoZSBvdGhlciByZWN0YW5nbGUgaWYgaXQncyB0aGVyZQoKICAgICAgICAgIGlmICh4MiAhPSB4Mm9sZCkgewogICAgICAgICAgICBjdHgubGluZVRvKGF4aXN4LnAyYyh4MiksIGF4aXN5LnAyYyh5MikpOwogICAgICAgICAgICBjdHgubGluZVRvKGF4aXN4LnAyYyh4Mm9sZCksIGF4aXN5LnAyYyh5MikpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgY3R4LnNhdmUoKTsKICAgICAgY3R4LnRyYW5zbGF0ZShwbG90T2Zmc2V0LmxlZnQsIHBsb3RPZmZzZXQudG9wKTsKICAgICAgY3R4LmxpbmVKb2luID0gInJvdW5kIjsKICAgICAgdmFyIGx3ID0gc2VyaWVzLmxpbmVzLmxpbmVXaWR0aCwKICAgICAgICAgIHN3ID0gc2VyaWVzLnNoYWRvd1NpemU7IC8vIEZJWE1FOiBjb25zaWRlciBhbm90aGVyIGZvcm0gb2Ygc2hhZG93IHdoZW4gZmlsbGluZyBpcyB0dXJuZWQgb24KCiAgICAgIGlmIChsdyA+IDAgJiYgc3cgPiAwKSB7CiAgICAgICAgLy8gZHJhdyBzaGFkb3cgYXMgYSB0aGljayBhbmQgdGhpbiBsaW5lIHdpdGggdHJhbnNwYXJlbmN5CiAgICAgICAgY3R4LmxpbmVXaWR0aCA9IHN3OwogICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICJyZ2JhKDAsMCwwLDAuMSkiOyAvLyBwb3NpdGlvbiBzaGFkb3cgYXQgYW5nbGUgZnJvbSB0aGUgbWlkIG9mIGxpbmUKCiAgICAgICAgdmFyIGFuZ2xlID0gTWF0aC5QSSAvIDE4OwogICAgICAgIHBsb3RMaW5lKHNlcmllcy5kYXRhcG9pbnRzLCBNYXRoLnNpbihhbmdsZSkgKiAobHcgLyAyICsgc3cgLyAyKSwgTWF0aC5jb3MoYW5nbGUpICogKGx3IC8gMiArIHN3IC8gMiksIHNlcmllcy54YXhpcywgc2VyaWVzLnlheGlzKTsKICAgICAgICBjdHgubGluZVdpZHRoID0gc3cgLyAyOwogICAgICAgIHBsb3RMaW5lKHNlcmllcy5kYXRhcG9pbnRzLCBNYXRoLnNpbihhbmdsZSkgKiAobHcgLyAyICsgc3cgLyA0KSwgTWF0aC5jb3MoYW5nbGUpICogKGx3IC8gMiArIHN3IC8gNCksIHNlcmllcy54YXhpcywgc2VyaWVzLnlheGlzKTsKICAgICAgfQoKICAgICAgY3R4LmxpbmVXaWR0aCA9IGx3OwogICAgICBjdHguc3Ryb2tlU3R5bGUgPSBzZXJpZXMuY29sb3I7CiAgICAgIHZhciBmaWxsU3R5bGUgPSBnZXRGaWxsU3R5bGUoc2VyaWVzLmxpbmVzLCBzZXJpZXMuY29sb3IsIDAsIHBsb3RIZWlnaHQpOwoKICAgICAgaWYgKGZpbGxTdHlsZSkgewogICAgICAgIGN0eC5maWxsU3R5bGUgPSBmaWxsU3R5bGU7CiAgICAgICAgcGxvdExpbmVBcmVhKHNlcmllcy5kYXRhcG9pbnRzLCBzZXJpZXMueGF4aXMsIHNlcmllcy55YXhpcyk7CiAgICAgIH0KCiAgICAgIGlmIChsdyA+IDApIHBsb3RMaW5lKHNlcmllcy5kYXRhcG9pbnRzLCAwLCAwLCBzZXJpZXMueGF4aXMsIHNlcmllcy55YXhpcyk7CiAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICB9CgogICAgZnVuY3Rpb24gZHJhd1Nlcmllc1BvaW50cyhzZXJpZXMpIHsKICAgICAgZnVuY3Rpb24gcGxvdFBvaW50cyhkYXRhcG9pbnRzLCByYWRpdXMsIGZpbGxTdHlsZSwgb2Zmc2V0LCBzaGFkb3csIGF4aXN4LCBheGlzeSwgc3ltYm9sKSB7CiAgICAgICAgdmFyIHBvaW50cyA9IGRhdGFwb2ludHMucG9pbnRzLAogICAgICAgICAgICBwcyA9IGRhdGFwb2ludHMucG9pbnRzaXplOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBvaW50cy5sZW5ndGg7IGkgKz0gcHMpIHsKICAgICAgICAgIHZhciB4ID0gcG9pbnRzW2ldLAogICAgICAgICAgICAgIHkgPSBwb2ludHNbaSArIDFdOwogICAgICAgICAgaWYgKHggPT0gbnVsbCB8fCB4IDwgYXhpc3gubWluIHx8IHggPiBheGlzeC5tYXggfHwgeSA8IGF4aXN5Lm1pbiB8fCB5ID4gYXhpc3kubWF4KSBjb250aW51ZTsKICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgIHggPSBheGlzeC5wMmMoeCk7CiAgICAgICAgICB5ID0gYXhpc3kucDJjKHkpICsgb2Zmc2V0OwogICAgICAgICAgaWYgKHN5bWJvbCA9PSAiY2lyY2xlIikgY3R4LmFyYyh4LCB5LCByYWRpdXMsIDAsIHNoYWRvdyA/IE1hdGguUEkgOiBNYXRoLlBJICogMiwgZmFsc2UpO2Vsc2Ugc3ltYm9sKGN0eCwgeCwgeSwgcmFkaXVzLCBzaGFkb3cpOwogICAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwoKICAgICAgICAgIGlmIChmaWxsU3R5bGUpIHsKICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGZpbGxTdHlsZTsKICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgIH0KCiAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgfQogICAgICB9CgogICAgICBjdHguc2F2ZSgpOwogICAgICBjdHgudHJhbnNsYXRlKHBsb3RPZmZzZXQubGVmdCwgcGxvdE9mZnNldC50b3ApOwogICAgICB2YXIgbHcgPSBzZXJpZXMucG9pbnRzLmxpbmVXaWR0aCwKICAgICAgICAgIHN3ID0gc2VyaWVzLnNoYWRvd1NpemUsCiAgICAgICAgICByYWRpdXMgPSBzZXJpZXMucG9pbnRzLnJhZGl1cywKICAgICAgICAgIHN5bWJvbCA9IHNlcmllcy5wb2ludHMuc3ltYm9sOyAvLyBJZiB0aGUgdXNlciBzZXRzIHRoZSBsaW5lIHdpZHRoIHRvIDAsIHdlIGNoYW5nZSBpdCB0byBhIHZlcnkKICAgICAgLy8gc21hbGwgdmFsdWUuIEEgbGluZSB3aWR0aCBvZiAwIHNlZW1zIHRvIGZvcmNlIHRoZSBkZWZhdWx0IG9mIDEuCiAgICAgIC8vIERvaW5nIHRoZSBjb25kaXRpb25hbCBoZXJlIGFsbG93cyB0aGUgc2hhZG93IHNldHRpbmcgdG8gc3RpbGwgYmUKICAgICAgLy8gb3B0aW9uYWwgZXZlbiB3aXRoIGEgbGluZVdpZHRoIG9mIDAuCgogICAgICBpZiAobHcgPT0gMCkgbHcgPSAwLjAwMDE7CgogICAgICBpZiAobHcgPiAwICYmIHN3ID4gMCkgewogICAgICAgIC8vIGRyYXcgc2hhZG93IGluIHR3byBzdGVwcwogICAgICAgIHZhciB3ID0gc3cgLyAyOwogICAgICAgIGN0eC5saW5lV2lkdGggPSB3OwogICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICJyZ2JhKDAsMCwwLDAuMSkiOwogICAgICAgIHBsb3RQb2ludHMoc2VyaWVzLmRhdGFwb2ludHMsIHJhZGl1cywgbnVsbCwgdyArIHcgLyAyLCB0cnVlLCBzZXJpZXMueGF4aXMsIHNlcmllcy55YXhpcywgc3ltYm9sKTsKICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAicmdiYSgwLDAsMCwwLjIpIjsKICAgICAgICBwbG90UG9pbnRzKHNlcmllcy5kYXRhcG9pbnRzLCByYWRpdXMsIG51bGwsIHcgLyAyLCB0cnVlLCBzZXJpZXMueGF4aXMsIHNlcmllcy55YXhpcywgc3ltYm9sKTsKICAgICAgfQoKICAgICAgY3R4LmxpbmVXaWR0aCA9IGx3OwogICAgICBjdHguc3Ryb2tlU3R5bGUgPSBzZXJpZXMuY29sb3I7CiAgICAgIHBsb3RQb2ludHMoc2VyaWVzLmRhdGFwb2ludHMsIHJhZGl1cywgZ2V0RmlsbFN0eWxlKHNlcmllcy5wb2ludHMsIHNlcmllcy5jb2xvciksIDAsIGZhbHNlLCBzZXJpZXMueGF4aXMsIHNlcmllcy55YXhpcywgc3ltYm9sKTsKICAgICAgY3R4LnJlc3RvcmUoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBkcmF3QmFyKHgsIHksIGIsIGJhckxlZnQsIGJhclJpZ2h0LCBmaWxsU3R5bGVDYWxsYmFjaywgYXhpc3gsIGF4aXN5LCBjLCBob3Jpem9udGFsLCBsaW5lV2lkdGgpIHsKICAgICAgdmFyIGxlZnQsIHJpZ2h0LCBib3R0b20sIHRvcCwgZHJhd0xlZnQsIGRyYXdSaWdodCwgZHJhd1RvcCwgZHJhd0JvdHRvbSwgdG1wOyAvLyBpbiBob3Jpem9udGFsIG1vZGUsIHdlIHN0YXJ0IHRoZSBiYXIgZnJvbSB0aGUgbGVmdAogICAgICAvLyBpbnN0ZWFkIG9mIGZyb20gdGhlIGJvdHRvbSBzbyBpdCBhcHBlYXJzIHRvIGJlCiAgICAgIC8vIGhvcml6b250YWwgcmF0aGVyIHRoYW4gdmVydGljYWwKCiAgICAgIGlmIChob3Jpem9udGFsKSB7CiAgICAgICAgZHJhd0JvdHRvbSA9IGRyYXdSaWdodCA9IGRyYXdUb3AgPSB0cnVlOwogICAgICAgIGRyYXdMZWZ0ID0gZmFsc2U7CiAgICAgICAgbGVmdCA9IGI7CiAgICAgICAgcmlnaHQgPSB4OwogICAgICAgIHRvcCA9IHkgKyBiYXJMZWZ0OwogICAgICAgIGJvdHRvbSA9IHkgKyBiYXJSaWdodDsgLy8gYWNjb3VudCBmb3IgbmVnYXRpdmUgYmFycwoKICAgICAgICBpZiAocmlnaHQgPCBsZWZ0KSB7CiAgICAgICAgICB0bXAgPSByaWdodDsKICAgICAgICAgIHJpZ2h0ID0gbGVmdDsKICAgICAgICAgIGxlZnQgPSB0bXA7CiAgICAgICAgICBkcmF3TGVmdCA9IHRydWU7CiAgICAgICAgICBkcmF3UmlnaHQgPSBmYWxzZTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZHJhd0xlZnQgPSBkcmF3UmlnaHQgPSBkcmF3VG9wID0gdHJ1ZTsKICAgICAgICBkcmF3Qm90dG9tID0gZmFsc2U7CiAgICAgICAgbGVmdCA9IHggKyBiYXJMZWZ0OwogICAgICAgIHJpZ2h0ID0geCArIGJhclJpZ2h0OwogICAgICAgIGJvdHRvbSA9IGI7CiAgICAgICAgdG9wID0geTsgLy8gYWNjb3VudCBmb3IgbmVnYXRpdmUgYmFycwoKICAgICAgICBpZiAodG9wIDwgYm90dG9tKSB7CiAgICAgICAgICB0bXAgPSB0b3A7CiAgICAgICAgICB0b3AgPSBib3R0b207CiAgICAgICAgICBib3R0b20gPSB0bXA7CiAgICAgICAgICBkcmF3Qm90dG9tID0gdHJ1ZTsKICAgICAgICAgIGRyYXdUb3AgPSBmYWxzZTsKICAgICAgICB9CiAgICAgIH0gLy8gY2xpcAoKCiAgICAgIGlmIChyaWdodCA8IGF4aXN4Lm1pbiB8fCBsZWZ0ID4gYXhpc3gubWF4IHx8IHRvcCA8IGF4aXN5Lm1pbiB8fCBib3R0b20gPiBheGlzeS5tYXgpIHJldHVybjsKCiAgICAgIGlmIChsZWZ0IDwgYXhpc3gubWluKSB7CiAgICAgICAgbGVmdCA9IGF4aXN4Lm1pbjsKICAgICAgICBkcmF3TGVmdCA9IGZhbHNlOwogICAgICB9CgogICAgICBpZiAocmlnaHQgPiBheGlzeC5tYXgpIHsKICAgICAgICByaWdodCA9IGF4aXN4Lm1heDsKICAgICAgICBkcmF3UmlnaHQgPSBmYWxzZTsKICAgICAgfQoKICAgICAgaWYgKGJvdHRvbSA8IGF4aXN5Lm1pbikgewogICAgICAgIGJvdHRvbSA9IGF4aXN5Lm1pbjsKICAgICAgICBkcmF3Qm90dG9tID0gZmFsc2U7CiAgICAgIH0KCiAgICAgIGlmICh0b3AgPiBheGlzeS5tYXgpIHsKICAgICAgICB0b3AgPSBheGlzeS5tYXg7CiAgICAgICAgZHJhd1RvcCA9IGZhbHNlOwogICAgICB9CgogICAgICBsZWZ0ID0gYXhpc3gucDJjKGxlZnQpOwogICAgICBib3R0b20gPSBheGlzeS5wMmMoYm90dG9tKTsKICAgICAgcmlnaHQgPSBheGlzeC5wMmMocmlnaHQpOwogICAgICB0b3AgPSBheGlzeS5wMmModG9wKTsgLy8gZmlsbCB0aGUgYmFyCgogICAgICBpZiAoZmlsbFN0eWxlQ2FsbGJhY2spIHsKICAgICAgICBjLmZpbGxTdHlsZSA9IGZpbGxTdHlsZUNhbGxiYWNrKGJvdHRvbSwgdG9wKTsKICAgICAgICBjLmZpbGxSZWN0KGxlZnQsIHRvcCwgcmlnaHQgLSBsZWZ0LCBib3R0b20gLSB0b3ApOwogICAgICB9IC8vIGRyYXcgb3V0bGluZQoKCiAgICAgIGlmIChsaW5lV2lkdGggPiAwICYmIChkcmF3TGVmdCB8fCBkcmF3UmlnaHQgfHwgZHJhd1RvcCB8fCBkcmF3Qm90dG9tKSkgewogICAgICAgIGMuYmVnaW5QYXRoKCk7IC8vIEZJWE1FOiBpbmxpbmUgbW92ZVRvIGlzIGJ1Z2d5IHdpdGggZXhjYW52YXMKCiAgICAgICAgYy5tb3ZlVG8obGVmdCwgYm90dG9tKTsKICAgICAgICBpZiAoZHJhd0xlZnQpIGMubGluZVRvKGxlZnQsIHRvcCk7ZWxzZSBjLm1vdmVUbyhsZWZ0LCB0b3ApOwogICAgICAgIGlmIChkcmF3VG9wKSBjLmxpbmVUbyhyaWdodCwgdG9wKTtlbHNlIGMubW92ZVRvKHJpZ2h0LCB0b3ApOwogICAgICAgIGlmIChkcmF3UmlnaHQpIGMubGluZVRvKHJpZ2h0LCBib3R0b20pO2Vsc2UgYy5tb3ZlVG8ocmlnaHQsIGJvdHRvbSk7CiAgICAgICAgaWYgKGRyYXdCb3R0b20pIGMubGluZVRvKGxlZnQsIGJvdHRvbSk7ZWxzZSBjLm1vdmVUbyhsZWZ0LCBib3R0b20pOwogICAgICAgIGMuc3Ryb2tlKCk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBkcmF3U2VyaWVzQmFycyhzZXJpZXMpIHsKICAgICAgZnVuY3Rpb24gcGxvdEJhcnMoZGF0YXBvaW50cywgYmFyTGVmdCwgYmFyUmlnaHQsIGZpbGxTdHlsZUNhbGxiYWNrLCBheGlzeCwgYXhpc3kpIHsKICAgICAgICB2YXIgcG9pbnRzID0gZGF0YXBvaW50cy5wb2ludHMsCiAgICAgICAgICAgIHBzID0gZGF0YXBvaW50cy5wb2ludHNpemU7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcG9pbnRzLmxlbmd0aDsgaSArPSBwcykgewogICAgICAgICAgaWYgKHBvaW50c1tpXSA9PSBudWxsKSBjb250aW51ZTsKICAgICAgICAgIGRyYXdCYXIocG9pbnRzW2ldLCBwb2ludHNbaSArIDFdLCBwb2ludHNbaSArIDJdLCBiYXJMZWZ0LCBiYXJSaWdodCwgZmlsbFN0eWxlQ2FsbGJhY2ssIGF4aXN4LCBheGlzeSwgY3R4LCBzZXJpZXMuYmFycy5ob3Jpem9udGFsLCBzZXJpZXMuYmFycy5saW5lV2lkdGgpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgY3R4LnNhdmUoKTsKICAgICAgY3R4LnRyYW5zbGF0ZShwbG90T2Zmc2V0LmxlZnQsIHBsb3RPZmZzZXQudG9wKTsgLy8gRklYTUU6IGZpZ3VyZSBvdXQgYSB3YXkgdG8gYWRkIHNoYWRvd3MgKGZvciBpbnN0YW5jZSBhbG9uZyB0aGUgcmlnaHQgZWRnZSkKCiAgICAgIGN0eC5saW5lV2lkdGggPSBzZXJpZXMuYmFycy5saW5lV2lkdGg7CiAgICAgIGN0eC5zdHJva2VTdHlsZSA9IHNlcmllcy5jb2xvcjsKICAgICAgdmFyIGJhckxlZnQ7CgogICAgICBzd2l0Y2ggKHNlcmllcy5iYXJzLmFsaWduKSB7CiAgICAgICAgY2FzZSAibGVmdCI6CiAgICAgICAgICBiYXJMZWZ0ID0gMDsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICJyaWdodCI6CiAgICAgICAgICBiYXJMZWZ0ID0gLXNlcmllcy5iYXJzLmJhcldpZHRoOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICBiYXJMZWZ0ID0gLXNlcmllcy5iYXJzLmJhcldpZHRoIC8gMjsKICAgICAgfQoKICAgICAgdmFyIGZpbGxTdHlsZUNhbGxiYWNrID0gc2VyaWVzLmJhcnMuZmlsbCA/IGZ1bmN0aW9uIChib3R0b20sIHRvcCkgewogICAgICAgIHJldHVybiBnZXRGaWxsU3R5bGUoc2VyaWVzLmJhcnMsIHNlcmllcy5jb2xvciwgYm90dG9tLCB0b3ApOwogICAgICB9IDogbnVsbDsKICAgICAgcGxvdEJhcnMoc2VyaWVzLmRhdGFwb2ludHMsIGJhckxlZnQsIGJhckxlZnQgKyBzZXJpZXMuYmFycy5iYXJXaWR0aCwgZmlsbFN0eWxlQ2FsbGJhY2ssIHNlcmllcy54YXhpcywgc2VyaWVzLnlheGlzKTsKICAgICAgY3R4LnJlc3RvcmUoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRGaWxsU3R5bGUoZmlsbG9wdGlvbnMsIHNlcmllc0NvbG9yLCBib3R0b20sIHRvcCkgewogICAgICB2YXIgZmlsbCA9IGZpbGxvcHRpb25zLmZpbGw7CiAgICAgIGlmICghZmlsbCkgcmV0dXJuIG51bGw7CiAgICAgIGlmIChmaWxsb3B0aW9ucy5maWxsQ29sb3IpIHJldHVybiBnZXRDb2xvck9yR3JhZGllbnQoZmlsbG9wdGlvbnMuZmlsbENvbG9yLCBib3R0b20sIHRvcCwgc2VyaWVzQ29sb3IpOwogICAgICB2YXIgYyA9ICQuY29sb3IucGFyc2Uoc2VyaWVzQ29sb3IpOwogICAgICBjLmEgPSB0eXBlb2YgZmlsbCA9PSAibnVtYmVyIiA/IGZpbGwgOiAwLjQ7CiAgICAgIGMubm9ybWFsaXplKCk7CiAgICAgIHJldHVybiBjLnRvU3RyaW5nKCk7CiAgICB9CgogICAgZnVuY3Rpb24gaW5zZXJ0TGVnZW5kKCkgewogICAgICBpZiAob3B0aW9ucy5sZWdlbmQuY29udGFpbmVyICE9IG51bGwpIHsKICAgICAgICAkKG9wdGlvbnMubGVnZW5kLmNvbnRhaW5lcikuaHRtbCgiIik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcGxhY2Vob2xkZXIuZmluZCgiLmxlZ2VuZCIpLnJlbW92ZSgpOwogICAgICB9CgogICAgICBpZiAoIW9wdGlvbnMubGVnZW5kLnNob3cpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBmcmFnbWVudHMgPSBbXSwKICAgICAgICAgIGVudHJpZXMgPSBbXSwKICAgICAgICAgIHJvd1N0YXJ0ZWQgPSBmYWxzZSwKICAgICAgICAgIGxmID0gb3B0aW9ucy5sZWdlbmQubGFiZWxGb3JtYXR0ZXIsCiAgICAgICAgICBzLAogICAgICAgICAgbGFiZWw7IC8vIEJ1aWxkIGEgbGlzdCBvZiBsZWdlbmQgZW50cmllcywgd2l0aCBlYWNoIGhhdmluZyBhIGxhYmVsIGFuZCBhIGNvbG9yCgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNlcmllcy5sZW5ndGg7ICsraSkgewogICAgICAgIHMgPSBzZXJpZXNbaV07CgogICAgICAgIGlmIChzLmxhYmVsKSB7CiAgICAgICAgICBsYWJlbCA9IGxmID8gbGYocy5sYWJlbCwgcykgOiBzLmxhYmVsOwoKICAgICAgICAgIGlmIChsYWJlbCkgewogICAgICAgICAgICBlbnRyaWVzLnB1c2goewogICAgICAgICAgICAgIGxhYmVsOiBsYWJlbCwKICAgICAgICAgICAgICBjb2xvcjogcy5jb2xvcgogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gLy8gU29ydCB0aGUgbGVnZW5kIHVzaW5nIGVpdGhlciB0aGUgZGVmYXVsdCBvciBhIGN1c3RvbSBjb21wYXJhdG9yCgoKICAgICAgaWYgKG9wdGlvbnMubGVnZW5kLnNvcnRlZCkgewogICAgICAgIGlmICgkLmlzRnVuY3Rpb24ob3B0aW9ucy5sZWdlbmQuc29ydGVkKSkgewogICAgICAgICAgZW50cmllcy5zb3J0KG9wdGlvbnMubGVnZW5kLnNvcnRlZCk7CiAgICAgICAgfSBlbHNlIGlmIChvcHRpb25zLmxlZ2VuZC5zb3J0ZWQgPT0gInJldmVyc2UiKSB7CiAgICAgICAgICBlbnRyaWVzLnJldmVyc2UoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIGFzY2VuZGluZyA9IG9wdGlvbnMubGVnZW5kLnNvcnRlZCAhPSAiZGVzY2VuZGluZyI7CiAgICAgICAgICBlbnRyaWVzLnNvcnQoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIGEubGFiZWwgPT0gYi5sYWJlbCA/IDAgOiBhLmxhYmVsIDwgYi5sYWJlbCAhPSBhc2NlbmRpbmcgPyAxIDogLTEgLy8gTG9naWNhbCBYT1IKICAgICAgICAgICAgOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9IC8vIEdlbmVyYXRlIG1hcmt1cCBmb3IgdGhlIGxpc3Qgb2YgZW50cmllcywgaW4gdGhlaXIgZmluYWwgb3JkZXIKCgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGVudHJpZXMubGVuZ3RoOyArK2kpIHsKICAgICAgICB2YXIgZW50cnkgPSBlbnRyaWVzW2ldOwoKICAgICAgICBpZiAoaSAlIG9wdGlvbnMubGVnZW5kLm5vQ29sdW1ucyA9PSAwKSB7CiAgICAgICAgICBpZiAocm93U3RhcnRlZCkgZnJhZ21lbnRzLnB1c2goJzwvdHI+Jyk7CiAgICAgICAgICBmcmFnbWVudHMucHVzaCgnPHRyPicpOwogICAgICAgICAgcm93U3RhcnRlZCA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICBmcmFnbWVudHMucHVzaCgnPHRkIGNsYXNzPSJsZWdlbmRDb2xvckJveCI+PGRpdiBzdHlsZT0iYm9yZGVyOjFweCBzb2xpZCAnICsgb3B0aW9ucy5sZWdlbmQubGFiZWxCb3hCb3JkZXJDb2xvciArICc7cGFkZGluZzoxcHgiPjxkaXYgc3R5bGU9IndpZHRoOjRweDtoZWlnaHQ6MDtib3JkZXI6NXB4IHNvbGlkICcgKyBlbnRyeS5jb2xvciArICc7b3ZlcmZsb3c6aGlkZGVuIj48L2Rpdj48L2Rpdj48L3RkPicgKyAnPHRkIGNsYXNzPSJsZWdlbmRMYWJlbCIgZGF0YS10ZXN0LXN1Ymo9ImZsb3RMZWdlbmRMYWJlbCI+JyArIGVudHJ5LmxhYmVsICsgJzwvdGQ+Jyk7CiAgICAgIH0KCiAgICAgIGlmIChyb3dTdGFydGVkKSBmcmFnbWVudHMucHVzaCgnPC90cj4nKTsKICAgICAgaWYgKGZyYWdtZW50cy5sZW5ndGggPT0gMCkgcmV0dXJuOwogICAgICB2YXIgdGFibGUgPSAnPHRhYmxlIHN0eWxlPSJmb250LXNpemU6c21hbGxlcjtjb2xvcjonICsgb3B0aW9ucy5ncmlkLmNvbG9yICsgJyI+JyArIGZyYWdtZW50cy5qb2luKCIiKSArICc8L3RhYmxlPic7CiAgICAgIGlmIChvcHRpb25zLmxlZ2VuZC5jb250YWluZXIgIT0gbnVsbCkgJChvcHRpb25zLmxlZ2VuZC5jb250YWluZXIpLmh0bWwodGFibGUpO2Vsc2UgewogICAgICAgIHZhciBwb3MgPSAiIiwKICAgICAgICAgICAgcCA9IG9wdGlvbnMubGVnZW5kLnBvc2l0aW9uLAogICAgICAgICAgICBtID0gb3B0aW9ucy5sZWdlbmQubWFyZ2luOwogICAgICAgIGlmIChtWzBdID09IG51bGwpIG0gPSBbbSwgbV07CiAgICAgICAgaWYgKHAuY2hhckF0KDApID09ICJuIikgcG9zICs9ICd0b3A6JyArIChtWzFdICsgcGxvdE9mZnNldC50b3ApICsgJ3B4Oyc7ZWxzZSBpZiAocC5jaGFyQXQoMCkgPT0gInMiKSBwb3MgKz0gJ2JvdHRvbTonICsgKG1bMV0gKyBwbG90T2Zmc2V0LmJvdHRvbSkgKyAncHg7JzsKICAgICAgICBpZiAocC5jaGFyQXQoMSkgPT0gImUiKSBwb3MgKz0gJ3JpZ2h0OicgKyAobVswXSArIHBsb3RPZmZzZXQucmlnaHQpICsgJ3B4Oyc7ZWxzZSBpZiAocC5jaGFyQXQoMSkgPT0gInciKSBwb3MgKz0gJ2xlZnQ6JyArIChtWzBdICsgcGxvdE9mZnNldC5sZWZ0KSArICdweDsnOwogICAgICAgIHZhciBsZWdlbmQgPSAkKCc8ZGl2IGNsYXNzPSJsZWdlbmQiPicgKyB0YWJsZS5yZXBsYWNlKCdzdHlsZT0iJywgJ3N0eWxlPSJwb3NpdGlvbjphYnNvbHV0ZTsnICsgcG9zICsgJzsnKSArICc8L2Rpdj4nKS5hcHBlbmRUbyhwbGFjZWhvbGRlcik7CgogICAgICAgIGlmIChvcHRpb25zLmxlZ2VuZC5iYWNrZ3JvdW5kT3BhY2l0eSAhPSAwLjApIHsKICAgICAgICAgIC8vIHB1dCBpbiB0aGUgdHJhbnNwYXJlbnQgYmFja2dyb3VuZAogICAgICAgICAgLy8gc2VwYXJhdGVseSB0byBhdm9pZCBibGVuZGVkIGxhYmVscyBhbmQKICAgICAgICAgIC8vIGxhYmVsIGJveGVzCiAgICAgICAgICB2YXIgYyA9IG9wdGlvbnMubGVnZW5kLmJhY2tncm91bmRDb2xvcjsKCiAgICAgICAgICBpZiAoYyA9PSBudWxsKSB7CiAgICAgICAgICAgIGMgPSBvcHRpb25zLmdyaWQuYmFja2dyb3VuZENvbG9yOwogICAgICAgICAgICBpZiAoYyAmJiB0eXBlb2YgYyA9PSAic3RyaW5nIikgYyA9ICQuY29sb3IucGFyc2UoYyk7ZWxzZSBjID0gJC5jb2xvci5leHRyYWN0KGxlZ2VuZCwgJ2JhY2tncm91bmQtY29sb3InKTsKICAgICAgICAgICAgYy5hID0gMTsKICAgICAgICAgICAgYyA9IGMudG9TdHJpbmcoKTsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgZGl2ID0gbGVnZW5kLmNoaWxkcmVuKCk7CiAgICAgICAgICAkKCc8ZGl2IHN0eWxlPSJwb3NpdGlvbjphYnNvbHV0ZTt3aWR0aDonICsgZGl2LndpZHRoKCkgKyAncHg7aGVpZ2h0OicgKyBkaXYuaGVpZ2h0KCkgKyAncHg7JyArIHBvcyArICdiYWNrZ3JvdW5kLWNvbG9yOicgKyBjICsgJzsiPiA8L2Rpdj4nKS5wcmVwZW5kVG8obGVnZW5kKS5jc3MoJ29wYWNpdHknLCBvcHRpb25zLmxlZ2VuZC5iYWNrZ3JvdW5kT3BhY2l0eSk7CiAgICAgICAgfQogICAgICB9CiAgICB9IC8vIGludGVyYWN0aXZlIGZlYXR1cmVzCgoKICAgIHZhciBoaWdobGlnaHRzID0gW10sCiAgICAgICAgcmVkcmF3VGltZW91dCA9IG51bGw7IC8vIHJldHVybnMgdGhlIGRhdGEgaXRlbSB0aGUgbW91c2UgaXMgb3Zlciwgb3IgbnVsbCBpZiBub25lIGlzIGZvdW5kCgogICAgZnVuY3Rpb24gZmluZE5lYXJieUl0ZW0obW91c2VYLCBtb3VzZVksIHNlcmllc0ZpbHRlcikgewogICAgICB2YXIgbWF4RGlzdGFuY2UgPSBvcHRpb25zLmdyaWQubW91c2VBY3RpdmVSYWRpdXMsCiAgICAgICAgICBzbWFsbGVzdERpc3RhbmNlID0gbWF4RGlzdGFuY2UgKiBtYXhEaXN0YW5jZSArIDEsCiAgICAgICAgICBpdGVtID0gbnVsbCwKICAgICAgICAgIGZvdW5kUG9pbnQgPSBmYWxzZSwKICAgICAgICAgIGksCiAgICAgICAgICBqLAogICAgICAgICAgcHM7CgogICAgICBmb3IgKGkgPSBzZXJpZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpIHsKICAgICAgICBpZiAoIXNlcmllc0ZpbHRlcihzZXJpZXNbaV0pKSBjb250aW51ZTsKICAgICAgICB2YXIgcyA9IHNlcmllc1tpXSwKICAgICAgICAgICAgYXhpc3ggPSBzLnhheGlzLAogICAgICAgICAgICBheGlzeSA9IHMueWF4aXMsCiAgICAgICAgICAgIHBvaW50cyA9IHMuZGF0YXBvaW50cy5wb2ludHMsCiAgICAgICAgICAgIG14ID0gYXhpc3guYzJwKG1vdXNlWCksCiAgICAgICAgICAgIC8vIHByZWNvbXB1dGUgc29tZSBzdHVmZiB0byBtYWtlIHRoZSBsb29wIGZhc3RlcgogICAgICAgIG15ID0gYXhpc3kuYzJwKG1vdXNlWSksCiAgICAgICAgICAgIG1heHggPSBtYXhEaXN0YW5jZSAvIGF4aXN4LnNjYWxlLAogICAgICAgICAgICBtYXh5ID0gbWF4RGlzdGFuY2UgLyBheGlzeS5zY2FsZTsKICAgICAgICBwcyA9IHMuZGF0YXBvaW50cy5wb2ludHNpemU7IC8vIHdpdGggaW52ZXJzZSB0cmFuc2Zvcm1zLCB3ZSBjYW4ndCB1c2UgdGhlIG1heHgvbWF4eQogICAgICAgIC8vIG9wdGltaXphdGlvbiwgc2FkbHkKCiAgICAgICAgaWYgKGF4aXN4Lm9wdGlvbnMuaW52ZXJzZVRyYW5zZm9ybSkgbWF4eCA9IE51bWJlci5NQVhfVkFMVUU7CiAgICAgICAgaWYgKGF4aXN5Lm9wdGlvbnMuaW52ZXJzZVRyYW5zZm9ybSkgbWF4eSA9IE51bWJlci5NQVhfVkFMVUU7CgogICAgICAgIGlmIChzLmxpbmVzLnNob3cgfHwgcy5wb2ludHMuc2hvdykgewogICAgICAgICAgZm9yIChqID0gMDsgaiA8IHBvaW50cy5sZW5ndGg7IGogKz0gcHMpIHsKICAgICAgICAgICAgdmFyIHggPSBwb2ludHNbal0sCiAgICAgICAgICAgICAgICB5ID0gcG9pbnRzW2ogKyAxXTsKICAgICAgICAgICAgaWYgKHggPT0gbnVsbCkgY29udGludWU7IC8vIEZvciBwb2ludHMgYW5kIGxpbmVzLCB0aGUgY3Vyc29yIG11c3QgYmUgd2l0aGluIGEKICAgICAgICAgICAgLy8gY2VydGFpbiBkaXN0YW5jZSB0byB0aGUgZGF0YSBwb2ludAoKICAgICAgICAgICAgaWYgKHggLSBteCA+IG1heHggfHwgeCAtIG14IDwgLW1heHggfHwgeSAtIG15ID4gbWF4eSB8fCB5IC0gbXkgPCAtbWF4eSkgY29udGludWU7IC8vIFdlIGhhdmUgdG8gY2FsY3VsYXRlIGRpc3RhbmNlcyBpbiBwaXhlbHMsIG5vdCBpbgogICAgICAgICAgICAvLyBkYXRhIHVuaXRzLCBiZWNhdXNlIHRoZSBzY2FsZXMgb2YgdGhlIGF4ZXMgbWF5IGJlIGRpZmZlcmVudAoKICAgICAgICAgICAgdmFyIGR4ID0gTWF0aC5hYnMoYXhpc3gucDJjKHgpIC0gbW91c2VYKSwKICAgICAgICAgICAgICAgIGR5ID0gTWF0aC5hYnMoYXhpc3kucDJjKHkpIC0gbW91c2VZKSwKICAgICAgICAgICAgICAgIGRpc3QgPSBkeCAqIGR4ICsgZHkgKiBkeTsgLy8gd2Ugc2F2ZSB0aGUgc3FydAogICAgICAgICAgICAvLyB1c2UgPD0gdG8gZW5zdXJlIGxhc3QgcG9pbnQgdGFrZXMgcHJlY2VkZW5jZQogICAgICAgICAgICAvLyAobGFzdCBnZW5lcmFsbHkgbWVhbnMgb24gdG9wIG9mKQoKICAgICAgICAgICAgaWYgKGRpc3QgPCBzbWFsbGVzdERpc3RhbmNlKSB7CiAgICAgICAgICAgICAgc21hbGxlc3REaXN0YW5jZSA9IGRpc3Q7CiAgICAgICAgICAgICAgaXRlbSA9IFtpLCBqIC8gcHNdOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAocy5iYXJzLnNob3cgJiYgIWl0ZW0pIHsKICAgICAgICAgIC8vIG5vIG90aGVyIHBvaW50IGNhbiBiZSBuZWFyYnkKICAgICAgICAgIHZhciBiYXJMZWZ0LCBiYXJSaWdodDsKCiAgICAgICAgICBzd2l0Y2ggKHMuYmFycy5hbGlnbikgewogICAgICAgICAgICBjYXNlICJsZWZ0IjoKICAgICAgICAgICAgICBiYXJMZWZ0ID0gMDsKICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgInJpZ2h0IjoKICAgICAgICAgICAgICBiYXJMZWZ0ID0gLXMuYmFycy5iYXJXaWR0aDsKICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgYmFyTGVmdCA9IC1zLmJhcnMuYmFyV2lkdGggLyAyOwogICAgICAgICAgfQoKICAgICAgICAgIGJhclJpZ2h0ID0gYmFyTGVmdCArIHMuYmFycy5iYXJXaWR0aDsKCiAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgcG9pbnRzLmxlbmd0aDsgaiArPSBwcykgewogICAgICAgICAgICB2YXIgeCA9IHBvaW50c1tqXSwKICAgICAgICAgICAgICAgIHkgPSBwb2ludHNbaiArIDFdLAogICAgICAgICAgICAgICAgYiA9IHBvaW50c1tqICsgMl07CiAgICAgICAgICAgIGlmICh4ID09IG51bGwpIGNvbnRpbnVlOyAvLyBmb3IgYSBiYXIgZ3JhcGgsIHRoZSBjdXJzb3IgbXVzdCBiZSBpbnNpZGUgdGhlIGJhcgoKICAgICAgICAgICAgaWYgKHNlcmllc1tpXS5iYXJzLmhvcml6b250YWwgPyBteCA8PSBNYXRoLm1heChiLCB4KSAmJiBteCA+PSBNYXRoLm1pbihiLCB4KSAmJiBteSA+PSB5ICsgYmFyTGVmdCAmJiBteSA8PSB5ICsgYmFyUmlnaHQgOiBteCA+PSB4ICsgYmFyTGVmdCAmJiBteCA8PSB4ICsgYmFyUmlnaHQgJiYgbXkgPj0gTWF0aC5taW4oYiwgeSkgJiYgbXkgPD0gTWF0aC5tYXgoYiwgeSkpIGl0ZW0gPSBbaSwgaiAvIHBzXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChpdGVtKSB7CiAgICAgICAgaSA9IGl0ZW1bMF07CiAgICAgICAgaiA9IGl0ZW1bMV07CiAgICAgICAgcHMgPSBzZXJpZXNbaV0uZGF0YXBvaW50cy5wb2ludHNpemU7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGRhdGFwb2ludDogc2VyaWVzW2ldLmRhdGFwb2ludHMucG9pbnRzLnNsaWNlKGogKiBwcywgKGogKyAxKSAqIHBzKSwKICAgICAgICAgIGRhdGFJbmRleDogaiwKICAgICAgICAgIHNlcmllczogc2VyaWVzW2ldLAogICAgICAgICAgc2VyaWVzSW5kZXg6IGkKICAgICAgICB9OwogICAgICB9CgogICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICBmdW5jdGlvbiBvbk1vdXNlTW92ZShlKSB7CiAgICAgIGlmIChvcHRpb25zLmdyaWQuaG92ZXJhYmxlKSB0cmlnZ2VyQ2xpY2tIb3ZlckV2ZW50KCJwbG90aG92ZXIiLCBlLCBmdW5jdGlvbiAocykgewogICAgICAgIHJldHVybiBzWyJob3ZlcmFibGUiXSAhPSBmYWxzZTsKICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gb25Nb3VzZUxlYXZlKGUpIHsKICAgICAgaWYgKG9wdGlvbnMuZ3JpZC5ob3ZlcmFibGUpIHRyaWdnZXJDbGlja0hvdmVyRXZlbnQoInBsb3Rob3ZlciIsIGUsIGZ1bmN0aW9uIChzKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9KTsKICAgIH0KCiAgICBmdW5jdGlvbiBvbkNsaWNrKGUpIHsKICAgICAgdHJpZ2dlckNsaWNrSG92ZXJFdmVudCgicGxvdGNsaWNrIiwgZSwgZnVuY3Rpb24gKHMpIHsKICAgICAgICByZXR1cm4gc1siY2xpY2thYmxlIl0gIT0gZmFsc2U7CiAgICAgIH0pOwogICAgfSAvLyB0cmlnZ2VyIGNsaWNrIG9yIGhvdmVyIGV2ZW50ICh0aGV5IHNlbmQgdGhlIHNhbWUgcGFyYW1ldGVycwogICAgLy8gc28gd2Ugc2hhcmUgdGhlaXIgY29kZSkKCgogICAgZnVuY3Rpb24gdHJpZ2dlckNsaWNrSG92ZXJFdmVudChldmVudG5hbWUsIGV2ZW50LCBzZXJpZXNGaWx0ZXIpIHsKICAgICAgdmFyIG9mZnNldCA9IGV2ZW50SG9sZGVyLm9mZnNldCgpLAogICAgICAgICAgY2FudmFzWCA9IGV2ZW50LnBhZ2VYIC0gb2Zmc2V0LmxlZnQgLSBwbG90T2Zmc2V0LmxlZnQsCiAgICAgICAgICBjYW52YXNZID0gZXZlbnQucGFnZVkgLSBvZmZzZXQudG9wIC0gcGxvdE9mZnNldC50b3AsCiAgICAgICAgICBwb3MgPSBjYW52YXNUb0F4aXNDb29yZHMoewogICAgICAgIGxlZnQ6IGNhbnZhc1gsCiAgICAgICAgdG9wOiBjYW52YXNZCiAgICAgIH0pOwogICAgICBwb3MucGFnZVggPSBldmVudC5wYWdlWDsKICAgICAgcG9zLnBhZ2VZID0gZXZlbnQucGFnZVk7CiAgICAgIHZhciBpdGVtID0gZmluZE5lYXJieUl0ZW0oY2FudmFzWCwgY2FudmFzWSwgc2VyaWVzRmlsdGVyKTsKCiAgICAgIGlmIChpdGVtKSB7CiAgICAgICAgLy8gZmlsbCBpbiBtb3VzZSBwb3MgZm9yIGFueSBsaXN0ZW5lcnMgb3V0IHRoZXJlCiAgICAgICAgaXRlbS5wYWdlWCA9IHBhcnNlSW50KGl0ZW0uc2VyaWVzLnhheGlzLnAyYyhpdGVtLmRhdGFwb2ludFswXSkgKyBvZmZzZXQubGVmdCArIHBsb3RPZmZzZXQubGVmdCwgMTApOwogICAgICAgIGl0ZW0ucGFnZVkgPSBwYXJzZUludChpdGVtLnNlcmllcy55YXhpcy5wMmMoaXRlbS5kYXRhcG9pbnRbMV0pICsgb2Zmc2V0LnRvcCArIHBsb3RPZmZzZXQudG9wLCAxMCk7CiAgICAgIH0KCiAgICAgIGlmIChvcHRpb25zLmdyaWQuYXV0b0hpZ2hsaWdodCkgewogICAgICAgIC8vIGNsZWFyIGF1dG8taGlnaGxpZ2h0cwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaGlnaGxpZ2h0cy5sZW5ndGg7ICsraSkgewogICAgICAgICAgdmFyIGggPSBoaWdobGlnaHRzW2ldOwogICAgICAgICAgaWYgKGguYXV0byA9PSBldmVudG5hbWUgJiYgIShpdGVtICYmIGguc2VyaWVzID09IGl0ZW0uc2VyaWVzICYmIGgucG9pbnRbMF0gPT0gaXRlbS5kYXRhcG9pbnRbMF0gJiYgaC5wb2ludFsxXSA9PSBpdGVtLmRhdGFwb2ludFsxXSkpIHVuaGlnaGxpZ2h0KGguc2VyaWVzLCBoLnBvaW50KTsKICAgICAgICB9CgogICAgICAgIGlmIChpdGVtKSBoaWdobGlnaHQoaXRlbS5zZXJpZXMsIGl0ZW0uZGF0YXBvaW50LCBldmVudG5hbWUpOwogICAgICB9CgogICAgICBwbGFjZWhvbGRlci50cmlnZ2VyKGV2ZW50bmFtZSwgW3BvcywgaXRlbV0pOwogICAgfQoKICAgIGZ1bmN0aW9uIHRyaWdnZXJSZWRyYXdPdmVybGF5KCkgewogICAgICB2YXIgdCA9IG9wdGlvbnMuaW50ZXJhY3Rpb24ucmVkcmF3T3ZlcmxheUludGVydmFsOwoKICAgICAgaWYgKHQgPT0gLTEpIHsKICAgICAgICAvLyBza2lwIGV2ZW50IHF1ZXVlCiAgICAgICAgZHJhd092ZXJsYXkoKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICghcmVkcmF3VGltZW91dCkgcmVkcmF3VGltZW91dCA9IHNldFRpbWVvdXQoZHJhd092ZXJsYXksIHQpOwogICAgfQoKICAgIGZ1bmN0aW9uIGRyYXdPdmVybGF5KCkgewogICAgICByZWRyYXdUaW1lb3V0ID0gbnVsbDsgLy8gZHJhdyBoaWdobGlnaHRzCgogICAgICBvY3R4LnNhdmUoKTsKICAgICAgb3ZlcmxheS5jbGVhcigpOwogICAgICBvY3R4LnRyYW5zbGF0ZShwbG90T2Zmc2V0LmxlZnQsIHBsb3RPZmZzZXQudG9wKTsKICAgICAgdmFyIGksIGhpOwoKICAgICAgZm9yIChpID0gMDsgaSA8IGhpZ2hsaWdodHMubGVuZ3RoOyArK2kpIHsKICAgICAgICBoaSA9IGhpZ2hsaWdodHNbaV07CiAgICAgICAgaWYgKGhpLnNlcmllcy5iYXJzLnNob3cpIGRyYXdCYXJIaWdobGlnaHQoaGkuc2VyaWVzLCBoaS5wb2ludCk7ZWxzZSBkcmF3UG9pbnRIaWdobGlnaHQoaGkuc2VyaWVzLCBoaS5wb2ludCk7CiAgICAgIH0KCiAgICAgIG9jdHgucmVzdG9yZSgpOwogICAgICBleGVjdXRlSG9va3MoaG9va3MuZHJhd092ZXJsYXksIFtvY3R4XSk7CiAgICB9CgogICAgZnVuY3Rpb24gaGlnaGxpZ2h0KHMsIHBvaW50LCBhdXRvKSB7CiAgICAgIGlmICh0eXBlb2YgcyA9PSAibnVtYmVyIikgcyA9IHNlcmllc1tzXTsKCiAgICAgIGlmICh0eXBlb2YgcG9pbnQgPT0gIm51bWJlciIpIHsKICAgICAgICB2YXIgcHMgPSBzLmRhdGFwb2ludHMucG9pbnRzaXplOwogICAgICAgIHBvaW50ID0gcy5kYXRhcG9pbnRzLnBvaW50cy5zbGljZShwcyAqIHBvaW50LCBwcyAqIChwb2ludCArIDEpKTsKICAgICAgfQoKICAgICAgdmFyIGkgPSBpbmRleE9mSGlnaGxpZ2h0KHMsIHBvaW50KTsKCiAgICAgIGlmIChpID09IC0xKSB7CiAgICAgICAgaGlnaGxpZ2h0cy5wdXNoKHsKICAgICAgICAgIHNlcmllczogcywKICAgICAgICAgIHBvaW50OiBwb2ludCwKICAgICAgICAgIGF1dG86IGF1dG8KICAgICAgICB9KTsKICAgICAgICB0cmlnZ2VyUmVkcmF3T3ZlcmxheSgpOwogICAgICB9IGVsc2UgaWYgKCFhdXRvKSBoaWdobGlnaHRzW2ldLmF1dG8gPSBmYWxzZTsKICAgIH0KCiAgICBmdW5jdGlvbiB1bmhpZ2hsaWdodChzLCBwb2ludCkgewogICAgICBpZiAocyA9PSBudWxsICYmIHBvaW50ID09IG51bGwpIHsKICAgICAgICBoaWdobGlnaHRzID0gW107CiAgICAgICAgdHJpZ2dlclJlZHJhd092ZXJsYXkoKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICh0eXBlb2YgcyA9PSAibnVtYmVyIikgcyA9IHNlcmllc1tzXTsKCiAgICAgIGlmICh0eXBlb2YgcG9pbnQgPT0gIm51bWJlciIpIHsKICAgICAgICB2YXIgcHMgPSBzLmRhdGFwb2ludHMucG9pbnRzaXplOwogICAgICAgIHBvaW50ID0gcy5kYXRhcG9pbnRzLnBvaW50cy5zbGljZShwcyAqIHBvaW50LCBwcyAqIChwb2ludCArIDEpKTsKICAgICAgfQoKICAgICAgdmFyIGkgPSBpbmRleE9mSGlnaGxpZ2h0KHMsIHBvaW50KTsKCiAgICAgIGlmIChpICE9IC0xKSB7CiAgICAgICAgaGlnaGxpZ2h0cy5zcGxpY2UoaSwgMSk7CiAgICAgICAgdHJpZ2dlclJlZHJhd092ZXJsYXkoKTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGluZGV4T2ZIaWdobGlnaHQocywgcCkgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGhpZ2hsaWdodHMubGVuZ3RoOyArK2kpIHsKICAgICAgICB2YXIgaCA9IGhpZ2hsaWdodHNbaV07CiAgICAgICAgaWYgKGguc2VyaWVzID09IHMgJiYgaC5wb2ludFswXSA9PSBwWzBdICYmIGgucG9pbnRbMV0gPT0gcFsxXSkgcmV0dXJuIGk7CiAgICAgIH0KCiAgICAgIHJldHVybiAtMTsKICAgIH0KCiAgICBmdW5jdGlvbiBkcmF3UG9pbnRIaWdobGlnaHQoc2VyaWVzLCBwb2ludCkgewogICAgICB2YXIgeCA9IHBvaW50WzBdLAogICAgICAgICAgeSA9IHBvaW50WzFdLAogICAgICAgICAgYXhpc3ggPSBzZXJpZXMueGF4aXMsCiAgICAgICAgICBheGlzeSA9IHNlcmllcy55YXhpcywKICAgICAgICAgIGhpZ2hsaWdodENvbG9yID0gdHlwZW9mIHNlcmllcy5oaWdobGlnaHRDb2xvciA9PT0gInN0cmluZyIgPyBzZXJpZXMuaGlnaGxpZ2h0Q29sb3IgOiAkLmNvbG9yLnBhcnNlKHNlcmllcy5jb2xvcikuc2NhbGUoJ2EnLCAwLjUpLnRvU3RyaW5nKCk7CiAgICAgIGlmICh4IDwgYXhpc3gubWluIHx8IHggPiBheGlzeC5tYXggfHwgeSA8IGF4aXN5Lm1pbiB8fCB5ID4gYXhpc3kubWF4KSByZXR1cm47CiAgICAgIHZhciBwb2ludFJhZGl1cyA9IHNlcmllcy5wb2ludHMucmFkaXVzICsgc2VyaWVzLnBvaW50cy5saW5lV2lkdGggLyAyOwogICAgICBvY3R4LmxpbmVXaWR0aCA9IHBvaW50UmFkaXVzOwogICAgICBvY3R4LnN0cm9rZVN0eWxlID0gaGlnaGxpZ2h0Q29sb3I7CiAgICAgIHZhciByYWRpdXMgPSAxLjUgKiBwb2ludFJhZGl1czsKICAgICAgeCA9IGF4aXN4LnAyYyh4KTsKICAgICAgeSA9IGF4aXN5LnAyYyh5KTsKICAgICAgb2N0eC5iZWdpblBhdGgoKTsKICAgICAgaWYgKHNlcmllcy5wb2ludHMuc3ltYm9sID09ICJjaXJjbGUiKSBvY3R4LmFyYyh4LCB5LCByYWRpdXMsIDAsIDIgKiBNYXRoLlBJLCBmYWxzZSk7ZWxzZSBzZXJpZXMucG9pbnRzLnN5bWJvbChvY3R4LCB4LCB5LCByYWRpdXMsIGZhbHNlKTsKICAgICAgb2N0eC5jbG9zZVBhdGgoKTsKICAgICAgb2N0eC5zdHJva2UoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBkcmF3QmFySGlnaGxpZ2h0KHNlcmllcywgcG9pbnQpIHsKICAgICAgdmFyIGhpZ2hsaWdodENvbG9yID0gdHlwZW9mIHNlcmllcy5oaWdobGlnaHRDb2xvciA9PT0gInN0cmluZyIgPyBzZXJpZXMuaGlnaGxpZ2h0Q29sb3IgOiAkLmNvbG9yLnBhcnNlKHNlcmllcy5jb2xvcikuc2NhbGUoJ2EnLCAwLjUpLnRvU3RyaW5nKCksCiAgICAgICAgICBmaWxsU3R5bGUgPSBoaWdobGlnaHRDb2xvciwKICAgICAgICAgIGJhckxlZnQ7CgogICAgICBzd2l0Y2ggKHNlcmllcy5iYXJzLmFsaWduKSB7CiAgICAgICAgY2FzZSAibGVmdCI6CiAgICAgICAgICBiYXJMZWZ0ID0gMDsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICJyaWdodCI6CiAgICAgICAgICBiYXJMZWZ0ID0gLXNlcmllcy5iYXJzLmJhcldpZHRoOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICBiYXJMZWZ0ID0gLXNlcmllcy5iYXJzLmJhcldpZHRoIC8gMjsKICAgICAgfQoKICAgICAgb2N0eC5saW5lV2lkdGggPSBzZXJpZXMuYmFycy5saW5lV2lkdGg7CiAgICAgIG9jdHguc3Ryb2tlU3R5bGUgPSBoaWdobGlnaHRDb2xvcjsKICAgICAgZHJhd0Jhcihwb2ludFswXSwgcG9pbnRbMV0sIHBvaW50WzJdIHx8IDAsIGJhckxlZnQsIGJhckxlZnQgKyBzZXJpZXMuYmFycy5iYXJXaWR0aCwgZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBmaWxsU3R5bGU7CiAgICAgIH0sIHNlcmllcy54YXhpcywgc2VyaWVzLnlheGlzLCBvY3R4LCBzZXJpZXMuYmFycy5ob3Jpem9udGFsLCBzZXJpZXMuYmFycy5saW5lV2lkdGgpOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldENvbG9yT3JHcmFkaWVudChzcGVjLCBib3R0b20sIHRvcCwgZGVmYXVsdENvbG9yKSB7CiAgICAgIGlmICh0eXBlb2Ygc3BlYyA9PSAic3RyaW5nIikgcmV0dXJuIHNwZWM7ZWxzZSB7CiAgICAgICAgLy8gYXNzdW1lIHRoaXMgaXMgYSBncmFkaWVudCBzcGVjOyBJRSBjdXJyZW50bHkgb25seQogICAgICAgIC8vIHN1cHBvcnRzIGEgc2ltcGxlIHZlcnRpY2FsIGdyYWRpZW50IHByb3Blcmx5LCBzbyB0aGF0J3MKICAgICAgICAvLyB3aGF0IHdlIHN1cHBvcnQgdG9vCiAgICAgICAgdmFyIGdyYWRpZW50ID0gY3R4LmNyZWF0ZUxpbmVhckdyYWRpZW50KDAsIHRvcCwgMCwgYm90dG9tKTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBzcGVjLmNvbG9ycy5sZW5ndGg7IGkgPCBsOyArK2kpIHsKICAgICAgICAgIHZhciBjID0gc3BlYy5jb2xvcnNbaV07CgogICAgICAgICAgaWYgKHR5cGVvZiBjICE9ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHZhciBjbyA9ICQuY29sb3IucGFyc2UoZGVmYXVsdENvbG9yKTsKICAgICAgICAgICAgaWYgKGMuYnJpZ2h0bmVzcyAhPSBudWxsKSBjbyA9IGNvLnNjYWxlKCdyZ2InLCBjLmJyaWdodG5lc3MpOwogICAgICAgICAgICBpZiAoYy5vcGFjaXR5ICE9IG51bGwpIGNvLmEgKj0gYy5vcGFjaXR5OwogICAgICAgICAgICBjID0gY28udG9TdHJpbmcoKTsKICAgICAgICAgIH0KCiAgICAgICAgICBncmFkaWVudC5hZGRDb2xvclN0b3AoaSAvIChsIC0gMSksIGMpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGdyYWRpZW50OwogICAgICB9CiAgICB9CiAgfSAvLyBBZGQgdGhlIHBsb3QgZnVuY3Rpb24gdG8gdGhlIHRvcCBsZXZlbCBvZiB0aGUgalF1ZXJ5IG9iamVjdAoKCiAgJC5wbG90ID0gZnVuY3Rpb24gKHBsYWNlaG9sZGVyLCBkYXRhLCBvcHRpb25zKSB7CiAgICAvL3ZhciB0MCA9IG5ldyBEYXRlKCk7CiAgICB2YXIgcGxvdCA9IG5ldyBQbG90KCQocGxhY2Vob2xkZXIpLCBkYXRhLCBvcHRpb25zLCAkLnBsb3QucGx1Z2lucyk7IC8vKHdpbmRvdy5jb25zb2xlID8gY29uc29sZS5sb2cgOiBhbGVydCkoInRpbWUgdXNlZCAobXNlY3MpOiAiICsgKChuZXcgRGF0ZSgpKS5nZXRUaW1lKCkgLSB0MC5nZXRUaW1lKCkpKTsKCiAgICByZXR1cm4gcGxvdDsKICB9OwoKICAkLnBsb3QudmVyc2lvbiA9ICIwLjguMyI7CiAgJC5wbG90LnBsdWdpbnMgPSBbXTsgLy8gQWxzbyBhZGQgdGhlIHBsb3QgZnVuY3Rpb24gYXMgYSBjaGFpbmFibGUgcHJvcGVydHkKCiAgJC5mbi5wbG90ID0gZnVuY3Rpb24gKGRhdGEsIG9wdGlvbnMpIHsKICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAkLnBsb3QodGhpcywgZGF0YSwgb3B0aW9ucyk7CiAgICB9KTsKICB9OyAvLyByb3VuZCB0byBuZWFyYnkgbG93ZXIgbXVsdGlwbGUgb2YgYmFzZQoKCiAgZnVuY3Rpb24gZmxvb3JJbkJhc2UobiwgYmFzZSkgewogICAgcmV0dXJuIGJhc2UgKiBNYXRoLmZsb29yKG4gLyBiYXNlKTsKICB9Cn0pKGpRdWVyeSk7"},null]}
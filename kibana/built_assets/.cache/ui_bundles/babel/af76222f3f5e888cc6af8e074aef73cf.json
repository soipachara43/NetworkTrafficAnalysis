{"remainingRequest":"node_modules/thread-loader/dist/cjs.js??ref--8-1!node_modules/babel-loader/lib/index.js??ref--8-2!x-pack/legacy/plugins/lens/public/indexpattern_datasource/indexpattern_suggestions.js","dependencies":[{"path":"x-pack/legacy/plugins/lens/public/indexpattern_datasource/indexpattern_suggestions.js","mtime":1589249552308},{"path":"node_modules/cache-loader/dist/cjs.js","mtime":1589249605183},{"path":"node_modules/thread-loader/dist/cjs.js","mtime":1589249608558},{"path":"node_modules/babel-loader/lib/index.js","mtime":1589249591025}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:InVzZSBzdHJpY3QiOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpleHBvcnRzLmdldERhdGFzb3VyY2VTdWdnZXN0aW9uc0ZvckZpZWxkID0gZ2V0RGF0YXNvdXJjZVN1Z2dlc3Rpb25zRm9yRmllbGQ7CmV4cG9ydHMuZ2V0RGF0YXNvdXJjZVN1Z2dlc3Rpb25zRnJvbUN1cnJlbnRTdGF0ZSA9IGdldERhdGFzb3VyY2VTdWdnZXN0aW9uc0Zyb21DdXJyZW50U3RhdGU7Cgp2YXIgX2xvZGFzaCA9IF9pbnRlcm9wUmVxdWlyZVdpbGRjYXJkKHJlcXVpcmUoImxvZGFzaCIpKTsKCnZhciBfaTE4biA9IHJlcXVpcmUoIkBrYm4vaTE4biIpOwoKdmFyIF9pZF9nZW5lcmF0b3IgPSByZXF1aXJlKCIuLi9pZF9nZW5lcmF0b3IiKTsKCnZhciBfaW5kZXhwYXR0ZXJuID0gcmVxdWlyZSgiLi9pbmRleHBhdHRlcm4iKTsKCnZhciBfb3BlcmF0aW9ucyA9IHJlcXVpcmUoIi4vb3BlcmF0aW9ucyIpOwoKdmFyIF9kZWZpbml0aW9ucyA9IHJlcXVpcmUoIi4vb3BlcmF0aW9ucy9kZWZpbml0aW9ucyIpOwoKdmFyIF91dGlscyA9IHJlcXVpcmUoIi4vdXRpbHMiKTsKCnZhciBfZG9jdW1lbnRfZmllbGQgPSByZXF1aXJlKCIuL2RvY3VtZW50X2ZpZWxkIik7CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVXaWxkY2FyZChvYmopIHsKICBpZiAob2JqICYmIG9iai5fX2VzTW9kdWxlKSB7CiAgICByZXR1cm4gb2JqOwogIH0gZWxzZSB7CiAgICB2YXIgbmV3T2JqID0ge307CgogICAgaWYgKG9iaiAhPSBudWxsKSB7CiAgICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KSkgewogICAgICAgICAgdmFyIGRlc2MgPSBPYmplY3QuZGVmaW5lUHJvcGVydHkgJiYgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvciA/IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqLCBrZXkpIDoge307CgogICAgICAgICAgaWYgKGRlc2MuZ2V0IHx8IGRlc2Muc2V0KSB7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShuZXdPYmosIGtleSwgZGVzYyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuZXdPYmpba2V5XSA9IG9ialtrZXldOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIG5ld09iai5kZWZhdWx0ID0gb2JqOwogICAgcmV0dXJuIG5ld09iajsKICB9Cn0KCmZ1bmN0aW9uIF90b0FycmF5KGFycikgewogIHJldHVybiBfYXJyYXlXaXRoSG9sZXMoYXJyKSB8fCBfaXRlcmFibGVUb0FycmF5KGFycikgfHwgX25vbkl0ZXJhYmxlUmVzdCgpOwp9CgpmdW5jdGlvbiBfdG9Db25zdW1hYmxlQXJyYXkoYXJyKSB7CiAgcmV0dXJuIF9hcnJheVdpdGhvdXRIb2xlcyhhcnIpIHx8IF9pdGVyYWJsZVRvQXJyYXkoYXJyKSB8fCBfbm9uSXRlcmFibGVTcHJlYWQoKTsKfQoKZnVuY3Rpb24gX25vbkl0ZXJhYmxlU3ByZWFkKCkgewogIHRocm93IG5ldyBUeXBlRXJyb3IoIkludmFsaWQgYXR0ZW1wdCB0byBzcHJlYWQgbm9uLWl0ZXJhYmxlIGluc3RhbmNlIik7Cn0KCmZ1bmN0aW9uIF9pdGVyYWJsZVRvQXJyYXkoaXRlcikgewogIGlmIChTeW1ib2wuaXRlcmF0b3IgaW4gT2JqZWN0KGl0ZXIpIHx8IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChpdGVyKSA9PT0gIltvYmplY3QgQXJndW1lbnRzXSIpIHJldHVybiBBcnJheS5mcm9tKGl0ZXIpOwp9CgpmdW5jdGlvbiBfYXJyYXlXaXRob3V0SG9sZXMoYXJyKSB7CiAgaWYgKEFycmF5LmlzQXJyYXkoYXJyKSkgewogICAgZm9yICh2YXIgaSA9IDAsIGFycjIgPSBuZXcgQXJyYXkoYXJyLmxlbmd0aCk7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsKICAgICAgYXJyMltpXSA9IGFycltpXTsKICAgIH0KCiAgICByZXR1cm4gYXJyMjsKICB9Cn0KCmZ1bmN0aW9uIF9zbGljZWRUb0FycmF5KGFyciwgaSkgewogIHJldHVybiBfYXJyYXlXaXRoSG9sZXMoYXJyKSB8fCBfaXRlcmFibGVUb0FycmF5TGltaXQoYXJyLCBpKSB8fCBfbm9uSXRlcmFibGVSZXN0KCk7Cn0KCmZ1bmN0aW9uIF9ub25JdGVyYWJsZVJlc3QoKSB7CiAgdGhyb3cgbmV3IFR5cGVFcnJvcigiSW52YWxpZCBhdHRlbXB0IHRvIGRlc3RydWN0dXJlIG5vbi1pdGVyYWJsZSBpbnN0YW5jZSIpOwp9CgpmdW5jdGlvbiBfaXRlcmFibGVUb0FycmF5TGltaXQoYXJyLCBpKSB7CiAgdmFyIF9hcnIgPSBbXTsKICB2YXIgX24gPSB0cnVlOwogIHZhciBfZCA9IGZhbHNlOwogIHZhciBfZSA9IHVuZGVmaW5lZDsKCiAgdHJ5IHsKICAgIGZvciAodmFyIF9pID0gYXJyW1N5bWJvbC5pdGVyYXRvcl0oKSwgX3M7ICEoX24gPSAoX3MgPSBfaS5uZXh0KCkpLmRvbmUpOyBfbiA9IHRydWUpIHsKICAgICAgX2Fyci5wdXNoKF9zLnZhbHVlKTsKCiAgICAgIGlmIChpICYmIF9hcnIubGVuZ3RoID09PSBpKSBicmVhazsKICAgIH0KICB9IGNhdGNoIChlcnIpIHsKICAgIF9kID0gdHJ1ZTsKICAgIF9lID0gZXJyOwogIH0gZmluYWxseSB7CiAgICB0cnkgewogICAgICBpZiAoIV9uICYmIF9pWyJyZXR1cm4iXSAhPSBudWxsKSBfaVsicmV0dXJuIl0oKTsKICAgIH0gZmluYWxseSB7CiAgICAgIGlmIChfZCkgdGhyb3cgX2U7CiAgICB9CiAgfQoKICByZXR1cm4gX2FycjsKfQoKZnVuY3Rpb24gX2FycmF5V2l0aEhvbGVzKGFycikgewogIGlmIChBcnJheS5pc0FycmF5KGFycikpIHJldHVybiBhcnI7Cn0KCmZ1bmN0aW9uIG93bktleXMob2JqZWN0LCBlbnVtZXJhYmxlT25seSkgewogIHZhciBrZXlzID0gT2JqZWN0LmtleXMob2JqZWN0KTsKCiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBzeW1ib2xzID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhvYmplY3QpOwogICAgaWYgKGVudW1lcmFibGVPbmx5KSBzeW1ib2xzID0gc3ltYm9scy5maWx0ZXIoZnVuY3Rpb24gKHN5bSkgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvYmplY3QsIHN5bSkuZW51bWVyYWJsZTsKICAgIH0pOwogICAga2V5cy5wdXNoLmFwcGx5KGtleXMsIHN5bWJvbHMpOwogIH0KCiAgcmV0dXJuIGtleXM7Cn0KCmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQodGFyZ2V0KSB7CiAgZm9yICh2YXIgaSA9IDE7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgIHZhciBzb3VyY2UgPSBhcmd1bWVudHNbaV0gIT0gbnVsbCA/IGFyZ3VtZW50c1tpXSA6IHt9OwoKICAgIGlmIChpICUgMikgewogICAgICBvd25LZXlzKHNvdXJjZSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgX2RlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCBzb3VyY2Vba2V5XSk7CiAgICAgIH0pOwogICAgfSBlbHNlIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHNvdXJjZSkpOwogICAgfSBlbHNlIHsKICAgICAgb3duS2V5cyhzb3VyY2UpLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihzb3VyY2UsIGtleSkpOwogICAgICB9KTsKICAgIH0KICB9CgogIHJldHVybiB0YXJnZXQ7Cn0KCmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eShvYmosIGtleSwgdmFsdWUpIHsKICBpZiAoa2V5IGluIG9iaikgewogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwga2V5LCB7CiAgICAgIHZhbHVlOiB2YWx1ZSwKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICB3cml0YWJsZTogdHJ1ZQogICAgfSk7CiAgfSBlbHNlIHsKICAgIG9ialtrZXldID0gdmFsdWU7CiAgfQoKICByZXR1cm4gb2JqOwp9CgpmdW5jdGlvbiBidWlsZFN1Z2dlc3Rpb24oX3JlZikgewogIHZhciBzdGF0ZSA9IF9yZWYuc3RhdGUsCiAgICAgIHVwZGF0ZWRMYXllciA9IF9yZWYudXBkYXRlZExheWVyLAogICAgICBsYXllcklkID0gX3JlZi5sYXllcklkLAogICAgICBsYWJlbCA9IF9yZWYubGFiZWwsCiAgICAgIGNoYW5nZVR5cGUgPSBfcmVmLmNoYW5nZVR5cGU7CiAgdmFyIHVwZGF0ZWRTdGF0ZSA9IHVwZGF0ZWRMYXllciA/IF9vYmplY3RTcHJlYWQoe30sIHN0YXRlLCB7CiAgICBsYXllcnM6IF9vYmplY3RTcHJlYWQoe30sIHN0YXRlLmxheWVycywgX2RlZmluZVByb3BlcnR5KHt9LCBsYXllcklkLCB1cGRhdGVkTGF5ZXIpKQogIH0pIDogc3RhdGU7IC8vIEl0J3MgZmFpcmx5IGVhc3kgdG8gYWNjaWRlbnRhbGx5IGludHJvZHVjZSBhIG1pc21hdGNoIGJldHdlZW4KICAvLyBjb2x1bW5PcmRlciBhbmQgY29sdW1ucywgc28gdGhpcyBpcyBhIHNhZmVndWFyZCB0byBlbnN1cmUgdGhlCiAgLy8gdHdvIG1hdGNoIHVwLgoKICB2YXIgbGF5ZXJzID0gX2xvZGFzaC5kZWZhdWx0Lm1hcFZhbHVlcyh1cGRhdGVkU3RhdGUubGF5ZXJzLCBmdW5jdGlvbiAobGF5ZXIpIHsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkKHt9LCBsYXllciwgewogICAgICBjb2x1bW5zOiBfbG9kYXNoLmRlZmF1bHQucGljayhsYXllci5jb2x1bW5zLCBsYXllci5jb2x1bW5PcmRlcikKICAgIH0pOwogIH0pOwoKICB2YXIgY29sdW1uT3JkZXIgPSBsYXllcnNbbGF5ZXJJZF0uY29sdW1uT3JkZXI7CiAgdmFyIGNvbHVtbk1hcCA9IGxheWVyc1tsYXllcklkXS5jb2x1bW5zOwogIHZhciBpc011bHRpUm93ID0gT2JqZWN0LnZhbHVlcyhjb2x1bW5NYXApLnNvbWUoZnVuY3Rpb24gKGNvbHVtbikgewogICAgcmV0dXJuIGNvbHVtbi5pc0J1Y2tldGVkOwogIH0pOwogIHJldHVybiB7CiAgICBzdGF0ZTogX29iamVjdFNwcmVhZCh7fSwgdXBkYXRlZFN0YXRlLCB7CiAgICAgIGxheWVyczogbGF5ZXJzCiAgICB9KSwKICAgIHRhYmxlOiB7CiAgICAgIGNvbHVtbnM6IGNvbHVtbk9yZGVyLm1hcChmdW5jdGlvbiAoY29sdW1uSWQpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgY29sdW1uSWQ6IGNvbHVtbklkLAogICAgICAgICAgb3BlcmF0aW9uOiAoMCwgX2luZGV4cGF0dGVybi5jb2x1bW5Ub09wZXJhdGlvbikoY29sdW1uTWFwW2NvbHVtbklkXSkKICAgICAgICB9OwogICAgICB9KSwKICAgICAgaXNNdWx0aVJvdzogaXNNdWx0aVJvdywKICAgICAgbGF5ZXJJZDogbGF5ZXJJZCwKICAgICAgY2hhbmdlVHlwZTogY2hhbmdlVHlwZSwKICAgICAgbGFiZWw6IGxhYmVsCiAgICB9LAogICAga2VwdExheWVySWRzOiBPYmplY3Qua2V5cyhzdGF0ZS5sYXllcnMpCiAgfTsKfQoKZnVuY3Rpb24gZ2V0RGF0YXNvdXJjZVN1Z2dlc3Rpb25zRm9yRmllbGQoc3RhdGUsIGluZGV4UGF0dGVybklkLCBmaWVsZCkgewogIHZhciBsYXllcnMgPSBPYmplY3Qua2V5cyhzdGF0ZS5sYXllcnMpOwogIHZhciBsYXllcklkcyA9IGxheWVycy5maWx0ZXIoZnVuY3Rpb24gKGlkKSB7CiAgICByZXR1cm4gc3RhdGUubGF5ZXJzW2lkXS5pbmRleFBhdHRlcm5JZCA9PT0gaW5kZXhQYXR0ZXJuSWQ7CiAgfSk7CgogIGlmIChsYXllcklkcy5sZW5ndGggPT09IDApIHsKICAgIC8vIFRoZSBmaWVsZCB3ZSdyZSBzdWdnZXN0aW5nIG9uIGRvZXMgbm90IG1hdGNoIGFueSBleGlzdGluZyBsYXllci4KICAgIC8vIFRoaXMgZ2VuZXJhdGVzIGEgc2V0IG9mIHN1Z2dlc3Rpb25zIHdoZXJlIHdlIGFkZCBhIGxheWVyLgogICAgLy8gQSBzZWNvbmQgc2V0IG9mIHN1Z2dlc3Rpb25zIGlzIGdlbmVyYXRlZCBmb3IgdmlzdWFsaXphdGlvbnMgdGhhdCBkb24ndCB3b3JrIHdpdGggbGF5ZXJzCiAgICB2YXIgbmV3SWQgPSAoMCwgX2lkX2dlbmVyYXRvci5nZW5lcmF0ZUlkKSgpOwogICAgcmV0dXJuIGdldEVtcHR5TGF5ZXJTdWdnZXN0aW9uc0ZvckZpZWxkKHN0YXRlLCBuZXdJZCwgaW5kZXhQYXR0ZXJuSWQsIGZpZWxkKS5jb25jYXQoZ2V0RW1wdHlMYXllclN1Z2dlc3Rpb25zRm9yRmllbGQoX29iamVjdFNwcmVhZCh7fSwgc3RhdGUsIHsKICAgICAgbGF5ZXJzOiB7fQogICAgfSksIG5ld0lkLCBpbmRleFBhdHRlcm5JZCwgZmllbGQpKTsKICB9IGVsc2UgewogICAgLy8gVGhlIGZpZWxkIHdlJ3JlIHN1Z2dlc3Rpbmcgb24gbWF0Y2hlcyBhbiBleGlzdGluZyBsYXllci4gSW4gdGhpcyBjYXNlIHdlIGZpbmQgdGhlIGxheWVyIHdpdGgKICAgIC8vIHRoZSBmZXdlc3QgY29uZmlndXJlZCBjb2x1bW5zIGFuZCB0cnkgdG8gYWRkIHRoZSBmaWVsZCB0byB0aGlzIHRhYmxlLiBJZiB0aGlzIGxheWVyIGRvZXMgbm90CiAgICAvLyBjb250YWluIGFueSBsYXllcnMgeWV0LCBiZWhhdmUgYXMgaWYgdGhlcmUgaXMgbm8gbGF5ZXIuCiAgICB2YXIgbW9zdEVtcHR5TGF5ZXJJZCA9IF9sb2Rhc2guZGVmYXVsdC5taW4obGF5ZXJJZHMsIGZ1bmN0aW9uIChsYXllcklkKSB7CiAgICAgIHJldHVybiBzdGF0ZS5sYXllcnNbbGF5ZXJJZF0uY29sdW1uT3JkZXIubGVuZ3RoOwogICAgfSk7CgogICAgaWYgKHN0YXRlLmxheWVyc1ttb3N0RW1wdHlMYXllcklkXS5jb2x1bW5PcmRlci5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIGdldEVtcHR5TGF5ZXJTdWdnZXN0aW9uc0ZvckZpZWxkKHN0YXRlLCBtb3N0RW1wdHlMYXllcklkLCBpbmRleFBhdHRlcm5JZCwgZmllbGQpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGdldEV4aXN0aW5nTGF5ZXJTdWdnZXN0aW9uc0ZvckZpZWxkKHN0YXRlLCBtb3N0RW1wdHlMYXllcklkLCBmaWVsZCk7CiAgICB9CiAgfQp9CgpmdW5jdGlvbiBnZXRCdWNrZXRPcGVyYXRpb24oZmllbGQpIHsKICAvLyBXZSBhbGxvdyBudW1lcmljIGJ1Y2tldCB0eXBlcyBpbiBzb21lIGNhc2VzLCBidXQgaXQncyBnZW5lcmFsbHkgbm90IHRoZSByaWdodCBzdWdnZXN0aW9uLAogIC8vIHNvIHdlIGVsaW1pbmF0ZSBpdCBoZXJlLgogIGlmIChmaWVsZC50eXBlICE9PSAnbnVtYmVyJykgewogICAgcmV0dXJuICgwLCBfb3BlcmF0aW9ucy5nZXRPcGVyYXRpb25UeXBlc0ZvckZpZWxkKShmaWVsZCkuZmluZChmdW5jdGlvbiAob3ApIHsKICAgICAgcmV0dXJuIG9wID09PSAnZGF0ZV9oaXN0b2dyYW0nIHx8IG9wID09PSAndGVybXMnOwogICAgfSk7CiAgfQp9CgpmdW5jdGlvbiBnZXRFeGlzdGluZ0xheWVyU3VnZ2VzdGlvbnNGb3JGaWVsZChzdGF0ZSwgbGF5ZXJJZCwgZmllbGQpIHsKICB2YXIgbGF5ZXIgPSBzdGF0ZS5sYXllcnNbbGF5ZXJJZF07CiAgdmFyIGluZGV4UGF0dGVybiA9IHN0YXRlLmluZGV4UGF0dGVybnNbbGF5ZXIuaW5kZXhQYXR0ZXJuSWRdOwogIHZhciBvcGVyYXRpb25zID0gKDAsIF9vcGVyYXRpb25zLmdldE9wZXJhdGlvblR5cGVzRm9yRmllbGQpKGZpZWxkKTsKICB2YXIgdXNhYmxlQXNCdWNrZXRPcGVyYXRpb24gPSBnZXRCdWNrZXRPcGVyYXRpb24oZmllbGQpOwogIHZhciBmaWVsZEluVXNlID0gT2JqZWN0LnZhbHVlcyhsYXllci5jb2x1bW5zKS5zb21lKGZ1bmN0aW9uIChjb2x1bW4pIHsKICAgIHJldHVybiAoMCwgX3V0aWxzLmhhc0ZpZWxkKShjb2x1bW4pICYmIGNvbHVtbi5zb3VyY2VGaWVsZCA9PT0gZmllbGQubmFtZTsKICB9KTsKICB2YXIgc3VnZ2VzdGlvbnMgPSBbXTsKCiAgaWYgKHVzYWJsZUFzQnVja2V0T3BlcmF0aW9uICYmICFmaWVsZEluVXNlKSB7CiAgICBzdWdnZXN0aW9ucy5wdXNoKGJ1aWxkU3VnZ2VzdGlvbih7CiAgICAgIHN0YXRlOiBzdGF0ZSwKICAgICAgdXBkYXRlZExheWVyOiBhZGRGaWVsZEFzQnVja2V0T3BlcmF0aW9uKGxheWVyLCBsYXllcklkLCBpbmRleFBhdHRlcm4sIGZpZWxkKSwKICAgICAgbGF5ZXJJZDogbGF5ZXJJZCwKICAgICAgY2hhbmdlVHlwZTogJ2V4dGVuZGVkJwogICAgfSkpOwogIH0KCiAgaWYgKCF1c2FibGVBc0J1Y2tldE9wZXJhdGlvbiAmJiBvcGVyYXRpb25zLmxlbmd0aCA+IDApIHsKICAgIHZhciB1cGRhdGVkTGF5ZXIgPSBhZGRGaWVsZEFzTWV0cmljT3BlcmF0aW9uKGxheWVyLCBsYXllcklkLCBpbmRleFBhdHRlcm4sIGZpZWxkKTsKCiAgICBpZiAodXBkYXRlZExheWVyKSB7CiAgICAgIHN1Z2dlc3Rpb25zLnB1c2goYnVpbGRTdWdnZXN0aW9uKHsKICAgICAgICBzdGF0ZTogc3RhdGUsCiAgICAgICAgdXBkYXRlZExheWVyOiB1cGRhdGVkTGF5ZXIsCiAgICAgICAgbGF5ZXJJZDogbGF5ZXJJZCwKICAgICAgICBjaGFuZ2VUeXBlOiAnZXh0ZW5kZWQnCiAgICAgIH0pKTsKICAgIH0KICB9CgogIHZhciBtZXRyaWNTdWdnZXN0aW9uID0gY3JlYXRlTWV0cmljU3VnZ2VzdGlvbihpbmRleFBhdHRlcm4sIGxheWVySWQsIHN0YXRlLCBmaWVsZCk7CgogIGlmIChtZXRyaWNTdWdnZXN0aW9uKSB7CiAgICBzdWdnZXN0aW9ucy5wdXNoKG1ldHJpY1N1Z2dlc3Rpb24pOwogIH0KCiAgcmV0dXJuIHN1Z2dlc3Rpb25zOwp9CgpmdW5jdGlvbiBhZGRGaWVsZEFzTWV0cmljT3BlcmF0aW9uKGxheWVyLCBsYXllcklkLCBpbmRleFBhdHRlcm4sIGZpZWxkKSB7CiAgdmFyIG9wZXJhdGlvbnMgPSAoMCwgX29wZXJhdGlvbnMuZ2V0T3BlcmF0aW9uVHlwZXNGb3JGaWVsZCkoZmllbGQpOwogIHZhciBvcGVyYXRpb25zQWxyZWFkeUFwcGxpZWRUb1RoaXNGaWVsZCA9IE9iamVjdC52YWx1ZXMobGF5ZXIuY29sdW1ucykuZmlsdGVyKGZ1bmN0aW9uIChjb2x1bW4pIHsKICAgIHJldHVybiAoMCwgX3V0aWxzLmhhc0ZpZWxkKShjb2x1bW4pICYmIGNvbHVtbi5zb3VyY2VGaWVsZCA9PT0gZmllbGQubmFtZTsKICB9KS5tYXAoZnVuY3Rpb24gKGNvbHVtbikgewogICAgcmV0dXJuIGNvbHVtbi5vcGVyYXRpb25UeXBlOwogIH0pOwogIHZhciBvcGVyYXRpb25DYW5kaWRhdGUgPSBvcGVyYXRpb25zLmZpbmQoZnVuY3Rpb24gKG9wZXJhdGlvbikgewogICAgcmV0dXJuICFvcGVyYXRpb25zQWxyZWFkeUFwcGxpZWRUb1RoaXNGaWVsZC5pbmNsdWRlcyhvcGVyYXRpb24pOwogIH0pOwoKICBpZiAoIW9wZXJhdGlvbkNhbmRpZGF0ZSkgewogICAgcmV0dXJuOwogIH0KCiAgdmFyIG5ld0NvbHVtbiA9ICgwLCBfb3BlcmF0aW9ucy5idWlsZENvbHVtbikoewogICAgb3A6IG9wZXJhdGlvbkNhbmRpZGF0ZSwKICAgIGNvbHVtbnM6IGxheWVyLmNvbHVtbnMsCiAgICBsYXllcklkOiBsYXllcklkLAogICAgaW5kZXhQYXR0ZXJuOiBpbmRleFBhdHRlcm4sCiAgICBzdWdnZXN0ZWRQcmlvcml0eTogdW5kZWZpbmVkLAogICAgZmllbGQ6IGZpZWxkCiAgfSk7CiAgdmFyIGFkZGVkQ29sdW1uSWQgPSAoMCwgX2lkX2dlbmVyYXRvci5nZW5lcmF0ZUlkKSgpOwoKICB2YXIgX3NlcGFyYXRlQnVja2V0Q29sdW1uID0gc2VwYXJhdGVCdWNrZXRDb2x1bW5zKGxheWVyKSwKICAgICAgX3NlcGFyYXRlQnVja2V0Q29sdW1uMiA9IF9zbGljZWRUb0FycmF5KF9zZXBhcmF0ZUJ1Y2tldENvbHVtbiwgMiksCiAgICAgIG1ldHJpY3MgPSBfc2VwYXJhdGVCdWNrZXRDb2x1bW4yWzFdOyAvLyBBZGQgbWV0cmljcyBpZiB0aGVyZSBhcmUgMCBvciA+IDEgbWV0cmljCgoKICBpZiAobWV0cmljcy5sZW5ndGggIT09IDEpIHsKICAgIHJldHVybiB7CiAgICAgIGluZGV4UGF0dGVybklkOiBpbmRleFBhdHRlcm4uaWQsCiAgICAgIGNvbHVtbnM6IF9vYmplY3RTcHJlYWQoe30sIGxheWVyLmNvbHVtbnMsIF9kZWZpbmVQcm9wZXJ0eSh7fSwgYWRkZWRDb2x1bW5JZCwgbmV3Q29sdW1uKSksCiAgICAgIGNvbHVtbk9yZGVyOiBbXS5jb25jYXQoX3RvQ29uc3VtYWJsZUFycmF5KGxheWVyLmNvbHVtbk9yZGVyKSwgW2FkZGVkQ29sdW1uSWRdKQogICAgfTsKICB9IC8vIFJlcGxhY2luZyBvbGQgY29sdW1uIHdpdGggbmV3IGNvbHVtbiwga2VlcGluZyB0aGUgb2xkIElECgoKICB2YXIgbmV3Q29sdW1ucyA9IF9vYmplY3RTcHJlYWQoe30sIGxheWVyLmNvbHVtbnMsIF9kZWZpbmVQcm9wZXJ0eSh7fSwgbWV0cmljc1swXSwgbmV3Q29sdW1uKSk7CgogIHJldHVybiB7CiAgICBpbmRleFBhdHRlcm5JZDogaW5kZXhQYXR0ZXJuLmlkLAogICAgY29sdW1uczogbmV3Q29sdW1ucywKICAgIGNvbHVtbk9yZGVyOiBsYXllci5jb2x1bW5PcmRlciAvLyBPcmRlciBpcyBrZXB0IGJ5IHJlcGxhY2luZwoKICB9Owp9CgpmdW5jdGlvbiBhZGRGaWVsZEFzQnVja2V0T3BlcmF0aW9uKGxheWVyLCBsYXllcklkLCBpbmRleFBhdHRlcm4sIGZpZWxkKSB7CiAgdmFyIGFwcGxpY2FibGVCdWNrZXRPcGVyYXRpb24gPSBnZXRCdWNrZXRPcGVyYXRpb24oZmllbGQpOwogIHZhciBuZXdDb2x1bW4gPSAoMCwgX29wZXJhdGlvbnMuYnVpbGRDb2x1bW4pKHsKICAgIG9wOiBhcHBsaWNhYmxlQnVja2V0T3BlcmF0aW9uLAogICAgY29sdW1uczogbGF5ZXIuY29sdW1ucywKICAgIGxheWVySWQ6IGxheWVySWQsCiAgICBpbmRleFBhdHRlcm46IGluZGV4UGF0dGVybiwKICAgIHN1Z2dlc3RlZFByaW9yaXR5OiB1bmRlZmluZWQsCiAgICBmaWVsZDogZmllbGQKICB9KTsKCiAgdmFyIF9zZXBhcmF0ZUJ1Y2tldENvbHVtbjMgPSBzZXBhcmF0ZUJ1Y2tldENvbHVtbnMobGF5ZXIpLAogICAgICBfc2VwYXJhdGVCdWNrZXRDb2x1bW40ID0gX3NsaWNlZFRvQXJyYXkoX3NlcGFyYXRlQnVja2V0Q29sdW1uMywgMiksCiAgICAgIGJ1Y2tldHMgPSBfc2VwYXJhdGVCdWNrZXRDb2x1bW40WzBdLAogICAgICBtZXRyaWNzID0gX3NlcGFyYXRlQnVja2V0Q29sdW1uNFsxXTsKCiAgdmFyIG5ld0NvbHVtbklkID0gKDAsIF9pZF9nZW5lcmF0b3IuZ2VuZXJhdGVJZCkoKTsKCiAgdmFyIHVwZGF0ZWRDb2x1bW5zID0gX29iamVjdFNwcmVhZCh7fSwgbGF5ZXIuY29sdW1ucywgX2RlZmluZVByb3BlcnR5KHt9LCBuZXdDb2x1bW5JZCwgbmV3Q29sdW1uKSk7CgogIHZhciBvbGREYXRlSGlzdG9ncmFtSW5kZXggPSBsYXllci5jb2x1bW5PcmRlci5maW5kSW5kZXgoZnVuY3Rpb24gKGNvbHVtbklkKSB7CiAgICByZXR1cm4gbGF5ZXIuY29sdW1uc1tjb2x1bW5JZF0ub3BlcmF0aW9uVHlwZSA9PT0gJ2RhdGVfaGlzdG9ncmFtJzsKICB9KTsKICB2YXIgb2xkRGF0ZUhpc3RvZ3JhbUlkID0gb2xkRGF0ZUhpc3RvZ3JhbUluZGV4ID4gLTEgPyBsYXllci5jb2x1bW5PcmRlcltvbGREYXRlSGlzdG9ncmFtSW5kZXhdIDogbnVsbDsKICB2YXIgdXBkYXRlZENvbHVtbk9yZGVyID0gW107CgogIGlmIChvbGREYXRlSGlzdG9ncmFtSWQpIHsKICAgIGlmIChhcHBsaWNhYmxlQnVja2V0T3BlcmF0aW9uID09PSAndGVybXMnKSB7CiAgICAgIC8vIEluc2VydCB0aGUgbmV3IHRlcm1zIGJ1Y2tldCBhYm92ZSB0aGUgZmlyc3QgZGF0ZSBoaXN0b2dyYW0KICAgICAgdXBkYXRlZENvbHVtbk9yZGVyID0gW10uY29uY2F0KF90b0NvbnN1bWFibGVBcnJheShidWNrZXRzLnNsaWNlKDAsIG9sZERhdGVIaXN0b2dyYW1JbmRleCkpLCBbbmV3Q29sdW1uSWRdLCBfdG9Db25zdW1hYmxlQXJyYXkoYnVja2V0cy5zbGljZShvbGREYXRlSGlzdG9ncmFtSW5kZXgsIGJ1Y2tldHMubGVuZ3RoKSksIF90b0NvbnN1bWFibGVBcnJheShtZXRyaWNzKSk7CiAgICB9IGVsc2UgaWYgKGFwcGxpY2FibGVCdWNrZXRPcGVyYXRpb24gPT09ICdkYXRlX2hpc3RvZ3JhbScpIHsKICAgICAgLy8gUmVwbGFjZSBkYXRlIGhpc3RvZ3JhbSB3aXRoIG5ldyBkYXRlIGhpc3RvZ3JhbQogICAgICBkZWxldGUgdXBkYXRlZENvbHVtbnNbb2xkRGF0ZUhpc3RvZ3JhbUlkXTsKICAgICAgdXBkYXRlZENvbHVtbk9yZGVyID0gbGF5ZXIuY29sdW1uT3JkZXIubWFwKGZ1bmN0aW9uIChjb2x1bW5JZCkgewogICAgICAgIHJldHVybiBjb2x1bW5JZCAhPT0gb2xkRGF0ZUhpc3RvZ3JhbUlkID8gY29sdW1uSWQgOiBuZXdDb2x1bW5JZDsKICAgICAgfSk7CiAgICB9CiAgfSBlbHNlIHsKICAgIC8vIEluc2VydCB0aGUgbmV3IGJ1Y2tldCBhZnRlciBleGlzdGluZyBidWNrZXRzLiBVc2VycyB3aWxsIHNlZSB0aGUgc2FtZSBkYXRhCiAgICAvLyB0aGV5IGFscmVhZHkgaGFkLCB3aXRoIGFuIGV4dHJhIGxldmVsIG9mIGRldGFpbC4KICAgIHVwZGF0ZWRDb2x1bW5PcmRlciA9IFtdLmNvbmNhdChfdG9Db25zdW1hYmxlQXJyYXkoYnVja2V0cyksIFtuZXdDb2x1bW5JZF0sIF90b0NvbnN1bWFibGVBcnJheShtZXRyaWNzKSk7CiAgfQoKICByZXR1cm4gewogICAgaW5kZXhQYXR0ZXJuSWQ6IGluZGV4UGF0dGVybi5pZCwKICAgIGNvbHVtbnM6IHVwZGF0ZWRDb2x1bW5zLAogICAgY29sdW1uT3JkZXI6IHVwZGF0ZWRDb2x1bW5PcmRlcgogIH07Cn0KCmZ1bmN0aW9uIGdldEVtcHR5TGF5ZXJTdWdnZXN0aW9uc0ZvckZpZWxkKHN0YXRlLCBsYXllcklkLCBpbmRleFBhdHRlcm5JZCwgZmllbGQpIHsKICB2YXIgaW5kZXhQYXR0ZXJuID0gc3RhdGUuaW5kZXhQYXR0ZXJuc1tpbmRleFBhdHRlcm5JZF07CiAgdmFyIG5ld0xheWVyOwoKICBpZiAoZ2V0QnVja2V0T3BlcmF0aW9uKGZpZWxkKSkgewogICAgbmV3TGF5ZXIgPSBjcmVhdGVOZXdMYXllcldpdGhCdWNrZXRBZ2dyZWdhdGlvbihsYXllcklkLCBpbmRleFBhdHRlcm4sIGZpZWxkKTsKICB9IGVsc2UgaWYgKGluZGV4UGF0dGVybi50aW1lRmllbGROYW1lICYmICgwLCBfb3BlcmF0aW9ucy5nZXRPcGVyYXRpb25UeXBlc0ZvckZpZWxkKShmaWVsZCkubGVuZ3RoID4gMCkgewogICAgbmV3TGF5ZXIgPSBjcmVhdGVOZXdMYXllcldpdGhNZXRyaWNBZ2dyZWdhdGlvbihsYXllcklkLCBpbmRleFBhdHRlcm4sIGZpZWxkKTsKICB9CgogIHZhciBuZXdMYXllclN1Z2dlc3Rpb25zID0gbmV3TGF5ZXIgPyBbYnVpbGRTdWdnZXN0aW9uKHsKICAgIHN0YXRlOiBzdGF0ZSwKICAgIHVwZGF0ZWRMYXllcjogbmV3TGF5ZXIsCiAgICBsYXllcklkOiBsYXllcklkLAogICAgY2hhbmdlVHlwZTogJ2luaXRpYWwnCiAgfSldIDogW107CiAgdmFyIG1ldHJpY0xheWVyID0gY3JlYXRlTWV0cmljU3VnZ2VzdGlvbihpbmRleFBhdHRlcm4sIGxheWVySWQsIHN0YXRlLCBmaWVsZCk7CiAgcmV0dXJuIG1ldHJpY0xheWVyID8gbmV3TGF5ZXJTdWdnZXN0aW9ucy5jb25jYXQobWV0cmljTGF5ZXIpIDogbmV3TGF5ZXJTdWdnZXN0aW9uczsKfQoKZnVuY3Rpb24gY3JlYXRlTmV3TGF5ZXJXaXRoQnVja2V0QWdncmVnYXRpb24obGF5ZXJJZCwgaW5kZXhQYXR0ZXJuLCBmaWVsZCkgewogIHZhciBfY29sdW1uczI7CgogIHZhciBjb3VudENvbHVtbiA9ICgwLCBfb3BlcmF0aW9ucy5idWlsZENvbHVtbikoewogICAgb3A6ICdjb3VudCcsCiAgICBjb2x1bW5zOiB7fSwKICAgIGluZGV4UGF0dGVybjogaW5kZXhQYXR0ZXJuLAogICAgbGF5ZXJJZDogbGF5ZXJJZCwKICAgIHN1Z2dlc3RlZFByaW9yaXR5OiB1bmRlZmluZWQsCiAgICBmaWVsZDogX2RvY3VtZW50X2ZpZWxkLmRvY3VtZW50RmllbGQKICB9KTsKICB2YXIgY29sMSA9ICgwLCBfaWRfZ2VuZXJhdG9yLmdlbmVyYXRlSWQpKCk7CiAgdmFyIGNvbDIgPSAoMCwgX2lkX2dlbmVyYXRvci5nZW5lcmF0ZUlkKSgpOyAvLyBsZXQgY29sdW1uIGtub3cgYWJvdXQgY291bnQgY29sdW1uCgogIHZhciBjb2x1bW4gPSAoMCwgX29wZXJhdGlvbnMuYnVpbGRDb2x1bW4pKHsKICAgIGxheWVySWQ6IGxheWVySWQsCiAgICBvcDogZ2V0QnVja2V0T3BlcmF0aW9uKGZpZWxkKSwKICAgIGluZGV4UGF0dGVybjogaW5kZXhQYXR0ZXJuLAogICAgY29sdW1uczogX2RlZmluZVByb3BlcnR5KHt9LCBjb2wyLCBjb3VudENvbHVtbiksCiAgICBmaWVsZDogZmllbGQsCiAgICBzdWdnZXN0ZWRQcmlvcml0eTogdW5kZWZpbmVkCiAgfSk7CiAgcmV0dXJuIHsKICAgIGluZGV4UGF0dGVybklkOiBpbmRleFBhdHRlcm4uaWQsCiAgICBjb2x1bW5zOiAoX2NvbHVtbnMyID0ge30sIF9kZWZpbmVQcm9wZXJ0eShfY29sdW1uczIsIGNvbDEsIGNvbHVtbiksIF9kZWZpbmVQcm9wZXJ0eShfY29sdW1uczIsIGNvbDIsIGNvdW50Q29sdW1uKSwgX2NvbHVtbnMyKSwKICAgIGNvbHVtbk9yZGVyOiBbY29sMSwgY29sMl0KICB9Owp9CgpmdW5jdGlvbiBjcmVhdGVOZXdMYXllcldpdGhNZXRyaWNBZ2dyZWdhdGlvbihsYXllcklkLCBpbmRleFBhdHRlcm4sIGZpZWxkKSB7CiAgdmFyIF9jb2x1bW5zMzsKCiAgdmFyIGRhdGVGaWVsZCA9IGluZGV4UGF0dGVybi5maWVsZHMuZmluZChmdW5jdGlvbiAoZikgewogICAgcmV0dXJuIGYubmFtZSA9PT0gaW5kZXhQYXR0ZXJuLnRpbWVGaWVsZE5hbWU7CiAgfSk7CiAgdmFyIG9wZXJhdGlvbnMgPSAoMCwgX29wZXJhdGlvbnMuZ2V0T3BlcmF0aW9uVHlwZXNGb3JGaWVsZCkoZmllbGQpOwogIHZhciBjb2x1bW4gPSAoMCwgX29wZXJhdGlvbnMuYnVpbGRDb2x1bW4pKHsKICAgIG9wOiBvcGVyYXRpb25zWzBdLAogICAgY29sdW1uczoge30sCiAgICBzdWdnZXN0ZWRQcmlvcml0eTogdW5kZWZpbmVkLAogICAgZmllbGQ6IGZpZWxkLAogICAgaW5kZXhQYXR0ZXJuOiBpbmRleFBhdHRlcm4sCiAgICBsYXllcklkOiBsYXllcklkCiAgfSk7CiAgdmFyIGRhdGVDb2x1bW4gPSAoMCwgX29wZXJhdGlvbnMuYnVpbGRDb2x1bW4pKHsKICAgIG9wOiAnZGF0ZV9oaXN0b2dyYW0nLAogICAgY29sdW1uczoge30sCiAgICBzdWdnZXN0ZWRQcmlvcml0eTogdW5kZWZpbmVkLAogICAgZmllbGQ6IGRhdGVGaWVsZCwKICAgIGluZGV4UGF0dGVybjogaW5kZXhQYXR0ZXJuLAogICAgbGF5ZXJJZDogbGF5ZXJJZAogIH0pOwogIHZhciBjb2wxID0gKDAsIF9pZF9nZW5lcmF0b3IuZ2VuZXJhdGVJZCkoKTsKICB2YXIgY29sMiA9ICgwLCBfaWRfZ2VuZXJhdG9yLmdlbmVyYXRlSWQpKCk7CiAgcmV0dXJuIHsKICAgIGluZGV4UGF0dGVybklkOiBpbmRleFBhdHRlcm4uaWQsCiAgICBjb2x1bW5zOiAoX2NvbHVtbnMzID0ge30sIF9kZWZpbmVQcm9wZXJ0eShfY29sdW1uczMsIGNvbDEsIGRhdGVDb2x1bW4pLCBfZGVmaW5lUHJvcGVydHkoX2NvbHVtbnMzLCBjb2wyLCBjb2x1bW4pLCBfY29sdW1uczMpLAogICAgY29sdW1uT3JkZXI6IFtjb2wxLCBjb2wyXQogIH07Cn0KCmZ1bmN0aW9uIGdldERhdGFzb3VyY2VTdWdnZXN0aW9uc0Zyb21DdXJyZW50U3RhdGUoc3RhdGUpIHsKICB2YXIgbGF5ZXJzID0gT2JqZWN0LmVudHJpZXMoc3RhdGUubGF5ZXJzIHx8IHt9KTsKCiAgaWYgKGxheWVycy5sZW5ndGggPiAxKSB7CiAgICAvLyBSZXR1cm4gc3VnZ2VzdGlvbnMgdGhhdCByZWR1Y2UgdGhlIGRhdGEgdG8gZWFjaCBsYXllciBpbmRpdmlkdWFsbHkKICAgIHJldHVybiBsYXllcnMubWFwKGZ1bmN0aW9uIChfcmVmMiwgaW5kZXgpIHsKICAgICAgdmFyIF9yZWYzID0gX3NsaWNlZFRvQXJyYXkoX3JlZjIsIDIpLAogICAgICAgICAgbGF5ZXJJZCA9IF9yZWYzWzBdLAogICAgICAgICAgbGF5ZXIgPSBfcmVmM1sxXTsKCiAgICAgIHZhciBoYXNNYXRjaGluZ0xheWVyID0gbGF5ZXJzLnNvbWUoZnVuY3Rpb24gKF9yZWY0KSB7CiAgICAgICAgdmFyIF9yZWY1ID0gX3NsaWNlZFRvQXJyYXkoX3JlZjQsIDIpLAogICAgICAgICAgICBvdGhlckxheWVySWQgPSBfcmVmNVswXSwKICAgICAgICAgICAgb3RoZXJMYXllciA9IF9yZWY1WzFdOwoKICAgICAgICByZXR1cm4gb3RoZXJMYXllcklkICE9PSBsYXllcklkICYmIG90aGVyTGF5ZXIuaW5kZXhQYXR0ZXJuSWQgPT09IGxheWVyLmluZGV4UGF0dGVybklkOwogICAgICB9KTsKICAgICAgdmFyIHN1Z2dlc3Rpb25UaXRsZSA9IGhhc01hdGNoaW5nTGF5ZXIgPyBfaTE4bi5pMThuLnRyYW5zbGF0ZSgneHBhY2subGVucy5pbmRleFBhdHRlcm5TdWdnZXN0aW9uLnJlbW92ZUxheWVyUG9zaXRpb25MYWJlbCcsIHsKICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ1Nob3cgb25seSBsYXllciB7bGF5ZXJOdW1iZXJ9JywKICAgICAgICB2YWx1ZXM6IHsKICAgICAgICAgIGxheWVyTnVtYmVyOiBpbmRleCArIDEKICAgICAgICB9CiAgICAgIH0pIDogX2kxOG4uaTE4bi50cmFuc2xhdGUoJ3hwYWNrLmxlbnMuaW5kZXhQYXR0ZXJuU3VnZ2VzdGlvbi5yZW1vdmVMYXllckxhYmVsJywgewogICAgICAgIGRlZmF1bHRNZXNzYWdlOiAnU2hvdyBvbmx5IHtpbmRleFBhdHRlcm5UaXRsZX0nLAogICAgICAgIHZhbHVlczogewogICAgICAgICAgaW5kZXhQYXR0ZXJuVGl0bGU6IHN0YXRlLmluZGV4UGF0dGVybnNbbGF5ZXIuaW5kZXhQYXR0ZXJuSWRdLnRpdGxlCiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIGJ1aWxkU3VnZ2VzdGlvbih7CiAgICAgICAgc3RhdGU6IF9vYmplY3RTcHJlYWQoe30sIHN0YXRlLCB7CiAgICAgICAgICBsYXllcnM6IF9kZWZpbmVQcm9wZXJ0eSh7fSwgbGF5ZXJJZCwgbGF5ZXIpCiAgICAgICAgfSksCiAgICAgICAgbGF5ZXJJZDogbGF5ZXJJZCwKICAgICAgICBjaGFuZ2VUeXBlOiAnbGF5ZXJzJywKICAgICAgICBsYWJlbDogc3VnZ2VzdGlvblRpdGxlCiAgICAgIH0pOwogICAgfSkuY29uY2F0KFtidWlsZFN1Z2dlc3Rpb24oewogICAgICBzdGF0ZTogc3RhdGUsCiAgICAgIGxheWVySWQ6IGxheWVyc1swXVswXSwKICAgICAgY2hhbmdlVHlwZTogJ3VuY2hhbmdlZCcKICAgIH0pXSk7CiAgfQoKICByZXR1cm4gX2xvZGFzaC5kZWZhdWx0LmZsYXR0ZW4oT2JqZWN0LmVudHJpZXMoc3RhdGUubGF5ZXJzIHx8IHt9KS5maWx0ZXIoZnVuY3Rpb24gKF9yZWY2KSB7CiAgICB2YXIgX3JlZjcgPSBfc2xpY2VkVG9BcnJheShfcmVmNiwgMiksCiAgICAgICAgX2lkID0gX3JlZjdbMF0sCiAgICAgICAgbGF5ZXIgPSBfcmVmN1sxXTsKCiAgICByZXR1cm4gbGF5ZXIuY29sdW1uT3JkZXIubGVuZ3RoICYmIGxheWVyLmluZGV4UGF0dGVybklkOwogIH0pLm1hcChmdW5jdGlvbiAoX3JlZjgpIHsKICAgIHZhciBfcmVmOSA9IF9zbGljZWRUb0FycmF5KF9yZWY4LCAyKSwKICAgICAgICBsYXllcklkID0gX3JlZjlbMF0sCiAgICAgICAgbGF5ZXIgPSBfcmVmOVsxXTsKCiAgICB2YXIgaW5kZXhQYXR0ZXJuID0gc3RhdGUuaW5kZXhQYXR0ZXJuc1tsYXllci5pbmRleFBhdHRlcm5JZF07CgogICAgdmFyIF9zZXBhcmF0ZUJ1Y2tldENvbHVtbjUgPSBzZXBhcmF0ZUJ1Y2tldENvbHVtbnMobGF5ZXIpLAogICAgICAgIF9zZXBhcmF0ZUJ1Y2tldENvbHVtbjYgPSBfc2xpY2VkVG9BcnJheShfc2VwYXJhdGVCdWNrZXRDb2x1bW41LCAyKSwKICAgICAgICBidWNrZXRzID0gX3NlcGFyYXRlQnVja2V0Q29sdW1uNlswXSwKICAgICAgICBtZXRyaWNzID0gX3NlcGFyYXRlQnVja2V0Q29sdW1uNlsxXTsKCiAgICB2YXIgdGltZURpbWVuc2lvbiA9IGxheWVyLmNvbHVtbk9yZGVyLmZpbmQoZnVuY3Rpb24gKGNvbHVtbklkKSB7CiAgICAgIHJldHVybiBsYXllci5jb2x1bW5zW2NvbHVtbklkXS5pc0J1Y2tldGVkICYmIGxheWVyLmNvbHVtbnNbY29sdW1uSWRdLmRhdGFUeXBlID09PSAnZGF0ZSc7CiAgICB9KTsKICAgIHZhciB0aW1lRmllbGQgPSBpbmRleFBhdHRlcm4uZmllbGRzLmZpbmQoZnVuY3Rpb24gKF9yZWYxMCkgewogICAgICB2YXIgbmFtZSA9IF9yZWYxMC5uYW1lOwogICAgICByZXR1cm4gbmFtZSA9PT0gaW5kZXhQYXR0ZXJuLnRpbWVGaWVsZE5hbWU7CiAgICB9KTsKICAgIHZhciBzdWdnZXN0aW9ucyA9IFtdOwoKICAgIGlmIChtZXRyaWNzLmxlbmd0aCA9PT0gMCkgewogICAgICAvLyBpbnRlcm1lZGlhcnkgY2hhcnQgd2l0aG91dCBtZXRyaWMsIGRvbid0IHRyeSB0byBzdWdnZXN0IHJlZHVjZWQgdmVyc2lvbnMKICAgICAgc3VnZ2VzdGlvbnMucHVzaChidWlsZFN1Z2dlc3Rpb24oewogICAgICAgIHN0YXRlOiBzdGF0ZSwKICAgICAgICBsYXllcklkOiBsYXllcklkLAogICAgICAgIGNoYW5nZVR5cGU6ICd1bmNoYW5nZWQnCiAgICAgIH0pKTsKICAgIH0gZWxzZSBpZiAoYnVja2V0cy5sZW5ndGggPT09IDApIHsKICAgICAgaWYgKHRpbWVGaWVsZCkgewogICAgICAgIC8vIHN1Z2dlc3QgY3VycmVudCBtZXRyaWMgb3ZlciB0aW1lIGlmIHRoZXJlIGlzIGEgZGVmYXVsdCB0aW1lIGZpZWxkCiAgICAgICAgc3VnZ2VzdGlvbnMucHVzaChjcmVhdGVTdWdnZXN0aW9uV2l0aERlZmF1bHREYXRlSGlzdG9ncmFtKHN0YXRlLCBsYXllcklkLCB0aW1lRmllbGQpKTsKICAgICAgfQoKICAgICAgc3VnZ2VzdGlvbnMucHVzaC5hcHBseShzdWdnZXN0aW9ucywgX3RvQ29uc3VtYWJsZUFycmF5KGNyZWF0ZUFsdGVybmF0aXZlTWV0cmljU3VnZ2VzdGlvbnMoaW5kZXhQYXR0ZXJuLCBsYXllcklkLCBzdGF0ZSkpKTsgLy8gYWxzbyBzdWdnZXN0IHNpbXBsZSBjdXJyZW50IHN0YXRlCgogICAgICBzdWdnZXN0aW9ucy5wdXNoKGJ1aWxkU3VnZ2VzdGlvbih7CiAgICAgICAgc3RhdGU6IHN0YXRlLAogICAgICAgIGxheWVySWQ6IGxheWVySWQsCiAgICAgICAgY2hhbmdlVHlwZTogJ3VuY2hhbmdlZCcKICAgICAgfSkpOwogICAgfSBlbHNlIHsKICAgICAgc3VnZ2VzdGlvbnMucHVzaC5hcHBseShzdWdnZXN0aW9ucywgX3RvQ29uc3VtYWJsZUFycmF5KGNyZWF0ZVNpbXBsaWZpZWRUYWJsZVN1Z2dlc3Rpb25zKHN0YXRlLCBsYXllcklkKSkpOwoKICAgICAgaWYgKCF0aW1lRGltZW5zaW9uICYmIHRpbWVGaWVsZCkgewogICAgICAgIC8vIHN1Z2dlc3QgY3VycmVudCBjb25maWd1cmF0aW9uIG92ZXIgdGltZSBpZiB0aGVyZSBpcyBhIGRlZmF1bHQgdGltZSBmaWVsZAogICAgICAgIC8vIGFuZCBubyB0aW1lIGRpbWVuc2lvbiB5ZXQKICAgICAgICBzdWdnZXN0aW9ucy5wdXNoKGNyZWF0ZVN1Z2dlc3Rpb25XaXRoRGVmYXVsdERhdGVIaXN0b2dyYW0oc3RhdGUsIGxheWVySWQsIHRpbWVGaWVsZCkpOwogICAgICB9CgogICAgICBpZiAoYnVja2V0cy5sZW5ndGggPT09IDIpIHsKICAgICAgICBzdWdnZXN0aW9ucy5wdXNoKGNyZWF0ZUNoYW5nZWROZXN0aW5nU3VnZ2VzdGlvbihzdGF0ZSwgbGF5ZXJJZCkpOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHN1Z2dlc3Rpb25zOwogIH0pKTsKfQoKZnVuY3Rpb24gY3JlYXRlQ2hhbmdlZE5lc3RpbmdTdWdnZXN0aW9uKHN0YXRlLCBsYXllcklkKSB7CiAgdmFyIGxheWVyID0gc3RhdGUubGF5ZXJzW2xheWVySWRdOwoKICB2YXIgX2xheWVyJGNvbHVtbk9yZGVyID0gX3RvQXJyYXkobGF5ZXIuY29sdW1uT3JkZXIpLAogICAgICBmaXJzdEJ1Y2tldCA9IF9sYXllciRjb2x1bW5PcmRlclswXSwKICAgICAgc2Vjb25kQnVja2V0ID0gX2xheWVyJGNvbHVtbk9yZGVyWzFdLAogICAgICByZXN0ID0gX2xheWVyJGNvbHVtbk9yZGVyLnNsaWNlKDIpOwoKICB2YXIgdXBkYXRlZExheWVyID0gX29iamVjdFNwcmVhZCh7fSwgbGF5ZXIsIHsKICAgIGNvbHVtbk9yZGVyOiBbc2Vjb25kQnVja2V0LCBmaXJzdEJ1Y2tldF0uY29uY2F0KF90b0NvbnN1bWFibGVBcnJheShyZXN0KSkKICB9KTsKCiAgcmV0dXJuIGJ1aWxkU3VnZ2VzdGlvbih7CiAgICBzdGF0ZTogc3RhdGUsCiAgICBsYXllcklkOiBsYXllcklkLAogICAgdXBkYXRlZExheWVyOiB1cGRhdGVkTGF5ZXIsCiAgICBsYWJlbDogZ2V0TmVzdGVkVGl0bGUoW2xheWVyLmNvbHVtbnNbc2Vjb25kQnVja2V0XSwgbGF5ZXIuY29sdW1uc1tmaXJzdEJ1Y2tldF1dKSwKICAgIGNoYW5nZVR5cGU6ICdleHRlbmRlZCcKICB9KTsKfQoKZnVuY3Rpb24gY3JlYXRlTWV0cmljU3VnZ2VzdGlvbihpbmRleFBhdHRlcm4sIGxheWVySWQsIHN0YXRlLCBmaWVsZCkgewogIHZhciBvcGVyYXRpb25EZWZpbml0aW9uc01hcCA9IF9sb2Rhc2guZGVmYXVsdC5pbmRleEJ5KF9kZWZpbml0aW9ucy5vcGVyYXRpb25EZWZpbml0aW9ucywgJ3R5cGUnKTsKCiAgdmFyIF9nZXRPcGVyYXRpb25UeXBlc0ZvciA9ICgwLCBfb3BlcmF0aW9ucy5nZXRPcGVyYXRpb25UeXBlc0ZvckZpZWxkKShmaWVsZCkubWFwKGZ1bmN0aW9uICh0eXBlKSB7CiAgICByZXR1cm4gb3BlcmF0aW9uRGVmaW5pdGlvbnNNYXBbdHlwZV0uYnVpbGRDb2x1bW4oewogICAgICBmaWVsZDogZmllbGQsCiAgICAgIGluZGV4UGF0dGVybjogaW5kZXhQYXR0ZXJuLAogICAgICBsYXllcklkOiBsYXllcklkLAogICAgICBjb2x1bW5zOiB7fSwKICAgICAgc3VnZ2VzdGVkUHJpb3JpdHk6IDAKICAgIH0pOwogIH0pLmZpbHRlcihmdW5jdGlvbiAob3ApIHsKICAgIHJldHVybiAob3AuZGF0YVR5cGUgPT09ICdudW1iZXInIHx8IG9wLmRhdGFUeXBlID09PSAnZG9jdW1lbnQnKSAmJiAhb3AuaXNCdWNrZXRlZDsKICB9KSwKICAgICAgX2dldE9wZXJhdGlvblR5cGVzRm9yMiA9IF9zbGljZWRUb0FycmF5KF9nZXRPcGVyYXRpb25UeXBlc0ZvciwgMSksCiAgICAgIGNvbHVtbiA9IF9nZXRPcGVyYXRpb25UeXBlc0ZvcjJbMF07CgogIGlmICghY29sdW1uKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgbmV3SWQgPSAoMCwgX2lkX2dlbmVyYXRvci5nZW5lcmF0ZUlkKSgpOwogIHJldHVybiBidWlsZFN1Z2dlc3Rpb24oewogICAgbGF5ZXJJZDogbGF5ZXJJZCwKICAgIHN0YXRlOiBzdGF0ZSwKICAgIGNoYW5nZVR5cGU6ICdpbml0aWFsJywKICAgIHVwZGF0ZWRMYXllcjogewogICAgICBpbmRleFBhdHRlcm5JZDogaW5kZXhQYXR0ZXJuLmlkLAogICAgICBjb2x1bW5zOiBfZGVmaW5lUHJvcGVydHkoe30sIG5ld0lkLCBjb2x1bW4uZGF0YVR5cGUgIT09ICdkb2N1bWVudCcgPyBjb2x1bW4gOiAoMCwgX29wZXJhdGlvbnMuYnVpbGRDb2x1bW4pKHsKICAgICAgICBvcDogJ2NvdW50JywKICAgICAgICBjb2x1bW5zOiB7fSwKICAgICAgICBpbmRleFBhdHRlcm46IGluZGV4UGF0dGVybiwKICAgICAgICBsYXllcklkOiBsYXllcklkLAogICAgICAgIHN1Z2dlc3RlZFByaW9yaXR5OiB1bmRlZmluZWQsCiAgICAgICAgZmllbGQ6IF9kb2N1bWVudF9maWVsZC5kb2N1bWVudEZpZWxkCiAgICAgIH0pKSwKICAgICAgY29sdW1uT3JkZXI6IFtuZXdJZF0KICAgIH0KICB9KTsKfQoKZnVuY3Rpb24gZ2V0TmVzdGVkVGl0bGUoX3JlZjExKSB7CiAgdmFyIF9yZWYxMiA9IF9zbGljZWRUb0FycmF5KF9yZWYxMSwgMiksCiAgICAgIG91dGVyQnVja2V0ID0gX3JlZjEyWzBdLAogICAgICBpbm5lckJ1Y2tldCA9IF9yZWYxMlsxXTsKCiAgcmV0dXJuIF9pMThuLmkxOG4udHJhbnNsYXRlKCd4cGFjay5sZW5zLmluZGV4cGF0dGVybi5zdWdnZXN0aW9ucy5uZXN0aW5nQ2hhbmdlTGFiZWwnLCB7CiAgICBkZWZhdWx0TWVzc2FnZTogJ3tpbm5lck9wZXJhdGlvbn0gZm9yIGVhY2gge291dGVyT3BlcmF0aW9ufScsCiAgICB2YWx1ZXM6IHsKICAgICAgaW5uZXJPcGVyYXRpb246IGlubmVyQnVja2V0LnNvdXJjZUZpZWxkLAogICAgICBvdXRlck9wZXJhdGlvbjogb3V0ZXJCdWNrZXQuc291cmNlRmllbGQKICAgIH0KICB9KTsKfQoKZnVuY3Rpb24gY3JlYXRlQWx0ZXJuYXRpdmVNZXRyaWNTdWdnZXN0aW9ucyhpbmRleFBhdHRlcm4sIGxheWVySWQsIHN0YXRlKSB7CiAgdmFyIGxheWVyID0gc3RhdGUubGF5ZXJzW2xheWVySWRdOwogIHZhciBzdWdnZXN0aW9ucyA9IFtdOwogIGxheWVyLmNvbHVtbk9yZGVyLmZvckVhY2goZnVuY3Rpb24gKGNvbHVtbklkKSB7CiAgICB2YXIgY29sdW1uID0gbGF5ZXIuY29sdW1uc1tjb2x1bW5JZF07CgogICAgaWYgKCEoMCwgX3V0aWxzLmhhc0ZpZWxkKShjb2x1bW4pKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgZmllbGQgPSBpbmRleFBhdHRlcm4uZmllbGRzLmZpbmQoZnVuY3Rpb24gKF9yZWYxMykgewogICAgICB2YXIgbmFtZSA9IF9yZWYxMy5uYW1lOwogICAgICByZXR1cm4gY29sdW1uLnNvdXJjZUZpZWxkID09PSBuYW1lOwogICAgfSk7CiAgICB2YXIgYWx0ZXJuYXRpdmVNZXRyaWNPcGVyYXRpb25zID0gKDAsIF9vcGVyYXRpb25zLmdldE9wZXJhdGlvblR5cGVzRm9yRmllbGQpKGZpZWxkKS5maWx0ZXIoZnVuY3Rpb24gKG9wZXJhdGlvblR5cGUpIHsKICAgICAgcmV0dXJuIG9wZXJhdGlvblR5cGUgIT09IGNvbHVtbi5vcGVyYXRpb25UeXBlOwogICAgfSk7CgogICAgaWYgKGFsdGVybmF0aXZlTWV0cmljT3BlcmF0aW9ucy5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBuZXdJZCA9ICgwLCBfaWRfZ2VuZXJhdG9yLmdlbmVyYXRlSWQpKCk7CiAgICB2YXIgbmV3Q29sdW1uID0gKDAsIF9vcGVyYXRpb25zLmJ1aWxkQ29sdW1uKSh7CiAgICAgIG9wOiBhbHRlcm5hdGl2ZU1ldHJpY09wZXJhdGlvbnNbMF0sCiAgICAgIGNvbHVtbnM6IGxheWVyLmNvbHVtbnMsCiAgICAgIGluZGV4UGF0dGVybjogaW5kZXhQYXR0ZXJuLAogICAgICBsYXllcklkOiBsYXllcklkLAogICAgICBmaWVsZDogZmllbGQsCiAgICAgIHN1Z2dlc3RlZFByaW9yaXR5OiB1bmRlZmluZWQKICAgIH0pOwogICAgdmFyIHVwZGF0ZWRMYXllciA9IHsKICAgICAgaW5kZXhQYXR0ZXJuSWQ6IGluZGV4UGF0dGVybi5pZCwKICAgICAgY29sdW1uczogX2RlZmluZVByb3BlcnR5KHt9LCBuZXdJZCwgbmV3Q29sdW1uKSwKICAgICAgY29sdW1uT3JkZXI6IFtuZXdJZF0KICAgIH07CiAgICBzdWdnZXN0aW9ucy5wdXNoKGJ1aWxkU3VnZ2VzdGlvbih7CiAgICAgIHN0YXRlOiBzdGF0ZSwKICAgICAgbGF5ZXJJZDogbGF5ZXJJZCwKICAgICAgdXBkYXRlZExheWVyOiB1cGRhdGVkTGF5ZXIsCiAgICAgIGNoYW5nZVR5cGU6ICdpbml0aWFsJwogICAgfSkpOwogIH0pOwogIHJldHVybiBzdWdnZXN0aW9uczsKfQoKZnVuY3Rpb24gY3JlYXRlU3VnZ2VzdGlvbldpdGhEZWZhdWx0RGF0ZUhpc3RvZ3JhbShzdGF0ZSwgbGF5ZXJJZCwgdGltZUZpZWxkKSB7CiAgdmFyIGxheWVyID0gc3RhdGUubGF5ZXJzW2xheWVySWRdOwogIHZhciBpbmRleFBhdHRlcm4gPSBzdGF0ZS5pbmRleFBhdHRlcm5zW2xheWVyLmluZGV4UGF0dGVybklkXTsKICB2YXIgbmV3SWQgPSAoMCwgX2lkX2dlbmVyYXRvci5nZW5lcmF0ZUlkKSgpOwoKICB2YXIgX3NlcGFyYXRlQnVja2V0Q29sdW1uNyA9IHNlcGFyYXRlQnVja2V0Q29sdW1ucyhsYXllciksCiAgICAgIF9zZXBhcmF0ZUJ1Y2tldENvbHVtbjggPSBfc2xpY2VkVG9BcnJheShfc2VwYXJhdGVCdWNrZXRDb2x1bW43LCAyKSwKICAgICAgYnVja2V0cyA9IF9zZXBhcmF0ZUJ1Y2tldENvbHVtbjhbMF0sCiAgICAgIG1ldHJpY3MgPSBfc2VwYXJhdGVCdWNrZXRDb2x1bW44WzFdOwoKICB2YXIgdGltZUNvbHVtbiA9ICgwLCBfb3BlcmF0aW9ucy5idWlsZENvbHVtbikoewogICAgbGF5ZXJJZDogbGF5ZXJJZCwKICAgIG9wOiAnZGF0ZV9oaXN0b2dyYW0nLAogICAgaW5kZXhQYXR0ZXJuOiBpbmRleFBhdHRlcm4sCiAgICBjb2x1bW5zOiBsYXllci5jb2x1bW5zLAogICAgZmllbGQ6IHRpbWVGaWVsZCwKICAgIHN1Z2dlc3RlZFByaW9yaXR5OiB1bmRlZmluZWQKICB9KTsKICB2YXIgdXBkYXRlZExheWVyID0gewogICAgaW5kZXhQYXR0ZXJuSWQ6IGxheWVyLmluZGV4UGF0dGVybklkLAogICAgY29sdW1uczogX29iamVjdFNwcmVhZCh7fSwgbGF5ZXIuY29sdW1ucywgX2RlZmluZVByb3BlcnR5KHt9LCBuZXdJZCwgdGltZUNvbHVtbikpLAogICAgY29sdW1uT3JkZXI6IFtdLmNvbmNhdChfdG9Db25zdW1hYmxlQXJyYXkoYnVja2V0cyksIFtuZXdJZF0sIF90b0NvbnN1bWFibGVBcnJheShtZXRyaWNzKSkKICB9OwogIHJldHVybiBidWlsZFN1Z2dlc3Rpb24oewogICAgc3RhdGU6IHN0YXRlLAogICAgbGF5ZXJJZDogbGF5ZXJJZCwKICAgIHVwZGF0ZWRMYXllcjogdXBkYXRlZExheWVyLAogICAgbGFiZWw6IF9pMThuLmkxOG4udHJhbnNsYXRlKCd4cGFjay5sZW5zLmluZGV4cGF0dGVybi5zdWdnZXN0aW9ucy5vdmVyVGltZUxhYmVsJywgewogICAgICBkZWZhdWx0TWVzc2FnZTogJ092ZXIgdGltZScKICAgIH0pLAogICAgY2hhbmdlVHlwZTogJ2V4dGVuZGVkJwogIH0pOwp9CgpmdW5jdGlvbiBjcmVhdGVTaW1wbGlmaWVkVGFibGVTdWdnZXN0aW9ucyhzdGF0ZSwgbGF5ZXJJZCkgewogIHZhciBsYXllciA9IHN0YXRlLmxheWVyc1tsYXllcklkXTsKCiAgdmFyIF9zZXBhcmF0ZUJ1Y2tldENvbHVtbjkgPSBzZXBhcmF0ZUJ1Y2tldENvbHVtbnMobGF5ZXIpLAogICAgICBfc2VwYXJhdGVCdWNrZXRDb2x1bW4xMCA9IF9zbGljZWRUb0FycmF5KF9zZXBhcmF0ZUJ1Y2tldENvbHVtbjksIDIpLAogICAgICBhdmFpbGFibGVCdWNrZXRlZENvbHVtbnMgPSBfc2VwYXJhdGVCdWNrZXRDb2x1bW4xMFswXSwKICAgICAgYXZhaWxhYmxlTWV0cmljQ29sdW1ucyA9IF9zZXBhcmF0ZUJ1Y2tldENvbHVtbjEwWzFdOwoKICByZXR1cm4gX2xvZGFzaC5kZWZhdWx0LmZsYXR0ZW4oYXZhaWxhYmxlQnVja2V0ZWRDb2x1bW5zLm1hcChmdW5jdGlvbiAoX2NvbCwgaW5kZXgpIHsKICAgIC8vIGJ1aWxkIHN1Z2dlc3Rpb25zIHdpdGggZmV3ZXIgYnVja2V0cwogICAgdmFyIGJ1Y2tldGVkQ29sdW1ucyA9IGF2YWlsYWJsZUJ1Y2tldGVkQ29sdW1ucy5zbGljZSgwLCBpbmRleCArIDEpOwoKICAgIHZhciBhbGxNZXRyaWNzU3VnZ2VzdGlvbiA9IF9vYmplY3RTcHJlYWQoe30sIGxheWVyLCB7CiAgICAgIGNvbHVtbk9yZGVyOiBbXS5jb25jYXQoX3RvQ29uc3VtYWJsZUFycmF5KGJ1Y2tldGVkQ29sdW1ucyksIF90b0NvbnN1bWFibGVBcnJheShhdmFpbGFibGVNZXRyaWNDb2x1bW5zKSkKICAgIH0pOwoKICAgIGlmIChhdmFpbGFibGVNZXRyaWNDb2x1bW5zLmxlbmd0aCA+IDEpIHsKICAgICAgcmV0dXJuIFthbGxNZXRyaWNzU3VnZ2VzdGlvbiwgX29iamVjdFNwcmVhZCh7fSwgbGF5ZXIsIHsKICAgICAgICBjb2x1bW5PcmRlcjogW10uY29uY2F0KF90b0NvbnN1bWFibGVBcnJheShidWNrZXRlZENvbHVtbnMpLCBbYXZhaWxhYmxlTWV0cmljQ29sdW1uc1swXV0pCiAgICAgIH0pXTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBhbGxNZXRyaWNzU3VnZ2VzdGlvbjsKICAgIH0KICB9KSkuY29uY2F0KGF2YWlsYWJsZU1ldHJpY0NvbHVtbnMubWFwKGZ1bmN0aW9uIChjb2x1bW5JZCkgewogICAgLy8gYnVpbGQgc3VnZ2VzdGlvbnMgd2l0aCBvbmx5IG1ldHJpY3MKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkKHt9LCBsYXllciwgewogICAgICBjb2x1bW5PcmRlcjogW2NvbHVtbklkXQogICAgfSk7CiAgfSkpLm1hcChmdW5jdGlvbiAodXBkYXRlZExheWVyKSB7CiAgICByZXR1cm4gYnVpbGRTdWdnZXN0aW9uKHsKICAgICAgc3RhdGU6IHN0YXRlLAogICAgICBsYXllcklkOiBsYXllcklkLAogICAgICB1cGRhdGVkTGF5ZXI6IHVwZGF0ZWRMYXllciwKICAgICAgY2hhbmdlVHlwZTogbGF5ZXIuY29sdW1uT3JkZXIubGVuZ3RoID09PSB1cGRhdGVkTGF5ZXIuY29sdW1uT3JkZXIubGVuZ3RoID8gJ3VuY2hhbmdlZCcgOiAncmVkdWNlZCcsCiAgICAgIGxhYmVsOiB1cGRhdGVkTGF5ZXIuY29sdW1uT3JkZXIubGVuZ3RoID09PSAxID8gZ2V0TWV0cmljU3VnZ2VzdGlvblRpdGxlKHVwZGF0ZWRMYXllciwgYXZhaWxhYmxlTWV0cmljQ29sdW1ucy5sZW5ndGggPT09IDEpIDogdW5kZWZpbmVkCiAgICB9KTsKICB9KTsKfQoKZnVuY3Rpb24gZ2V0TWV0cmljU3VnZ2VzdGlvblRpdGxlKGxheWVyLCBvbmx5TWV0cmljKSB7CiAgdmFyIF9sYXllciRjb2x1bW5zJGxheWVyJCA9IGxheWVyLmNvbHVtbnNbbGF5ZXIuY29sdW1uT3JkZXJbMF1dLAogICAgICBvcGVyYXRpb25UeXBlID0gX2xheWVyJGNvbHVtbnMkbGF5ZXIkLm9wZXJhdGlvblR5cGUsCiAgICAgIGxhYmVsID0gX2xheWVyJGNvbHVtbnMkbGF5ZXIkLmxhYmVsOwogIHJldHVybiBfaTE4bi5pMThuLnRyYW5zbGF0ZSgneHBhY2subGVucy5pbmRleHBhdHRlcm4uc3VnZ2VzdGlvbnMub3ZlcmFsbExhYmVsJywgewogICAgZGVmYXVsdE1lc3NhZ2U6ICd7b3BlcmF0aW9ufSBvdmVyYWxsJywKICAgIHZhbHVlczogewogICAgICBvcGVyYXRpb246IG9ubHlNZXRyaWMgPyBfb3BlcmF0aW9ucy5vcGVyYXRpb25EZWZpbml0aW9uTWFwW29wZXJhdGlvblR5cGVdLmRpc3BsYXlOYW1lIDogbGFiZWwKICAgIH0sCiAgICBkZXNjcmlwdGlvbjogJ1RpdGxlIG9mIGEgc3VnZ2VzdGVkIGNoYXJ0IGNvbnRhaW5pbmcgb25seSBhIHNpbmdsZSBudW1lcmljYWwgbWV0cmljIGNhbGN1bGF0ZWQgb3ZlciBhbGwgYXZhaWxhYmxlIGRhdGEnCiAgfSk7Cn0KCmZ1bmN0aW9uIHNlcGFyYXRlQnVja2V0Q29sdW1ucyhsYXllcikgewogIHJldHVybiAoMCwgX2xvZGFzaC5wYXJ0aXRpb24pKGxheWVyLmNvbHVtbk9yZGVyLCBmdW5jdGlvbiAoY29sdW1uSWQpIHsKICAgIHJldHVybiBsYXllci5jb2x1bW5zW2NvbHVtbklkXS5pc0J1Y2tldGVkOwogIH0pOwp9"},null]}
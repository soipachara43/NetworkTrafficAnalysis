{"remainingRequest":"node_modules/thread-loader/dist/cjs.js??ref--8-1!node_modules/babel-loader/lib/index.js??ref--8-2!src/legacy/core_plugins/kibana/public/discover/np_ready/angular/discover.js","dependencies":[{"path":"src/legacy/core_plugins/kibana/public/discover/np_ready/angular/discover.js","mtime":1589249549678},{"path":"node_modules/cache-loader/dist/cjs.js","mtime":1589249605183},{"path":"node_modules/thread-loader/dist/cjs.js","mtime":1589249608558},{"path":"node_modules/babel-loader/lib/index.js","mtime":1589249591025}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:InVzZSBzdHJpY3QiOwoKdmFyIF9sb2Rhc2ggPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoImxvZGFzaCIpKTsKCnZhciBfcmVhY3QgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoInJlYWN0IikpOwoKdmFyIF9yeGpzID0gcmVxdWlyZSgicnhqcyIpOwoKdmFyIF9vcGVyYXRvcnMgPSByZXF1aXJlKCJyeGpzL29wZXJhdG9ycyIpOwoKdmFyIF9tb21lbnQgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoIm1vbWVudCIpKTsKCnZhciBfZGF0ZW1hdGggPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoIkBlbGFzdGljL2RhdGVtYXRoIikpOwoKdmFyIF9pMThuID0gcmVxdWlyZSgiQGtibi9pMThuIik7Cgp2YXIgX2Rpc2NvdmVyX3N0YXRlID0gcmVxdWlyZSgiLi9kaXNjb3Zlcl9zdGF0ZSIpOwoKdmFyIF9wdWJsaWMgPSByZXF1aXJlKCIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wbHVnaW5zL2luc3BlY3Rvci9wdWJsaWMiKTsKCnZhciBfcHVibGljMiA9IHJlcXVpcmUoIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3BsdWdpbnMvc2F2ZWRfb2JqZWN0cy9wdWJsaWMiKTsKCnZhciBfZG9jX3RhYmxlID0gcmVxdWlyZSgiLi9kb2NfdGFibGUiKTsKCnZhciBjb2x1bW5BY3Rpb25zID0gX2ludGVyb3BSZXF1aXJlV2lsZGNhcmQocmVxdWlyZSgiLi9kb2NfdGFibGUvYWN0aW9ucy9jb2x1bW5zIikpOwoKdmFyIF9kaXNjb3ZlciA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZSgiLi9kaXNjb3Zlci5odG1sIikpOwoKdmFyIF9zaG93X29wZW5fc2VhcmNoX3BhbmVsID0gcmVxdWlyZSgiLi4vY29tcG9uZW50cy90b3BfbmF2L3Nob3dfb3Blbl9zZWFyY2hfcGFuZWwiKTsKCnZhciBfaGVscF9tZW51X3V0aWwgPSByZXF1aXJlKCIuLi9jb21wb25lbnRzL2hlbHBfbWVudS9oZWxwX21lbnVfdXRpbCIpOwoKcmVxdWlyZSgiLi4vY29tcG9uZW50cy9mZXRjaF9lcnJvciIpOwoKdmFyIF9nZXRfcGFpbmxlc3NfZXJyb3IgPSByZXF1aXJlKCIuL2dldF9wYWlubGVzc19lcnJvciIpOwoKdmFyIF9yZXNwb25zZV9oYW5kbGVyID0gcmVxdWlyZSgiLi9yZXNwb25zZV9oYW5kbGVyIik7Cgp2YXIgX2tpYmFuYV9zZXJ2aWNlcyA9IHJlcXVpcmUoIi4uLy4uL2tpYmFuYV9zZXJ2aWNlcyIpOwoKdmFyIF9icmVhZGNydW1icyA9IHJlcXVpcmUoIi4uL2hlbHBlcnMvYnJlYWRjcnVtYnMiKTsKCnZhciBfcHVibGljMyA9IHJlcXVpcmUoIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3BsdWdpbnMvZGF0YS9wdWJsaWMiKTsKCnZhciBfZ2V0X2luZGV4X3BhdHRlcm5faWQgPSByZXF1aXJlKCIuLi9oZWxwZXJzL2dldF9pbmRleF9wYXR0ZXJuX2lkIik7Cgp2YXIgX3B1YmxpYzQgPSByZXF1aXJlKCIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wbHVnaW5zL2tpYmFuYV9sZWdhY3kvcHVibGljIik7CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVXaWxkY2FyZChvYmopIHsgaWYgKG9iaiAmJiBvYmouX19lc01vZHVsZSkgeyByZXR1cm4gb2JqOyB9IGVsc2UgeyB2YXIgbmV3T2JqID0ge307IGlmIChvYmogIT0gbnVsbCkgeyBmb3IgKHZhciBrZXkgaW4gb2JqKSB7IGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBrZXkpKSB7IHZhciBkZXNjID0gT2JqZWN0LmRlZmluZVByb3BlcnR5ICYmIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IgPyBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG9iaiwga2V5KSA6IHt9OyBpZiAoZGVzYy5nZXQgfHwgZGVzYy5zZXQpIHsgT2JqZWN0LmRlZmluZVByb3BlcnR5KG5ld09iaiwga2V5LCBkZXNjKTsgfSBlbHNlIHsgbmV3T2JqW2tleV0gPSBvYmpba2V5XTsgfSB9IH0gfSBuZXdPYmouZGVmYXVsdCA9IG9iajsgcmV0dXJuIG5ld09iajsgfSB9CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyBkZWZhdWx0OiBvYmogfTsgfQoKZnVuY3Rpb24gX3NsaWNlZFRvQXJyYXkoYXJyLCBpKSB7IHJldHVybiBfYXJyYXlXaXRoSG9sZXMoYXJyKSB8fCBfaXRlcmFibGVUb0FycmF5TGltaXQoYXJyLCBpKSB8fCBfbm9uSXRlcmFibGVSZXN0KCk7IH0KCmZ1bmN0aW9uIF9ub25JdGVyYWJsZVJlc3QoKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoIkludmFsaWQgYXR0ZW1wdCB0byBkZXN0cnVjdHVyZSBub24taXRlcmFibGUgaW5zdGFuY2UiKTsgfQoKZnVuY3Rpb24gX2l0ZXJhYmxlVG9BcnJheUxpbWl0KGFyciwgaSkgeyB2YXIgX2FyciA9IFtdOyB2YXIgX24gPSB0cnVlOyB2YXIgX2QgPSBmYWxzZTsgdmFyIF9lID0gdW5kZWZpbmVkOyB0cnkgeyBmb3IgKHZhciBfaSA9IGFycltTeW1ib2wuaXRlcmF0b3JdKCksIF9zOyAhKF9uID0gKF9zID0gX2kubmV4dCgpKS5kb25lKTsgX24gPSB0cnVlKSB7IF9hcnIucHVzaChfcy52YWx1ZSk7IGlmIChpICYmIF9hcnIubGVuZ3RoID09PSBpKSBicmVhazsgfSB9IGNhdGNoIChlcnIpIHsgX2QgPSB0cnVlOyBfZSA9IGVycjsgfSBmaW5hbGx5IHsgdHJ5IHsgaWYgKCFfbiAmJiBfaVsicmV0dXJuIl0gIT0gbnVsbCkgX2lbInJldHVybiJdKCk7IH0gZmluYWxseSB7IGlmIChfZCkgdGhyb3cgX2U7IH0gfSByZXR1cm4gX2FycjsgfQoKZnVuY3Rpb24gX2FycmF5V2l0aEhvbGVzKGFycikgeyBpZiAoQXJyYXkuaXNBcnJheShhcnIpKSByZXR1cm4gYXJyOyB9CgpmdW5jdGlvbiBfdG9Db25zdW1hYmxlQXJyYXkoYXJyKSB7IHJldHVybiBfYXJyYXlXaXRob3V0SG9sZXMoYXJyKSB8fCBfaXRlcmFibGVUb0FycmF5KGFycikgfHwgX25vbkl0ZXJhYmxlU3ByZWFkKCk7IH0KCmZ1bmN0aW9uIF9ub25JdGVyYWJsZVNwcmVhZCgpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcigiSW52YWxpZCBhdHRlbXB0IHRvIHNwcmVhZCBub24taXRlcmFibGUgaW5zdGFuY2UiKTsgfQoKZnVuY3Rpb24gX2l0ZXJhYmxlVG9BcnJheShpdGVyKSB7IGlmIChTeW1ib2wuaXRlcmF0b3IgaW4gT2JqZWN0KGl0ZXIpIHx8IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChpdGVyKSA9PT0gIltvYmplY3QgQXJndW1lbnRzXSIpIHJldHVybiBBcnJheS5mcm9tKGl0ZXIpOyB9CgpmdW5jdGlvbiBfYXJyYXlXaXRob3V0SG9sZXMoYXJyKSB7IGlmIChBcnJheS5pc0FycmF5KGFycikpIHsgZm9yICh2YXIgaSA9IDAsIGFycjIgPSBuZXcgQXJyYXkoYXJyLmxlbmd0aCk7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsgYXJyMltpXSA9IGFycltpXTsgfSByZXR1cm4gYXJyMjsgfSB9CgpmdW5jdGlvbiBhc3luY0dlbmVyYXRvclN0ZXAoZ2VuLCByZXNvbHZlLCByZWplY3QsIF9uZXh0LCBfdGhyb3csIGtleSwgYXJnKSB7IHRyeSB7IHZhciBpbmZvID0gZ2VuW2tleV0oYXJnKTsgdmFyIHZhbHVlID0gaW5mby52YWx1ZTsgfSBjYXRjaCAoZXJyb3IpIHsgcmVqZWN0KGVycm9yKTsgcmV0dXJuOyB9IGlmIChpbmZvLmRvbmUpIHsgcmVzb2x2ZSh2YWx1ZSk7IH0gZWxzZSB7IFByb21pc2UucmVzb2x2ZSh2YWx1ZSkudGhlbihfbmV4dCwgX3Rocm93KTsgfSB9CgpmdW5jdGlvbiBfYXN5bmNUb0dlbmVyYXRvcihmbikgeyByZXR1cm4gZnVuY3Rpb24gKCkgeyB2YXIgc2VsZiA9IHRoaXMsIGFyZ3MgPSBhcmd1bWVudHM7IHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7IHZhciBnZW4gPSBmbi5hcHBseShzZWxmLCBhcmdzKTsgZnVuY3Rpb24gX25leHQodmFsdWUpIHsgYXN5bmNHZW5lcmF0b3JTdGVwKGdlbiwgcmVzb2x2ZSwgcmVqZWN0LCBfbmV4dCwgX3Rocm93LCAibmV4dCIsIHZhbHVlKTsgfSBmdW5jdGlvbiBfdGhyb3coZXJyKSB7IGFzeW5jR2VuZXJhdG9yU3RlcChnZW4sIHJlc29sdmUsIHJlamVjdCwgX25leHQsIF90aHJvdywgInRocm93IiwgZXJyKTsgfSBfbmV4dCh1bmRlZmluZWQpOyB9KTsgfTsgfQoKZnVuY3Rpb24gb3duS2V5cyhvYmplY3QsIGVudW1lcmFibGVPbmx5KSB7IHZhciBrZXlzID0gT2JqZWN0LmtleXMob2JqZWN0KTsgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsgdmFyIHN5bWJvbHMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKG9iamVjdCk7IGlmIChlbnVtZXJhYmxlT25seSkgc3ltYm9scyA9IHN5bWJvbHMuZmlsdGVyKGZ1bmN0aW9uIChzeW0pIHsgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqZWN0LCBzeW0pLmVudW1lcmFibGU7IH0pOyBrZXlzLnB1c2guYXBwbHkoa2V5cywgc3ltYm9scyk7IH0gcmV0dXJuIGtleXM7IH0KCmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQodGFyZ2V0KSB7IGZvciAodmFyIGkgPSAxOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7IHZhciBzb3VyY2UgPSBhcmd1bWVudHNbaV0gIT0gbnVsbCA/IGFyZ3VtZW50c1tpXSA6IHt9OyBpZiAoaSAlIDIpIHsgb3duS2V5cyhzb3VyY2UsIHRydWUpLmZvckVhY2goZnVuY3Rpb24gKGtleSkgeyBfZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHNvdXJjZVtrZXldKTsgfSk7IH0gZWxzZSBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMpIHsgT2JqZWN0LmRlZmluZVByb3BlcnRpZXModGFyZ2V0LCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyhzb3VyY2UpKTsgfSBlbHNlIHsgb3duS2V5cyhzb3VyY2UpLmZvckVhY2goZnVuY3Rpb24gKGtleSkgeyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Ioc291cmNlLCBrZXkpKTsgfSk7IH0gfSByZXR1cm4gdGFyZ2V0OyB9CgpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkob2JqLCBrZXksIHZhbHVlKSB7IGlmIChrZXkgaW4gb2JqKSB7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvYmosIGtleSwgeyB2YWx1ZTogdmFsdWUsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSk7IH0gZWxzZSB7IG9ialtrZXldID0gdmFsdWU7IH0gcmV0dXJuIG9iajsgfQoKdmFyIF9nZXRTZXJ2aWNlcyA9ICgwLCBfa2liYW5hX3NlcnZpY2VzLmdldFNlcnZpY2VzKSgpLAogICAgY29yZSA9IF9nZXRTZXJ2aWNlcy5jb3JlLAogICAgY2hyb21lID0gX2dldFNlcnZpY2VzLmNocm9tZSwKICAgIGRhdGEgPSBfZ2V0U2VydmljZXMuZGF0YSwKICAgIGhpc3RvcnkgPSBfZ2V0U2VydmljZXMuaGlzdG9yeSwKICAgIGluZGV4UGF0dGVybnMgPSBfZ2V0U2VydmljZXMuaW5kZXhQYXR0ZXJucywKICAgIGZpbHRlck1hbmFnZXIgPSBfZ2V0U2VydmljZXMuZmlsdGVyTWFuYWdlciwKICAgIHNoYXJlID0gX2dldFNlcnZpY2VzLnNoYXJlLAogICAgdGltZWZpbHRlciA9IF9nZXRTZXJ2aWNlcy50aW1lZmlsdGVyLAogICAgdG9hc3ROb3RpZmljYXRpb25zID0gX2dldFNlcnZpY2VzLnRvYXN0Tm90aWZpY2F0aW9ucywKICAgIGNvbmZpZyA9IF9nZXRTZXJ2aWNlcy51aVNldHRpbmdzLAogICAgdmlzdWFsaXphdGlvbnMgPSBfZ2V0U2VydmljZXMudmlzdWFsaXphdGlvbnM7Cgp2YXIgZmV0Y2hTdGF0dXNlcyA9IHsKICBVTklOSVRJQUxJWkVEOiAndW5pbml0aWFsaXplZCcsCiAgTE9BRElORzogJ2xvYWRpbmcnLAogIENPTVBMRVRFOiAnY29tcGxldGUnCn07CnZhciBhcHAgPSAoMCwgX2tpYmFuYV9zZXJ2aWNlcy5nZXRBbmd1bGFyTW9kdWxlKSgpOwphcHAuY29uZmlnKGZ1bmN0aW9uICgkcm91dGVQcm92aWRlcikgewogIHZhciBkZWZhdWx0cyA9IHsKICAgIHJlcXVpcmVEZWZhdWx0SW5kZXg6IHRydWUsCiAgICByZXF1aXJlVUlDYXBhYmlsaXR5OiAnZGlzY292ZXIuc2hvdycsCiAgICBrN0JyZWFkY3J1bWJzOiBmdW5jdGlvbiBrN0JyZWFkY3J1bWJzKCRyb3V0ZSwgJGluamVjdG9yKSB7CiAgICAgIHJldHVybiAkaW5qZWN0b3IuaW52b2tlKCRyb3V0ZS5jdXJyZW50LnBhcmFtcy5pZCA/IF9icmVhZGNydW1icy5nZXRTYXZlZFNlYXJjaEJyZWFkY3J1bWJzIDogX2JyZWFkY3J1bWJzLmdldFJvb3RCcmVhZGNydW1icyk7CiAgICB9LAogICAgYmFkZ2U6IGZ1bmN0aW9uIGJhZGdlKHVpQ2FwYWJpbGl0aWVzKSB7CiAgICAgIGlmICh1aUNhcGFiaWxpdGllcy5kaXNjb3Zlci5zYXZlKSB7CiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgfQoKICAgICAgcmV0dXJuIHsKICAgICAgICB0ZXh0OiBfaTE4bi5pMThuLnRyYW5zbGF0ZSgna2JuLmRpc2NvdmVyLmJhZGdlLnJlYWRPbmx5LnRleHQnLCB7CiAgICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ1JlYWQgb25seScKICAgICAgICB9KSwKICAgICAgICB0b29sdGlwOiBfaTE4bi5pMThuLnRyYW5zbGF0ZSgna2JuLmRpc2NvdmVyLmJhZGdlLnJlYWRPbmx5LnRvb2x0aXAnLCB7CiAgICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ1VuYWJsZSB0byBzYXZlIHNlYXJjaGVzJwogICAgICAgIH0pLAogICAgICAgIGljb25UeXBlOiAnZ2xhc3NlcycKICAgICAgfTsKICAgIH0KICB9OwogICRyb3V0ZVByb3ZpZGVyLndoZW4oJy9kaXNjb3Zlci86aWQ/JywgX29iamVjdFNwcmVhZCh7fSwgZGVmYXVsdHMsIHsKICAgIHRlbXBsYXRlOiBfZGlzY292ZXIuZGVmYXVsdCwKICAgIHJlbG9hZE9uU2VhcmNoOiBmYWxzZSwKICAgIHJlc29sdmU6IHsKICAgICAgc2F2ZWRPYmplY3RzOiBmdW5jdGlvbiBzYXZlZE9iamVjdHMoJHJvdXRlLCBQcm9taXNlKSB7CiAgICAgICAgdmFyIHNhdmVkU2VhcmNoSWQgPSAkcm91dGUuY3VycmVudC5wYXJhbXMuaWQ7CiAgICAgICAgcmV0dXJuICgwLCBfa2liYW5hX3NlcnZpY2VzLmVuc3VyZURlZmF1bHRJbmRleFBhdHRlcm4pKGNvcmUsIGRhdGEsIGhpc3RvcnkpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgdmFyIF9nZXRTdGF0ZSA9ICgwLCBfZGlzY292ZXJfc3RhdGUuZ2V0U3RhdGUpKHsKICAgICAgICAgICAgaGlzdG9yeTogaGlzdG9yeQogICAgICAgICAgfSksCiAgICAgICAgICAgICAgYXBwU3RhdGVDb250YWluZXIgPSBfZ2V0U3RhdGUuYXBwU3RhdGVDb250YWluZXI7CgogICAgICAgICAgdmFyIF9hcHBTdGF0ZUNvbnRhaW5lciRnZSA9IGFwcFN0YXRlQ29udGFpbmVyLmdldFN0YXRlKCksCiAgICAgICAgICAgICAgaW5kZXggPSBfYXBwU3RhdGVDb250YWluZXIkZ2UuaW5kZXg7CgogICAgICAgICAgcmV0dXJuIFByb21pc2UucHJvcHMoewogICAgICAgICAgICBpcDogaW5kZXhQYXR0ZXJucy5nZXRDYWNoZSgpLnRoZW4oZnVuY3Rpb24gKGluZGV4UGF0dGVybkxpc3QpIHsKICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgKiAgSW4gbWFraW5nIHRoZSBpbmRleFBhdHRlcm4gbW9kaWZpYWJsZSBpdCB3YXMgcGxhY2VkIGluIGFwcFN0YXRlLiBVbmZvcnR1bmF0ZWx5LAogICAgICAgICAgICAgICAqICB0aGUgbG9hZCBvcmRlciBvZiBBcHBTdGF0ZSBjb25mbGljdHMgd2l0aCB0aGUgbG9hZCBvcmRlciBvZiBtYW55IG90aGVyIHRoaW5ncwogICAgICAgICAgICAgICAqICBzbyBpbiBvcmRlciB0byBnZXQgdGhlIG5hbWUgb2YgdGhlIGluZGV4IHdlIHNob3VsZCB1c2UsIGFuZCB0byBzd2l0Y2ggdG8gdGhlCiAgICAgICAgICAgICAgICogIGRlZmF1bHQgaWYgbmVjZXNzYXJ5LCB3ZSBwYXJzZSB0aGUgYXBwU3RhdGUgd2l0aCBhIHRlbXBvcmFyeSBTdGF0ZSBvYmplY3QgYW5kCiAgICAgICAgICAgICAgICogIHRoZW4gZGVzdHJveSBpdCBpbW1lZGlhdGx5IGFmdGVyIHdlJ3JlIGRvbmUKICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAqICBAdHlwZSB7U3RhdGV9CiAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgdmFyIGlkID0gKDAsIF9nZXRfaW5kZXhfcGF0dGVybl9pZC5nZXRJbmRleFBhdHRlcm5JZCkoaW5kZXgsIGluZGV4UGF0dGVybkxpc3QsIGNvbmZpZy5nZXQoJ2RlZmF1bHRJbmRleCcpKTsKICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5wcm9wcyh7CiAgICAgICAgICAgICAgICBsaXN0OiBpbmRleFBhdHRlcm5MaXN0LAogICAgICAgICAgICAgICAgbG9hZGVkOiBpbmRleFBhdHRlcm5zLmdldChpZCksCiAgICAgICAgICAgICAgICBzdGF0ZVZhbDogaW5kZXgsCiAgICAgICAgICAgICAgICBzdGF0ZVZhbEZvdW5kOiAhIWluZGV4ICYmIGlkID09PSBpbmRleAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KSwKICAgICAgICAgICAgc2F2ZWRTZWFyY2g6ICgwLCBfa2liYW5hX3NlcnZpY2VzLmdldFNlcnZpY2VzKSgpLmdldFNhdmVkU2VhcmNoQnlJZChzYXZlZFNlYXJjaElkKS50aGVuKGZ1bmN0aW9uIChzYXZlZFNlYXJjaCkgewogICAgICAgICAgICAgIGlmIChzYXZlZFNlYXJjaElkKSB7CiAgICAgICAgICAgICAgICBjaHJvbWUucmVjZW50bHlBY2Nlc3NlZC5hZGQoc2F2ZWRTZWFyY2guZ2V0RnVsbFBhdGgoKSwgc2F2ZWRTZWFyY2gudGl0bGUsIHNhdmVkU2VhcmNoSWQpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgcmV0dXJuIHNhdmVkU2VhcmNoOwogICAgICAgICAgICB9KS5jYXRjaCgoMCwgX2tpYmFuYV9zZXJ2aWNlcy5yZWRpcmVjdFdoZW5NaXNzaW5nKSh7CiAgICAgICAgICAgICAgaGlzdG9yeTogaGlzdG9yeSwKICAgICAgICAgICAgICBtYXBwaW5nOiB7CiAgICAgICAgICAgICAgICBzZWFyY2g6ICcvZGlzY292ZXInLAogICAgICAgICAgICAgICAgJ2luZGV4LXBhdHRlcm4nOiAnL21hbmFnZW1lbnQva2liYW5hL29iamVjdHMvc2F2ZWRTZWFyY2hlcy8nICsgJHJvdXRlLmN1cnJlbnQucGFyYW1zLmlkCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB0b2FzdE5vdGlmaWNhdGlvbnM6IHRvYXN0Tm90aWZpY2F0aW9ucywKICAgICAgICAgICAgICBvbkJlZm9yZVJlZGlyZWN0OiBmdW5jdGlvbiBvbkJlZm9yZVJlZGlyZWN0KCkgewogICAgICAgICAgICAgICAgKDAsIF9raWJhbmFfc2VydmljZXMuZ2V0VXJsVHJhY2tlcikoKS5zZXRUcmFja2VkVXJsKCcvZGlzY292ZXInKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pKQogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICB9KSk7Cn0pOwphcHAuZGlyZWN0aXZlKCdkaXNjb3ZlckFwcCcsIGZ1bmN0aW9uICgpIHsKICByZXR1cm4gewogICAgcmVzdHJpY3Q6ICdFJywKICAgIGNvbnRyb2xsZXJBczogJ2Rpc2NvdmVyQXBwJywKICAgIGNvbnRyb2xsZXI6IGRpc2NvdmVyQ29udHJvbGxlcgogIH07Cn0pOwoKZnVuY3Rpb24gZGlzY292ZXJDb250cm9sbGVyKCRlbGVtZW50LCAkcm91dGUsICRzY29wZSwgJHRpbWVvdXQsICR3aW5kb3csIFByb21pc2UsIGxvY2FsU3RvcmFnZSwgdWlDYXBhYmlsaXRpZXMpIHsKICB2YXIgX3RoaXMgPSB0aGlzOwoKICB2YXIgaXNEZWZhdWx0VHlwZSA9IF9wdWJsaWMzLmluZGV4UGF0dGVybnMuaXNEZWZhdWx0OwogIHZhciBzdWJzY3JpcHRpb25zID0gbmV3IF9yeGpzLlN1YnNjcmlwdGlvbigpOwogIHZhciAkZmV0Y2hPYnNlcnZhYmxlID0gbmV3IF9yeGpzLlN1YmplY3QoKTsKICB2YXIgaW5zcGVjdG9yUmVxdWVzdDsKICB2YXIgc2F2ZWRTZWFyY2ggPSAkcm91dGUuY3VycmVudC5sb2NhbHMuc2F2ZWRPYmplY3RzLnNhdmVkU2VhcmNoOwogICRzY29wZS5zZWFyY2hTb3VyY2UgPSBzYXZlZFNlYXJjaC5zZWFyY2hTb3VyY2U7CiAgJHNjb3BlLmluZGV4UGF0dGVybiA9IHJlc29sdmVJbmRleFBhdHRlcm5Mb2FkaW5nKCk7IC8vdXNlZCBmb3IgZnVuY3Rpb25hbCB0ZXN0aW5nCgogICRzY29wZS5mZXRjaENvdW50ZXIgPSAwOwoKICB2YXIgZ2V0VGltZUZpZWxkID0gZnVuY3Rpb24gZ2V0VGltZUZpZWxkKCkgewogICAgcmV0dXJuIGlzRGVmYXVsdFR5cGUoJHNjb3BlLmluZGV4UGF0dGVybikgPyAkc2NvcGUuaW5kZXhQYXR0ZXJuLnRpbWVGaWVsZE5hbWUgOiB1bmRlZmluZWQ7CiAgfTsKCiAgdmFyIF9nZXRTdGF0ZTIgPSAoMCwgX2Rpc2NvdmVyX3N0YXRlLmdldFN0YXRlKSh7CiAgICBkZWZhdWx0QXBwU3RhdGU6IGdldFN0YXRlRGVmYXVsdHMoKSwKICAgIHN0b3JlSW5TZXNzaW9uU3RvcmFnZTogY29uZmlnLmdldCgnc3RhdGU6c3RvcmVJblNlc3Npb25TdG9yYWdlJyksCiAgICBoaXN0b3J5OiBoaXN0b3J5CiAgfSksCiAgICAgIGFwcFN0YXRlQ29udGFpbmVyID0gX2dldFN0YXRlMi5hcHBTdGF0ZUNvbnRhaW5lciwKICAgICAgc3RhcnRTdGF0ZVN5bmMgPSBfZ2V0U3RhdGUyLnN0YXJ0U3luYywKICAgICAgc3RvcFN0YXRlU3luYyA9IF9nZXRTdGF0ZTIuc3RvcFN5bmMsCiAgICAgIHNldEFwcFN0YXRlID0gX2dldFN0YXRlMi5zZXRBcHBTdGF0ZSwKICAgICAgcmVwbGFjZVVybEFwcFN0YXRlID0gX2dldFN0YXRlMi5yZXBsYWNlVXJsQXBwU3RhdGUsCiAgICAgIGlzQXBwU3RhdGVEaXJ0eSA9IF9nZXRTdGF0ZTIuaXNBcHBTdGF0ZURpcnR5LAogICAgICBrYm5VcmxTdGF0ZVN0b3JhZ2UgPSBfZ2V0U3RhdGUyLmtiblVybFN0YXRlU3RvcmFnZSwKICAgICAgZ2V0UHJldmlvdXNBcHBTdGF0ZSA9IF9nZXRTdGF0ZTIuZ2V0UHJldmlvdXNBcHBTdGF0ZSwKICAgICAgcmVzZXRJbml0aWFsQXBwU3RhdGUgPSBfZ2V0U3RhdGUyLnJlc2V0SW5pdGlhbEFwcFN0YXRlOwoKICBpZiAoYXBwU3RhdGVDb250YWluZXIuZ2V0U3RhdGUoKS5pbmRleCAhPT0gJHNjb3BlLmluZGV4UGF0dGVybi5pZCkgewogICAgLy91c2VkIGluZGV4IHBhdHRlcm4gaXMgZGlmZmVyZW50IHRoYW4gdGhlIGdpdmVuIGJ5IHVybC9zdGF0ZSB3aGljaCBpcyBpbnZhbGlkCiAgICBzZXRBcHBTdGF0ZSh7CiAgICAgIGluZGV4OiAkc2NvcGUuaW5kZXhQYXR0ZXJuLmlkCiAgICB9KTsKICB9CgogICRzY29wZS5zdGF0ZSA9IF9vYmplY3RTcHJlYWQoe30sIGFwcFN0YXRlQ29udGFpbmVyLmdldFN0YXRlKCkpOyAvLyBzeW5jcyBgX2dgIHBvcnRpb24gb2YgdXJsIHdpdGggcXVlcnkgc2VydmljZXMKCiAgdmFyIF9zeW5jUXVlcnlTdGF0ZVdpdGhVciA9ICgwLCBfcHVibGljMy5zeW5jUXVlcnlTdGF0ZVdpdGhVcmwpKGRhdGEucXVlcnksIGtiblVybFN0YXRlU3RvcmFnZSksCiAgICAgIHN0b3BTeW5jaW5nR2xvYmFsU3RhdGVXaXRoVXJsID0gX3N5bmNRdWVyeVN0YXRlV2l0aFVyLnN0b3A7IC8vIHN5bmMgaW5pdGlhbCBhcHAgZmlsdGVycyBmcm9tIHN0YXRlIHRvIGZpbHRlck1hbmFnZXIKCgogIGZpbHRlck1hbmFnZXIuc2V0QXBwRmlsdGVycyhfbG9kYXNoLmRlZmF1bHQuY2xvbmVEZWVwKGFwcFN0YXRlQ29udGFpbmVyLmdldFN0YXRlKCkuZmlsdGVycykpOwogIHZhciBzdG9wU3luY2luZ1F1ZXJ5QXBwU3RhdGVXaXRoU3RhdGVDb250YWluZXIgPSAoMCwgX3B1YmxpYzMuY29ubmVjdFRvUXVlcnlTdGF0ZSkoZGF0YS5xdWVyeSwgYXBwU3RhdGVDb250YWluZXIsIHsKICAgIGZpbHRlcnM6IF9wdWJsaWMzLmVzRmlsdGVycy5GaWx0ZXJTdGF0ZVN0b3JlLkFQUF9TVEFURQogIH0pOwogIHZhciBhcHBTdGF0ZVVuc3Vic2NyaWJlID0gYXBwU3RhdGVDb250YWluZXIuc3Vic2NyaWJlKAogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICB2YXIgX3JlZiA9IF9hc3luY1RvR2VuZXJhdG9yKAogICAgLyojX19QVVJFX18qLwogICAgcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTIobmV3U3RhdGUpIHsKICAgICAgdmFyIF9zcGxpdFN0YXRlLCBuZXdTdGF0ZVBhcnRpYWwsIF9zcGxpdFN0YXRlMiwgb2xkU3RhdGVQYXJ0aWFsOwoKICAgICAgcmV0dXJuIHJlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUyJChfY29udGV4dDIpIHsKICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgc3dpdGNoIChfY29udGV4dDIucHJldiA9IF9jb250ZXh0Mi5uZXh0KSB7CiAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICBfc3BsaXRTdGF0ZSA9ICgwLCBfZGlzY292ZXJfc3RhdGUuc3BsaXRTdGF0ZSkobmV3U3RhdGUpLCBuZXdTdGF0ZVBhcnRpYWwgPSBfc3BsaXRTdGF0ZS5zdGF0ZTsKICAgICAgICAgICAgICBfc3BsaXRTdGF0ZTIgPSAoMCwgX2Rpc2NvdmVyX3N0YXRlLnNwbGl0U3RhdGUpKGdldFByZXZpb3VzQXBwU3RhdGUoKSksIG9sZFN0YXRlUGFydGlhbCA9IF9zcGxpdFN0YXRlMi5zdGF0ZTsKCiAgICAgICAgICAgICAgaWYgKCFfbG9kYXNoLmRlZmF1bHQuaXNFcXVhbChuZXdTdGF0ZVBhcnRpYWwsIG9sZFN0YXRlUGFydGlhbCkpIHsKICAgICAgICAgICAgICAgICRzY29wZS4kZXZhbEFzeW5jKAogICAgICAgICAgICAgICAgLyojX19QVVJFX18qLwogICAgICAgICAgICAgICAgX2FzeW5jVG9HZW5lcmF0b3IoCiAgICAgICAgICAgICAgICAvKiNfX1BVUkVfXyovCiAgICAgICAgICAgICAgICByZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlKCkgewogICAgICAgICAgICAgICAgICB2YXIgY2hhbmdlczsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUkKF9jb250ZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQucHJldiA9IF9jb250ZXh0Lm5leHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5zdGF0ZSA9IF9vYmplY3RTcHJlYWQoe30sIG5ld1N0YXRlKTsgLy8gZGV0ZWN0IGNoYW5nZXMgdGhhdCBzaG91bGQgdHJpZ2dlciBmZXRjaGluZyBvZiBuZXcgZGF0YQoKICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFuZ2VzID0gWydpbnRlcnZhbCcsICdzb3J0JywgJ3F1ZXJ5J10uZmlsdGVyKGZ1bmN0aW9uIChwcm9wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gIV9sb2Rhc2guZGVmYXVsdC5pc0VxdWFsKG5ld1N0YXRlUGFydGlhbFtwcm9wXSwgb2xkU3RhdGVQYXJ0aWFsW3Byb3BdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNoYW5nZXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZmV0Y2hPYnNlcnZhYmxlLm5leHQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0LnN0b3AoKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0sIF9jYWxsZWUpOwogICAgICAgICAgICAgICAgfSkpKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Mi5zdG9wKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LCBfY2FsbGVlMik7CiAgICB9KSk7CgogICAgcmV0dXJuIGZ1bmN0aW9uIChfeCkgewogICAgICByZXR1cm4gX3JlZi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfTsKICB9KCkpOyAvLyB0aGlzIGxpc3RlbmVyIGlzIHdhaXRpbmcgZm9yIHN1Y2ggYSBwYXRoIGh0dHA6Ly9sb2NhbGhvc3Q6NTYwMS9hcHAva2liYW5hIy9kaXNjb3ZlcgogIC8vIHdoaWNoIGNvdWxkIGJlIHNldCB0aHJvdWdoIHByZXNzaW5nICJOZXciIGJ1dHRvbiBpbiB0b3AgbmF2IG9yIGdvIHRvICJEaXNjb3ZlciIgcGx1Z2luIGZyb20gdGhlIHNpZGViYXIKICAvLyB0byByZWxvYWQgdGhlIHBhZ2UgaW4gYSByaWdodCB3YXkKCiAgdmFyIHVubGlzdGVuSGlzdG9yeUJhc2VQYXRoID0gaGlzdG9yeS5saXN0ZW4oZnVuY3Rpb24gKF9yZWYzKSB7CiAgICB2YXIgcGF0aG5hbWUgPSBfcmVmMy5wYXRobmFtZSwKICAgICAgICBzZWFyY2ggPSBfcmVmMy5zZWFyY2gsCiAgICAgICAgaGFzaCA9IF9yZWYzLmhhc2g7CgogICAgaWYgKCFzZWFyY2ggJiYgIWhhc2ggJiYgcGF0aG5hbWUgPT09ICcvZGlzY292ZXInKSB7CiAgICAgICRyb3V0ZS5yZWxvYWQoKTsKICAgIH0KICB9KTsKCiAgJHNjb3BlLnNldEluZGV4UGF0dGVybiA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIHZhciBfcmVmNCA9IF9hc3luY1RvR2VuZXJhdG9yKAogICAgLyojX19QVVJFX18qLwogICAgcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTMoaWQpIHsKICAgICAgcmV0dXJuIHJlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUzJChfY29udGV4dDMpIHsKICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgc3dpdGNoIChfY29udGV4dDMucHJldiA9IF9jb250ZXh0My5uZXh0KSB7CiAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICBfY29udGV4dDMubmV4dCA9IDI7CiAgICAgICAgICAgICAgcmV0dXJuIHJlcGxhY2VVcmxBcHBTdGF0ZSh7CiAgICAgICAgICAgICAgICBpbmRleDogaWQKICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAkcm91dGUucmVsb2FkKCk7CgogICAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0My5zdG9wKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LCBfY2FsbGVlMyk7CiAgICB9KSk7CgogICAgcmV0dXJuIGZ1bmN0aW9uIChfeDIpIHsKICAgICAgcmV0dXJuIF9yZWY0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9OwogIH0oKTsgLy8gdXBkYXRlIGRhdGEgc291cmNlIHdoZW4gZmlsdGVycyB1cGRhdGUKCgogIHN1YnNjcmlwdGlvbnMuYWRkKCgwLCBfa2liYW5hX3NlcnZpY2VzLnN1YnNjcmliZVdpdGhTY29wZSkoJHNjb3BlLCBmaWx0ZXJNYW5hZ2VyLmdldFVwZGF0ZXMkKCksIHsKICAgIG5leHQ6IGZ1bmN0aW9uIG5leHQoKSB7CiAgICAgICRzY29wZS5zdGF0ZS5maWx0ZXJzID0gZmlsdGVyTWFuYWdlci5nZXRBcHBGaWx0ZXJzKCk7CiAgICAgICRzY29wZS51cGRhdGVEYXRhU291cmNlKCk7CiAgICB9CiAgfSwgZnVuY3Rpb24gKGVycm9yKSB7CiAgICByZXR1cm4gKDAsIF9wdWJsaWM0LmFkZEZhdGFsRXJyb3IpKGNvcmUuZmF0YWxFcnJvcnMsIGVycm9yKTsKICB9KSk7CiAgdmFyIGluc3BlY3RvckFkYXB0ZXJzID0gewogICAgcmVxdWVzdHM6IG5ldyBfcHVibGljLlJlcXVlc3RBZGFwdGVyKCkKICB9OwoKICAkc2NvcGUudGltZWZpbHRlclVwZGF0ZUhhbmRsZXIgPSBmdW5jdGlvbiAocmFuZ2VzKSB7CiAgICB0aW1lZmlsdGVyLnNldFRpbWUoewogICAgICBmcm9tOiAoMCwgX21vbWVudC5kZWZhdWx0KShyYW5nZXMuZnJvbSkudG9JU09TdHJpbmcoKSwKICAgICAgdG86ICgwLCBfbW9tZW50LmRlZmF1bHQpKHJhbmdlcy50bykudG9JU09TdHJpbmcoKSwKICAgICAgbW9kZTogJ2Fic29sdXRlJwogICAgfSk7CiAgfTsKCiAgJHNjb3BlLmludGVydmFsT3B0aW9ucyA9IF9wdWJsaWMzLnNlYXJjaC5hZ2dzLmludGVydmFsT3B0aW9uczsKICAkc2NvcGUubWluaW11bVZpc2libGVSb3dzID0gNTA7CiAgJHNjb3BlLmZldGNoU3RhdHVzID0gZmV0Y2hTdGF0dXNlcy5VTklOSVRJQUxJWkVEOwogICRzY29wZS5zaG93U2F2ZVF1ZXJ5ID0gdWlDYXBhYmlsaXRpZXMuZGlzY292ZXIuc2F2ZVF1ZXJ5OwogICRzY29wZS4kd2F0Y2goZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHVpQ2FwYWJpbGl0aWVzLmRpc2NvdmVyLnNhdmVRdWVyeTsKICB9LCBmdW5jdGlvbiAobmV3Q2FwYWJpbGl0eSkgewogICAgJHNjb3BlLnNob3dTYXZlUXVlcnkgPSBuZXdDYXBhYmlsaXR5OwogIH0pOwoKICAkc2NvcGUuaW50ZXJ2YWxFbmFibGVkID0gZnVuY3Rpb24gKGludGVydmFsKSB7CiAgICByZXR1cm4gaW50ZXJ2YWwudmFsICE9PSAnY3VzdG9tJzsKICB9OwoKICB2YXIgYWJvcnRDb250cm9sbGVyOwogICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24gKCkgewogICAgaWYgKGFib3J0Q29udHJvbGxlcikgYWJvcnRDb250cm9sbGVyLmFib3J0KCk7CiAgICBzYXZlZFNlYXJjaC5kZXN0cm95KCk7CiAgICBzdWJzY3JpcHRpb25zLnVuc3Vic2NyaWJlKCk7CiAgICBhcHBTdGF0ZVVuc3Vic2NyaWJlKCk7CiAgICBzdG9wU3RhdGVTeW5jKCk7CiAgICBzdG9wU3luY2luZ0dsb2JhbFN0YXRlV2l0aFVybCgpOwogICAgc3RvcFN5bmNpbmdRdWVyeUFwcFN0YXRlV2l0aFN0YXRlQ29udGFpbmVyKCk7CiAgICB1bmxpc3Rlbkhpc3RvcnlCYXNlUGF0aCgpOwogIH0pOwoKICB2YXIgZ2V0VG9wTmF2TGlua3MgPSBmdW5jdGlvbiBnZXRUb3BOYXZMaW5rcygpIHsKICAgIHZhciBuZXdTZWFyY2ggPSB7CiAgICAgIGlkOiAnbmV3JywKICAgICAgbGFiZWw6IF9pMThuLmkxOG4udHJhbnNsYXRlKCdrYm4uZGlzY292ZXIubG9jYWxNZW51LmxvY2FsTWVudS5uZXdTZWFyY2hUaXRsZScsIHsKICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ05ldycKICAgICAgfSksCiAgICAgIGRlc2NyaXB0aW9uOiBfaTE4bi5pMThuLnRyYW5zbGF0ZSgna2JuLmRpc2NvdmVyLmxvY2FsTWVudS5uZXdTZWFyY2hEZXNjcmlwdGlvbicsIHsKICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ05ldyBTZWFyY2gnCiAgICAgIH0pLAogICAgICBydW46IGZ1bmN0aW9uIHJ1bigpIHsKICAgICAgICAkc2NvcGUuJGV2YWxBc3luYyhmdW5jdGlvbiAoKSB7CiAgICAgICAgICBoaXN0b3J5LnB1c2goJy9kaXNjb3ZlcicpOwogICAgICAgIH0pOwogICAgICB9LAogICAgICB0ZXN0SWQ6ICdkaXNjb3Zlck5ld0J1dHRvbicKICAgIH07CiAgICB2YXIgc2F2ZVNlYXJjaCA9IHsKICAgICAgaWQ6ICdzYXZlJywKICAgICAgbGFiZWw6IF9pMThuLmkxOG4udHJhbnNsYXRlKCdrYm4uZGlzY292ZXIubG9jYWxNZW51LnNhdmVUaXRsZScsIHsKICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ1NhdmUnCiAgICAgIH0pLAogICAgICBkZXNjcmlwdGlvbjogX2kxOG4uaTE4bi50cmFuc2xhdGUoJ2tibi5kaXNjb3Zlci5sb2NhbE1lbnUuc2F2ZVNlYXJjaERlc2NyaXB0aW9uJywgewogICAgICAgIGRlZmF1bHRNZXNzYWdlOiAnU2F2ZSBTZWFyY2gnCiAgICAgIH0pLAogICAgICB0ZXN0SWQ6ICdkaXNjb3ZlclNhdmVCdXR0b24nLAogICAgICBydW46IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgX3J1biA9IF9hc3luY1RvR2VuZXJhdG9yKAogICAgICAgIC8qI19fUFVSRV9fKi8KICAgICAgICByZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlNCgpIHsKICAgICAgICAgIHZhciBvblNhdmUsIHNhdmVNb2RhbDsKICAgICAgICAgIHJldHVybiByZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlNCQoX2NvbnRleHQ0KSB7CiAgICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDQucHJldiA9IF9jb250ZXh0NC5uZXh0KSB7CiAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgIG9uU2F2ZSA9IGZ1bmN0aW9uIG9uU2F2ZShfcmVmNSkgewogICAgICAgICAgICAgICAgICAgIHZhciBuZXdUaXRsZSA9IF9yZWY1Lm5ld1RpdGxlLAogICAgICAgICAgICAgICAgICAgICAgICBuZXdDb3B5T25TYXZlID0gX3JlZjUubmV3Q29weU9uU2F2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgaXNUaXRsZUR1cGxpY2F0ZUNvbmZpcm1lZCA9IF9yZWY1LmlzVGl0bGVEdXBsaWNhdGVDb25maXJtZWQsCiAgICAgICAgICAgICAgICAgICAgICAgIG9uVGl0bGVEdXBsaWNhdGUgPSBfcmVmNS5vblRpdGxlRHVwbGljYXRlOwogICAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50VGl0bGUgPSBzYXZlZFNlYXJjaC50aXRsZTsKICAgICAgICAgICAgICAgICAgICBzYXZlZFNlYXJjaC50aXRsZSA9IG5ld1RpdGxlOwogICAgICAgICAgICAgICAgICAgIHNhdmVkU2VhcmNoLmNvcHlPblNhdmUgPSBuZXdDb3B5T25TYXZlOwogICAgICAgICAgICAgICAgICAgIHZhciBzYXZlT3B0aW9ucyA9IHsKICAgICAgICAgICAgICAgICAgICAgIGNvbmZpcm1PdmVyd3JpdGU6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgaXNUaXRsZUR1cGxpY2F0ZUNvbmZpcm1lZDogaXNUaXRsZUR1cGxpY2F0ZUNvbmZpcm1lZCwKICAgICAgICAgICAgICAgICAgICAgIG9uVGl0bGVEdXBsaWNhdGU6IG9uVGl0bGVEdXBsaWNhdGUKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIHJldHVybiBzYXZlRGF0YVNvdXJjZShzYXZlT3B0aW9ucykudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIElmIHRoZSBzYXZlIHdhc24ndCBzdWNjZXNzZnVsLCBwdXQgdGhlIG9yaWdpbmFsIHZhbHVlcyBiYWNrLgogICAgICAgICAgICAgICAgICAgICAgaWYgKCFyZXNwb25zZS5pZCB8fCByZXNwb25zZS5lcnJvcikgewogICAgICAgICAgICAgICAgICAgICAgICBzYXZlZFNlYXJjaC50aXRsZSA9IGN1cnJlbnRUaXRsZTsKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc2V0SW5pdGlhbEFwcFN0YXRlKCk7CiAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgc2F2ZU1vZGFsID0gX3JlYWN0LmRlZmF1bHQuY3JlYXRlRWxlbWVudChfcHVibGljMi5TYXZlZE9iamVjdFNhdmVNb2RhbCwgewogICAgICAgICAgICAgICAgICAgIG9uU2F2ZTogb25TYXZlLAogICAgICAgICAgICAgICAgICAgIG9uQ2xvc2U6IGZ1bmN0aW9uIG9uQ2xvc2UoKSB7fSwKICAgICAgICAgICAgICAgICAgICB0aXRsZTogc2F2ZWRTZWFyY2gudGl0bGUsCiAgICAgICAgICAgICAgICAgICAgc2hvd0NvcHlPblNhdmU6ICEhc2F2ZWRTZWFyY2guaWQsCiAgICAgICAgICAgICAgICAgICAgb2JqZWN0VHlwZTogInNlYXJjaCIsCiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IF9pMThuLmkxOG4udHJhbnNsYXRlKCdrYm4uZGlzY292ZXIubG9jYWxNZW51LnNhdmVTYXZlU2VhcmNoRGVzY3JpcHRpb24nLCB7CiAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ1NhdmUgeW91ciBEaXNjb3ZlciBzZWFyY2ggc28geW91IGNhbiB1c2UgaXQgaW4gdmlzdWFsaXphdGlvbnMgYW5kIGRhc2hib2FyZHMnCiAgICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICAgICAgc2hvd0Rlc2NyaXB0aW9uOiBmYWxzZQogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgKDAsIF9wdWJsaWMyLnNob3dTYXZlTW9kYWwpKHNhdmVNb2RhbCwgY29yZS5pMThuLkNvbnRleHQpOwoKICAgICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDQuc3RvcCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSwgX2NhbGxlZTQpOwogICAgICAgIH0pKTsKCiAgICAgICAgZnVuY3Rpb24gcnVuKCkgewogICAgICAgICAgcmV0dXJuIF9ydW4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBydW47CiAgICAgIH0oKQogICAgfTsKICAgIHZhciBvcGVuU2VhcmNoID0gewogICAgICBpZDogJ29wZW4nLAogICAgICBsYWJlbDogX2kxOG4uaTE4bi50cmFuc2xhdGUoJ2tibi5kaXNjb3Zlci5sb2NhbE1lbnUub3BlblRpdGxlJywgewogICAgICAgIGRlZmF1bHRNZXNzYWdlOiAnT3BlbicKICAgICAgfSksCiAgICAgIGRlc2NyaXB0aW9uOiBfaTE4bi5pMThuLnRyYW5zbGF0ZSgna2JuLmRpc2NvdmVyLmxvY2FsTWVudS5vcGVuU2F2ZWRTZWFyY2hEZXNjcmlwdGlvbicsIHsKICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ09wZW4gU2F2ZWQgU2VhcmNoJwogICAgICB9KSwKICAgICAgdGVzdElkOiAnZGlzY292ZXJPcGVuQnV0dG9uJywKICAgICAgcnVuOiBmdW5jdGlvbiBydW4oKSB7CiAgICAgICAgKDAsIF9zaG93X29wZW5fc2VhcmNoX3BhbmVsLnNob3dPcGVuU2VhcmNoUGFuZWwpKHsKICAgICAgICAgIG1ha2VVcmw6IGZ1bmN0aW9uIG1ha2VVcmwoc2VhcmNoSWQpIHsKICAgICAgICAgICAgcmV0dXJuICIjL2Rpc2NvdmVyLyIuY29uY2F0KGVuY29kZVVSSUNvbXBvbmVudChzZWFyY2hJZCkpOwogICAgICAgICAgfSwKICAgICAgICAgIEkxOG5Db250ZXh0OiBjb3JlLmkxOG4uQ29udGV4dAogICAgICAgIH0pOwogICAgICB9CiAgICB9OwogICAgdmFyIHNoYXJlU2VhcmNoID0gewogICAgICBpZDogJ3NoYXJlJywKICAgICAgbGFiZWw6IF9pMThuLmkxOG4udHJhbnNsYXRlKCdrYm4uZGlzY292ZXIubG9jYWxNZW51LnNoYXJlVGl0bGUnLCB7CiAgICAgICAgZGVmYXVsdE1lc3NhZ2U6ICdTaGFyZScKICAgICAgfSksCiAgICAgIGRlc2NyaXB0aW9uOiBfaTE4bi5pMThuLnRyYW5zbGF0ZSgna2JuLmRpc2NvdmVyLmxvY2FsTWVudS5zaGFyZVNlYXJjaERlc2NyaXB0aW9uJywgewogICAgICAgIGRlZmF1bHRNZXNzYWdlOiAnU2hhcmUgU2VhcmNoJwogICAgICB9KSwKICAgICAgdGVzdElkOiAnc2hhcmVUb3BOYXZCdXR0b24nLAogICAgICBydW46IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgX3J1bjIgPSBfYXN5bmNUb0dlbmVyYXRvcigKICAgICAgICAvKiNfX1BVUkVfXyovCiAgICAgICAgcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTUoYW5jaG9yRWxlbWVudCkgewogICAgICAgICAgdmFyIHNoYXJpbmdEYXRhOwogICAgICAgICAgcmV0dXJuIHJlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWU1JChfY29udGV4dDUpIHsKICAgICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0NS5wcmV2ID0gX2NvbnRleHQ1Lm5leHQpIHsKICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ1Lm5leHQgPSAyOwogICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMuZ2V0U2hhcmluZ0RhdGEoKTsKCiAgICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICAgIHNoYXJpbmdEYXRhID0gX2NvbnRleHQ1LnNlbnQ7CiAgICAgICAgICAgICAgICAgIHNoYXJlLnRvZ2dsZVNoYXJlQ29udGV4dE1lbnUoewogICAgICAgICAgICAgICAgICAgIGFuY2hvckVsZW1lbnQ6IGFuY2hvckVsZW1lbnQsCiAgICAgICAgICAgICAgICAgICAgYWxsb3dFbWJlZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgYWxsb3dTaG9ydFVybDogdWlDYXBhYmlsaXRpZXMuZGlzY292ZXIuY3JlYXRlU2hvcnRVcmwsCiAgICAgICAgICAgICAgICAgICAgc2hhcmVhYmxlVXJsOiAoMCwgX2tpYmFuYV9zZXJ2aWNlcy51bmhhc2hVcmwpKHdpbmRvdy5sb2NhdGlvbi5ocmVmKSwKICAgICAgICAgICAgICAgICAgICBvYmplY3RJZDogc2F2ZWRTZWFyY2guaWQsCiAgICAgICAgICAgICAgICAgICAgb2JqZWN0VHlwZTogJ3NlYXJjaCcsCiAgICAgICAgICAgICAgICAgICAgc2hhcmluZ0RhdGE6IF9vYmplY3RTcHJlYWQoe30sIHNoYXJpbmdEYXRhLCB7CiAgICAgICAgICAgICAgICAgICAgICB0aXRsZTogc2F2ZWRTZWFyY2gudGl0bGUKICAgICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgICAgICBpc0RpcnR5OiAhc2F2ZWRTZWFyY2guaWQgfHwgaXNBcHBTdGF0ZURpcnR5KCkKICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0NS5zdG9wKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9LCBfY2FsbGVlNSk7CiAgICAgICAgfSkpOwoKICAgICAgICBmdW5jdGlvbiBydW4oX3gzKSB7CiAgICAgICAgICByZXR1cm4gX3J1bjIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBydW47CiAgICAgIH0oKQogICAgfTsKICAgIHZhciBpbnNwZWN0U2VhcmNoID0gewogICAgICBpZDogJ2luc3BlY3QnLAogICAgICBsYWJlbDogX2kxOG4uaTE4bi50cmFuc2xhdGUoJ2tibi5kaXNjb3Zlci5sb2NhbE1lbnUuaW5zcGVjdFRpdGxlJywgewogICAgICAgIGRlZmF1bHRNZXNzYWdlOiAnSW5zcGVjdCcKICAgICAgfSksCiAgICAgIGRlc2NyaXB0aW9uOiBfaTE4bi5pMThuLnRyYW5zbGF0ZSgna2JuLmRpc2NvdmVyLmxvY2FsTWVudS5vcGVuSW5zcGVjdG9yRm9yU2VhcmNoRGVzY3JpcHRpb24nLCB7CiAgICAgICAgZGVmYXVsdE1lc3NhZ2U6ICdPcGVuIEluc3BlY3RvciBmb3Igc2VhcmNoJwogICAgICB9KSwKICAgICAgdGVzdElkOiAnb3Blbkluc3BlY3RvckJ1dHRvbicsCiAgICAgIHJ1bjogZnVuY3Rpb24gcnVuKCkgewogICAgICAgICgwLCBfa2liYW5hX3NlcnZpY2VzLmdldFNlcnZpY2VzKSgpLmluc3BlY3Rvci5vcGVuKGluc3BlY3RvckFkYXB0ZXJzLCB7CiAgICAgICAgICB0aXRsZTogc2F2ZWRTZWFyY2gudGl0bGUKICAgICAgICB9KTsKICAgICAgfQogICAgfTsKICAgIHJldHVybiBbbmV3U2VhcmNoXS5jb25jYXQoX3RvQ29uc3VtYWJsZUFycmF5KHVpQ2FwYWJpbGl0aWVzLmRpc2NvdmVyLnNhdmUgPyBbc2F2ZVNlYXJjaF0gOiBbXSksIFtvcGVuU2VhcmNoLCBzaGFyZVNlYXJjaCwgaW5zcGVjdFNlYXJjaF0pOwogIH07CgogICRzY29wZS50b3BOYXZNZW51ID0gZ2V0VG9wTmF2TGlua3MoKTsKICAkc2NvcGUuc2VhcmNoU291cmNlLnNldEZpZWxkKCdpbmRleCcsICRzY29wZS5pbmRleFBhdHRlcm4pLnNldEZpZWxkKCdoaWdobGlnaHRBbGwnLCB0cnVlKS5zZXRGaWVsZCgndmVyc2lvbicsIHRydWUpOyAvLyBFdmVuIHdoZW4gc2VhcmNoaW5nIHJvbGx1cHMsIHdlIHdhbnQgdG8gdXNlIHRoZSBkZWZhdWx0IHN0cmF0ZWd5IHNvIHRoYXQgd2UgZ2V0IGJhY2sgYQogIC8vIGRvY3VtZW50LWxpa2UgcmVzcG9uc2UuCgogICRzY29wZS5zZWFyY2hTb3VyY2Uuc2V0UHJlZmVycmVkU2VhcmNoU3RyYXRlZ3lJZCgnZGVmYXVsdCcpOyAvLyBzZWFyY2hTb3VyY2Ugd2hpY2ggYXBwbGllcyB0aW1lIHJhbmdlCgogIHZhciB0aW1lUmFuZ2VTZWFyY2hTb3VyY2UgPSBzYXZlZFNlYXJjaC5zZWFyY2hTb3VyY2UuY3JlYXRlKCk7CgogIGlmIChpc0RlZmF1bHRUeXBlKCRzY29wZS5pbmRleFBhdHRlcm4pKSB7CiAgICB0aW1lUmFuZ2VTZWFyY2hTb3VyY2Uuc2V0RmllbGQoJ2ZpbHRlcicsIGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRpbWVmaWx0ZXIuY3JlYXRlRmlsdGVyKCRzY29wZS5pbmRleFBhdHRlcm4pOwogICAgfSk7CiAgfQoKICAkc2NvcGUuc2VhcmNoU291cmNlLnNldFBhcmVudCh0aW1lUmFuZ2VTZWFyY2hTb3VyY2UpOwogIHZhciBwYWdlVGl0bGVTdWZmaXggPSBzYXZlZFNlYXJjaC5pZCAmJiBzYXZlZFNlYXJjaC50aXRsZSA/ICI6ICIuY29uY2F0KHNhdmVkU2VhcmNoLnRpdGxlKSA6ICcnOwogIGNocm9tZS5kb2NUaXRsZS5jaGFuZ2UoIkRpc2NvdmVyIi5jb25jYXQocGFnZVRpdGxlU3VmZml4KSk7CgogIHZhciBkaXNjb3ZlckJyZWFkY3J1bWJzVGl0bGUgPSBfaTE4bi5pMThuLnRyYW5zbGF0ZSgna2JuLmRpc2NvdmVyLmRpc2NvdmVyQnJlYWRjcnVtYlRpdGxlJywgewogICAgZGVmYXVsdE1lc3NhZ2U6ICdEaXNjb3ZlcicKICB9KTsKCiAgaWYgKHNhdmVkU2VhcmNoLmlkICYmIHNhdmVkU2VhcmNoLnRpdGxlKSB7CiAgICBjaHJvbWUuc2V0QnJlYWRjcnVtYnMoW3sKICAgICAgdGV4dDogZGlzY292ZXJCcmVhZGNydW1ic1RpdGxlLAogICAgICBocmVmOiAnIy9kaXNjb3ZlcicKICAgIH0sIHsKICAgICAgdGV4dDogc2F2ZWRTZWFyY2gudGl0bGUKICAgIH1dKTsKICB9IGVsc2UgewogICAgY2hyb21lLnNldEJyZWFkY3J1bWJzKFt7CiAgICAgIHRleHQ6IGRpc2NvdmVyQnJlYWRjcnVtYnNUaXRsZQogICAgfV0pOwogIH0KCiAgJHNjb3BlLnNjcmVlblRpdGxlID0gc2F2ZWRTZWFyY2gudGl0bGU7CgogIHZhciBnZXRGaWVsZENvdW50cyA9CiAgLyojX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIHZhciBfcmVmNiA9IF9hc3luY1RvR2VuZXJhdG9yKAogICAgLyojX19QVVJFX18qLwogICAgcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTYoKSB7CiAgICAgIHJldHVybiByZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlNiQoX2NvbnRleHQ2KSB7CiAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQ2LnByZXYgPSBfY29udGV4dDYubmV4dCkgewogICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgaWYgKCEoJHNjb3BlLmZldGNoU3RhdHVzID09PSBmZXRjaFN0YXR1c2VzLkNPTVBMRVRFKSkgewogICAgICAgICAgICAgICAgX2NvbnRleHQ2Lm5leHQgPSAyOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ2LmFicnVwdCgicmV0dXJuIiwgJHNjb3BlLmZpZWxkQ291bnRzKTsKCiAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICBfY29udGV4dDYubmV4dCA9IDQ7CiAgICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlKSB7CiAgICAgICAgICAgICAgICB2YXIgdW53YXRjaCA9ICRzY29wZS4kd2F0Y2goJ2ZldGNoU3RhdHVzJywgZnVuY3Rpb24gKG5ld1ZhbHVlKSB7CiAgICAgICAgICAgICAgICAgIGlmIChuZXdWYWx1ZSA9PT0gZmV0Y2hTdGF0dXNlcy5DT01QTEVURSkgewogICAgICAgICAgICAgICAgICAgIHVud2F0Y2goKTsKICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCRzY29wZS5maWVsZENvdW50cyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDYuYWJydXB0KCJyZXR1cm4iLCBfY29udGV4dDYuc2VudCk7CgogICAgICAgICAgICBjYXNlIDU6CiAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Ni5zdG9wKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LCBfY2FsbGVlNik7CiAgICB9KSk7CgogICAgcmV0dXJuIGZ1bmN0aW9uIGdldEZpZWxkQ291bnRzKCkgewogICAgICByZXR1cm4gX3JlZjYuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH07CiAgfSgpOwoKICB2YXIgZ2V0U2hhcmluZ0RhdGFGaWVsZHMgPQogIC8qI19fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICB2YXIgX3JlZjcgPSBfYXN5bmNUb0dlbmVyYXRvcigKICAgIC8qI19fUFVSRV9fKi8KICAgIHJlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWU3KHNlbGVjdGVkRmllbGRzLCB0aW1lRmllbGROYW1lLCBoaWRlVGltZUNvbHVtbikgewogICAgICB2YXIgZmllbGRDb3VudHMsIGZpZWxkczsKICAgICAgcmV0dXJuIHJlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWU3JChfY29udGV4dDcpIHsKICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgc3dpdGNoIChfY29udGV4dDcucHJldiA9IF9jb250ZXh0Ny5uZXh0KSB7CiAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICBpZiAoIShzZWxlY3RlZEZpZWxkcy5sZW5ndGggPT09IDEgJiYgc2VsZWN0ZWRGaWVsZHNbMF0gPT09ICdfc291cmNlJykpIHsKICAgICAgICAgICAgICAgIF9jb250ZXh0Ny5uZXh0ID0gNTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgX2NvbnRleHQ3Lm5leHQgPSAzOwogICAgICAgICAgICAgIHJldHVybiBnZXRGaWVsZENvdW50cygpOwoKICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgIGZpZWxkQ291bnRzID0gX2NvbnRleHQ3LnNlbnQ7CiAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Ny5hYnJ1cHQoInJldHVybiIsIHsKICAgICAgICAgICAgICAgIHNlYXJjaEZpZWxkczogbnVsbCwKICAgICAgICAgICAgICAgIHNlbGVjdEZpZWxkczogX2xvZGFzaC5kZWZhdWx0LmtleXMoZmllbGRDb3VudHMpLnNvcnQoKQogICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICAgIGZpZWxkcyA9IHRpbWVGaWVsZE5hbWUgJiYgIWhpZGVUaW1lQ29sdW1uID8gW3RpbWVGaWVsZE5hbWVdLmNvbmNhdChfdG9Db25zdW1hYmxlQXJyYXkoc2VsZWN0ZWRGaWVsZHMpKSA6IHNlbGVjdGVkRmllbGRzOwogICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDcuYWJydXB0KCJyZXR1cm4iLCB7CiAgICAgICAgICAgICAgICBzZWFyY2hGaWVsZHM6IGZpZWxkcywKICAgICAgICAgICAgICAgIHNlbGVjdEZpZWxkczogZmllbGRzCiAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBjYXNlIDc6CiAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Ny5zdG9wKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LCBfY2FsbGVlNyk7CiAgICB9KSk7CgogICAgcmV0dXJuIGZ1bmN0aW9uIGdldFNoYXJpbmdEYXRhRmllbGRzKF94NCwgX3g1LCBfeDYpIHsKICAgICAgcmV0dXJuIF9yZWY3LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9OwogIH0oKTsKCiAgdGhpcy5nZXRTaGFyaW5nRGF0YSA9CiAgLyojX19QVVJFX18qLwogIF9hc3luY1RvR2VuZXJhdG9yKAogIC8qI19fUFVSRV9fKi8KICByZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlOCgpIHsKICAgIHZhciBzZWFyY2hTb3VyY2UsIF9yZWY5LCBzZWFyY2hGaWVsZHMsIHNlbGVjdEZpZWxkcywgYm9keTsKCiAgICByZXR1cm4gcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTgkKF9jb250ZXh0OCkgewogICAgICB3aGlsZSAoMSkgewogICAgICAgIHN3aXRjaCAoX2NvbnRleHQ4LnByZXYgPSBfY29udGV4dDgubmV4dCkgewogICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICBzZWFyY2hTb3VyY2UgPSAkc2NvcGUuc2VhcmNoU291cmNlLmNyZWF0ZUNvcHkoKTsKICAgICAgICAgICAgX2NvbnRleHQ4Lm5leHQgPSAzOwogICAgICAgICAgICByZXR1cm4gZ2V0U2hhcmluZ0RhdGFGaWVsZHMoJHNjb3BlLnN0YXRlLmNvbHVtbnMsICRzY29wZS5pbmRleFBhdHRlcm4udGltZUZpZWxkTmFtZSwgY29uZmlnLmdldCgnZG9jX3RhYmxlOmhpZGVUaW1lQ29sdW1uJykpOwoKICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgX3JlZjkgPSBfY29udGV4dDguc2VudDsKICAgICAgICAgICAgc2VhcmNoRmllbGRzID0gX3JlZjkuc2VhcmNoRmllbGRzOwogICAgICAgICAgICBzZWxlY3RGaWVsZHMgPSBfcmVmOS5zZWxlY3RGaWVsZHM7CiAgICAgICAgICAgIHNlYXJjaFNvdXJjZS5zZXRGaWVsZCgnZmllbGRzJywgc2VhcmNoRmllbGRzKTsKICAgICAgICAgICAgc2VhcmNoU291cmNlLnNldEZpZWxkKCdzb3J0JywgKDAsIF9kb2NfdGFibGUuZ2V0U29ydEZvclNlYXJjaFNvdXJjZSkoJHNjb3BlLnN0YXRlLnNvcnQsICRzY29wZS5pbmRleFBhdHRlcm4sIGNvbmZpZy5nZXQoJ2Rpc2NvdmVyOnNvcnQ6ZGVmYXVsdE9yZGVyJykpKTsKICAgICAgICAgICAgc2VhcmNoU291cmNlLnNldEZpZWxkKCdoaWdobGlnaHQnLCBudWxsKTsKICAgICAgICAgICAgc2VhcmNoU291cmNlLnNldEZpZWxkKCdoaWdobGlnaHRBbGwnLCBudWxsKTsKICAgICAgICAgICAgc2VhcmNoU291cmNlLnNldEZpZWxkKCdhZ2dzJywgbnVsbCk7CiAgICAgICAgICAgIHNlYXJjaFNvdXJjZS5zZXRGaWVsZCgnc2l6ZScsIG51bGwpOwogICAgICAgICAgICBfY29udGV4dDgubmV4dCA9IDE0OwogICAgICAgICAgICByZXR1cm4gc2VhcmNoU291cmNlLmdldFNlYXJjaFJlcXVlc3RCb2R5KCk7CgogICAgICAgICAgY2FzZSAxNDoKICAgICAgICAgICAgYm9keSA9IF9jb250ZXh0OC5zZW50OwogICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ4LmFicnVwdCgicmV0dXJuIiwgewogICAgICAgICAgICAgIHNlYXJjaFJlcXVlc3Q6IHsKICAgICAgICAgICAgICAgIGluZGV4OiBzZWFyY2hTb3VyY2UuZ2V0RmllbGQoJ2luZGV4JykudGl0bGUsCiAgICAgICAgICAgICAgICBib2R5OiBib2R5CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBmaWVsZHM6IHNlbGVjdEZpZWxkcywKICAgICAgICAgICAgICBtZXRhRmllbGRzOiAkc2NvcGUuaW5kZXhQYXR0ZXJuLm1ldGFGaWVsZHMsCiAgICAgICAgICAgICAgY29uZmxpY3RlZFR5cGVzRmllbGRzOiAkc2NvcGUuaW5kZXhQYXR0ZXJuLmZpZWxkcy5maWx0ZXIoZnVuY3Rpb24gKGYpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmLnR5cGUgPT09ICdjb25mbGljdCc7CiAgICAgICAgICAgICAgfSkubWFwKGZ1bmN0aW9uIChmKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZi5uYW1lOwogICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgIGluZGV4UGF0dGVybklkOiBzZWFyY2hTb3VyY2UuZ2V0RmllbGQoJ2luZGV4JykuaWQKICAgICAgICAgICAgfSk7CgogICAgICAgICAgY2FzZSAxNjoKICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgIHJldHVybiBfY29udGV4dDguc3RvcCgpOwogICAgICAgIH0KICAgICAgfQogICAgfSwgX2NhbGxlZTgpOwogIH0pKTsKCiAgZnVuY3Rpb24gZ2V0U3RhdGVEZWZhdWx0cygpIHsKICAgIHZhciBxdWVyeSA9ICRzY29wZS5zZWFyY2hTb3VyY2UuZ2V0RmllbGQoJ3F1ZXJ5JykgfHwgKDAsIF9wdWJsaWMzLmdldERlZmF1bHRRdWVyeSkobG9jYWxTdG9yYWdlLmdldCgna2liYW5hLnVzZXJRdWVyeUxhbmd1YWdlJykgfHwgY29uZmlnLmdldCgnc2VhcmNoOnF1ZXJ5TGFuZ3VhZ2UnKSk7CiAgICByZXR1cm4gewogICAgICBxdWVyeTogcXVlcnksCiAgICAgIHNvcnQ6ICgwLCBfZG9jX3RhYmxlLmdldFNvcnRBcnJheSkoc2F2ZWRTZWFyY2guc29ydCwgJHNjb3BlLmluZGV4UGF0dGVybiksCiAgICAgIGNvbHVtbnM6IHNhdmVkU2VhcmNoLmNvbHVtbnMubGVuZ3RoID4gMCA/IHNhdmVkU2VhcmNoLmNvbHVtbnMgOiBjb25maWcuZ2V0KCdkZWZhdWx0Q29sdW1ucycpLnNsaWNlKCksCiAgICAgIGluZGV4OiAkc2NvcGUuaW5kZXhQYXR0ZXJuLmlkLAogICAgICBpbnRlcnZhbDogJ2F1dG8nLAogICAgICBmaWx0ZXJzOiBfbG9kYXNoLmRlZmF1bHQuY2xvbmVEZWVwKCRzY29wZS5zZWFyY2hTb3VyY2UuZ2V0T3duRmllbGQoJ2ZpbHRlcicpKQogICAgfTsKICB9CgogICRzY29wZS5zdGF0ZS5pbmRleCA9ICRzY29wZS5pbmRleFBhdHRlcm4uaWQ7CiAgJHNjb3BlLnN0YXRlLnNvcnQgPSAoMCwgX2RvY190YWJsZS5nZXRTb3J0QXJyYXkpKCRzY29wZS5zdGF0ZS5zb3J0LCAkc2NvcGUuaW5kZXhQYXR0ZXJuKTsKCiAgJHNjb3BlLmdldEJ1Y2tldEludGVydmFsVG9vbFRpcFRleHQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gX2kxOG4uaTE4bi50cmFuc2xhdGUoJ2tibi5kaXNjb3Zlci5idWNrZXRJbnRlcnZhbFRvb2x0aXAnLCB7CiAgICAgIGRlZmF1bHRNZXNzYWdlOiAnVGhpcyBpbnRlcnZhbCBjcmVhdGVzIHtidWNrZXRzRGVzY3JpcHRpb259IHRvIHNob3cgaW4gdGhlIHNlbGVjdGVkIHRpbWUgcmFuZ2UsIHNvIGl0IGhhcyBiZWVuIHNjYWxlZCB0byB7YnVja2V0SW50ZXJ2YWxEZXNjcmlwdGlvbn0nLAogICAgICB2YWx1ZXM6IHsKICAgICAgICBidWNrZXRzRGVzY3JpcHRpb246ICRzY29wZS5idWNrZXRJbnRlcnZhbC5zY2FsZSA+IDEgPyBfaTE4bi5pMThuLnRyYW5zbGF0ZSgna2JuLmRpc2NvdmVyLmJ1Y2tldEludGVydmFsVG9vbHRpcC50b29MYXJnZUJ1Y2tldHNUZXh0JywgewogICAgICAgICAgZGVmYXVsdE1lc3NhZ2U6ICdidWNrZXRzIHRoYXQgYXJlIHRvbyBsYXJnZScKICAgICAgICB9KSA6IF9pMThuLmkxOG4udHJhbnNsYXRlKCdrYm4uZGlzY292ZXIuYnVja2V0SW50ZXJ2YWxUb29sdGlwLnRvb01hbnlCdWNrZXRzVGV4dCcsIHsKICAgICAgICAgIGRlZmF1bHRNZXNzYWdlOiAndG9vIG1hbnkgYnVja2V0cycKICAgICAgICB9KSwKICAgICAgICBidWNrZXRJbnRlcnZhbERlc2NyaXB0aW9uOiAkc2NvcGUuYnVja2V0SW50ZXJ2YWwuZGVzY3JpcHRpb24KICAgICAgfQogICAgfSk7CiAgfTsKCiAgJHNjb3BlLm9wdHMgPSB7CiAgICAvLyBudW1iZXIgb2YgcmVjb3JkcyB0byBmZXRjaCwgdGhlbiBwYWdpbmF0ZSB0aHJvdWdoCiAgICBzYW1wbGVTaXplOiBjb25maWcuZ2V0KCdkaXNjb3ZlcjpzYW1wbGVTaXplJyksCiAgICB0aW1lZmllbGQ6IGdldFRpbWVGaWVsZCgpLAogICAgc2F2ZWRTZWFyY2g6IHNhdmVkU2VhcmNoLAogICAgaW5kZXhQYXR0ZXJuTGlzdDogJHJvdXRlLmN1cnJlbnQubG9jYWxzLnNhdmVkT2JqZWN0cy5pcC5saXN0CiAgfTsKCiAgdmFyIHNob3VsZFNlYXJjaE9uUGFnZUxvYWQgPSBmdW5jdGlvbiBzaG91bGRTZWFyY2hPblBhZ2VMb2FkKCkgewogICAgLy8gQSBzYXZlZCBzZWFyY2ggaXMgY3JlYXRlZCBvbiBldmVyeSBwYWdlIGxvYWQsIHNvIHdlIGNoZWNrIHRoZSBJRCB0byBzZWUgaWYgd2UncmUgbG9hZGluZyBhCiAgICAvLyBwcmV2aW91c2x5IHNhdmVkIHNlYXJjaCBvciBpZiBpdCBpcyBqdXN0IHRyYW5zaWVudAogICAgcmV0dXJuIGNvbmZpZy5nZXQoJ2Rpc2NvdmVyOnNlYXJjaE9uUGFnZUxvYWQnKSB8fCBzYXZlZFNlYXJjaC5pZCAhPT0gdW5kZWZpbmVkIHx8IHRpbWVmaWx0ZXIuZ2V0UmVmcmVzaEludGVydmFsKCkucGF1c2UgPT09IGZhbHNlOwogIH07CgogIHZhciBpbml0ID0gX2xvZGFzaC5kZWZhdWx0Lm9uY2UoZnVuY3Rpb24gKCkgewogICAgJHNjb3BlLnVwZGF0ZURhdGFTb3VyY2UoKS50aGVuKAogICAgLyojX19QVVJFX18qLwogICAgX2FzeW5jVG9HZW5lcmF0b3IoCiAgICAvKiNfX1BVUkVfXyovCiAgICByZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlOSgpIHsKICAgICAgdmFyIHNlYXJjaEJhckNoYW5nZXM7CiAgICAgIHJldHVybiByZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlOSQoX2NvbnRleHQ5KSB7CiAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQ5LnByZXYgPSBfY29udGV4dDkubmV4dCkgewogICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgc2VhcmNoQmFyQ2hhbmdlcyA9ICgwLCBfcnhqcy5tZXJnZSkodGltZWZpbHRlci5nZXRBdXRvUmVmcmVzaEZldGNoJCgpLCB0aW1lZmlsdGVyLmdldEZldGNoJCgpLCBmaWx0ZXJNYW5hZ2VyLmdldEZldGNoZXMkKCksICRmZXRjaE9ic2VydmFibGUpLnBpcGUoKDAsIF9vcGVyYXRvcnMuZGVib3VuY2VUaW1lKSgxMDApKTsKICAgICAgICAgICAgICBzdWJzY3JpcHRpb25zLmFkZCgoMCwgX2tpYmFuYV9zZXJ2aWNlcy5zdWJzY3JpYmVXaXRoU2NvcGUpKCRzY29wZSwgc2VhcmNoQmFyQ2hhbmdlcywgewogICAgICAgICAgICAgICAgbmV4dDogJHNjb3BlLmZldGNoCiAgICAgICAgICAgICAgfSwgZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gKDAsIF9wdWJsaWM0LmFkZEZhdGFsRXJyb3IpKGNvcmUuZmF0YWxFcnJvcnMsIGVycm9yKTsKICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgICAgc3Vic2NyaXB0aW9ucy5hZGQoKDAsIF9raWJhbmFfc2VydmljZXMuc3Vic2NyaWJlV2l0aFNjb3BlKSgkc2NvcGUsIHRpbWVmaWx0ZXIuZ2V0VGltZVVwZGF0ZSQoKSwgewogICAgICAgICAgICAgICAgbmV4dDogZnVuY3Rpb24gbmV4dCgpIHsKICAgICAgICAgICAgICAgICAgJHNjb3BlLnVwZGF0ZVRpbWUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LCBmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICAgICAgICAgIHJldHVybiAoMCwgX3B1YmxpYzQuYWRkRmF0YWxFcnJvcikoY29yZS5mYXRhbEVycm9ycywgZXJyb3IpOwogICAgICAgICAgICAgIH0pKTsgLy9IYW5kbGluZyBjaGFuZ2Ugb2Z0IHRoZSBoaXN0b2dyYW0gaW50ZXJ2YWwKCiAgICAgICAgICAgICAgJHNjb3BlLiR3YXRjaCgnc3RhdGUuaW50ZXJ2YWwnLCBmdW5jdGlvbiAobmV3SW50ZXJ2YWwsIG9sZEludGVydmFsKSB7CiAgICAgICAgICAgICAgICBpZiAobmV3SW50ZXJ2YWwgIT09IG9sZEludGVydmFsKSB7CiAgICAgICAgICAgICAgICAgIHNldEFwcFN0YXRlKHsKICAgICAgICAgICAgICAgICAgICBpbnRlcnZhbDogbmV3SW50ZXJ2YWwKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgJHNjb3BlLiR3YXRjaE11bHRpKFsncm93cycsICdmZXRjaFN0YXR1cyddLCBmdW5jdGlvbiB1cGRhdGVSZXN1bHRTdGF0ZSgpIHsKICAgICAgICAgICAgICAgIHZhciBwcmV2ID0ge307CiAgICAgICAgICAgICAgICB2YXIgc3RhdHVzID0gewogICAgICAgICAgICAgICAgICBVTklOSVRJQUxJWkVEOiAndW5pbml0aWFsaXplZCcsCiAgICAgICAgICAgICAgICAgIExPQURJTkc6ICdsb2FkaW5nJywKICAgICAgICAgICAgICAgICAgLy8gaW5pdGlhbCBkYXRhIGxvYWQKICAgICAgICAgICAgICAgICAgUkVBRFk6ICdyZWFkeScsCiAgICAgICAgICAgICAgICAgIC8vIHJlc3VsdHMgY2FtZSBiYWNrCiAgICAgICAgICAgICAgICAgIE5PX1JFU1VMVFM6ICdub25lJyAvLyBubyByZXN1bHRzIGNhbWUgYmFjawoKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gcGljayhyb3dzLCBvbGRSb3dzLCBmZXRjaFN0YXR1cykgewogICAgICAgICAgICAgICAgICAvLyBpbml0aWFsIHN0YXRlLCBwcmV0ZW5kIHdlJ3JlIGFscmVhZHkgbG9hZGluZyBpZiB3ZSdyZSBhYm91dCB0byBleGVjdXRlIGEgc2VhcmNoIHNvCiAgICAgICAgICAgICAgICAgIC8vIHRoYXQgdGhlIHVuaW5pdGlsaXplZCBtZXNzYWdlIGRvZXNuJ3QgZmxhc2ggb24gc2NyZWVuCiAgICAgICAgICAgICAgICAgIGlmIChyb3dzID09IG51bGwgJiYgb2xkUm93cyA9PSBudWxsICYmIHNob3VsZFNlYXJjaE9uUGFnZUxvYWQoKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBzdGF0dXMuTE9BRElORzsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgaWYgKGZldGNoU3RhdHVzID09PSBmZXRjaFN0YXR1c2VzLlVOSU5JVElBTElaRUQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gc3RhdHVzLlVOSU5JVElBTElaRUQ7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIHZhciByb3dzRW1wdHkgPSBfbG9kYXNoLmRlZmF1bHQuaXNFbXB0eShyb3dzKTsKCiAgICAgICAgICAgICAgICAgIGlmIChyb3dzRW1wdHkgJiYgZmV0Y2hTdGF0dXMgPT09IGZldGNoU3RhdHVzZXMuTE9BRElORykgcmV0dXJuIHN0YXR1cy5MT0FESU5HO2Vsc2UgaWYgKCFyb3dzRW1wdHkpIHJldHVybiBzdGF0dXMuUkVBRFk7ZWxzZSByZXR1cm4gc3RhdHVzLk5PX1JFU1VMVFM7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnQgPSB7CiAgICAgICAgICAgICAgICAgICAgcm93czogJHNjb3BlLnJvd3MsCiAgICAgICAgICAgICAgICAgICAgZmV0Y2hTdGF0dXM6ICRzY29wZS5mZXRjaFN0YXR1cwogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAkc2NvcGUucmVzdWx0U3RhdGUgPSBwaWNrKGN1cnJlbnQucm93cywgcHJldi5yb3dzLCBjdXJyZW50LmZldGNoU3RhdHVzLCBwcmV2LmZldGNoU3RhdHVzKTsKICAgICAgICAgICAgICAgICAgcHJldiA9IGN1cnJlbnQ7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIH0oKSk7CgogICAgICAgICAgICAgIGlmIChnZXRUaW1lRmllbGQoKSkgewogICAgICAgICAgICAgICAgc2V0dXBWaXN1YWxpemF0aW9uKCk7CiAgICAgICAgICAgICAgICAkc2NvcGUudXBkYXRlVGltZSgpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgaW5pdC5jb21wbGV0ZSA9IHRydWU7CgogICAgICAgICAgICAgIGlmIChzaG91bGRTZWFyY2hPblBhZ2VMb2FkKCkpIHsKICAgICAgICAgICAgICAgICRmZXRjaE9ic2VydmFibGUubmV4dCgpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNhc2UgODoKICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ5LnN0b3AoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sIF9jYWxsZWU5KTsKICAgIH0pKSk7CiAgfSk7CgogIGZ1bmN0aW9uIHNhdmVEYXRhU291cmNlKF94NykgewogICAgcmV0dXJuIF9zYXZlRGF0YVNvdXJjZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH0KCiAgZnVuY3Rpb24gX3NhdmVEYXRhU291cmNlKCkgewogICAgX3NhdmVEYXRhU291cmNlID0gX2FzeW5jVG9HZW5lcmF0b3IoCiAgICAvKiNfX1BVUkVfXyovCiAgICByZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMTAoc2F2ZU9wdGlvbnMpIHsKICAgICAgdmFyIGlkOwogICAgICByZXR1cm4gcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTEwJChfY29udGV4dDEwKSB7CiAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQxMC5wcmV2ID0gX2NvbnRleHQxMC5uZXh0KSB7CiAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICBfY29udGV4dDEwLm5leHQgPSAyOwogICAgICAgICAgICAgIHJldHVybiAkc2NvcGUudXBkYXRlRGF0YVNvdXJjZSgpOwoKICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgIHNhdmVkU2VhcmNoLmNvbHVtbnMgPSAkc2NvcGUuc3RhdGUuY29sdW1uczsKICAgICAgICAgICAgICBzYXZlZFNlYXJjaC5zb3J0ID0gJHNjb3BlLnN0YXRlLnNvcnQ7CiAgICAgICAgICAgICAgX2NvbnRleHQxMC5wcmV2ID0gNDsKICAgICAgICAgICAgICBfY29udGV4dDEwLm5leHQgPSA3OwogICAgICAgICAgICAgIHJldHVybiBzYXZlZFNlYXJjaC5zYXZlKHNhdmVPcHRpb25zKTsKCiAgICAgICAgICAgIGNhc2UgNzoKICAgICAgICAgICAgICBpZCA9IF9jb250ZXh0MTAuc2VudDsKICAgICAgICAgICAgICAkc2NvcGUuJGV2YWxBc3luYyhmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBpZiAoaWQpIHsKICAgICAgICAgICAgICAgICAgdG9hc3ROb3RpZmljYXRpb25zLmFkZFN1Y2Nlc3MoewogICAgICAgICAgICAgICAgICAgIHRpdGxlOiBfaTE4bi5pMThuLnRyYW5zbGF0ZSgna2JuLmRpc2NvdmVyLm5vdGlmaWNhdGlvbnMuc2F2ZWRTZWFyY2hUaXRsZScsIHsKICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHRNZXNzYWdlOiAiU2VhcmNoICd7c2F2ZWRTZWFyY2hUaXRsZX0nIHdhcyBzYXZlZCIsCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZXM6IHsKICAgICAgICAgICAgICAgICAgICAgICAgc2F2ZWRTZWFyY2hUaXRsZTogc2F2ZWRTZWFyY2gudGl0bGUKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgICAgICAnZGF0YS10ZXN0LXN1YmonOiAnc2F2ZVNlYXJjaFN1Y2Nlc3MnCiAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgaWYgKHNhdmVkU2VhcmNoLmlkICE9PSAkcm91dGUuY3VycmVudC5wYXJhbXMuaWQpIHsKICAgICAgICAgICAgICAgICAgICBoaXN0b3J5LnB1c2goIi9kaXNjb3Zlci8iLmNvbmNhdChlbmNvZGVVUklDb21wb25lbnQoc2F2ZWRTZWFyY2guaWQpKSk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVXBkYXRlIGRlZmF1bHRzIHNvIHRoYXQgInJlbG9hZCBzYXZlZCBxdWVyeSIgZnVuY3Rpb25zIGNvcnJlY3RseQogICAgICAgICAgICAgICAgICAgIHNldEFwcFN0YXRlKGdldFN0YXRlRGVmYXVsdHMoKSk7CiAgICAgICAgICAgICAgICAgICAgY2hyb21lLmRvY1RpdGxlLmNoYW5nZShzYXZlZFNlYXJjaC5sYXN0U2F2ZWRUaXRsZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxMC5hYnJ1cHQoInJldHVybiIsIHsKICAgICAgICAgICAgICAgIGlkOiBpZAogICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgY2FzZSAxMjoKICAgICAgICAgICAgICBfY29udGV4dDEwLnByZXYgPSAxMjsKICAgICAgICAgICAgICBfY29udGV4dDEwLnQwID0gX2NvbnRleHQxMFsiY2F0Y2giXSg0KTsKICAgICAgICAgICAgICB0b2FzdE5vdGlmaWNhdGlvbnMuYWRkRGFuZ2VyKHsKICAgICAgICAgICAgICAgIHRpdGxlOiBfaTE4bi5pMThuLnRyYW5zbGF0ZSgna2JuLmRpc2NvdmVyLm5vdGlmaWNhdGlvbnMubm90U2F2ZWRTZWFyY2hUaXRsZScsIHsKICAgICAgICAgICAgICAgICAgZGVmYXVsdE1lc3NhZ2U6ICJTZWFyY2ggJ3tzYXZlZFNlYXJjaFRpdGxlfScgd2FzIG5vdCBzYXZlZC4iLAogICAgICAgICAgICAgICAgICB2YWx1ZXM6IHsKICAgICAgICAgICAgICAgICAgICBzYXZlZFNlYXJjaFRpdGxlOiBzYXZlZFNlYXJjaC50aXRsZQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIHRleHQ6IF9jb250ZXh0MTAudDAubWVzc2FnZQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDEwLmFicnVwdCgicmV0dXJuIiwgewogICAgICAgICAgICAgICAgZXJyb3I6IF9jb250ZXh0MTAudDAKICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGNhc2UgMTY6CiAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTAuc3RvcCgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwgX2NhbGxlZTEwLCBudWxsLCBbWzQsIDEyXV0pOwogICAgfSkpOwogICAgcmV0dXJuIF9zYXZlRGF0YVNvdXJjZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH0KCiAgJHNjb3BlLm9wdHMuZmV0Y2ggPSAkc2NvcGUuZmV0Y2ggPSBmdW5jdGlvbiAoKSB7CiAgICAvLyBpZ25vcmUgcmVxdWVzdHMgdG8gZmV0Y2ggYmVmb3JlIHRoZSBhcHAgaW5pdHMKICAgIGlmICghaW5pdC5jb21wbGV0ZSkgcmV0dXJuOwogICAgJHNjb3BlLmZldGNoQ291bnRlcisrOwogICAgJHNjb3BlLmZldGNoRXJyb3IgPSB1bmRlZmluZWQ7IC8vIEFib3J0IGFueSBpbi1wcm9ncmVzcyByZXF1ZXN0cyBiZWZvcmUgZmV0Y2hpbmcgYWdhaW4KCiAgICBpZiAoYWJvcnRDb250cm9sbGVyKSBhYm9ydENvbnRyb2xsZXIuYWJvcnQoKTsKICAgIGFib3J0Q29udHJvbGxlciA9IG5ldyBBYm9ydENvbnRyb2xsZXIoKTsKICAgICRzY29wZS51cGRhdGVEYXRhU291cmNlKCkudGhlbihzZXR1cFZpc3VhbGl6YXRpb24pLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAkc2NvcGUuZmV0Y2hTdGF0dXMgPSBmZXRjaFN0YXR1c2VzLkxPQURJTkc7CiAgICAgIGxvZ0luc3BlY3RvclJlcXVlc3QoKTsKICAgICAgcmV0dXJuICRzY29wZS5zZWFyY2hTb3VyY2UuZmV0Y2goewogICAgICAgIGFib3J0U2lnbmFsOiBhYm9ydENvbnRyb2xsZXIuc2lnbmFsCiAgICAgIH0pOwogICAgfSkudGhlbihvblJlc3VsdHMpLmNhdGNoKGZ1bmN0aW9uIChlcnJvcikgewogICAgICAvLyBJZiB0aGUgcmVxdWVzdCB3YXMgYWJvcnRlZCB0aGVuIG5vIG5lZWQgdG8gc3VyZmFjZSB0aGlzIGVycm9yIGluIHRoZSBVSQogICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBFcnJvciAmJiBlcnJvci5uYW1lID09PSAnQWJvcnRFcnJvcicpIHJldHVybjsKICAgICAgdmFyIGZldGNoRXJyb3IgPSAoMCwgX2dldF9wYWlubGVzc19lcnJvci5nZXRQYWlubGVzc0Vycm9yKShlcnJvcik7CgogICAgICBpZiAoZmV0Y2hFcnJvcikgewogICAgICAgICRzY29wZS5mZXRjaEVycm9yID0gZmV0Y2hFcnJvcjsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgX2Vycm9yJGJvZHk7CgogICAgICAgIHRvYXN0Tm90aWZpY2F0aW9ucy5hZGRFcnJvcihlcnJvciwgewogICAgICAgICAgdGl0bGU6IF9pMThuLmkxOG4udHJhbnNsYXRlKCdrYm4uZGlzY292ZXIuZXJyb3JMb2FkaW5nRGF0YScsIHsKICAgICAgICAgICAgZGVmYXVsdE1lc3NhZ2U6ICdFcnJvciBsb2FkaW5nIGRhdGEnCiAgICAgICAgICB9KSwKICAgICAgICAgIHRvYXN0TWVzc2FnZTogZXJyb3Iuc2hvcnRNZXNzYWdlIHx8ICgoX2Vycm9yJGJvZHkgPSBlcnJvci5ib2R5KSA9PT0gbnVsbCB8fCBfZXJyb3IkYm9keSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Vycm9yJGJvZHkubWVzc2FnZSkKICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgfTsKCiAgJHNjb3BlLnVwZGF0ZVF1ZXJ5ID0gZnVuY3Rpb24gKF9yZWYxMSkgewogICAgdmFyIHF1ZXJ5ID0gX3JlZjExLnF1ZXJ5OwogICAgdmFyIGlzVXBkYXRlID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMV0gOiB0cnVlOwoKICAgIGlmICghX2xvZGFzaC5kZWZhdWx0LmlzRXF1YWwocXVlcnksIGFwcFN0YXRlQ29udGFpbmVyLmdldFN0YXRlKCkucXVlcnkpIHx8IGlzVXBkYXRlID09PSBmYWxzZSkgewogICAgICBzZXRBcHBTdGF0ZSh7CiAgICAgICAgcXVlcnk6IHF1ZXJ5CiAgICAgIH0pOwogICAgICAkZmV0Y2hPYnNlcnZhYmxlLm5leHQoKTsKICAgIH0KICB9OwoKICAkc2NvcGUudXBkYXRlU2F2ZWRRdWVyeUlkID0gZnVuY3Rpb24gKG5ld1NhdmVkUXVlcnlJZCkgewogICAgaWYgKG5ld1NhdmVkUXVlcnlJZCkgewogICAgICBzZXRBcHBTdGF0ZSh7CiAgICAgICAgc2F2ZWRRdWVyeTogbmV3U2F2ZWRRdWVyeUlkCiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgLy8gcmVtb3ZlIHNhdmVkUXVlcnlJZCBmcm9tIHN0YXRlCiAgICAgIHZhciBzdGF0ZSA9IF9vYmplY3RTcHJlYWQoe30sIGFwcFN0YXRlQ29udGFpbmVyLmdldFN0YXRlKCkpOwoKICAgICAgZGVsZXRlIHN0YXRlLnNhdmVkUXVlcnk7CiAgICAgIGFwcFN0YXRlQ29udGFpbmVyLnNldChzdGF0ZSk7CiAgICB9CiAgfTsKCiAgZnVuY3Rpb24gZ2V0RGltZW5zaW9ucyhhZ2dzLCB0aW1lUmFuZ2UpIHsKICAgIHZhciBfYWdncyA9IF9zbGljZWRUb0FycmF5KGFnZ3MsIDIpLAogICAgICAgIG1ldHJpYyA9IF9hZ2dzWzBdLAogICAgICAgIGFnZyA9IF9hZ2dzWzFdOwoKICAgIGFnZy5wYXJhbXMudGltZVJhbmdlID0gdGltZVJhbmdlOwogICAgdmFyIGJvdW5kcyA9IGFnZy5wYXJhbXMudGltZVJhbmdlID8gdGltZWZpbHRlci5jYWxjdWxhdGVCb3VuZHMoYWdnLnBhcmFtcy50aW1lUmFuZ2UpIDogbnVsbDsKICAgIGFnZy5idWNrZXRzLnNldEJvdW5kcyhib3VuZHMpOwoKICAgIHZhciBfYWdnJGJ1Y2tldHMkZ2V0SW50ZXIgPSBhZ2cuYnVja2V0cy5nZXRJbnRlcnZhbCgpLAogICAgICAgIGVzVW5pdCA9IF9hZ2ckYnVja2V0cyRnZXRJbnRlci5lc1VuaXQsCiAgICAgICAgZXNWYWx1ZSA9IF9hZ2ckYnVja2V0cyRnZXRJbnRlci5lc1ZhbHVlOwoKICAgIHJldHVybiB7CiAgICAgIHg6IHsKICAgICAgICBhY2Nlc3NvcjogMCwKICAgICAgICBsYWJlbDogYWdnLm1ha2VMYWJlbCgpLAogICAgICAgIGZvcm1hdDogX3B1YmxpYzMuZmllbGRGb3JtYXRzLnNlcmlhbGl6ZShhZ2cpLAogICAgICAgIHBhcmFtczogewogICAgICAgICAgZGF0ZTogdHJ1ZSwKICAgICAgICAgIGludGVydmFsOiBfbW9tZW50LmRlZmF1bHQuZHVyYXRpb24oZXNWYWx1ZSwgZXNVbml0KSwKICAgICAgICAgIGludGVydmFsRVNWYWx1ZTogZXNWYWx1ZSwKICAgICAgICAgIGludGVydmFsRVNVbml0OiBlc1VuaXQsCiAgICAgICAgICBmb3JtYXQ6IGFnZy5idWNrZXRzLmdldFNjYWxlZERhdGVGb3JtYXQoKSwKICAgICAgICAgIGJvdW5kczogYWdnLmJ1Y2tldHMuZ2V0Qm91bmRzKCkKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHk6IHsKICAgICAgICBhY2Nlc3NvcjogMSwKICAgICAgICBmb3JtYXQ6IF9wdWJsaWMzLmZpZWxkRm9ybWF0cy5zZXJpYWxpemUobWV0cmljKSwKICAgICAgICBsYWJlbDogbWV0cmljLm1ha2VMYWJlbCgpCiAgICAgIH0KICAgIH07CiAgfQoKICBmdW5jdGlvbiBvblJlc3VsdHMocmVzcCkgewogICAgaW5zcGVjdG9yUmVxdWVzdC5zdGF0cygoMCwgX2tpYmFuYV9zZXJ2aWNlcy5nZXRSZXNwb25zZUluc3BlY3RvclN0YXRzKSgkc2NvcGUuc2VhcmNoU291cmNlLCByZXNwKSkub2soewogICAgICBqc29uOiByZXNwCiAgICB9KTsKCiAgICBpZiAoZ2V0VGltZUZpZWxkKCkpIHsKICAgICAgdmFyIHRhYmlmaWVkRGF0YSA9ICgwLCBfa2liYW5hX3NlcnZpY2VzLnRhYmlmeUFnZ1Jlc3BvbnNlKSgkc2NvcGUudmlzLmRhdGEuYWdncywgcmVzcCk7CiAgICAgICRzY29wZS5zZWFyY2hTb3VyY2UucmF3UmVzcG9uc2UgPSByZXNwOwogICAgICAkc2NvcGUuaGlzdG9ncmFtRGF0YSA9ICgwLCBfcmVzcG9uc2VfaGFuZGxlci5kaXNjb3ZlclJlc3BvbnNlSGFuZGxlcikodGFiaWZpZWREYXRhLCBnZXREaW1lbnNpb25zKCRzY29wZS52aXMuZGF0YS5hZ2dzLmFnZ3MsICRzY29wZS50aW1lUmFuZ2UpKTsKCiAgICAgIGlmICgkc2NvcGUudmlzLmRhdGEuYWdncy5hZ2dzWzFdKSB7CiAgICAgICAgJHNjb3BlLmJ1Y2tldEludGVydmFsID0gJHNjb3BlLnZpcy5kYXRhLmFnZ3MuYWdnc1sxXS5idWNrZXRzLmdldEludGVydmFsKCk7CiAgICAgIH0KICAgIH0KCiAgICAkc2NvcGUuaGl0cyA9IHJlc3AuaGl0cy50b3RhbDsKICAgICRzY29wZS5yb3dzID0gcmVzcC5oaXRzLmhpdHM7IC8vIGlmIHdlIGhhdmVuJ3QgY291bnRlZCB5ZXQsIHJlc2V0IHRoZSBjb3VudHMKCiAgICB2YXIgY291bnRzID0gJHNjb3BlLmZpZWxkQ291bnRzID0gJHNjb3BlLmZpZWxkQ291bnRzIHx8IHt9OwogICAgJHNjb3BlLnJvd3MuZm9yRWFjaChmdW5jdGlvbiAoaGl0KSB7CiAgICAgIHZhciBmaWVsZHMgPSBPYmplY3Qua2V5cygkc2NvcGUuaW5kZXhQYXR0ZXJuLmZsYXR0ZW5IaXQoaGl0KSk7CiAgICAgIGZpZWxkcy5mb3JFYWNoKGZ1bmN0aW9uIChmaWVsZE5hbWUpIHsKICAgICAgICBjb3VudHNbZmllbGROYW1lXSA9IChjb3VudHNbZmllbGROYW1lXSB8fCAwKSArIDE7CiAgICAgIH0pOwogICAgfSk7CiAgICAkc2NvcGUuZmV0Y2hTdGF0dXMgPSBmZXRjaFN0YXR1c2VzLkNPTVBMRVRFOwogIH0KCiAgZnVuY3Rpb24gbG9nSW5zcGVjdG9yUmVxdWVzdCgpIHsKICAgIGluc3BlY3RvckFkYXB0ZXJzLnJlcXVlc3RzLnJlc2V0KCk7CgogICAgdmFyIHRpdGxlID0gX2kxOG4uaTE4bi50cmFuc2xhdGUoJ2tibi5kaXNjb3Zlci5pbnNwZWN0b3JSZXF1ZXN0RGF0YVRpdGxlJywgewogICAgICBkZWZhdWx0TWVzc2FnZTogJ2RhdGEnCiAgICB9KTsKCiAgICB2YXIgZGVzY3JpcHRpb24gPSBfaTE4bi5pMThuLnRyYW5zbGF0ZSgna2JuLmRpc2NvdmVyLmluc3BlY3RvclJlcXVlc3REZXNjcmlwdGlvbicsIHsKICAgICAgZGVmYXVsdE1lc3NhZ2U6ICdUaGlzIHJlcXVlc3QgcXVlcmllcyBFbGFzdGljc2VhcmNoIHRvIGZldGNoIHRoZSBkYXRhIGZvciB0aGUgc2VhcmNoLicKICAgIH0pOwoKICAgIGluc3BlY3RvclJlcXVlc3QgPSBpbnNwZWN0b3JBZGFwdGVycy5yZXF1ZXN0cy5zdGFydCh0aXRsZSwgewogICAgICBkZXNjcmlwdGlvbjogZGVzY3JpcHRpb24KICAgIH0pOwogICAgaW5zcGVjdG9yUmVxdWVzdC5zdGF0cygoMCwgX2tpYmFuYV9zZXJ2aWNlcy5nZXRSZXF1ZXN0SW5zcGVjdG9yU3RhdHMpKCRzY29wZS5zZWFyY2hTb3VyY2UpKTsKICAgICRzY29wZS5zZWFyY2hTb3VyY2UuZ2V0U2VhcmNoUmVxdWVzdEJvZHkoKS50aGVuKGZ1bmN0aW9uIChib2R5KSB7CiAgICAgIGluc3BlY3RvclJlcXVlc3QuanNvbihib2R5KTsKICAgIH0pOwogIH0KCiAgJHNjb3BlLnVwZGF0ZVRpbWUgPSBmdW5jdGlvbiAoKSB7CiAgICAvL3RoaXMgaXMgdGhlIHRpbWVyYW5nZSBmb3IgdGhlIGhpc3RvZ3JhbSwgc2hvdWxkIGJlIHJlZmFjdG9yZWQKICAgICRzY29wZS50aW1lUmFuZ2UgPSB7CiAgICAgIGZyb206IF9kYXRlbWF0aC5kZWZhdWx0LnBhcnNlKHRpbWVmaWx0ZXIuZ2V0VGltZSgpLmZyb20pLAogICAgICB0bzogX2RhdGVtYXRoLmRlZmF1bHQucGFyc2UodGltZWZpbHRlci5nZXRUaW1lKCkudG8sIHsKICAgICAgICByb3VuZFVwOiB0cnVlCiAgICAgIH0pCiAgICB9OwogIH07CgogICRzY29wZS50b01vbWVudCA9IGZ1bmN0aW9uIChkYXRldGltZSkgewogICAgcmV0dXJuICgwLCBfbW9tZW50LmRlZmF1bHQpKGRhdGV0aW1lKS5mb3JtYXQoY29uZmlnLmdldCgnZGF0ZUZvcm1hdCcpKTsKICB9OwoKICAkc2NvcGUucmVzZXRRdWVyeSA9IGZ1bmN0aW9uICgpIHsKICAgIGhpc3RvcnkucHVzaCgiL2Rpc2NvdmVyLyIuY29uY2F0KGVuY29kZVVSSUNvbXBvbmVudCgkcm91dGUuY3VycmVudC5wYXJhbXMuaWQpKSk7CiAgfTsKCiAgJHNjb3BlLm5ld1F1ZXJ5ID0gZnVuY3Rpb24gKCkgewogICAgaGlzdG9yeS5wdXNoKCcvZGlzY292ZXInKTsKICB9OwoKICAkc2NvcGUudXBkYXRlRGF0YVNvdXJjZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBpbmRleFBhdHRlcm4gPSAkc2NvcGUuaW5kZXhQYXR0ZXJuLAogICAgICAgIHNlYXJjaFNvdXJjZSA9ICRzY29wZS5zZWFyY2hTb3VyY2U7CiAgICBzZWFyY2hTb3VyY2Uuc2V0RmllbGQoJ2luZGV4JywgJHNjb3BlLmluZGV4UGF0dGVybikuc2V0RmllbGQoJ3NpemUnLCAkc2NvcGUub3B0cy5zYW1wbGVTaXplKS5zZXRGaWVsZCgnc29ydCcsICgwLCBfZG9jX3RhYmxlLmdldFNvcnRGb3JTZWFyY2hTb3VyY2UpKCRzY29wZS5zdGF0ZS5zb3J0LCBpbmRleFBhdHRlcm4sIGNvbmZpZy5nZXQoJ2Rpc2NvdmVyOnNvcnQ6ZGVmYXVsdE9yZGVyJykpKS5zZXRGaWVsZCgncXVlcnknLCAkc2NvcGUuc3RhdGUucXVlcnkgfHwgbnVsbCkuc2V0RmllbGQoJ2ZpbHRlcicsIGZpbHRlck1hbmFnZXIuZ2V0RmlsdGVycygpKTsKICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTsKICB9OwoKICAkc2NvcGUuc2V0U29ydE9yZGVyID0gZnVuY3Rpb24gc2V0U29ydE9yZGVyKHNvcnQpIHsKICAgIHNldEFwcFN0YXRlKHsKICAgICAgc29ydDogc29ydAogICAgfSk7CiAgfTsgLy8gVE9ETzogT24gYXJyYXkgZmllbGRzLCBuZWdhdGluZyBkb2VzIG5vdCBuZWdhdGUgdGhlIGNvbWJpbmF0aW9uLCByYXRoZXIgYWxsIHRlcm1zCgoKICAkc2NvcGUuZmlsdGVyUXVlcnkgPSBmdW5jdGlvbiAoZmllbGQsIHZhbHVlcywgb3BlcmF0aW9uKSB7CiAgICAkc2NvcGUuaW5kZXhQYXR0ZXJuLnBvcHVsYXJpemVGaWVsZChmaWVsZCwgMSk7CgogICAgdmFyIG5ld0ZpbHRlcnMgPSBfcHVibGljMy5lc0ZpbHRlcnMuZ2VuZXJhdGVGaWx0ZXJzKGZpbHRlck1hbmFnZXIsIGZpZWxkLCB2YWx1ZXMsIG9wZXJhdGlvbiwgJHNjb3BlLmluZGV4UGF0dGVybi5pZCk7CgogICAgcmV0dXJuIGZpbHRlck1hbmFnZXIuYWRkRmlsdGVycyhuZXdGaWx0ZXJzKTsKICB9OwoKICAkc2NvcGUuYWRkQ29sdW1uID0gZnVuY3Rpb24gYWRkQ29sdW1uKGNvbHVtbk5hbWUpIHsKICAgICRzY29wZS5pbmRleFBhdHRlcm4ucG9wdWxhcml6ZUZpZWxkKGNvbHVtbk5hbWUsIDEpOwogICAgdmFyIGNvbHVtbnMgPSBjb2x1bW5BY3Rpb25zLmFkZENvbHVtbigkc2NvcGUuc3RhdGUuY29sdW1ucywgY29sdW1uTmFtZSk7CiAgICBzZXRBcHBTdGF0ZSh7CiAgICAgIGNvbHVtbnM6IGNvbHVtbnMKICAgIH0pOwogIH07CgogICRzY29wZS5yZW1vdmVDb2x1bW4gPSBmdW5jdGlvbiByZW1vdmVDb2x1bW4oY29sdW1uTmFtZSkgewogICAgJHNjb3BlLmluZGV4UGF0dGVybi5wb3B1bGFyaXplRmllbGQoY29sdW1uTmFtZSwgMSk7CiAgICB2YXIgY29sdW1ucyA9IGNvbHVtbkFjdGlvbnMucmVtb3ZlQ29sdW1uKCRzY29wZS5zdGF0ZS5jb2x1bW5zLCBjb2x1bW5OYW1lKTsKICAgIHNldEFwcFN0YXRlKHsKICAgICAgY29sdW1uczogY29sdW1ucwogICAgfSk7CiAgfTsKCiAgJHNjb3BlLm1vdmVDb2x1bW4gPSBmdW5jdGlvbiBtb3ZlQ29sdW1uKGNvbHVtbk5hbWUsIG5ld0luZGV4KSB7CiAgICB2YXIgY29sdW1ucyA9IGNvbHVtbkFjdGlvbnMubW92ZUNvbHVtbigkc2NvcGUuc3RhdGUuY29sdW1ucywgY29sdW1uTmFtZSwgbmV3SW5kZXgpOwogICAgc2V0QXBwU3RhdGUoewogICAgICBjb2x1bW5zOiBjb2x1bW5zCiAgICB9KTsKICB9OwoKICAkc2NvcGUuc2Nyb2xsVG9Ub3AgPSBmdW5jdGlvbiAoKSB7CiAgICAkd2luZG93LnNjcm9sbFRvKDAsIDApOwogIH07CgogICRzY29wZS5zY3JvbGxUb0JvdHRvbSA9IGZ1bmN0aW9uICgpIHsKICAgIC8vIGRlbGF5IHNjcm9sbGluZyB0byBhZnRlciB0aGUgcm93cyBoYXZlIGJlZW4gcmVuZGVyZWQKICAgICR0aW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgJGVsZW1lbnQuZmluZCgnI2Rpc2NvdmVyQm90dG9tTWFya2VyJykuZm9jdXMoKTsKICAgIH0sIDApOwogIH07CgogICRzY29wZS5zaG93QWxsUm93cyA9IGZ1bmN0aW9uICgpIHsKICAgICRzY29wZS5taW5pbXVtVmlzaWJsZVJvd3MgPSAkc2NvcGUuaGl0czsKICB9OwoKICBmdW5jdGlvbiBzZXR1cFZpc3VhbGl6YXRpb24oKSB7CiAgICByZXR1cm4gX3NldHVwVmlzdWFsaXphdGlvbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH0KCiAgZnVuY3Rpb24gX3NldHVwVmlzdWFsaXphdGlvbigpIHsKICAgIF9zZXR1cFZpc3VhbGl6YXRpb24gPSBfYXN5bmNUb0dlbmVyYXRvcigKICAgIC8qI19fUFVSRV9fKi8KICAgIHJlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUxMSgpIHsKICAgICAgdmFyIGhpc3RvZ3JhbUludGVydmFsLCB2aXNTdGF0ZUFnZ3M7CiAgICAgIHJldHVybiByZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlMTEkKF9jb250ZXh0MTEpIHsKICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgc3dpdGNoIChfY29udGV4dDExLnByZXYgPSBfY29udGV4dDExLm5leHQpIHsKICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgIGlmIChnZXRUaW1lRmllbGQoKSkgewogICAgICAgICAgICAgICAgX2NvbnRleHQxMS5uZXh0ID0gMjsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTEuYWJydXB0KCJyZXR1cm4iKTsKCiAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICBoaXN0b2dyYW1JbnRlcnZhbCA9ICRzY29wZS5zdGF0ZS5pbnRlcnZhbDsKICAgICAgICAgICAgICB2aXNTdGF0ZUFnZ3MgPSBbewogICAgICAgICAgICAgICAgdHlwZTogJ2NvdW50JywKICAgICAgICAgICAgICAgIHNjaGVtYTogJ21ldHJpYycKICAgICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICB0eXBlOiAnZGF0ZV9oaXN0b2dyYW0nLAogICAgICAgICAgICAgICAgc2NoZW1hOiAnc2VnbWVudCcsCiAgICAgICAgICAgICAgICBwYXJhbXM6IHsKICAgICAgICAgICAgICAgICAgZmllbGQ6IGdldFRpbWVGaWVsZCgpLAogICAgICAgICAgICAgICAgICBpbnRlcnZhbDogaGlzdG9ncmFtSW50ZXJ2YWwsCiAgICAgICAgICAgICAgICAgIHRpbWVSYW5nZTogdGltZWZpbHRlci5nZXRUaW1lKCkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9XTsKICAgICAgICAgICAgICAkc2NvcGUudmlzID0gdmlzdWFsaXphdGlvbnMuY3JlYXRlVmlzKCdoaXN0b2dyYW0nLCB7CiAgICAgICAgICAgICAgICB0aXRsZTogc2F2ZWRTZWFyY2gudGl0bGUsCiAgICAgICAgICAgICAgICBwYXJhbXM6IHsKICAgICAgICAgICAgICAgICAgYWRkTGVnZW5kOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgYWRkVGltZU1hcmtlcjogdHJ1ZQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGRhdGE6IHsKICAgICAgICAgICAgICAgICAgYWdnczogdmlzU3RhdGVBZ2dzLAogICAgICAgICAgICAgICAgICBpbmRleFBhdHRlcm46ICRzY29wZS5zZWFyY2hTb3VyY2UuZ2V0RmllbGQoJ2luZGV4JykuaWQsCiAgICAgICAgICAgICAgICAgIHNlYXJjaFNvdXJjZTogJHNjb3BlLnNlYXJjaFNvdXJjZQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICRzY29wZS5zZWFyY2hTb3VyY2Uub25SZXF1ZXN0U3RhcnQoZnVuY3Rpb24gKHNlYXJjaFNvdXJjZSwgb3B0aW9ucykgewogICAgICAgICAgICAgICAgaWYgKCEkc2NvcGUudmlzKSByZXR1cm47CiAgICAgICAgICAgICAgICByZXR1cm4gJHNjb3BlLnZpcy5kYXRhLmFnZ3Mub25TZWFyY2hSZXF1ZXN0U3RhcnQoc2VhcmNoU291cmNlLCBvcHRpb25zKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAkc2NvcGUuc2VhcmNoU291cmNlLnNldEZpZWxkKCdhZ2dzJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgaWYgKCEkc2NvcGUudmlzKSByZXR1cm47CiAgICAgICAgICAgICAgICByZXR1cm4gJHNjb3BlLnZpcy5kYXRhLmFnZ3MudG9Ec2woKTsKICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGNhc2UgNzoKICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxMS5zdG9wKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LCBfY2FsbGVlMTEpOwogICAgfSkpOwogICAgcmV0dXJuIF9zZXR1cFZpc3VhbGl6YXRpb24uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9CgogIGZ1bmN0aW9uIGdldEluZGV4UGF0dGVybldhcm5pbmcoaW5kZXgpIHsKICAgIHJldHVybiBfaTE4bi5pMThuLnRyYW5zbGF0ZSgna2JuLmRpc2NvdmVyLnZhbHVlSXNOb3RDb25maWd1cmVkSW5kZXhQYXR0ZXJuSURXYXJuaW5nVGl0bGUnLCB7CiAgICAgIGRlZmF1bHRNZXNzYWdlOiAne3N0YXRlVmFsfSBpcyBub3QgYSBjb25maWd1cmVkIGluZGV4IHBhdHRlcm4gSUQnLAogICAgICB2YWx1ZXM6IHsKICAgICAgICBzdGF0ZVZhbDogIlwiIi5jb25jYXQoaW5kZXgsICJcIiIpCiAgICAgIH0KICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gcmVzb2x2ZUluZGV4UGF0dGVybkxvYWRpbmcoKSB7CiAgICB2YXIgXyRyb3V0ZSRjdXJyZW50JGxvY2FsID0gJHJvdXRlLmN1cnJlbnQubG9jYWxzLnNhdmVkT2JqZWN0cy5pcCwKICAgICAgICBsb2FkZWRJbmRleFBhdHRlcm4gPSBfJHJvdXRlJGN1cnJlbnQkbG9jYWwubG9hZGVkLAogICAgICAgIHN0YXRlVmFsID0gXyRyb3V0ZSRjdXJyZW50JGxvY2FsLnN0YXRlVmFsLAogICAgICAgIHN0YXRlVmFsRm91bmQgPSBfJHJvdXRlJGN1cnJlbnQkbG9jYWwuc3RhdGVWYWxGb3VuZDsKICAgIHZhciBvd25JbmRleFBhdHRlcm4gPSAkc2NvcGUuc2VhcmNoU291cmNlLmdldE93bkZpZWxkKCdpbmRleCcpOwoKICAgIGlmIChvd25JbmRleFBhdHRlcm4gJiYgIXN0YXRlVmFsKSB7CiAgICAgIHJldHVybiBvd25JbmRleFBhdHRlcm47CiAgICB9CgogICAgaWYgKHN0YXRlVmFsICYmICFzdGF0ZVZhbEZvdW5kKSB7CiAgICAgIHZhciB3YXJuaW5nVGl0bGUgPSBnZXRJbmRleFBhdHRlcm5XYXJuaW5nKCk7CgogICAgICBpZiAob3duSW5kZXhQYXR0ZXJuKSB7CiAgICAgICAgdG9hc3ROb3RpZmljYXRpb25zLmFkZFdhcm5pbmcoewogICAgICAgICAgdGl0bGU6IHdhcm5pbmdUaXRsZSwKICAgICAgICAgIHRleHQ6IF9pMThuLmkxOG4udHJhbnNsYXRlKCdrYm4uZGlzY292ZXIuc2hvd2luZ1NhdmVkSW5kZXhQYXR0ZXJuV2FybmluZ0Rlc2NyaXB0aW9uJywgewogICAgICAgICAgICBkZWZhdWx0TWVzc2FnZTogJ1Nob3dpbmcgdGhlIHNhdmVkIGluZGV4IHBhdHRlcm46ICJ7b3duSW5kZXhQYXR0ZXJuVGl0bGV9IiAoe293bkluZGV4UGF0dGVybklkfSknLAogICAgICAgICAgICB2YWx1ZXM6IHsKICAgICAgICAgICAgICBvd25JbmRleFBhdHRlcm5UaXRsZTogb3duSW5kZXhQYXR0ZXJuLnRpdGxlLAogICAgICAgICAgICAgIG93bkluZGV4UGF0dGVybklkOiBvd25JbmRleFBhdHRlcm4uaWQKICAgICAgICAgICAgfQogICAgICAgICAgfSkKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gb3duSW5kZXhQYXR0ZXJuOwogICAgICB9CgogICAgICB0b2FzdE5vdGlmaWNhdGlvbnMuYWRkV2FybmluZyh7CiAgICAgICAgdGl0bGU6IHdhcm5pbmdUaXRsZSwKICAgICAgICB0ZXh0OiBfaTE4bi5pMThuLnRyYW5zbGF0ZSgna2JuLmRpc2NvdmVyLnNob3dpbmdEZWZhdWx0SW5kZXhQYXR0ZXJuV2FybmluZ0Rlc2NyaXB0aW9uJywgewogICAgICAgICAgZGVmYXVsdE1lc3NhZ2U6ICdTaG93aW5nIHRoZSBkZWZhdWx0IGluZGV4IHBhdHRlcm46ICJ7bG9hZGVkSW5kZXhQYXR0ZXJuVGl0bGV9IiAoe2xvYWRlZEluZGV4UGF0dGVybklkfSknLAogICAgICAgICAgdmFsdWVzOiB7CiAgICAgICAgICAgIGxvYWRlZEluZGV4UGF0dGVyblRpdGxlOiBsb2FkZWRJbmRleFBhdHRlcm4udGl0bGUsCiAgICAgICAgICAgIGxvYWRlZEluZGV4UGF0dGVybklkOiBsb2FkZWRJbmRleFBhdHRlcm4uaWQKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICB9KTsKICAgIH0KCiAgICByZXR1cm4gbG9hZGVkSW5kZXhQYXR0ZXJuOwogIH0KCiAgKDAsIF9oZWxwX21lbnVfdXRpbC5hZGRIZWxwTWVudVRvQXBwQ2hyb21lKShjaHJvbWUpOwogIGluaXQoKTsgLy8gUHJvcGFnYXRlIGN1cnJlbnQgYXBwIHN0YXRlIHRvIHVybCwgdGhlbiBzdGFydCBzeW5jaW5nCgogIHJlcGxhY2VVcmxBcHBTdGF0ZSgpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHN0YXJ0U3RhdGVTeW5jKCk7CiAgfSk7Cn0="},null]}
{"remainingRequest":"node_modules/thread-loader/dist/cjs.js??ref--8-1!node_modules/babel-loader/lib/index.js??ref--8-2!x-pack/legacy/plugins/canvas/canvas_plugin_src/lib/flot-charts/jquery.flot.js","dependencies":[{"path":"x-pack/legacy/plugins/canvas/canvas_plugin_src/lib/flot-charts/jquery.flot.js","mtime":1589249551803},{"path":"node_modules/cache-loader/dist/cjs.js","mtime":1589249605183},{"path":"node_modules/thread-loader/dist/cjs.js","mtime":1589249608558},{"path":"node_modules/babel-loader/lib/index.js","mtime":1589249591025}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:InVzZSBzdHJpY3QiOwoKZnVuY3Rpb24gX3R5cGVvZihvYmopIHsgaWYgKHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIFN5bWJvbC5pdGVyYXRvciA9PT0gInN5bWJvbCIpIHsgX3R5cGVvZiA9IGZ1bmN0aW9uIF90eXBlb2Yob2JqKSB7IHJldHVybiB0eXBlb2Ygb2JqOyB9OyB9IGVsc2UgeyBfdHlwZW9mID0gZnVuY3Rpb24gX3R5cGVvZihvYmopIHsgcmV0dXJuIG9iaiAmJiB0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIG9iai5jb25zdHJ1Y3RvciA9PT0gU3ltYm9sICYmIG9iaiAhPT0gU3ltYm9sLnByb3RvdHlwZSA/ICJzeW1ib2wiIDogdHlwZW9mIG9iajsgfTsgfSByZXR1cm4gX3R5cGVvZihvYmopOyB9CgovKiBKYXZhc2NyaXB0IHBsb3R0aW5nIGxpYnJhcnkgZm9yIGpRdWVyeSwgdmVyc2lvbiAwLjguMy4KCkNvcHlyaWdodCAoYykgMjAwNy0yMDE0IElPTEEgYW5kIE9sZSBMYXVyc2VuLgpMaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCgoqLwovLyBmaXJzdCBhbiBpbmxpbmUgZGVwZW5kZW5jeSwganF1ZXJ5LmNvbG9yaGVscGVycy5qcywgd2UgaW5saW5lIGl0IGhlcmUKLy8gZm9yIGNvbnZlbmllbmNlCgovKiBQbHVnaW4gZm9yIGpRdWVyeSBmb3Igd29ya2luZyB3aXRoIGNvbG9ycy4KICoKICogVmVyc2lvbiAxLjEuCiAqCiAqIEluc3BpcmF0aW9uIGZyb20galF1ZXJ5IGNvbG9yIGFuaW1hdGlvbiBwbHVnaW4gYnkgSm9obiBSZXNpZy4KICoKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGJ5IE9sZSBMYXVyc2VuLCBPY3RvYmVyIDIwMDkuCiAqCiAqIEV4YW1wbGVzOgogKgogKiAgICQuY29sb3IucGFyc2UoIiNmZmYiKS5zY2FsZSgncmdiJywgMC4yNSkuYWRkKCdhJywgLTAuNSkudG9TdHJpbmcoKQogKiAgIHZhciBjID0gJC5jb2xvci5leHRyYWN0KCQoIiNteWRpdiIpLCAnYmFja2dyb3VuZC1jb2xvcicpOwogKiAgIGNvbnNvbGUubG9nKGMuciwgYy5nLCBjLmIsIGMuYSk7CiAqICAgJC5jb2xvci5tYWtlKDEwMCwgNTAsIDI1LCAwLjQpLnRvU3RyaW5nKCkgLy8gcmV0dXJucyAicmdiYSgxMDAsNTAsMjUsMC40KSIKICoKICogTm90ZSB0aGF0IC5zY2FsZSgpIGFuZCAuYWRkKCkgcmV0dXJuIHRoZSBzYW1lIG1vZGlmaWVkIG9iamVjdAogKiBpbnN0ZWFkIG9mIG1ha2luZyBhIG5ldyBvbmUuCiAqCiAqIFYuIDEuMTogRml4IGVycm9yIGhhbmRsaW5nIHNvIGUuZy4gcGFyc2luZyBhbiBlbXB0eSBzdHJpbmcgZG9lcwogKiBwcm9kdWNlIGEgY29sb3IgcmF0aGVyIHRoYW4ganVzdCBjcmFzaGluZy4KICovCihmdW5jdGlvbiAoJCkgewogICQuY29sb3IgPSB7fTsKCiAgJC5jb2xvci5tYWtlID0gZnVuY3Rpb24gKHIsIGcsIGIsIGEpIHsKICAgIHZhciBvID0ge307CiAgICBvLnIgPSByIHx8IDA7CiAgICBvLmcgPSBnIHx8IDA7CiAgICBvLmIgPSBiIHx8IDA7CiAgICBvLmEgPSBhICE9IG51bGwgPyBhIDogMTsKCiAgICBvLmFkZCA9IGZ1bmN0aW9uIChjLCBkKSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYy5sZW5ndGg7ICsraSkgewogICAgICAgIG9bYy5jaGFyQXQoaSldICs9IGQ7CiAgICAgIH0KCiAgICAgIHJldHVybiBvLm5vcm1hbGl6ZSgpOwogICAgfTsKCiAgICBvLnNjYWxlID0gZnVuY3Rpb24gKGMsIGYpIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjLmxlbmd0aDsgKytpKSB7CiAgICAgICAgb1tjLmNoYXJBdChpKV0gKj0gZjsKICAgICAgfQoKICAgICAgcmV0dXJuIG8ubm9ybWFsaXplKCk7CiAgICB9OwoKICAgIG8udG9TdHJpbmcgPSBmdW5jdGlvbiAoKSB7CiAgICAgIGlmIChvLmEgPj0gMSkgewogICAgICAgIHJldHVybiAicmdiKCIgKyBbby5yLCBvLmcsIG8uYl0uam9pbigiLCIpICsgIikiOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiAicmdiYSgiICsgW28uciwgby5nLCBvLmIsIG8uYV0uam9pbigiLCIpICsgIikiOwogICAgICB9CiAgICB9OwoKICAgIG8ubm9ybWFsaXplID0gZnVuY3Rpb24gKCkgewogICAgICBmdW5jdGlvbiBjbGFtcChtaW4sIHZhbHVlLCBtYXgpIHsKICAgICAgICByZXR1cm4gdmFsdWUgPCBtaW4gPyBtaW4gOiB2YWx1ZSA+IG1heCA/IG1heCA6IHZhbHVlOwogICAgICB9CgogICAgICBvLnIgPSBjbGFtcCgwLCBwYXJzZUludChvLnIpLCAyNTUpOwogICAgICBvLmcgPSBjbGFtcCgwLCBwYXJzZUludChvLmcpLCAyNTUpOwogICAgICBvLmIgPSBjbGFtcCgwLCBwYXJzZUludChvLmIpLCAyNTUpOwogICAgICBvLmEgPSBjbGFtcCgwLCBvLmEsIDEpOwogICAgICByZXR1cm4gbzsKICAgIH07CgogICAgby5jbG9uZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuICQuY29sb3IubWFrZShvLnIsIG8uYiwgby5nLCBvLmEpOwogICAgfTsKCiAgICByZXR1cm4gby5ub3JtYWxpemUoKTsKICB9OwoKICAkLmNvbG9yLmV4dHJhY3QgPSBmdW5jdGlvbiAoZWxlbSwgY3NzKSB7CiAgICB2YXIgYzsKCiAgICBkbyB7CiAgICAgIGMgPSBlbGVtLmNzcyhjc3MpLnRvTG93ZXJDYXNlKCk7CiAgICAgIGlmIChjICE9ICIiICYmIGMgIT0gInRyYW5zcGFyZW50IikgYnJlYWs7CiAgICAgIGVsZW0gPSBlbGVtLnBhcmVudCgpOwogICAgfSB3aGlsZSAoZWxlbS5sZW5ndGggJiYgISQubm9kZU5hbWUoZWxlbS5nZXQoMCksICJib2R5IikpOwoKICAgIGlmIChjID09ICJyZ2JhKDAsIDAsIDAsIDApIikgYyA9ICJ0cmFuc3BhcmVudCI7CiAgICByZXR1cm4gJC5jb2xvci5wYXJzZShjKTsKICB9OwoKICAkLmNvbG9yLnBhcnNlID0gZnVuY3Rpb24gKHN0cikgewogICAgdmFyIHJlcywKICAgICAgICBtID0gJC5jb2xvci5tYWtlOwogICAgaWYgKHJlcyA9IC9yZ2JcKFxzKihbMC05XXsxLDN9KVxzKixccyooWzAtOV17MSwzfSlccyosXHMqKFswLTldezEsM30pXHMqXCkvLmV4ZWMoc3RyKSkgcmV0dXJuIG0ocGFyc2VJbnQocmVzWzFdLCAxMCksIHBhcnNlSW50KHJlc1syXSwgMTApLCBwYXJzZUludChyZXNbM10sIDEwKSk7CiAgICBpZiAocmVzID0gL3JnYmFcKFxzKihbMC05XXsxLDN9KVxzKixccyooWzAtOV17MSwzfSlccyosXHMqKFswLTldezEsM30pXHMqLFxzKihbMC05XSsoPzpcLlswLTldKyk/KVxzKlwpLy5leGVjKHN0cikpIHJldHVybiBtKHBhcnNlSW50KHJlc1sxXSwgMTApLCBwYXJzZUludChyZXNbMl0sIDEwKSwgcGFyc2VJbnQocmVzWzNdLCAxMCksIHBhcnNlRmxvYXQocmVzWzRdKSk7CiAgICBpZiAocmVzID0gL3JnYlwoXHMqKFswLTldKyg/OlwuWzAtOV0rKT8pXCVccyosXHMqKFswLTldKyg/OlwuWzAtOV0rKT8pXCVccyosXHMqKFswLTldKyg/OlwuWzAtOV0rKT8pXCVccypcKS8uZXhlYyhzdHIpKSByZXR1cm4gbShwYXJzZUZsb2F0KHJlc1sxXSkgKiAyLjU1LCBwYXJzZUZsb2F0KHJlc1syXSkgKiAyLjU1LCBwYXJzZUZsb2F0KHJlc1szXSkgKiAyLjU1KTsKICAgIGlmIChyZXMgPSAvcmdiYVwoXHMqKFswLTldKyg/OlwuWzAtOV0rKT8pXCVccyosXHMqKFswLTldKyg/OlwuWzAtOV0rKT8pXCVccyosXHMqKFswLTldKyg/OlwuWzAtOV0rKT8pXCVccyosXHMqKFswLTldKyg/OlwuWzAtOV0rKT8pXHMqXCkvLmV4ZWMoc3RyKSkgcmV0dXJuIG0ocGFyc2VGbG9hdChyZXNbMV0pICogMi41NSwgcGFyc2VGbG9hdChyZXNbMl0pICogMi41NSwgcGFyc2VGbG9hdChyZXNbM10pICogMi41NSwgcGFyc2VGbG9hdChyZXNbNF0pKTsKICAgIGlmIChyZXMgPSAvIyhbYS1mQS1GMC05XXsyfSkoW2EtZkEtRjAtOV17Mn0pKFthLWZBLUYwLTldezJ9KS8uZXhlYyhzdHIpKSByZXR1cm4gbShwYXJzZUludChyZXNbMV0sIDE2KSwgcGFyc2VJbnQocmVzWzJdLCAxNiksIHBhcnNlSW50KHJlc1szXSwgMTYpKTsKICAgIGlmIChyZXMgPSAvIyhbYS1mQS1GMC05XSkoW2EtZkEtRjAtOV0pKFthLWZBLUYwLTldKS8uZXhlYyhzdHIpKSByZXR1cm4gbShwYXJzZUludChyZXNbMV0gKyByZXNbMV0sIDE2KSwgcGFyc2VJbnQocmVzWzJdICsgcmVzWzJdLCAxNiksIHBhcnNlSW50KHJlc1szXSArIHJlc1szXSwgMTYpKTsKICAgIHZhciBuYW1lID0gJC50cmltKHN0cikudG9Mb3dlckNhc2UoKTsKICAgIGlmIChuYW1lID09ICJ0cmFuc3BhcmVudCIpIHJldHVybiBtKDI1NSwgMjU1LCAyNTUsIDApO2Vsc2UgewogICAgICByZXMgPSBsb29rdXBDb2xvcnNbbmFtZV0gfHwgWzAsIDAsIDBdOwogICAgICByZXR1cm4gbShyZXNbMF0sIHJlc1sxXSwgcmVzWzJdKTsKICAgIH0KICB9OwoKICB2YXIgbG9va3VwQ29sb3JzID0gewogICAgYXF1YTogWzAsIDI1NSwgMjU1XSwKICAgIGF6dXJlOiBbMjQwLCAyNTUsIDI1NV0sCiAgICBiZWlnZTogWzI0NSwgMjQ1LCAyMjBdLAogICAgYmxhY2s6IFswLCAwLCAwXSwKICAgIGJsdWU6IFswLCAwLCAyNTVdLAogICAgYnJvd246IFsxNjUsIDQyLCA0Ml0sCiAgICBjeWFuOiBbMCwgMjU1LCAyNTVdLAogICAgZGFya2JsdWU6IFswLCAwLCAxMzldLAogICAgZGFya2N5YW46IFswLCAxMzksIDEzOV0sCiAgICBkYXJrZ3JleTogWzE2OSwgMTY5LCAxNjldLAogICAgZGFya2dyZWVuOiBbMCwgMTAwLCAwXSwKICAgIGRhcmtraGFraTogWzE4OSwgMTgzLCAxMDddLAogICAgZGFya21hZ2VudGE6IFsxMzksIDAsIDEzOV0sCiAgICBkYXJrb2xpdmVncmVlbjogWzg1LCAxMDcsIDQ3XSwKICAgIGRhcmtvcmFuZ2U6IFsyNTUsIDE0MCwgMF0sCiAgICBkYXJrb3JjaGlkOiBbMTUzLCA1MCwgMjA0XSwKICAgIGRhcmtyZWQ6IFsxMzksIDAsIDBdLAogICAgZGFya3NhbG1vbjogWzIzMywgMTUwLCAxMjJdLAogICAgZGFya3Zpb2xldDogWzE0OCwgMCwgMjExXSwKICAgIGZ1Y2hzaWE6IFsyNTUsIDAsIDI1NV0sCiAgICBnb2xkOiBbMjU1LCAyMTUsIDBdLAogICAgZ3JlZW46IFswLCAxMjgsIDBdLAogICAgaW5kaWdvOiBbNzUsIDAsIDEzMF0sCiAgICBraGFraTogWzI0MCwgMjMwLCAxNDBdLAogICAgbGlnaHRibHVlOiBbMTczLCAyMTYsIDIzMF0sCiAgICBsaWdodGN5YW46IFsyMjQsIDI1NSwgMjU1XSwKICAgIGxpZ2h0Z3JlZW46IFsxNDQsIDIzOCwgMTQ0XSwKICAgIGxpZ2h0Z3JleTogWzIxMSwgMjExLCAyMTFdLAogICAgbGlnaHRwaW5rOiBbMjU1LCAxODIsIDE5M10sCiAgICBsaWdodHllbGxvdzogWzI1NSwgMjU1LCAyMjRdLAogICAgbGltZTogWzAsIDI1NSwgMF0sCiAgICBtYWdlbnRhOiBbMjU1LCAwLCAyNTVdLAogICAgbWFyb29uOiBbMTI4LCAwLCAwXSwKICAgIG5hdnk6IFswLCAwLCAxMjhdLAogICAgb2xpdmU6IFsxMjgsIDEyOCwgMF0sCiAgICBvcmFuZ2U6IFsyNTUsIDE2NSwgMF0sCiAgICBwaW5rOiBbMjU1LCAxOTIsIDIwM10sCiAgICBwdXJwbGU6IFsxMjgsIDAsIDEyOF0sCiAgICB2aW9sZXQ6IFsxMjgsIDAsIDEyOF0sCiAgICByZWQ6IFsyNTUsIDAsIDBdLAogICAgc2lsdmVyOiBbMTkyLCAxOTIsIDE5Ml0sCiAgICB3aGl0ZTogWzI1NSwgMjU1LCAyNTVdLAogICAgeWVsbG93OiBbMjU1LCAyNTUsIDBdCiAgfTsKfSkoalF1ZXJ5KTsgLy8gdGhlIGFjdHVhbCBGbG90IGNvZGUKCgooZnVuY3Rpb24gKCQpIHsKICAvLyBDYWNoZSB0aGUgcHJvdG90eXBlIGhhc093blByb3BlcnR5IGZvciBmYXN0ZXIgYWNjZXNzCiAgdmFyIGhhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsgLy8gQSBzaGltIHRvIHByb3ZpZGUgJ2RldGFjaCcgdG8galF1ZXJ5IHZlcnNpb25zIHByaW9yIHRvIDEuNC4gIFVzaW5nIGEgRE9NCiAgLy8gb3BlcmF0aW9uIHByb2R1Y2VzIHRoZSBzYW1lIGVmZmVjdCBhcyBkZXRhY2gsIGkuZS4gcmVtb3ZpbmcgdGhlIGVsZW1lbnQKICAvLyB3aXRob3V0IHRvdWNoaW5nIGl0cyBqUXVlcnkgZGF0YS4KICAvLyBEbyBub3QgbWVyZ2UgdGhpcyBpbnRvIEZsb3QgMC45LCBzaW5jZSBpdCByZXF1aXJlcyBqUXVlcnkgMS40LjQrLgoKICBpZiAoISQuZm4uZGV0YWNoKSB7CiAgICAkLmZuLmRldGFjaCA9IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKHRoaXMucGFyZW50Tm9kZSkgewogICAgICAgICAgdGhpcy5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRoaXMpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9OwogIH0gLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgLy8gVGhlIENhbnZhcyBvYmplY3QgaXMgYSB3cmFwcGVyIGFyb3VuZCBhbiBIVE1MNSA8Y2FudmFzPiB0YWcuCiAgLy8KICAvLyBAY29uc3RydWN0b3IKICAvLyBAcGFyYW0ge3N0cmluZ30gY2xzIExpc3Qgb2YgY2xhc3NlcyB0byBhcHBseSB0byB0aGUgY2FudmFzLgogIC8vIEBwYXJhbSB7ZWxlbWVudH0gY29udGFpbmVyIEVsZW1lbnQgb250byB3aGljaCB0byBhcHBlbmQgdGhlIGNhbnZhcy4KICAvLwogIC8vIFJlcXVpcmluZyBhIGNvbnRhaW5lciBpcyBhIGxpdHRsZSBpZmZ5LCBidXQgdW5mb3J0dW5hdGVseSBjYW52YXMKICAvLyBvcGVyYXRpb25zIGRvbid0IHdvcmsgdW5sZXNzIHRoZSBjYW52YXMgaXMgYXR0YWNoZWQgdG8gdGhlIERPTS4KCgogIGZ1bmN0aW9uIENhbnZhcyhjbHMsIGNvbnRhaW5lcikgewogICAgdmFyIGVsZW1lbnQgPSBjb250YWluZXIuY2hpbGRyZW4oIi4iICsgY2xzKVswXTsKCiAgICBpZiAoZWxlbWVudCA9PSBudWxsKSB7CiAgICAgIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJjYW52YXMiKTsKICAgICAgZWxlbWVudC5jbGFzc05hbWUgPSBjbHM7CiAgICAgICQoZWxlbWVudCkuY3NzKHsKICAgICAgICBkaXJlY3Rpb246ICJsdHIiLAogICAgICAgIHBvc2l0aW9uOiAiYWJzb2x1dGUiLAogICAgICAgIGxlZnQ6IDAsCiAgICAgICAgdG9wOiAwCiAgICAgIH0pLmFwcGVuZFRvKGNvbnRhaW5lcik7IC8vIElmIEhUTUw1IENhbnZhcyBpc24ndCBhdmFpbGFibGUsIGZhbGwgYmFjayB0byBbRXh8Rmxhc2hdY2FudmFzCgogICAgICBpZiAoIWVsZW1lbnQuZ2V0Q29udGV4dCkgewogICAgICAgIGlmICh3aW5kb3cuR192bWxDYW52YXNNYW5hZ2VyKSB7CiAgICAgICAgICBlbGVtZW50ID0gd2luZG93Lkdfdm1sQ2FudmFzTWFuYWdlci5pbml0RWxlbWVudChlbGVtZW50KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW52YXMgaXMgbm90IGF2YWlsYWJsZS4gSWYgeW91J3JlIHVzaW5nIElFIHdpdGggYSBmYWxsLWJhY2sgc3VjaCBhcyBFeGNhbnZhcywgdGhlbiB0aGVyZSdzIGVpdGhlciBhIG1pc3Rha2UgaW4geW91ciBjb25kaXRpb25hbCBpbmNsdWRlLCBvciB0aGUgcGFnZSBoYXMgbm8gRE9DVFlQRSBhbmQgaXMgcmVuZGVyaW5nIGluIFF1aXJrcyBNb2RlLiIpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHRoaXMuZWxlbWVudCA9IGVsZW1lbnQ7CiAgICB2YXIgY29udGV4dCA9IHRoaXMuY29udGV4dCA9IGVsZW1lbnQuZ2V0Q29udGV4dCgiMmQiKTsgLy8gRGV0ZXJtaW5lIHRoZSBzY3JlZW4ncyByYXRpbyBvZiBwaHlzaWNhbCB0byBkZXZpY2UtaW5kZXBlbmRlbnQKICAgIC8vIHBpeGVscy4gIFRoaXMgaXMgdGhlIHJhdGlvIGJldHdlZW4gdGhlIGNhbnZhcyB3aWR0aCB0aGF0IHRoZSBicm93c2VyCiAgICAvLyBhZHZlcnRpc2VzIGFuZCB0aGUgbnVtYmVyIG9mIHBpeGVscyBhY3R1YWxseSBwcmVzZW50IGluIHRoYXQgc3BhY2UuCiAgICAvLyBUaGUgaVBob25lIDQsIGZvciBleGFtcGxlLCBoYXMgYSBkZXZpY2UtaW5kZXBlbmRlbnQgd2lkdGggb2YgMzIwcHgsCiAgICAvLyBidXQgaXRzIHNjcmVlbiBpcyBhY3R1YWxseSA2NDBweCB3aWRlLiAgSXQgdGhlcmVmb3JlIGhhcyBhIHBpeGVsCiAgICAvLyByYXRpbyBvZiAyLCB3aGlsZSBtb3N0IG5vcm1hbCBkZXZpY2VzIGhhdmUgYSByYXRpbyBvZiAxLgoKICAgIHZhciBkZXZpY2VQaXhlbFJhdGlvID0gd2luZG93LmRldmljZVBpeGVsUmF0aW8gfHwgMSwKICAgICAgICBiYWNraW5nU3RvcmVSYXRpbyA9IGNvbnRleHQud2Via2l0QmFja2luZ1N0b3JlUGl4ZWxSYXRpbyB8fCBjb250ZXh0Lm1vekJhY2tpbmdTdG9yZVBpeGVsUmF0aW8gfHwgY29udGV4dC5tc0JhY2tpbmdTdG9yZVBpeGVsUmF0aW8gfHwgY29udGV4dC5vQmFja2luZ1N0b3JlUGl4ZWxSYXRpbyB8fCBjb250ZXh0LmJhY2tpbmdTdG9yZVBpeGVsUmF0aW8gfHwgMTsKICAgIHRoaXMucGl4ZWxSYXRpbyA9IGRldmljZVBpeGVsUmF0aW8gLyBiYWNraW5nU3RvcmVSYXRpbzsgLy8gU2l6ZSB0aGUgY2FudmFzIHRvIG1hdGNoIHRoZSBpbnRlcm5hbCBkaW1lbnNpb25zIG9mIGl0cyBjb250YWluZXIKCiAgICB0aGlzLnJlc2l6ZShjb250YWluZXIud2lkdGgoKSwgY29udGFpbmVyLmhlaWdodCgpKTsgLy8gQ29sbGVjdGlvbiBvZiBIVE1MIGRpdiBsYXllcnMgZm9yIHRleHQgb3ZlcmxhaWQgb250byB0aGUgY2FudmFzCgogICAgdGhpcy50ZXh0Q29udGFpbmVyID0gbnVsbDsKICAgIHRoaXMudGV4dCA9IHt9OyAvLyBDYWNoZSBvZiB0ZXh0IGZyYWdtZW50cyBhbmQgbWV0cmljcywgc28gd2UgY2FuIGF2b2lkIGV4cGVuc2l2ZWx5CiAgICAvLyByZS1jYWxjdWxhdGluZyB0aGVtIHdoZW4gdGhlIHBsb3QgaXMgcmUtcmVuZGVyZWQgaW4gYSBsb29wLgoKICAgIHRoaXMuX3RleHRDYWNoZSA9IHt9OwogIH0gLy8gUmVzaXplcyB0aGUgY2FudmFzIHRvIHRoZSBnaXZlbiBkaW1lbnNpb25zLgogIC8vCiAgLy8gQHBhcmFtIHtudW1iZXJ9IHdpZHRoIE5ldyB3aWR0aCBvZiB0aGUgY2FudmFzLCBpbiBwaXhlbHMuCiAgLy8gQHBhcmFtIHtudW1iZXJ9IHdpZHRoIE5ldyBoZWlnaHQgb2YgdGhlIGNhbnZhcywgaW4gcGl4ZWxzLgoKCiAgQ2FudmFzLnByb3RvdHlwZS5yZXNpemUgPSBmdW5jdGlvbiAod2lkdGgsIGhlaWdodCkgewogICAgaWYgKHdpZHRoIDw9IDAgfHwgaGVpZ2h0IDw9IDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIGRpbWVuc2lvbnMgZm9yIHBsb3QsIHdpZHRoID0gIiArIHdpZHRoICsgIiwgaGVpZ2h0ID0gIiArIGhlaWdodCk7CiAgICB9CgogICAgdmFyIGVsZW1lbnQgPSB0aGlzLmVsZW1lbnQsCiAgICAgICAgY29udGV4dCA9IHRoaXMuY29udGV4dCwKICAgICAgICBwaXhlbFJhdGlvID0gdGhpcy5waXhlbFJhdGlvOyAvLyBSZXNpemUgdGhlIGNhbnZhcywgaW5jcmVhc2luZyBpdHMgZGVuc2l0eSBiYXNlZCBvbiB0aGUgZGlzcGxheSdzCiAgICAvLyBwaXhlbCByYXRpbzsgYmFzaWNhbGx5IGdpdmluZyBpdCBtb3JlIHBpeGVscyB3aXRob3V0IGluY3JlYXNpbmcgdGhlCiAgICAvLyBzaXplIG9mIGl0cyBlbGVtZW50LCB0byB0YWtlIGFkdmFudGFnZSBvZiB0aGUgZmFjdCB0aGF0IHJldGluYQogICAgLy8gZGlzcGxheXMgaGF2ZSB0aGF0IG1hbnkgbW9yZSBwaXhlbHMgaW4gdGhlIHNhbWUgYWR2ZXJ0aXNlZCBzcGFjZS4KICAgIC8vIFJlc2l6aW5nIHNob3VsZCByZXNldCB0aGUgc3RhdGUgKGV4Y2FudmFzIHNlZW1zIHRvIGJlIGJ1Z2d5IHRob3VnaCkKCiAgICBpZiAodGhpcy53aWR0aCAhPSB3aWR0aCkgewogICAgICBlbGVtZW50LndpZHRoID0gd2lkdGggKiBwaXhlbFJhdGlvOwogICAgICBlbGVtZW50LnN0eWxlLndpZHRoID0gd2lkdGggKyAicHgiOwogICAgICB0aGlzLndpZHRoID0gd2lkdGg7CiAgICB9CgogICAgaWYgKHRoaXMuaGVpZ2h0ICE9IGhlaWdodCkgewogICAgICBlbGVtZW50LmhlaWdodCA9IGhlaWdodCAqIHBpeGVsUmF0aW87CiAgICAgIGVsZW1lbnQuc3R5bGUuaGVpZ2h0ID0gaGVpZ2h0ICsgInB4IjsKICAgICAgdGhpcy5oZWlnaHQgPSBoZWlnaHQ7CiAgICB9IC8vIFNhdmUgdGhlIGNvbnRleHQsIHNvIHdlIGNhbiByZXNldCBpbiBjYXNlIHdlIGdldCByZXBsb3R0ZWQuICBUaGUKICAgIC8vIHJlc3RvcmUgZW5zdXJlIHRoYXQgd2UncmUgcmVhbGx5IGJhY2sgYXQgdGhlIGluaXRpYWwgc3RhdGUsIGFuZAogICAgLy8gc2hvdWxkIGJlIHNhZmUgZXZlbiBpZiB3ZSBoYXZlbid0IHNhdmVkIHRoZSBpbml0aWFsIHN0YXRlIHlldC4KCgogICAgY29udGV4dC5yZXN0b3JlKCk7CiAgICBjb250ZXh0LnNhdmUoKTsgLy8gU2NhbGUgdGhlIGNvb3JkaW5hdGUgc3BhY2UgdG8gbWF0Y2ggdGhlIGRpc3BsYXkgZGVuc2l0eTsgc28gZXZlbiB0aG91Z2ggd2UKICAgIC8vIG1heSBoYXZlIHR3aWNlIGFzIG1hbnkgcGl4ZWxzLCB3ZSBzdGlsbCB3YW50IGxpbmVzIGFuZCBvdGhlciBkcmF3aW5nIHRvCiAgICAvLyBhcHBlYXIgYXQgdGhlIHNhbWUgc2l6ZTsgdGhlIGV4dHJhIHBpeGVscyB3aWxsIGp1c3QgbWFrZSB0aGVtIGNyaXNwZXIuCgogICAgY29udGV4dC5zY2FsZShwaXhlbFJhdGlvLCBwaXhlbFJhdGlvKTsKICB9OyAvLyBDbGVhcnMgdGhlIGVudGlyZSBjYW52YXMgYXJlYSwgbm90IGluY2x1ZGluZyBhbnkgb3ZlcmxhaWQgSFRNTCB0ZXh0CgoKICBDYW52YXMucHJvdG90eXBlLmNsZWFyID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5jb250ZXh0LmNsZWFyUmVjdCgwLCAwLCB0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7CiAgfTsgLy8gRmluaXNoZXMgcmVuZGVyaW5nIHRoZSBjYW52YXMsIGluY2x1ZGluZyBtYW5hZ2luZyB0aGUgdGV4dCBvdmVybGF5LgoKCiAgQ2FudmFzLnByb3RvdHlwZS5yZW5kZXIgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgY2FjaGUgPSB0aGlzLl90ZXh0Q2FjaGU7IC8vIEZvciBlYWNoIHRleHQgbGF5ZXIsIGFkZCBlbGVtZW50cyBtYXJrZWQgYXMgYWN0aXZlIHRoYXQgaGF2ZW4ndAogICAgLy8gYWxyZWFkeSBiZWVuIHJlbmRlcmVkLCBhbmQgcmVtb3ZlIHRob3NlIHRoYXQgYXJlIG5vIGxvbmdlciBhY3RpdmUuCgogICAgZm9yICh2YXIgbGF5ZXJLZXkgaW4gY2FjaGUpIHsKICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoY2FjaGUsIGxheWVyS2V5KSkgewogICAgICAgIHZhciBsYXllciA9IHRoaXMuZ2V0VGV4dExheWVyKGxheWVyS2V5KSwKICAgICAgICAgICAgbGF5ZXJDYWNoZSA9IGNhY2hlW2xheWVyS2V5XTsKICAgICAgICBsYXllci5oaWRlKCk7CgogICAgICAgIGZvciAodmFyIHN0eWxlS2V5IGluIGxheWVyQ2FjaGUpIHsKICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGxheWVyQ2FjaGUsIHN0eWxlS2V5KSkgewogICAgICAgICAgICB2YXIgc3R5bGVDYWNoZSA9IGxheWVyQ2FjaGVbc3R5bGVLZXldOwoKICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIHN0eWxlQ2FjaGUpIHsKICAgICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChzdHlsZUNhY2hlLCBrZXkpKSB7CiAgICAgICAgICAgICAgICB2YXIgcG9zaXRpb25zID0gc3R5bGVDYWNoZVtrZXldLnBvc2l0aW9uczsKCiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgcG9zaXRpb247IHBvc2l0aW9uID0gcG9zaXRpb25zW2ldOyBpKyspIHsKICAgICAgICAgICAgICAgICAgaWYgKHBvc2l0aW9uLmFjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgIGlmICghcG9zaXRpb24ucmVuZGVyZWQpIHsKICAgICAgICAgICAgICAgICAgICAgIGxheWVyLmFwcGVuZChwb3NpdGlvbi5lbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uLnJlbmRlcmVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb25zLnNwbGljZShpLS0sIDEpOwoKICAgICAgICAgICAgICAgICAgICBpZiAocG9zaXRpb24ucmVuZGVyZWQpIHsKICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uLmVsZW1lbnQuZGV0YWNoKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHBvc2l0aW9ucy5sZW5ndGggPT0gMCkgewogICAgICAgICAgICAgICAgICBkZWxldGUgc3R5bGVDYWNoZVtrZXldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgbGF5ZXIuc2hvdygpOwogICAgICB9CiAgICB9CiAgfTsgLy8gQ3JlYXRlcyAoaWYgbmVjZXNzYXJ5KSBhbmQgcmV0dXJucyB0aGUgdGV4dCBvdmVybGF5IGNvbnRhaW5lci4KICAvLwogIC8vIEBwYXJhbSB7c3RyaW5nfSBjbGFzc2VzIFN0cmluZyBvZiBzcGFjZS1zZXBhcmF0ZWQgQ1NTIGNsYXNzZXMgdXNlZCB0bwogIC8vICAgICB1bmlxdWVseSBpZGVudGlmeSB0aGUgdGV4dCBsYXllci4KICAvLyBAcmV0dXJuIHtvYmplY3R9IFRoZSBqUXVlcnktd3JhcHBlZCB0ZXh0LWxheWVyIGRpdi4KCgogIENhbnZhcy5wcm90b3R5cGUuZ2V0VGV4dExheWVyID0gZnVuY3Rpb24gKGNsYXNzZXMpIHsKICAgIHZhciBsYXllciA9IHRoaXMudGV4dFtjbGFzc2VzXTsgLy8gQ3JlYXRlIHRoZSB0ZXh0IGxheWVyIGlmIGl0IGRvZXNuJ3QgZXhpc3QKCiAgICBpZiAobGF5ZXIgPT0gbnVsbCkgewogICAgICAvLyBDcmVhdGUgdGhlIHRleHQgbGF5ZXIgY29udGFpbmVyLCBpZiBpdCBkb2Vzbid0IGV4aXN0CiAgICAgIGlmICh0aGlzLnRleHRDb250YWluZXIgPT0gbnVsbCkgewogICAgICAgIHRoaXMudGV4dENvbnRhaW5lciA9ICQoIjxkaXYgY2xhc3M9J2Zsb3QtdGV4dCc+PC9kaXY+IikuY3NzKHsKICAgICAgICAgIHBvc2l0aW9uOiAiYWJzb2x1dGUiLAogICAgICAgICAgdG9wOiAwLAogICAgICAgICAgbGVmdDogMCwKICAgICAgICAgIGJvdHRvbTogMCwKICAgICAgICAgIHJpZ2h0OiAwLAogICAgICAgICAgJ2ZvbnQtc2l6ZSc6ICJzbWFsbGVyIiwKICAgICAgICAgIGNvbG9yOiAiIzU0NTQ1NCIKICAgICAgICB9KS5pbnNlcnRBZnRlcih0aGlzLmVsZW1lbnQpOwogICAgICB9CgogICAgICBsYXllciA9IHRoaXMudGV4dFtjbGFzc2VzXSA9ICQoIjxkaXY+PC9kaXY+IikuYWRkQ2xhc3MoY2xhc3NlcykuY3NzKHsKICAgICAgICBwb3NpdGlvbjogImFic29sdXRlIiwKICAgICAgICB0b3A6IDAsCiAgICAgICAgbGVmdDogMCwKICAgICAgICBib3R0b206IDAsCiAgICAgICAgcmlnaHQ6IDAKICAgICAgfSkuYXBwZW5kVG8odGhpcy50ZXh0Q29udGFpbmVyKTsKICAgIH0KCiAgICByZXR1cm4gbGF5ZXI7CiAgfTsgLy8gQ3JlYXRlcyAoaWYgbmVjZXNzYXJ5KSBhbmQgcmV0dXJucyBhIHRleHQgaW5mbyBvYmplY3QuCiAgLy8KICAvLyBUaGUgb2JqZWN0IGxvb2tzIGxpa2UgdGhpczoKICAvLwogIC8vIHsKICAvLyAgICAgd2lkdGg6IFdpZHRoIG9mIHRoZSB0ZXh0J3Mgd3JhcHBlciBkaXYuCiAgLy8gICAgIGhlaWdodDogSGVpZ2h0IG9mIHRoZSB0ZXh0J3Mgd3JhcHBlciBkaXYuCiAgLy8gICAgIGVsZW1lbnQ6IFRoZSBqUXVlcnktd3JhcHBlZCBIVE1MIGRpdiBjb250YWluaW5nIHRoZSB0ZXh0LgogIC8vICAgICBwb3NpdGlvbnM6IEFycmF5IG9mIHBvc2l0aW9ucyBhdCB3aGljaCB0aGlzIHRleHQgaXMgZHJhd24uCiAgLy8gfQogIC8vCiAgLy8gVGhlIHBvc2l0aW9ucyBhcnJheSBjb250YWlucyBvYmplY3RzIHRoYXQgbG9vayBsaWtlIHRoaXM6CiAgLy8KICAvLyB7CiAgLy8gICAgIGFjdGl2ZTogRmxhZyBpbmRpY2F0aW5nIHdoZXRoZXIgdGhlIHRleHQgc2hvdWxkIGJlIHZpc2libGUuCiAgLy8gICAgIHJlbmRlcmVkOiBGbGFnIGluZGljYXRpbmcgd2hldGhlciB0aGUgdGV4dCBpcyBjdXJyZW50bHkgdmlzaWJsZS4KICAvLyAgICAgZWxlbWVudDogVGhlIGpRdWVyeS13cmFwcGVkIEhUTUwgZGl2IGNvbnRhaW5pbmcgdGhlIHRleHQuCiAgLy8gICAgIHg6IFggY29vcmRpbmF0ZSBhdCB3aGljaCB0byBkcmF3IHRoZSB0ZXh0LgogIC8vICAgICB5OiBZIGNvb3JkaW5hdGUgYXQgd2hpY2ggdG8gZHJhdyB0aGUgdGV4dC4KICAvLyB9CiAgLy8KICAvLyBFYWNoIHBvc2l0aW9uIGFmdGVyIHRoZSBmaXJzdCByZWNlaXZlcyBhIGNsb25lIG9mIHRoZSBvcmlnaW5hbCBlbGVtZW50LgogIC8vCiAgLy8gVGhlIGlkZWEgaXMgdGhhdCB0aGF0IHRoZSB3aWR0aCwgaGVpZ2h0LCBhbmQgZ2VuZXJhbCAnaWRlbnRpdHknIG9mIHRoZQogIC8vIHRleHQgaXMgY29uc3RhbnQgbm8gbWF0dGVyIHdoZXJlIGl0IGlzIHBsYWNlZDsgdGhlIHBsYWNlbWVudHMgYXJlIGEKICAvLyBzZWNvbmRhcnkgcHJvcGVydHkuCiAgLy8KICAvLyBDYW52YXMgbWFpbnRhaW5zIGEgY2FjaGUgb2YgcmVjZW50bHktdXNlZCB0ZXh0IGluZm8gb2JqZWN0czsgZ2V0VGV4dEluZm8KICAvLyBlaXRoZXIgcmV0dXJucyB0aGUgY2FjaGVkIGVsZW1lbnQgb3IgY3JlYXRlcyBhIG5ldyBlbnRyeS4KICAvLwogIC8vIEBwYXJhbSB7c3RyaW5nfSBsYXllciBBIHN0cmluZyBvZiBzcGFjZS1zZXBhcmF0ZWQgQ1NTIGNsYXNzZXMgdW5pcXVlbHkKICAvLyAgICAgaWRlbnRpZnlpbmcgdGhlIGxheWVyIGNvbnRhaW5pbmcgdGhpcyB0ZXh0LgogIC8vIEBwYXJhbSB7c3RyaW5nfSB0ZXh0IFRleHQgc3RyaW5nIHRvIHJldHJpZXZlIGluZm8gZm9yLgogIC8vIEBwYXJhbSB7KHN0cmluZ3xvYmplY3QpPX0gZm9udCBFaXRoZXIgYSBzdHJpbmcgb2Ygc3BhY2Utc2VwYXJhdGVkIENTUwogIC8vICAgICBjbGFzc2VzIG9yIGEgZm9udC1zcGVjIG9iamVjdCwgZGVmaW5pbmcgdGhlIHRleHQncyBmb250IGFuZCBzdHlsZS4KICAvLyBAcGFyYW0ge251bWJlcj19IGFuZ2xlIEFuZ2xlIGF0IHdoaWNoIHRvIHJvdGF0ZSB0aGUgdGV4dCwgaW4gZGVncmVlcy4KICAvLyAgICAgQW5nbGUgaXMgY3VycmVudGx5IHVudXNlZCwgaXQgd2lsbCBiZSBpbXBsZW1lbnRlZCBpbiB0aGUgZnV0dXJlLgogIC8vIEBwYXJhbSB7bnVtYmVyPX0gd2lkdGggTWF4aW11bSB3aWR0aCBvZiB0aGUgdGV4dCBiZWZvcmUgaXQgd3JhcHMuCiAgLy8gQHJldHVybiB7b2JqZWN0fSBhIHRleHQgaW5mbyBvYmplY3QuCgoKICBDYW52YXMucHJvdG90eXBlLmdldFRleHRJbmZvID0gZnVuY3Rpb24gKGxheWVyLCB0ZXh0LCBmb250LCBhbmdsZSwgd2lkdGgpIHsKICAgIHZhciB0ZXh0U3R5bGUsIGxheWVyQ2FjaGUsIHN0eWxlQ2FjaGUsIGluZm87IC8vIENhc3QgdGhlIHZhbHVlIHRvIGEgc3RyaW5nLCBpbiBjYXNlIHdlIHdlcmUgZ2l2ZW4gYSBudW1iZXIgb3Igc3VjaAoKICAgIHRleHQgPSAiIiArIHRleHQ7IC8vIElmIHRoZSBmb250IGlzIGEgZm9udC1zcGVjIG9iamVjdCwgZ2VuZXJhdGUgYSBDU1MgZm9udCBkZWZpbml0aW9uCgogICAgaWYgKF90eXBlb2YoZm9udCkgPT09ICJvYmplY3QiKSB7CiAgICAgIHRleHRTdHlsZSA9IGZvbnQuc3R5bGUgKyAiICIgKyBmb250LnZhcmlhbnQgKyAiICIgKyBmb250LndlaWdodCArICIgIiArIGZvbnQuc2l6ZSArICJweC8iICsgZm9udC5saW5lSGVpZ2h0ICsgInB4ICIgKyBmb250LmZhbWlseTsKICAgIH0gZWxzZSB7CiAgICAgIHRleHRTdHlsZSA9IGZvbnQ7CiAgICB9IC8vIFJldHJpZXZlIChvciBjcmVhdGUpIHRoZSBjYWNoZSBmb3IgdGhlIHRleHQncyBsYXllciBhbmQgc3R5bGVzCgoKICAgIGxheWVyQ2FjaGUgPSB0aGlzLl90ZXh0Q2FjaGVbbGF5ZXJdOwoKICAgIGlmIChsYXllckNhY2hlID09IG51bGwpIHsKICAgICAgbGF5ZXJDYWNoZSA9IHRoaXMuX3RleHRDYWNoZVtsYXllcl0gPSB7fTsKICAgIH0KCiAgICBzdHlsZUNhY2hlID0gbGF5ZXJDYWNoZVt0ZXh0U3R5bGVdOwoKICAgIGlmIChzdHlsZUNhY2hlID09IG51bGwpIHsKICAgICAgc3R5bGVDYWNoZSA9IGxheWVyQ2FjaGVbdGV4dFN0eWxlXSA9IHt9OwogICAgfQoKICAgIGluZm8gPSBzdHlsZUNhY2hlW3RleHRdOyAvLyBJZiB3ZSBjYW4ndCBmaW5kIGEgbWF0Y2hpbmcgZWxlbWVudCBpbiBvdXIgY2FjaGUsIGNyZWF0ZSBhIG5ldyBvbmUKCiAgICBpZiAoaW5mbyA9PSBudWxsKSB7CiAgICAgIHZhciBlbGVtZW50ID0gJCgiPGRpdj48L2Rpdj4iKS5odG1sKHRleHQpLmNzcyh7CiAgICAgICAgcG9zaXRpb246ICJhYnNvbHV0ZSIsCiAgICAgICAgJ21heC13aWR0aCc6IHdpZHRoLAogICAgICAgIHRvcDogLTk5OTkKICAgICAgfSkuYXBwZW5kVG8odGhpcy5nZXRUZXh0TGF5ZXIobGF5ZXIpKTsKCiAgICAgIGlmIChfdHlwZW9mKGZvbnQpID09PSAib2JqZWN0IikgewogICAgICAgIGVsZW1lbnQuY3NzKHsKICAgICAgICAgIGZvbnQ6IHRleHRTdHlsZSwKICAgICAgICAgIGNvbG9yOiBmb250LmNvbG9yCiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGZvbnQgPT09ICJzdHJpbmciKSB7CiAgICAgICAgZWxlbWVudC5hZGRDbGFzcyhmb250KTsKICAgICAgfQoKICAgICAgaW5mbyA9IHN0eWxlQ2FjaGVbdGV4dF0gPSB7CiAgICAgICAgd2lkdGg6IGVsZW1lbnQub3V0ZXJXaWR0aCh0cnVlKSwKICAgICAgICBoZWlnaHQ6IGVsZW1lbnQub3V0ZXJIZWlnaHQodHJ1ZSksCiAgICAgICAgZWxlbWVudDogZWxlbWVudCwKICAgICAgICBwb3NpdGlvbnM6IFtdCiAgICAgIH07CiAgICAgIGVsZW1lbnQuZGV0YWNoKCk7CiAgICB9CgogICAgcmV0dXJuIGluZm87CiAgfTsgLy8gQWRkcyBhIHRleHQgc3RyaW5nIHRvIHRoZSBjYW52YXMgdGV4dCBvdmVybGF5LgogIC8vCiAgLy8gVGhlIHRleHQgaXNuJ3QgZHJhd24gaW1tZWRpYXRlbHk7IGl0IGlzIG1hcmtlZCBhcyByZW5kZXJpbmcsIHdoaWNoIHdpbGwKICAvLyByZXN1bHQgaW4gaXRzIGFkZGl0aW9uIHRvIHRoZSBjYW52YXMgb24gdGhlIG5leHQgcmVuZGVyIHBhc3MuCiAgLy8KICAvLyBAcGFyYW0ge3N0cmluZ30gbGF5ZXIgQSBzdHJpbmcgb2Ygc3BhY2Utc2VwYXJhdGVkIENTUyBjbGFzc2VzIHVuaXF1ZWx5CiAgLy8gICAgIGlkZW50aWZ5aW5nIHRoZSBsYXllciBjb250YWluaW5nIHRoaXMgdGV4dC4KICAvLyBAcGFyYW0ge251bWJlcn0geCBYIGNvb3JkaW5hdGUgYXQgd2hpY2ggdG8gZHJhdyB0aGUgdGV4dC4KICAvLyBAcGFyYW0ge251bWJlcn0geSBZIGNvb3JkaW5hdGUgYXQgd2hpY2ggdG8gZHJhdyB0aGUgdGV4dC4KICAvLyBAcGFyYW0ge3N0cmluZ30gdGV4dCBUZXh0IHN0cmluZyB0byBkcmF3LgogIC8vIEBwYXJhbSB7KHN0cmluZ3xvYmplY3QpPX0gZm9udCBFaXRoZXIgYSBzdHJpbmcgb2Ygc3BhY2Utc2VwYXJhdGVkIENTUwogIC8vICAgICBjbGFzc2VzIG9yIGEgZm9udC1zcGVjIG9iamVjdCwgZGVmaW5pbmcgdGhlIHRleHQncyBmb250IGFuZCBzdHlsZS4KICAvLyBAcGFyYW0ge251bWJlcj19IGFuZ2xlIEFuZ2xlIGF0IHdoaWNoIHRvIHJvdGF0ZSB0aGUgdGV4dCwgaW4gZGVncmVlcy4KICAvLyAgICAgQW5nbGUgaXMgY3VycmVudGx5IHVudXNlZCwgaXQgd2lsbCBiZSBpbXBsZW1lbnRlZCBpbiB0aGUgZnV0dXJlLgogIC8vIEBwYXJhbSB7bnVtYmVyPX0gd2lkdGggTWF4aW11bSB3aWR0aCBvZiB0aGUgdGV4dCBiZWZvcmUgaXQgd3JhcHMuCiAgLy8gQHBhcmFtIHtzdHJpbmc9fSBoYWxpZ24gSG9yaXpvbnRhbCBhbGlnbm1lbnQgb2YgdGhlIHRleHQ7IGVpdGhlciAibGVmdCIsCiAgLy8gICAgICJjZW50ZXIiIG9yICJyaWdodCIuCiAgLy8gQHBhcmFtIHtzdHJpbmc9fSB2YWxpZ24gVmVydGljYWwgYWxpZ25tZW50IG9mIHRoZSB0ZXh0OyBlaXRoZXIgInRvcCIsCiAgLy8gICAgICJtaWRkbGUiIG9yICJib3R0b20iLgoKCiAgQ2FudmFzLnByb3RvdHlwZS5hZGRUZXh0ID0gZnVuY3Rpb24gKGxheWVyLCB4LCB5LCB0ZXh0LCBmb250LCBhbmdsZSwgd2lkdGgsIGhhbGlnbiwgdmFsaWduKSB7CiAgICB2YXIgaW5mbyA9IHRoaXMuZ2V0VGV4dEluZm8obGF5ZXIsIHRleHQsIGZvbnQsIGFuZ2xlLCB3aWR0aCksCiAgICAgICAgcG9zaXRpb25zID0gaW5mby5wb3NpdGlvbnM7IC8vIFR3ZWFrIHRoZSBkaXYncyBwb3NpdGlvbiB0byBtYXRjaCB0aGUgdGV4dCdzIGFsaWdubWVudAoKICAgIGlmIChoYWxpZ24gPT0gImNlbnRlciIpIHsKICAgICAgeCAtPSBpbmZvLndpZHRoIC8gMjsKICAgIH0gZWxzZSBpZiAoaGFsaWduID09ICJyaWdodCIpIHsKICAgICAgeCAtPSBpbmZvLndpZHRoOwogICAgfQoKICAgIGlmICh2YWxpZ24gPT0gIm1pZGRsZSIpIHsKICAgICAgeSAtPSBpbmZvLmhlaWdodCAvIDI7CiAgICB9IGVsc2UgaWYgKHZhbGlnbiA9PSAiYm90dG9tIikgewogICAgICB5IC09IGluZm8uaGVpZ2h0OwogICAgfSAvLyBEZXRlcm1pbmUgd2hldGhlciB0aGlzIHRleHQgYWxyZWFkeSBleGlzdHMgYXQgdGhpcyBwb3NpdGlvbi4KICAgIC8vIElmIHNvLCBtYXJrIGl0IGZvciBpbmNsdXNpb24gaW4gdGhlIG5leHQgcmVuZGVyIHBhc3MuCgoKICAgIGZvciAodmFyIGkgPSAwLCBwb3NpdGlvbjsgcG9zaXRpb24gPSBwb3NpdGlvbnNbaV07IGkrKykgewogICAgICBpZiAocG9zaXRpb24ueCA9PSB4ICYmIHBvc2l0aW9uLnkgPT0geSkgewogICAgICAgIHBvc2l0aW9uLmFjdGl2ZSA9IHRydWU7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9IC8vIElmIHRoZSB0ZXh0IGRvZXNuJ3QgZXhpc3QgYXQgdGhpcyBwb3NpdGlvbiwgY3JlYXRlIGEgbmV3IGVudHJ5CiAgICAvLyBGb3IgdGhlIHZlcnkgZmlyc3QgcG9zaXRpb24gd2UnbGwgcmUtdXNlIHRoZSBvcmlnaW5hbCBlbGVtZW50LAogICAgLy8gd2hpbGUgZm9yIHN1YnNlcXVlbnQgb25lcyB3ZSdsbCBjbG9uZSBpdC4KCgogICAgcG9zaXRpb24gPSB7CiAgICAgIGFjdGl2ZTogdHJ1ZSwKICAgICAgcmVuZGVyZWQ6IGZhbHNlLAogICAgICBlbGVtZW50OiBwb3NpdGlvbnMubGVuZ3RoID8gaW5mby5lbGVtZW50LmNsb25lKCkgOiBpbmZvLmVsZW1lbnQsCiAgICAgIHg6IHgsCiAgICAgIHk6IHkKICAgIH07CiAgICBwb3NpdGlvbnMucHVzaChwb3NpdGlvbik7IC8vIE1vdmUgdGhlIGVsZW1lbnQgdG8gaXRzIGZpbmFsIHBvc2l0aW9uIHdpdGhpbiB0aGUgY29udGFpbmVyCgogICAgcG9zaXRpb24uZWxlbWVudC5jc3MoewogICAgICB0b3A6IE1hdGgucm91bmQoeSksCiAgICAgIGxlZnQ6IE1hdGgucm91bmQoeCksCiAgICAgICd0ZXh0LWFsaWduJzogaGFsaWduIC8vIEluIGNhc2UgdGhlIHRleHQgd3JhcHMKCiAgICB9KTsKICB9OyAvLyBSZW1vdmVzIG9uZSBvciBtb3JlIHRleHQgc3RyaW5ncyBmcm9tIHRoZSBjYW52YXMgdGV4dCBvdmVybGF5LgogIC8vCiAgLy8gSWYgbm8gcGFyYW1ldGVycyBhcmUgZ2l2ZW4sIGFsbCB0ZXh0IHdpdGhpbiB0aGUgbGF5ZXIgaXMgcmVtb3ZlZC4KICAvLwogIC8vIE5vdGUgdGhhdCB0aGUgdGV4dCBpcyBub3QgaW1tZWRpYXRlbHkgcmVtb3ZlZDsgaXQgaXMgc2ltcGx5IG1hcmtlZCBhcwogIC8vIGluYWN0aXZlLCB3aGljaCB3aWxsIHJlc3VsdCBpbiBpdHMgcmVtb3ZhbCBvbiB0aGUgbmV4dCByZW5kZXIgcGFzcy4KICAvLyBUaGlzIGF2b2lkcyB0aGUgcGVyZm9ybWFuY2UgcGVuYWx0eSBmb3IgJ2NsZWFyIGFuZCByZWRyYXcnIGJlaGF2aW9yLAogIC8vIHdoZXJlIHdlIHBvdGVudGlhbGx5IGdldCByaWQgb2YgYWxsIHRleHQgb24gYSBsYXllciwgYnV0IHdpbGwgbGlrZWx5CiAgLy8gYWRkIGJhY2sgbW9zdCBvciBhbGwgb2YgaXQgbGF0ZXIsIGFzIHdoZW4gcmVkcmF3aW5nIGF4ZXMsIGZvciBleGFtcGxlLgogIC8vCiAgLy8gQHBhcmFtIHtzdHJpbmd9IGxheWVyIEEgc3RyaW5nIG9mIHNwYWNlLXNlcGFyYXRlZCBDU1MgY2xhc3NlcyB1bmlxdWVseQogIC8vICAgICBpZGVudGlmeWluZyB0aGUgbGF5ZXIgY29udGFpbmluZyB0aGlzIHRleHQuCiAgLy8gQHBhcmFtIHtudW1iZXI9fSB4IFggY29vcmRpbmF0ZSBvZiB0aGUgdGV4dC4KICAvLyBAcGFyYW0ge251bWJlcj19IHkgWSBjb29yZGluYXRlIG9mIHRoZSB0ZXh0LgogIC8vIEBwYXJhbSB7c3RyaW5nPX0gdGV4dCBUZXh0IHN0cmluZyB0byByZW1vdmUuCiAgLy8gQHBhcmFtIHsoc3RyaW5nfG9iamVjdCk9fSBmb250IEVpdGhlciBhIHN0cmluZyBvZiBzcGFjZS1zZXBhcmF0ZWQgQ1NTCiAgLy8gICAgIGNsYXNzZXMgb3IgYSBmb250LXNwZWMgb2JqZWN0LCBkZWZpbmluZyB0aGUgdGV4dCdzIGZvbnQgYW5kIHN0eWxlLgogIC8vIEBwYXJhbSB7bnVtYmVyPX0gYW5nbGUgQW5nbGUgYXQgd2hpY2ggdGhlIHRleHQgaXMgcm90YXRlZCwgaW4gZGVncmVlcy4KICAvLyAgICAgQW5nbGUgaXMgY3VycmVudGx5IHVudXNlZCwgaXQgd2lsbCBiZSBpbXBsZW1lbnRlZCBpbiB0aGUgZnV0dXJlLgoKCiAgQ2FudmFzLnByb3RvdHlwZS5yZW1vdmVUZXh0ID0gZnVuY3Rpb24gKGxheWVyLCB4LCB5LCB0ZXh0LCBmb250LCBhbmdsZSkgewogICAgaWYgKHRleHQgPT0gbnVsbCkgewogICAgICB2YXIgbGF5ZXJDYWNoZSA9IHRoaXMuX3RleHRDYWNoZVtsYXllcl07CgogICAgICBpZiAobGF5ZXJDYWNoZSAhPSBudWxsKSB7CiAgICAgICAgZm9yICh2YXIgc3R5bGVLZXkgaW4gbGF5ZXJDYWNoZSkgewogICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwobGF5ZXJDYWNoZSwgc3R5bGVLZXkpKSB7CiAgICAgICAgICAgIHZhciBzdHlsZUNhY2hlID0gbGF5ZXJDYWNoZVtzdHlsZUtleV07CgogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gc3R5bGVDYWNoZSkgewogICAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHN0eWxlQ2FjaGUsIGtleSkpIHsKICAgICAgICAgICAgICAgIHZhciBwb3NpdGlvbnMgPSBzdHlsZUNhY2hlW2tleV0ucG9zaXRpb25zOwoKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBwb3NpdGlvbjsgcG9zaXRpb24gPSBwb3NpdGlvbnNbaV07IGkrKykgewogICAgICAgICAgICAgICAgICBwb3NpdGlvbi5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHZhciBwb3NpdGlvbnMgPSB0aGlzLmdldFRleHRJbmZvKGxheWVyLCB0ZXh0LCBmb250LCBhbmdsZSkucG9zaXRpb25zOwoKICAgICAgZm9yICh2YXIgaSA9IDAsIHBvc2l0aW9uOyBwb3NpdGlvbiA9IHBvc2l0aW9uc1tpXTsgaSsrKSB7CiAgICAgICAgaWYgKHBvc2l0aW9uLnggPT0geCAmJiBwb3NpdGlvbi55ID09IHkpIHsKICAgICAgICAgIHBvc2l0aW9uLmFjdGl2ZSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH07IC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogIC8vIFRoZSB0b3AtbGV2ZWwgY29udGFpbmVyIGZvciB0aGUgZW50aXJlIHBsb3QuCgoKICBmdW5jdGlvbiBQbG90KHBsYWNlaG9sZGVyLCBkYXRhXywgb3B0aW9uc18sIHBsdWdpbnMpIHsKICAgIC8vIGRhdGEgaXMgb24gdGhlIGZvcm06CiAgICAvLyAgIFsgc2VyaWVzMSwgc2VyaWVzMiAuLi4gXQogICAgLy8gd2hlcmUgc2VyaWVzIGlzIGVpdGhlciBqdXN0IHRoZSBkYXRhIGFzIFsgW3gxLCB5MV0sIFt4MiwgeTJdLCAuLi4gXQogICAgLy8gb3IgeyBkYXRhOiBbIFt4MSwgeTFdLCBbeDIsIHkyXSwgLi4uIF0sIGxhYmVsOiAic29tZSBsYWJlbCIsIC4uLiB9CiAgICB2YXIgc2VyaWVzID0gW10sCiAgICAgICAgb3B0aW9ucyA9IHsKICAgICAgLy8gdGhlIGNvbG9yIHRoZW1lIHVzZWQgZm9yIGdyYXBocwogICAgICBjb2xvcnM6IFsiI2VkYzI0MCIsICIjYWZkOGY4IiwgIiNjYjRiNGIiLCAiIzRkYTc0ZCIsICIjOTQ0MGVkIl0sCiAgICAgIGxlZ2VuZDogewogICAgICAgIHNob3c6IHRydWUsCiAgICAgICAgbm9Db2x1bW5zOiAxLAogICAgICAgIC8vIG51bWJlciBvZiBjb2x1bXMgaW4gbGVnZW5kIHRhYmxlCiAgICAgICAgbGFiZWxGb3JtYXR0ZXI6IG51bGwsCiAgICAgICAgLy8gZm46IHN0cmluZyAtPiBzdHJpbmcKICAgICAgICBsYWJlbEJveEJvcmRlckNvbG9yOiAiI2NjYyIsCiAgICAgICAgLy8gYm9yZGVyIGNvbG9yIGZvciB0aGUgbGl0dGxlIGxhYmVsIGJveGVzCiAgICAgICAgY29udGFpbmVyOiBudWxsLAogICAgICAgIC8vIGNvbnRhaW5lciAoYXMgalF1ZXJ5IG9iamVjdCkgdG8gcHV0IGxlZ2VuZCBpbiwgbnVsbCBtZWFucyBkZWZhdWx0IG9uIHRvcCBvZiBncmFwaAogICAgICAgIHBvc2l0aW9uOiAibmUiLAogICAgICAgIC8vIHBvc2l0aW9uIG9mIGRlZmF1bHQgbGVnZW5kIGNvbnRhaW5lciB3aXRoaW4gcGxvdAogICAgICAgIG1hcmdpbjogNSwKICAgICAgICAvLyBkaXN0YW5jZSBmcm9tIGdyaWQgZWRnZSB0byBkZWZhdWx0IGxlZ2VuZCBjb250YWluZXIgd2l0aGluIHBsb3QKICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IG51bGwsCiAgICAgICAgLy8gbnVsbCBtZWFucyBhdXRvLWRldGVjdAogICAgICAgIGJhY2tncm91bmRPcGFjaXR5OiAwLjg1LAogICAgICAgIC8vIHNldCB0byAwIHRvIGF2b2lkIGJhY2tncm91bmQKICAgICAgICBzb3J0ZWQ6IG51bGwgLy8gZGVmYXVsdCB0byBubyBsZWdlbmQgc29ydGluZwoKICAgICAgfSwKICAgICAgeGF4aXM6IHsKICAgICAgICBzaG93OiBudWxsLAogICAgICAgIC8vIG51bGwgPSBhdXRvLWRldGVjdCwgdHJ1ZSA9IGFsd2F5cywgZmFsc2UgPSBuZXZlcgogICAgICAgIHBvc2l0aW9uOiAiYm90dG9tIiwKICAgICAgICAvLyBvciAidG9wIgogICAgICAgIG1vZGU6IG51bGwsCiAgICAgICAgLy8gbnVsbCBvciAidGltZSIKICAgICAgICBmb250OiBudWxsLAogICAgICAgIC8vIG51bGwgKGRlcml2ZWQgZnJvbSBDU1MgaW4gcGxhY2Vob2xkZXIpIG9yIG9iamVjdCBsaWtlIHsgc2l6ZTogMTEsIGxpbmVIZWlnaHQ6IDEzLCBzdHlsZTogIml0YWxpYyIsIHdlaWdodDogImJvbGQiLCBmYW1pbHk6ICJzYW5zLXNlcmlmIiwgdmFyaWFudDogInNtYWxsLWNhcHMiIH0KICAgICAgICBjb2xvcjogbnVsbCwKICAgICAgICAvLyBiYXNlIGNvbG9yLCBsYWJlbHMsIHRpY2tzCiAgICAgICAgdGlja0NvbG9yOiBudWxsLAogICAgICAgIC8vIHBvc3NpYmx5IGRpZmZlcmVudCBjb2xvciBvZiB0aWNrcywgZS5nLiAicmdiYSgwLDAsMCwwLjE1KSIKICAgICAgICB0cmFuc2Zvcm06IG51bGwsCiAgICAgICAgLy8gbnVsbCBvciBmOiBudW1iZXIgLT4gbnVtYmVyIHRvIHRyYW5zZm9ybSBheGlzCiAgICAgICAgaW52ZXJzZVRyYW5zZm9ybTogbnVsbCwKICAgICAgICAvLyBpZiB0cmFuc2Zvcm0gaXMgc2V0LCB0aGlzIHNob3VsZCBiZSB0aGUgaW52ZXJzZSBmdW5jdGlvbgogICAgICAgIG1pbjogbnVsbCwKICAgICAgICAvLyBtaW4uIHZhbHVlIHRvIHNob3csIG51bGwgbWVhbnMgc2V0IGF1dG9tYXRpY2FsbHkKICAgICAgICBtYXg6IG51bGwsCiAgICAgICAgLy8gbWF4LiB2YWx1ZSB0byBzaG93LCBudWxsIG1lYW5zIHNldCBhdXRvbWF0aWNhbGx5CiAgICAgICAgYXV0b3NjYWxlTWFyZ2luOiBudWxsLAogICAgICAgIC8vIG1hcmdpbiBpbiAlIHRvIGFkZCBpZiBhdXRvLXNldHRpbmcgbWluL21heAogICAgICAgIHRpY2tzOiBudWxsLAogICAgICAgIC8vIGVpdGhlciBbMSwgM10gb3IgW1sxLCAiYSJdLCAzXSBvciAoZm46IGF4aXMgaW5mbyAtPiB0aWNrcykgb3IgYXBwLiBudW1iZXIgb2YgdGlja3MgZm9yIGF1dG8tdGlja3MKICAgICAgICB0aWNrRm9ybWF0dGVyOiBudWxsLAogICAgICAgIC8vIGZuOiBudW1iZXIgLT4gc3RyaW5nCiAgICAgICAgbGFiZWxXaWR0aDogbnVsbCwKICAgICAgICAvLyBzaXplIG9mIHRpY2sgbGFiZWxzIGluIHBpeGVscwogICAgICAgIGxhYmVsSGVpZ2h0OiBudWxsLAogICAgICAgIHJlc2VydmVTcGFjZTogbnVsbCwKICAgICAgICAvLyB3aGV0aGVyIHRvIHJlc2VydmUgc3BhY2UgZXZlbiBpZiBheGlzIGlzbid0IHNob3duCiAgICAgICAgdGlja0xlbmd0aDogbnVsbCwKICAgICAgICAvLyBzaXplIGluIHBpeGVscyBvZiB0aWNrcywgb3IgImZ1bGwiIGZvciB3aG9sZSBsaW5lCiAgICAgICAgYWxpZ25UaWNrc1dpdGhBeGlzOiBudWxsLAogICAgICAgIC8vIGF4aXMgbnVtYmVyIG9yIG51bGwgZm9yIG5vIHN5bmMKICAgICAgICB0aWNrRGVjaW1hbHM6IG51bGwsCiAgICAgICAgLy8gbm8uIG9mIGRlY2ltYWxzLCBudWxsIG1lYW5zIGF1dG8KICAgICAgICB0aWNrU2l6ZTogbnVsbCwKICAgICAgICAvLyBudW1iZXIgb3IgW251bWJlciwgInVuaXQiXQogICAgICAgIG1pblRpY2tTaXplOiBudWxsIC8vIG51bWJlciBvciBbbnVtYmVyLCAidW5pdCJdCgogICAgICB9LAogICAgICB5YXhpczogewogICAgICAgIGF1dG9zY2FsZU1hcmdpbjogMC4wMiwKICAgICAgICBwb3NpdGlvbjogImxlZnQiIC8vIG9yICJyaWdodCIKCiAgICAgIH0sCiAgICAgIHhheGVzOiBbXSwKICAgICAgeWF4ZXM6IFtdLAogICAgICBzZXJpZXM6IHsKICAgICAgICBwb2ludHM6IHsKICAgICAgICAgIHNob3c6IGZhbHNlLAogICAgICAgICAgcmFkaXVzOiAzLAogICAgICAgICAgbGluZVdpZHRoOiAyLAogICAgICAgICAgLy8gaW4gcGl4ZWxzCiAgICAgICAgICBmaWxsOiB0cnVlLAogICAgICAgICAgZmlsbENvbG9yOiAiI2ZmZmZmZiIsCiAgICAgICAgICBzeW1ib2w6ICJjaXJjbGUiIC8vIG9yIGNhbGxiYWNrCgogICAgICAgIH0sCiAgICAgICAgbGluZXM6IHsKICAgICAgICAgIC8vIHdlIGRvbid0IHB1dCBpbiBzaG93OiBmYWxzZSBzbyB3ZSBjYW4gc2VlCiAgICAgICAgICAvLyB3aGV0aGVyIGxpbmVzIHdlcmUgYWN0aXZlbHkgZGlzYWJsZWQKICAgICAgICAgIGxpbmVXaWR0aDogMiwKICAgICAgICAgIC8vIGluIHBpeGVscwogICAgICAgICAgZmlsbDogZmFsc2UsCiAgICAgICAgICBmaWxsQ29sb3I6IG51bGwsCiAgICAgICAgICBzdGVwczogZmFsc2UgLy8gT21pdCAnemVybycsIHNvIHdlIGNhbiBsYXRlciBkZWZhdWx0IGl0cyB2YWx1ZSB0bwogICAgICAgICAgLy8gbWF0Y2ggdGhhdCBvZiB0aGUgJ2ZpbGwnIG9wdGlvbi4KCiAgICAgICAgfSwKICAgICAgICBiYXJzOiB7CiAgICAgICAgICBzaG93OiBmYWxzZSwKICAgICAgICAgIGxpbmVXaWR0aDogMiwKICAgICAgICAgIC8vIGluIHBpeGVscwogICAgICAgICAgYmFyV2lkdGg6IDEsCiAgICAgICAgICAvLyBpbiB1bml0cyBvZiB0aGUgeCBheGlzCiAgICAgICAgICBmaWxsOiB0cnVlLAogICAgICAgICAgZmlsbENvbG9yOiBudWxsLAogICAgICAgICAgYWxpZ246ICJsZWZ0IiwKICAgICAgICAgIC8vICJsZWZ0IiwgInJpZ2h0Iiwgb3IgImNlbnRlciIKICAgICAgICAgIGhvcml6b250YWw6IGZhbHNlLAogICAgICAgICAgemVybzogdHJ1ZQogICAgICAgIH0sCiAgICAgICAgc2hhZG93U2l6ZTogMywKICAgICAgICBoaWdobGlnaHRDb2xvcjogbnVsbAogICAgICB9LAogICAgICBncmlkOiB7CiAgICAgICAgc2hvdzogdHJ1ZSwKICAgICAgICBhYm92ZURhdGE6IGZhbHNlLAogICAgICAgIGNvbG9yOiAiIzU0NTQ1NCIsCiAgICAgICAgLy8gcHJpbWFyeSBjb2xvciB1c2VkIGZvciBvdXRsaW5lIGFuZCBsYWJlbHMKICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IG51bGwsCiAgICAgICAgLy8gbnVsbCBmb3IgdHJhbnNwYXJlbnQsIGVsc2UgY29sb3IKICAgICAgICBib3JkZXJDb2xvcjogbnVsbCwKICAgICAgICAvLyBzZXQgaWYgZGlmZmVyZW50IGZyb20gdGhlIGdyaWQgY29sb3IKICAgICAgICB0aWNrQ29sb3I6IG51bGwsCiAgICAgICAgLy8gY29sb3IgZm9yIHRoZSB0aWNrcywgZS5nLiAicmdiYSgwLDAsMCwwLjE1KSIKICAgICAgICBtYXJnaW46IDAsCiAgICAgICAgLy8gZGlzdGFuY2UgZnJvbSB0aGUgY2FudmFzIGVkZ2UgdG8gdGhlIGdyaWQKICAgICAgICBsYWJlbE1hcmdpbjogNSwKICAgICAgICAvLyBpbiBwaXhlbHMKICAgICAgICBheGlzTWFyZ2luOiA4LAogICAgICAgIC8vIGluIHBpeGVscwogICAgICAgIGJvcmRlcldpZHRoOiAyLAogICAgICAgIC8vIGluIHBpeGVscwogICAgICAgIG1pbkJvcmRlck1hcmdpbjogbnVsbCwKICAgICAgICAvLyBpbiBwaXhlbHMsIG51bGwgbWVhbnMgdGFrZW4gZnJvbSBwb2ludHMgcmFkaXVzCiAgICAgICAgbWFya2luZ3M6IG51bGwsCiAgICAgICAgLy8gYXJyYXkgb2YgcmFuZ2VzIG9yIGZuOiBheGVzIC0+IGFycmF5IG9mIHJhbmdlcwogICAgICAgIG1hcmtpbmdzQ29sb3I6ICIjZjRmNGY0IiwKICAgICAgICBtYXJraW5nc0xpbmVXaWR0aDogMiwKICAgICAgICAvLyBpbnRlcmFjdGl2ZSBzdHVmZgogICAgICAgIGNsaWNrYWJsZTogZmFsc2UsCiAgICAgICAgaG92ZXJhYmxlOiBmYWxzZSwKICAgICAgICBhdXRvSGlnaGxpZ2h0OiB0cnVlLAogICAgICAgIC8vIGhpZ2hsaWdodCBpbiBjYXNlIG1vdXNlIGlzIG5lYXIKICAgICAgICBtb3VzZUFjdGl2ZVJhZGl1czogMTAgLy8gaG93IGZhciB0aGUgbW91c2UgY2FuIGJlIGF3YXkgdG8gYWN0aXZhdGUgYW4gaXRlbQoKICAgICAgfSwKICAgICAgaW50ZXJhY3Rpb246IHsKICAgICAgICByZWRyYXdPdmVybGF5SW50ZXJ2YWw6IDEwMDAgLyA2MCAvLyB0aW1lIGJldHdlZW4gdXBkYXRlcywgLTEgbWVhbnMgaW4gc2FtZSBmbG93CgogICAgICB9LAogICAgICBob29rczoge30KICAgIH0sCiAgICAgICAgc3VyZmFjZSA9IG51bGwsCiAgICAgICAgLy8gdGhlIGNhbnZhcyBmb3IgdGhlIHBsb3QgaXRzZWxmCiAgICBvdmVybGF5ID0gbnVsbCwKICAgICAgICAvLyBjYW52YXMgZm9yIGludGVyYWN0aXZlIHN0dWZmIG9uIHRvcCBvZiBwbG90CiAgICBldmVudEhvbGRlciA9IG51bGwsCiAgICAgICAgLy8galF1ZXJ5IG9iamVjdCB0aGF0IGV2ZW50cyBzaG91bGQgYmUgYm91bmQgdG8KICAgIGN0eCA9IG51bGwsCiAgICAgICAgb2N0eCA9IG51bGwsCiAgICAgICAgeGF4ZXMgPSBbXSwKICAgICAgICB5YXhlcyA9IFtdLAogICAgICAgIHBsb3RPZmZzZXQgPSB7CiAgICAgIGxlZnQ6IDAsCiAgICAgIHJpZ2h0OiAwLAogICAgICB0b3A6IDAsCiAgICAgIGJvdHRvbTogMAogICAgfSwKICAgICAgICBwbG90V2lkdGggPSAwLAogICAgICAgIHBsb3RIZWlnaHQgPSAwLAogICAgICAgIGhvb2tzID0gewogICAgICBwcm9jZXNzT3B0aW9uczogW10sCiAgICAgIHByb2Nlc3NSYXdEYXRhOiBbXSwKICAgICAgcHJvY2Vzc0RhdGFwb2ludHM6IFtdLAogICAgICBwcm9jZXNzT2Zmc2V0OiBbXSwKICAgICAgZHJhd0JhY2tncm91bmQ6IFtdLAogICAgICBkcmF3U2VyaWVzOiBbXSwKICAgICAgZHJhdzogW10sCiAgICAgIGJpbmRFdmVudHM6IFtdLAogICAgICBkcmF3T3ZlcmxheTogW10sCiAgICAgIHNodXRkb3duOiBbXQogICAgfSwKICAgICAgICBwbG90ID0gdGhpczsgLy8gcHVibGljIGZ1bmN0aW9ucwoKICAgIHBsb3Quc2V0RGF0YSA9IHNldERhdGE7CiAgICBwbG90LnNldHVwR3JpZCA9IHNldHVwR3JpZDsKICAgIHBsb3QuZHJhdyA9IGRyYXc7CgogICAgcGxvdC5nZXRQbGFjZWhvbGRlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHBsYWNlaG9sZGVyOwogICAgfTsKCiAgICBwbG90LmdldENhbnZhcyA9IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHN1cmZhY2UuZWxlbWVudDsKICAgIH07CgogICAgcGxvdC5nZXRQbG90T2Zmc2V0ID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gcGxvdE9mZnNldDsKICAgIH07CgogICAgcGxvdC53aWR0aCA9IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHBsb3RXaWR0aDsKICAgIH07CgogICAgcGxvdC5oZWlnaHQgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBwbG90SGVpZ2h0OwogICAgfTsKCiAgICBwbG90Lm9mZnNldCA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIG8gPSBldmVudEhvbGRlci5vZmZzZXQoKTsKICAgICAgby5sZWZ0ICs9IHBsb3RPZmZzZXQubGVmdDsKICAgICAgby50b3AgKz0gcGxvdE9mZnNldC50b3A7CiAgICAgIHJldHVybiBvOwogICAgfTsKCiAgICBwbG90LmdldERhdGEgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBzZXJpZXM7CiAgICB9OwoKICAgIHBsb3QuZ2V0QXhlcyA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHJlcyA9IHt9LAogICAgICAgICAgaTsKICAgICAgJC5lYWNoKHhheGVzLmNvbmNhdCh5YXhlcyksIGZ1bmN0aW9uIChfLCBheGlzKSB7CiAgICAgICAgaWYgKGF4aXMpIHJlc1theGlzLmRpcmVjdGlvbiArIChheGlzLm4gIT0gMSA/IGF4aXMubiA6ICIiKSArICJheGlzIl0gPSBheGlzOwogICAgICB9KTsKICAgICAgcmV0dXJuIHJlczsKICAgIH07CgogICAgcGxvdC5nZXRYQXhlcyA9IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHhheGVzOwogICAgfTsKCiAgICBwbG90LmdldFlBeGVzID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4geWF4ZXM7CiAgICB9OwoKICAgIHBsb3QuYzJwID0gY2FudmFzVG9BeGlzQ29vcmRzOwogICAgcGxvdC5wMmMgPSBheGlzVG9DYW52YXNDb29yZHM7CgogICAgcGxvdC5nZXRPcHRpb25zID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gb3B0aW9uczsKICAgIH07CgogICAgcGxvdC5oaWdobGlnaHQgPSBoaWdobGlnaHQ7CiAgICBwbG90LnVuaGlnaGxpZ2h0ID0gdW5oaWdobGlnaHQ7CiAgICBwbG90LnRyaWdnZXJSZWRyYXdPdmVybGF5ID0gdHJpZ2dlclJlZHJhd092ZXJsYXk7CgogICAgcGxvdC5wb2ludE9mZnNldCA9IGZ1bmN0aW9uIChwb2ludCkgewogICAgICByZXR1cm4gewogICAgICAgIGxlZnQ6IHBhcnNlSW50KHhheGVzW2F4aXNOdW1iZXIocG9pbnQsICJ4IikgLSAxXS5wMmMoK3BvaW50LngpICsgcGxvdE9mZnNldC5sZWZ0LCAxMCksCiAgICAgICAgdG9wOiBwYXJzZUludCh5YXhlc1theGlzTnVtYmVyKHBvaW50LCAieSIpIC0gMV0ucDJjKCtwb2ludC55KSArIHBsb3RPZmZzZXQudG9wLCAxMCkKICAgICAgfTsKICAgIH07CgogICAgcGxvdC5zaHV0ZG93biA9IHNodXRkb3duOwoKICAgIHBsb3QuZGVzdHJveSA9IGZ1bmN0aW9uICgpIHsKICAgICAgc2h1dGRvd24oKTsKICAgICAgcGxhY2Vob2xkZXIucmVtb3ZlRGF0YSgicGxvdCIpLmVtcHR5KCk7CiAgICAgIHNlcmllcyA9IFtdOwogICAgICBvcHRpb25zID0gbnVsbDsKICAgICAgc3VyZmFjZSA9IG51bGw7CiAgICAgIG92ZXJsYXkgPSBudWxsOwogICAgICBldmVudEhvbGRlciA9IG51bGw7CiAgICAgIGN0eCA9IG51bGw7CiAgICAgIG9jdHggPSBudWxsOwogICAgICB4YXhlcyA9IFtdOwogICAgICB5YXhlcyA9IFtdOwogICAgICBob29rcyA9IG51bGw7CiAgICAgIGhpZ2hsaWdodHMgPSBbXTsKICAgICAgcGxvdCA9IG51bGw7CiAgICB9OwoKICAgIHBsb3QucmVzaXplID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgd2lkdGggPSBwbGFjZWhvbGRlci53aWR0aCgpLAogICAgICAgICAgaGVpZ2h0ID0gcGxhY2Vob2xkZXIuaGVpZ2h0KCk7CiAgICAgIHN1cmZhY2UucmVzaXplKHdpZHRoLCBoZWlnaHQpOwogICAgICBvdmVybGF5LnJlc2l6ZSh3aWR0aCwgaGVpZ2h0KTsKICAgIH07IC8vIHB1YmxpYyBhdHRyaWJ1dGVzCgoKICAgIHBsb3QuaG9va3MgPSBob29rczsgLy8gaW5pdGlhbGl6ZQoKICAgIGluaXRQbHVnaW5zKHBsb3QpOwogICAgcGFyc2VPcHRpb25zKG9wdGlvbnNfKTsKICAgIHNldHVwQ2FudmFzZXMoKTsKICAgIHNldERhdGEoZGF0YV8pOwogICAgc2V0dXBHcmlkKCk7CiAgICBkcmF3KCk7CiAgICBiaW5kRXZlbnRzKCk7CgogICAgZnVuY3Rpb24gZXhlY3V0ZUhvb2tzKGhvb2ssIGFyZ3MpIHsKICAgICAgYXJncyA9IFtwbG90XS5jb25jYXQoYXJncyk7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGhvb2subGVuZ3RoOyArK2kpIHsKICAgICAgICBob29rW2ldLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gaW5pdFBsdWdpbnMoKSB7CiAgICAgIC8vIFJlZmVyZW5jZXMgdG8ga2V5IGNsYXNzZXMsIGFsbG93aW5nIHBsdWdpbnMgdG8gbW9kaWZ5IHRoZW0KICAgICAgdmFyIGNsYXNzZXMgPSB7CiAgICAgICAgQ2FudmFzOiBDYW52YXMKICAgICAgfTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGx1Z2lucy5sZW5ndGg7ICsraSkgewogICAgICAgIHZhciBwID0gcGx1Z2luc1tpXTsKICAgICAgICBwLmluaXQocGxvdCwgY2xhc3Nlcyk7CiAgICAgICAgaWYgKHAub3B0aW9ucykgJC5leHRlbmQodHJ1ZSwgb3B0aW9ucywgcC5vcHRpb25zKTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHBhcnNlT3B0aW9ucyhvcHRzKSB7CiAgICAgICQuZXh0ZW5kKHRydWUsIG9wdGlvbnMsIG9wdHMpOyAvLyAkLmV4dGVuZCBtZXJnZXMgYXJyYXlzLCByYXRoZXIgdGhhbiByZXBsYWNpbmcgdGhlbS4gIFdoZW4gbGVzcwogICAgICAvLyBjb2xvcnMgYXJlIHByb3ZpZGVkIHRoYW4gdGhlIHNpemUgb2YgdGhlIGRlZmF1bHQgcGFsZXR0ZSwgd2UKICAgICAgLy8gZW5kIHVwIHdpdGggdGhvc2UgY29sb3JzIHBsdXMgdGhlIHJlbWFpbmluZyBkZWZhdWx0cywgd2hpY2ggaXMKICAgICAgLy8gbm90IGV4cGVjdGVkIGJlaGF2aW9yOyBhdm9pZCBpdCBieSByZXBsYWNpbmcgdGhlbSBoZXJlLgoKICAgICAgaWYgKG9wdHMgJiYgb3B0cy5jb2xvcnMpIHsKICAgICAgICBvcHRpb25zLmNvbG9ycyA9IG9wdHMuY29sb3JzOwogICAgICB9CgogICAgICBpZiAob3B0aW9ucy54YXhpcy5jb2xvciA9PSBudWxsKSBvcHRpb25zLnhheGlzLmNvbG9yID0gJC5jb2xvci5wYXJzZShvcHRpb25zLmdyaWQuY29sb3IpLnNjYWxlKCdhJywgMC4yMikudG9TdHJpbmcoKTsKICAgICAgaWYgKG9wdGlvbnMueWF4aXMuY29sb3IgPT0gbnVsbCkgb3B0aW9ucy55YXhpcy5jb2xvciA9ICQuY29sb3IucGFyc2Uob3B0aW9ucy5ncmlkLmNvbG9yKS5zY2FsZSgnYScsIDAuMjIpLnRvU3RyaW5nKCk7CiAgICAgIGlmIChvcHRpb25zLnhheGlzLnRpY2tDb2xvciA9PSBudWxsKSAvLyBncmlkLnRpY2tDb2xvciBmb3IgYmFjay1jb21wYXRpYmlsaXR5CiAgICAgICAgb3B0aW9ucy54YXhpcy50aWNrQ29sb3IgPSBvcHRpb25zLmdyaWQudGlja0NvbG9yIHx8IG9wdGlvbnMueGF4aXMuY29sb3I7CiAgICAgIGlmIChvcHRpb25zLnlheGlzLnRpY2tDb2xvciA9PSBudWxsKSAvLyBncmlkLnRpY2tDb2xvciBmb3IgYmFjay1jb21wYXRpYmlsaXR5CiAgICAgICAgb3B0aW9ucy55YXhpcy50aWNrQ29sb3IgPSBvcHRpb25zLmdyaWQudGlja0NvbG9yIHx8IG9wdGlvbnMueWF4aXMuY29sb3I7CiAgICAgIGlmIChvcHRpb25zLmdyaWQuYm9yZGVyQ29sb3IgPT0gbnVsbCkgb3B0aW9ucy5ncmlkLmJvcmRlckNvbG9yID0gb3B0aW9ucy5ncmlkLmNvbG9yOwogICAgICBpZiAob3B0aW9ucy5ncmlkLnRpY2tDb2xvciA9PSBudWxsKSBvcHRpb25zLmdyaWQudGlja0NvbG9yID0gJC5jb2xvci5wYXJzZShvcHRpb25zLmdyaWQuY29sb3IpLnNjYWxlKCdhJywgMC4yMikudG9TdHJpbmcoKTsgLy8gRmlsbCBpbiBkZWZhdWx0cyBmb3IgYXhpcyBvcHRpb25zLCBpbmNsdWRpbmcgYW55IHVuc3BlY2lmaWVkCiAgICAgIC8vIGZvbnQtc3BlYyBmaWVsZHMsIGlmIGEgZm9udC1zcGVjIHdhcyBwcm92aWRlZC4KICAgICAgLy8gSWYgbm8geC95IGF4aXMgb3B0aW9ucyB3ZXJlIHByb3ZpZGVkLCBjcmVhdGUgb25lIG9mIGVhY2ggYW55d2F5LAogICAgICAvLyBzaW5jZSB0aGUgcmVzdCBvZiB0aGUgY29kZSBhc3N1bWVzIHRoYXQgdGhleSBleGlzdC4KCiAgICAgIHZhciBpLAogICAgICAgICAgYXhpc09wdGlvbnMsCiAgICAgICAgICBheGlzQ291bnQsCiAgICAgICAgICBmb250U2l6ZSA9IHBsYWNlaG9sZGVyLmNzcygiZm9udC1zaXplIiksCiAgICAgICAgICBmb250U2l6ZURlZmF1bHQgPSBmb250U2l6ZSA/ICtmb250U2l6ZS5yZXBsYWNlKCJweCIsICIiKSA6IDEzLAogICAgICAgICAgZm9udERlZmF1bHRzID0gewogICAgICAgIHN0eWxlOiBwbGFjZWhvbGRlci5jc3MoImZvbnQtc3R5bGUiKSwKICAgICAgICBzaXplOiBNYXRoLnJvdW5kKDAuOCAqIGZvbnRTaXplRGVmYXVsdCksCiAgICAgICAgdmFyaWFudDogcGxhY2Vob2xkZXIuY3NzKCJmb250LXZhcmlhbnQiKSwKICAgICAgICB3ZWlnaHQ6IHBsYWNlaG9sZGVyLmNzcygiZm9udC13ZWlnaHQiKSwKICAgICAgICBmYW1pbHk6IHBsYWNlaG9sZGVyLmNzcygiZm9udC1mYW1pbHkiKQogICAgICB9OwogICAgICBheGlzQ291bnQgPSBvcHRpb25zLnhheGVzLmxlbmd0aCB8fCAxOwoKICAgICAgZm9yIChpID0gMDsgaSA8IGF4aXNDb3VudDsgKytpKSB7CiAgICAgICAgYXhpc09wdGlvbnMgPSBvcHRpb25zLnhheGVzW2ldOwoKICAgICAgICBpZiAoYXhpc09wdGlvbnMgJiYgIWF4aXNPcHRpb25zLnRpY2tDb2xvcikgewogICAgICAgICAgYXhpc09wdGlvbnMudGlja0NvbG9yID0gYXhpc09wdGlvbnMuY29sb3I7CiAgICAgICAgfQoKICAgICAgICBheGlzT3B0aW9ucyA9ICQuZXh0ZW5kKHRydWUsIHt9LCBvcHRpb25zLnhheGlzLCBheGlzT3B0aW9ucyk7CiAgICAgICAgb3B0aW9ucy54YXhlc1tpXSA9IGF4aXNPcHRpb25zOwoKICAgICAgICBpZiAoYXhpc09wdGlvbnMuZm9udCkgewogICAgICAgICAgYXhpc09wdGlvbnMuZm9udCA9ICQuZXh0ZW5kKHt9LCBmb250RGVmYXVsdHMsIGF4aXNPcHRpb25zLmZvbnQpOwoKICAgICAgICAgIGlmICghYXhpc09wdGlvbnMuZm9udC5jb2xvcikgewogICAgICAgICAgICBheGlzT3B0aW9ucy5mb250LmNvbG9yID0gYXhpc09wdGlvbnMuY29sb3I7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKCFheGlzT3B0aW9ucy5mb250LmxpbmVIZWlnaHQpIHsKICAgICAgICAgICAgYXhpc09wdGlvbnMuZm9udC5saW5lSGVpZ2h0ID0gTWF0aC5yb3VuZChheGlzT3B0aW9ucy5mb250LnNpemUgKiAxLjE1KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGF4aXNDb3VudCA9IG9wdGlvbnMueWF4ZXMubGVuZ3RoIHx8IDE7CgogICAgICBmb3IgKGkgPSAwOyBpIDwgYXhpc0NvdW50OyArK2kpIHsKICAgICAgICBheGlzT3B0aW9ucyA9IG9wdGlvbnMueWF4ZXNbaV07CgogICAgICAgIGlmIChheGlzT3B0aW9ucyAmJiAhYXhpc09wdGlvbnMudGlja0NvbG9yKSB7CiAgICAgICAgICBheGlzT3B0aW9ucy50aWNrQ29sb3IgPSBheGlzT3B0aW9ucy5jb2xvcjsKICAgICAgICB9CgogICAgICAgIGF4aXNPcHRpb25zID0gJC5leHRlbmQodHJ1ZSwge30sIG9wdGlvbnMueWF4aXMsIGF4aXNPcHRpb25zKTsKICAgICAgICBvcHRpb25zLnlheGVzW2ldID0gYXhpc09wdGlvbnM7CgogICAgICAgIGlmIChheGlzT3B0aW9ucy5mb250KSB7CiAgICAgICAgICBheGlzT3B0aW9ucy5mb250ID0gJC5leHRlbmQoe30sIGZvbnREZWZhdWx0cywgYXhpc09wdGlvbnMuZm9udCk7CgogICAgICAgICAgaWYgKCFheGlzT3B0aW9ucy5mb250LmNvbG9yKSB7CiAgICAgICAgICAgIGF4aXNPcHRpb25zLmZvbnQuY29sb3IgPSBheGlzT3B0aW9ucy5jb2xvcjsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoIWF4aXNPcHRpb25zLmZvbnQubGluZUhlaWdodCkgewogICAgICAgICAgICBheGlzT3B0aW9ucy5mb250LmxpbmVIZWlnaHQgPSBNYXRoLnJvdW5kKGF4aXNPcHRpb25zLmZvbnQuc2l6ZSAqIDEuMTUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSAvLyBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eSwgdG8gYmUgcmVtb3ZlZCBpbiBmdXR1cmUKCgogICAgICBpZiAob3B0aW9ucy54YXhpcy5ub1RpY2tzICYmIG9wdGlvbnMueGF4aXMudGlja3MgPT0gbnVsbCkgb3B0aW9ucy54YXhpcy50aWNrcyA9IG9wdGlvbnMueGF4aXMubm9UaWNrczsKICAgICAgaWYgKG9wdGlvbnMueWF4aXMubm9UaWNrcyAmJiBvcHRpb25zLnlheGlzLnRpY2tzID09IG51bGwpIG9wdGlvbnMueWF4aXMudGlja3MgPSBvcHRpb25zLnlheGlzLm5vVGlja3M7CgogICAgICBpZiAob3B0aW9ucy54MmF4aXMpIHsKICAgICAgICBvcHRpb25zLnhheGVzWzFdID0gJC5leHRlbmQodHJ1ZSwge30sIG9wdGlvbnMueGF4aXMsIG9wdGlvbnMueDJheGlzKTsKICAgICAgICBvcHRpb25zLnhheGVzWzFdLnBvc2l0aW9uID0gInRvcCI7IC8vIE92ZXJyaWRlIHRoZSBpbmhlcml0IHRvIGFsbG93IHRoZSBheGlzIHRvIGF1dG8tc2NhbGUKCiAgICAgICAgaWYgKG9wdGlvbnMueDJheGlzLm1pbiA9PSBudWxsKSB7CiAgICAgICAgICBvcHRpb25zLnhheGVzWzFdLm1pbiA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBpZiAob3B0aW9ucy54MmF4aXMubWF4ID09IG51bGwpIHsKICAgICAgICAgIG9wdGlvbnMueGF4ZXNbMV0ubWF4ID0gbnVsbDsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChvcHRpb25zLnkyYXhpcykgewogICAgICAgIG9wdGlvbnMueWF4ZXNbMV0gPSAkLmV4dGVuZCh0cnVlLCB7fSwgb3B0aW9ucy55YXhpcywgb3B0aW9ucy55MmF4aXMpOwogICAgICAgIG9wdGlvbnMueWF4ZXNbMV0ucG9zaXRpb24gPSAicmlnaHQiOyAvLyBPdmVycmlkZSB0aGUgaW5oZXJpdCB0byBhbGxvdyB0aGUgYXhpcyB0byBhdXRvLXNjYWxlCgogICAgICAgIGlmIChvcHRpb25zLnkyYXhpcy5taW4gPT0gbnVsbCkgewogICAgICAgICAgb3B0aW9ucy55YXhlc1sxXS5taW4gPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgaWYgKG9wdGlvbnMueTJheGlzLm1heCA9PSBudWxsKSB7CiAgICAgICAgICBvcHRpb25zLnlheGVzWzFdLm1heCA9IG51bGw7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAob3B0aW9ucy5ncmlkLmNvbG9yZWRBcmVhcykgb3B0aW9ucy5ncmlkLm1hcmtpbmdzID0gb3B0aW9ucy5ncmlkLmNvbG9yZWRBcmVhczsKICAgICAgaWYgKG9wdGlvbnMuZ3JpZC5jb2xvcmVkQXJlYXNDb2xvcikgb3B0aW9ucy5ncmlkLm1hcmtpbmdzQ29sb3IgPSBvcHRpb25zLmdyaWQuY29sb3JlZEFyZWFzQ29sb3I7CiAgICAgIGlmIChvcHRpb25zLmxpbmVzKSAkLmV4dGVuZCh0cnVlLCBvcHRpb25zLnNlcmllcy5saW5lcywgb3B0aW9ucy5saW5lcyk7CiAgICAgIGlmIChvcHRpb25zLnBvaW50cykgJC5leHRlbmQodHJ1ZSwgb3B0aW9ucy5zZXJpZXMucG9pbnRzLCBvcHRpb25zLnBvaW50cyk7CiAgICAgIGlmIChvcHRpb25zLmJhcnMpICQuZXh0ZW5kKHRydWUsIG9wdGlvbnMuc2VyaWVzLmJhcnMsIG9wdGlvbnMuYmFycyk7CiAgICAgIGlmIChvcHRpb25zLnNoYWRvd1NpemUgIT0gbnVsbCkgb3B0aW9ucy5zZXJpZXMuc2hhZG93U2l6ZSA9IG9wdGlvbnMuc2hhZG93U2l6ZTsKICAgICAgaWYgKG9wdGlvbnMuaGlnaGxpZ2h0Q29sb3IgIT0gbnVsbCkgb3B0aW9ucy5zZXJpZXMuaGlnaGxpZ2h0Q29sb3IgPSBvcHRpb25zLmhpZ2hsaWdodENvbG9yOyAvLyBzYXZlIG9wdGlvbnMgb24gYXhlcyBmb3IgZnV0dXJlIHJlZmVyZW5jZQoKICAgICAgZm9yIChpID0gMDsgaSA8IG9wdGlvbnMueGF4ZXMubGVuZ3RoOyArK2kpIHsKICAgICAgICBnZXRPckNyZWF0ZUF4aXMoeGF4ZXMsIGkgKyAxKS5vcHRpb25zID0gb3B0aW9ucy54YXhlc1tpXTsKICAgICAgfQoKICAgICAgZm9yIChpID0gMDsgaSA8IG9wdGlvbnMueWF4ZXMubGVuZ3RoOyArK2kpIHsKICAgICAgICBnZXRPckNyZWF0ZUF4aXMoeWF4ZXMsIGkgKyAxKS5vcHRpb25zID0gb3B0aW9ucy55YXhlc1tpXTsKICAgICAgfSAvLyBhZGQgaG9va3MgZnJvbSBvcHRpb25zCgoKICAgICAgZm9yICh2YXIgbiBpbiBob29rcykgewogICAgICAgIGlmIChvcHRpb25zLmhvb2tzW25dICYmIG9wdGlvbnMuaG9va3Nbbl0ubGVuZ3RoKSBob29rc1tuXSA9IGhvb2tzW25dLmNvbmNhdChvcHRpb25zLmhvb2tzW25dKTsKICAgICAgfQoKICAgICAgZXhlY3V0ZUhvb2tzKGhvb2tzLnByb2Nlc3NPcHRpb25zLCBbb3B0aW9uc10pOwogICAgfQoKICAgIGZ1bmN0aW9uIHNldERhdGEoZCkgewogICAgICBzZXJpZXMgPSBwYXJzZURhdGEoZCk7CiAgICAgIGZpbGxJblNlcmllc09wdGlvbnMoKTsKICAgICAgcHJvY2Vzc0RhdGEoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBwYXJzZURhdGEoZCkgewogICAgICB2YXIgcmVzID0gW107CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGQubGVuZ3RoOyArK2kpIHsKICAgICAgICB2YXIgcyA9ICQuZXh0ZW5kKHRydWUsIHt9LCBvcHRpb25zLnNlcmllcyk7CgogICAgICAgIGlmIChkW2ldLmRhdGEgIT0gbnVsbCkgewogICAgICAgICAgcy5kYXRhID0gZFtpXS5kYXRhOyAvLyBtb3ZlIHRoZSBkYXRhIGluc3RlYWQgb2YgZGVlcC1jb3B5CgogICAgICAgICAgZGVsZXRlIGRbaV0uZGF0YTsKICAgICAgICAgICQuZXh0ZW5kKHRydWUsIHMsIGRbaV0pOwogICAgICAgICAgZFtpXS5kYXRhID0gcy5kYXRhOwogICAgICAgIH0gZWxzZSBzLmRhdGEgPSBkW2ldOwoKICAgICAgICByZXMucHVzaChzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHJlczsKICAgIH0KCiAgICBmdW5jdGlvbiBheGlzTnVtYmVyKG9iaiwgY29vcmQpIHsKICAgICAgdmFyIGEgPSBvYmpbY29vcmQgKyAiYXhpcyJdOwogICAgICBpZiAoX3R5cGVvZihhKSA9PSAib2JqZWN0IikgLy8gaWYgd2UgZ290IGEgcmVhbCBheGlzLCBleHRyYWN0IG51bWJlcgogICAgICAgIGEgPSBhLm47CiAgICAgIGlmICh0eXBlb2YgYSAhPSAibnVtYmVyIikgYSA9IDE7IC8vIGRlZmF1bHQgdG8gZmlyc3QgYXhpcwoKICAgICAgcmV0dXJuIGE7CiAgICB9CgogICAgZnVuY3Rpb24gYWxsQXhlcygpIHsKICAgICAgLy8gcmV0dXJuIGZsYXQgYXJyYXkgd2l0aG91dCBhbm5veWluZyBudWxsIGVudHJpZXMKICAgICAgcmV0dXJuICQuZ3JlcCh4YXhlcy5jb25jYXQoeWF4ZXMpLCBmdW5jdGlvbiAoYSkgewogICAgICAgIHJldHVybiBhOwogICAgICB9KTsKICAgIH0KCiAgICBmdW5jdGlvbiBjYW52YXNUb0F4aXNDb29yZHMocG9zKSB7CiAgICAgIC8vIHJldHVybiBhbiBvYmplY3Qgd2l0aCB4L3kgY29ycmVzcG9uZGluZyB0byBhbGwgdXNlZCBheGVzCiAgICAgIHZhciByZXMgPSB7fSwKICAgICAgICAgIGksCiAgICAgICAgICBheGlzOwoKICAgICAgZm9yIChpID0gMDsgaSA8IHhheGVzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgYXhpcyA9IHhheGVzW2ldOwogICAgICAgIGlmIChheGlzICYmIGF4aXMudXNlZCkgcmVzWyJ4IiArIGF4aXMubl0gPSBheGlzLmMycChwb3MubGVmdCk7CiAgICAgIH0KCiAgICAgIGZvciAoaSA9IDA7IGkgPCB5YXhlcy5sZW5ndGg7ICsraSkgewogICAgICAgIGF4aXMgPSB5YXhlc1tpXTsKICAgICAgICBpZiAoYXhpcyAmJiBheGlzLnVzZWQpIHJlc1sieSIgKyBheGlzLm5dID0gYXhpcy5jMnAocG9zLnRvcCk7CiAgICAgIH0KCiAgICAgIGlmIChyZXMueDEgIT09IHVuZGVmaW5lZCkgcmVzLnggPSByZXMueDE7CiAgICAgIGlmIChyZXMueTEgIT09IHVuZGVmaW5lZCkgcmVzLnkgPSByZXMueTE7CiAgICAgIHJldHVybiByZXM7CiAgICB9CgogICAgZnVuY3Rpb24gYXhpc1RvQ2FudmFzQ29vcmRzKHBvcykgewogICAgICAvLyBnZXQgY2FudmFzIGNvb3JkcyBmcm9tIHRoZSBmaXJzdCBwYWlyIG9mIHgveSBmb3VuZCBpbiBwb3MKICAgICAgdmFyIHJlcyA9IHt9LAogICAgICAgICAgaSwKICAgICAgICAgIGF4aXMsCiAgICAgICAgICBrZXk7CgogICAgICBmb3IgKGkgPSAwOyBpIDwgeGF4ZXMubGVuZ3RoOyArK2kpIHsKICAgICAgICBheGlzID0geGF4ZXNbaV07CgogICAgICAgIGlmIChheGlzICYmIGF4aXMudXNlZCkgewogICAgICAgICAga2V5ID0gIngiICsgYXhpcy5uOwogICAgICAgICAgaWYgKHBvc1trZXldID09IG51bGwgJiYgYXhpcy5uID09IDEpIGtleSA9ICJ4IjsKCiAgICAgICAgICBpZiAocG9zW2tleV0gIT0gbnVsbCkgewogICAgICAgICAgICByZXMubGVmdCA9IGF4aXMucDJjKHBvc1trZXldKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBmb3IgKGkgPSAwOyBpIDwgeWF4ZXMubGVuZ3RoOyArK2kpIHsKICAgICAgICBheGlzID0geWF4ZXNbaV07CgogICAgICAgIGlmIChheGlzICYmIGF4aXMudXNlZCkgewogICAgICAgICAga2V5ID0gInkiICsgYXhpcy5uOwogICAgICAgICAgaWYgKHBvc1trZXldID09IG51bGwgJiYgYXhpcy5uID09IDEpIGtleSA9ICJ5IjsKCiAgICAgICAgICBpZiAocG9zW2tleV0gIT0gbnVsbCkgewogICAgICAgICAgICByZXMudG9wID0gYXhpcy5wMmMocG9zW2tleV0pOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiByZXM7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0T3JDcmVhdGVBeGlzKGF4ZXMsIG51bWJlcikgewogICAgICBpZiAoIWF4ZXNbbnVtYmVyIC0gMV0pIGF4ZXNbbnVtYmVyIC0gMV0gPSB7CiAgICAgICAgbjogbnVtYmVyLAogICAgICAgIC8vIHNhdmUgdGhlIG51bWJlciBmb3IgZnV0dXJlIHJlZmVyZW5jZQogICAgICAgIGRpcmVjdGlvbjogYXhlcyA9PSB4YXhlcyA/ICJ4IiA6ICJ5IiwKICAgICAgICBvcHRpb25zOiAkLmV4dGVuZCh0cnVlLCB7fSwgYXhlcyA9PSB4YXhlcyA/IG9wdGlvbnMueGF4aXMgOiBvcHRpb25zLnlheGlzKQogICAgICB9OwogICAgICByZXR1cm4gYXhlc1tudW1iZXIgLSAxXTsKICAgIH0KCiAgICBmdW5jdGlvbiBmaWxsSW5TZXJpZXNPcHRpb25zKCkgewogICAgICB2YXIgbmVlZGVkQ29sb3JzID0gc2VyaWVzLmxlbmd0aCwKICAgICAgICAgIG1heEluZGV4ID0gLTEsCiAgICAgICAgICBpOyAvLyBTdWJ0cmFjdCB0aGUgbnVtYmVyIG9mIHNlcmllcyB0aGF0IGFscmVhZHkgaGF2ZSBmaXhlZCBjb2xvcnMgb3IKICAgICAgLy8gY29sb3IgaW5kZXhlcyBmcm9tIHRoZSBudW1iZXIgdGhhdCB3ZSBzdGlsbCBuZWVkIHRvIGdlbmVyYXRlLgoKICAgICAgZm9yIChpID0gMDsgaSA8IHNlcmllcy5sZW5ndGg7ICsraSkgewogICAgICAgIHZhciBzYyA9IHNlcmllc1tpXS5jb2xvcjsKCiAgICAgICAgaWYgKHNjICE9IG51bGwpIHsKICAgICAgICAgIG5lZWRlZENvbG9ycy0tOwoKICAgICAgICAgIGlmICh0eXBlb2Ygc2MgPT0gIm51bWJlciIgJiYgc2MgPiBtYXhJbmRleCkgewogICAgICAgICAgICBtYXhJbmRleCA9IHNjOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSAvLyBJZiBhbnkgb2YgdGhlIHNlcmllcyBoYXZlIGZpeGVkIGNvbG9yIGluZGV4ZXMsIHRoZW4gd2UgbmVlZCB0bwogICAgICAvLyBnZW5lcmF0ZSBhdCBsZWFzdCBhcyBtYW55IGNvbG9ycyBhcyB0aGUgaGlnaGVzdCBpbmRleC4KCgogICAgICBpZiAobmVlZGVkQ29sb3JzIDw9IG1heEluZGV4KSB7CiAgICAgICAgbmVlZGVkQ29sb3JzID0gbWF4SW5kZXggKyAxOwogICAgICB9IC8vIEdlbmVyYXRlIGFsbCB0aGUgY29sb3JzLCB1c2luZyBmaXJzdCB0aGUgb3B0aW9uIGNvbG9ycyBhbmQgdGhlbgogICAgICAvLyB2YXJpYXRpb25zIG9uIHRob3NlIGNvbG9ycyBvbmNlIHRoZXkncmUgZXhoYXVzdGVkLgoKCiAgICAgIHZhciBjLAogICAgICAgICAgY29sb3JzID0gW10sCiAgICAgICAgICBjb2xvclBvb2wgPSBvcHRpb25zLmNvbG9ycywKICAgICAgICAgIGNvbG9yUG9vbFNpemUgPSBjb2xvclBvb2wubGVuZ3RoLAogICAgICAgICAgdmFyaWF0aW9uID0gMDsKCiAgICAgIGZvciAoaSA9IDA7IGkgPCBuZWVkZWRDb2xvcnM7IGkrKykgewogICAgICAgIGMgPSAkLmNvbG9yLnBhcnNlKGNvbG9yUG9vbFtpICUgY29sb3JQb29sU2l6ZV0gfHwgIiM2NjYiKTsgLy8gRWFjaCB0aW1lIHdlIGV4aGF1c3QgdGhlIGNvbG9ycyBpbiB0aGUgcG9vbCB3ZSBhZGp1c3QKICAgICAgICAvLyBhIHNjYWxpbmcgZmFjdG9yIHVzZWQgdG8gcHJvZHVjZSBtb3JlIHZhcmlhdGlvbnMgb24KICAgICAgICAvLyB0aG9zZSBjb2xvcnMuIFRoZSBmYWN0b3IgYWx0ZXJuYXRlcyBuZWdhdGl2ZS9wb3NpdGl2ZQogICAgICAgIC8vIHRvIHByb2R1Y2UgbGlnaHRlci9kYXJrZXIgY29sb3JzLgogICAgICAgIC8vIFJlc2V0IHRoZSB2YXJpYXRpb24gYWZ0ZXIgZXZlcnkgZmV3IGN5Y2xlcywgb3IgZWxzZQogICAgICAgIC8vIGl0IHdpbGwgZW5kIHVwIHByb2R1Y2luZyBvbmx5IHdoaXRlIG9yIGJsYWNrIGNvbG9ycy4KCiAgICAgICAgaWYgKGkgJSBjb2xvclBvb2xTaXplID09IDAgJiYgaSkgewogICAgICAgICAgaWYgKHZhcmlhdGlvbiA+PSAwKSB7CiAgICAgICAgICAgIGlmICh2YXJpYXRpb24gPCAwLjUpIHsKICAgICAgICAgICAgICB2YXJpYXRpb24gPSAtdmFyaWF0aW9uIC0gMC4yOwogICAgICAgICAgICB9IGVsc2UgdmFyaWF0aW9uID0gMDsKICAgICAgICAgIH0gZWxzZSB2YXJpYXRpb24gPSAtdmFyaWF0aW9uOwogICAgICAgIH0KCiAgICAgICAgY29sb3JzW2ldID0gYy5zY2FsZSgncmdiJywgMSArIHZhcmlhdGlvbik7CiAgICAgIH0gLy8gRmluYWxpemUgdGhlIHNlcmllcyBvcHRpb25zLCBmaWxsaW5nIGluIHRoZWlyIGNvbG9ycwoKCiAgICAgIHZhciBjb2xvcmkgPSAwLAogICAgICAgICAgczsKCiAgICAgIGZvciAoaSA9IDA7IGkgPCBzZXJpZXMubGVuZ3RoOyArK2kpIHsKICAgICAgICBzID0gc2VyaWVzW2ldOyAvLyBhc3NpZ24gY29sb3JzCgogICAgICAgIGlmIChzLmNvbG9yID09IG51bGwpIHsKICAgICAgICAgIHMuY29sb3IgPSBjb2xvcnNbY29sb3JpXS50b1N0cmluZygpOwogICAgICAgICAgKytjb2xvcmk7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygcy5jb2xvciA9PSAibnVtYmVyIikgcy5jb2xvciA9IGNvbG9yc1tzLmNvbG9yXS50b1N0cmluZygpOyAvLyB0dXJuIG9uIGxpbmVzIGF1dG9tYXRpY2FsbHkgaW4gY2FzZSBub3RoaW5nIGlzIHNldAoKCiAgICAgICAgaWYgKHMubGluZXMuc2hvdyA9PSBudWxsKSB7CiAgICAgICAgICB2YXIgdiwKICAgICAgICAgICAgICBzaG93ID0gdHJ1ZTsKCiAgICAgICAgICBmb3IgKHYgaW4gcykgewogICAgICAgICAgICBpZiAoc1t2XSAmJiBzW3ZdLnNob3cpIHsKICAgICAgICAgICAgICBzaG93ID0gZmFsc2U7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoc2hvdykgcy5saW5lcy5zaG93ID0gdHJ1ZTsKICAgICAgICB9IC8vIElmIG5vdGhpbmcgd2FzIHByb3ZpZGVkIGZvciBsaW5lcy56ZXJvLCBkZWZhdWx0IGl0IHRvIG1hdGNoCiAgICAgICAgLy8gbGluZXMuZmlsbCwgc2luY2UgYXJlYXMgYnkgZGVmYXVsdCBzaG91bGQgZXh0ZW5kIHRvIHplcm8uCgoKICAgICAgICBpZiAocy5saW5lcy56ZXJvID09IG51bGwpIHsKICAgICAgICAgIHMubGluZXMuemVybyA9ICEhcy5saW5lcy5maWxsOwogICAgICAgIH0gLy8gc2V0dXAgYXhlcwoKCiAgICAgICAgcy54YXhpcyA9IGdldE9yQ3JlYXRlQXhpcyh4YXhlcywgYXhpc051bWJlcihzLCAieCIpKTsKICAgICAgICBzLnlheGlzID0gZ2V0T3JDcmVhdGVBeGlzKHlheGVzLCBheGlzTnVtYmVyKHMsICJ5IikpOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gcHJvY2Vzc0RhdGEoKSB7CiAgICAgIHZhciB0b3BTZW50cnkgPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFksCiAgICAgICAgICBib3R0b21TZW50cnkgPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFksCiAgICAgICAgICBmYWtlSW5maW5pdHkgPSBOdW1iZXIuTUFYX1ZBTFVFLAogICAgICAgICAgaSwKICAgICAgICAgIGosCiAgICAgICAgICBrLAogICAgICAgICAgbSwKICAgICAgICAgIGxlbmd0aCwKICAgICAgICAgIHMsCiAgICAgICAgICBwb2ludHMsCiAgICAgICAgICBwcywKICAgICAgICAgIHgsCiAgICAgICAgICB5LAogICAgICAgICAgYXhpcywKICAgICAgICAgIHZhbCwKICAgICAgICAgIGYsCiAgICAgICAgICBwLAogICAgICAgICAgZGF0YSwKICAgICAgICAgIGZvcm1hdDsKCiAgICAgIGZ1bmN0aW9uIHVwZGF0ZUF4aXMoYXhpcywgbWluLCBtYXgpIHsKICAgICAgICBpZiAobWluIDwgYXhpcy5kYXRhbWluICYmIG1pbiAhPSAtZmFrZUluZmluaXR5KSBheGlzLmRhdGFtaW4gPSBtaW47CiAgICAgICAgaWYgKG1heCA+IGF4aXMuZGF0YW1heCAmJiBtYXggIT0gZmFrZUluZmluaXR5KSBheGlzLmRhdGFtYXggPSBtYXg7CiAgICAgIH0KCiAgICAgICQuZWFjaChhbGxBeGVzKCksIGZ1bmN0aW9uIChfLCBheGlzKSB7CiAgICAgICAgLy8gaW5pdCBheGlzCiAgICAgICAgYXhpcy5kYXRhbWluID0gdG9wU2VudHJ5OwogICAgICAgIGF4aXMuZGF0YW1heCA9IGJvdHRvbVNlbnRyeTsKICAgICAgICBheGlzLnVzZWQgPSBmYWxzZTsKICAgICAgfSk7CgogICAgICBmb3IgKGkgPSAwOyBpIDwgc2VyaWVzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgcyA9IHNlcmllc1tpXTsKICAgICAgICBzLmRhdGFwb2ludHMgPSB7CiAgICAgICAgICBwb2ludHM6IFtdCiAgICAgICAgfTsKICAgICAgICBleGVjdXRlSG9va3MoaG9va3MucHJvY2Vzc1Jhd0RhdGEsIFtzLCBzLmRhdGEsIHMuZGF0YXBvaW50c10pOwogICAgICB9IC8vIGZpcnN0IHBhc3M6IGNsZWFuIGFuZCBjb3B5IGRhdGEKCgogICAgICBmb3IgKGkgPSAwOyBpIDwgc2VyaWVzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgcyA9IHNlcmllc1tpXTsKICAgICAgICBkYXRhID0gcy5kYXRhOwogICAgICAgIGZvcm1hdCA9IHMuZGF0YXBvaW50cy5mb3JtYXQ7CgogICAgICAgIGlmICghZm9ybWF0KSB7CiAgICAgICAgICBmb3JtYXQgPSBbXTsgLy8gZmluZCBvdXQgaG93IHRvIGNvcHkKCiAgICAgICAgICBmb3JtYXQucHVzaCh7CiAgICAgICAgICAgIHg6IHRydWUsCiAgICAgICAgICAgIG51bWJlcjogdHJ1ZSwKICAgICAgICAgICAgcmVxdWlyZWQ6IHRydWUKICAgICAgICAgIH0pOwogICAgICAgICAgZm9ybWF0LnB1c2goewogICAgICAgICAgICB5OiB0cnVlLAogICAgICAgICAgICBudW1iZXI6IHRydWUsCiAgICAgICAgICAgIHJlcXVpcmVkOiB0cnVlCiAgICAgICAgICB9KTsKCiAgICAgICAgICBpZiAocy5iYXJzLnNob3cgfHwgcy5saW5lcy5zaG93ICYmIHMubGluZXMuZmlsbCkgewogICAgICAgICAgICB2YXIgYXV0b3NjYWxlID0gISEocy5iYXJzLnNob3cgJiYgcy5iYXJzLnplcm8gfHwgcy5saW5lcy5zaG93ICYmIHMubGluZXMuemVybyk7CiAgICAgICAgICAgIGZvcm1hdC5wdXNoKHsKICAgICAgICAgICAgICB5OiB0cnVlLAogICAgICAgICAgICAgIG51bWJlcjogdHJ1ZSwKICAgICAgICAgICAgICByZXF1aXJlZDogZmFsc2UsCiAgICAgICAgICAgICAgZGVmYXVsdFZhbHVlOiAwLAogICAgICAgICAgICAgIGF1dG9zY2FsZTogYXV0b3NjYWxlCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgaWYgKHMuYmFycy5ob3Jpem9udGFsKSB7CiAgICAgICAgICAgICAgZGVsZXRlIGZvcm1hdFtmb3JtYXQubGVuZ3RoIC0gMV0ueTsKICAgICAgICAgICAgICBmb3JtYXRbZm9ybWF0Lmxlbmd0aCAtIDFdLnggPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgcy5kYXRhcG9pbnRzLmZvcm1hdCA9IGZvcm1hdDsKICAgICAgICB9CgogICAgICAgIGlmIChzLmRhdGFwb2ludHMucG9pbnRzaXplICE9IG51bGwpIGNvbnRpbnVlOyAvLyBhbHJlYWR5IGZpbGxlZCBpbgoKICAgICAgICBzLmRhdGFwb2ludHMucG9pbnRzaXplID0gZm9ybWF0Lmxlbmd0aDsKICAgICAgICBwcyA9IHMuZGF0YXBvaW50cy5wb2ludHNpemU7CiAgICAgICAgcG9pbnRzID0gcy5kYXRhcG9pbnRzLnBvaW50czsKICAgICAgICB2YXIgaW5zZXJ0U3RlcHMgPSBzLmxpbmVzLnNob3cgJiYgcy5saW5lcy5zdGVwczsKICAgICAgICBzLnhheGlzLnVzZWQgPSBzLnlheGlzLnVzZWQgPSB0cnVlOwoKICAgICAgICBmb3IgKGogPSBrID0gMDsgaiA8IGRhdGEubGVuZ3RoOyArK2osIGsgKz0gcHMpIHsKICAgICAgICAgIHAgPSBkYXRhW2pdOwogICAgICAgICAgdmFyIG51bGxpZnkgPSBwID09IG51bGw7CgogICAgICAgICAgaWYgKCFudWxsaWZ5KSB7CiAgICAgICAgICAgIGZvciAobSA9IDA7IG0gPCBwczsgKyttKSB7CiAgICAgICAgICAgICAgdmFsID0gcFttXTsKICAgICAgICAgICAgICBmID0gZm9ybWF0W21dOwoKICAgICAgICAgICAgICBpZiAoZikgewogICAgICAgICAgICAgICAgaWYgKGYubnVtYmVyICYmIHZhbCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhbCA9ICt2YWw7IC8vIGNvbnZlcnQgdG8gbnVtYmVyCgogICAgICAgICAgICAgICAgICBpZiAoaXNOYU4odmFsKSkgdmFsID0gbnVsbDtlbHNlIGlmICh2YWwgPT0gSW5maW5pdHkpIHZhbCA9IGZha2VJbmZpbml0eTtlbHNlIGlmICh2YWwgPT0gLUluZmluaXR5KSB2YWwgPSAtZmFrZUluZmluaXR5OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh2YWwgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBpZiAoZi5yZXF1aXJlZCkgbnVsbGlmeSA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGlmIChmLmRlZmF1bHRWYWx1ZSAhPSBudWxsKSB2YWwgPSBmLmRlZmF1bHRWYWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHBvaW50c1trICsgbV0gPSB2YWw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBpZiAobnVsbGlmeSkgewogICAgICAgICAgICBmb3IgKG0gPSAwOyBtIDwgcHM7ICsrbSkgewogICAgICAgICAgICAgIHZhbCA9IHBvaW50c1trICsgbV07CgogICAgICAgICAgICAgIGlmICh2YWwgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgZiA9IGZvcm1hdFttXTsgLy8gZXh0cmFjdCBtaW4vbWF4IGluZm8KCiAgICAgICAgICAgICAgICBpZiAoZi5hdXRvc2NhbGUgIT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgIGlmIChmLngpIHsKICAgICAgICAgICAgICAgICAgICB1cGRhdGVBeGlzKHMueGF4aXMsIHZhbCwgdmFsKTsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgaWYgKGYueSkgewogICAgICAgICAgICAgICAgICAgIHVwZGF0ZUF4aXMocy55YXhpcywgdmFsLCB2YWwpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBwb2ludHNbayArIG1dID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gYSBsaXR0bGUgYml0IG9mIGxpbmUgc3BlY2lmaWMgc3R1ZmYgdGhhdAogICAgICAgICAgICAvLyBwZXJoYXBzIHNob3VsZG4ndCBiZSBoZXJlLCBidXQgbGFja2luZwogICAgICAgICAgICAvLyBiZXR0ZXIgbWVhbnMuLi4KICAgICAgICAgICAgaWYgKGluc2VydFN0ZXBzICYmIGsgPiAwICYmIHBvaW50c1trIC0gcHNdICE9IG51bGwgJiYgcG9pbnRzW2sgLSBwc10gIT0gcG9pbnRzW2tdICYmIHBvaW50c1trIC0gcHMgKyAxXSAhPSBwb2ludHNbayArIDFdKSB7CiAgICAgICAgICAgICAgLy8gY29weSB0aGUgcG9pbnQgdG8gbWFrZSByb29tIGZvciBhIG1pZGRsZSBwb2ludAogICAgICAgICAgICAgIGZvciAobSA9IDA7IG0gPCBwczsgKyttKSB7CiAgICAgICAgICAgICAgICBwb2ludHNbayArIHBzICsgbV0gPSBwb2ludHNbayArIG1dOwogICAgICAgICAgICAgIH0gLy8gbWlkZGxlIHBvaW50IGhhcyBzYW1lIHkKCgogICAgICAgICAgICAgIHBvaW50c1trICsgMV0gPSBwb2ludHNbayAtIHBzICsgMV07IC8vIHdlJ3ZlIGFkZGVkIGEgcG9pbnQsIGJldHRlciByZWZsZWN0IHRoYXQKCiAgICAgICAgICAgICAgayArPSBwczsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSAvLyBnaXZlIHRoZSBob29rcyBhIGNoYW5jZSB0byBydW4KCgogICAgICBmb3IgKGkgPSAwOyBpIDwgc2VyaWVzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgcyA9IHNlcmllc1tpXTsKICAgICAgICBleGVjdXRlSG9va3MoaG9va3MucHJvY2Vzc0RhdGFwb2ludHMsIFtzLCBzLmRhdGFwb2ludHNdKTsKICAgICAgfSAvLyBzZWNvbmQgcGFzczogZmluZCBkYXRhbWF4L2RhdGFtaW4gZm9yIGF1dG8tc2NhbGluZwoKCiAgICAgIGZvciAoaSA9IDA7IGkgPCBzZXJpZXMubGVuZ3RoOyArK2kpIHsKICAgICAgICBzID0gc2VyaWVzW2ldOwogICAgICAgIHBvaW50cyA9IHMuZGF0YXBvaW50cy5wb2ludHM7CiAgICAgICAgcHMgPSBzLmRhdGFwb2ludHMucG9pbnRzaXplOwogICAgICAgIGZvcm1hdCA9IHMuZGF0YXBvaW50cy5mb3JtYXQ7CiAgICAgICAgdmFyIHhtaW4gPSB0b3BTZW50cnksCiAgICAgICAgICAgIHltaW4gPSB0b3BTZW50cnksCiAgICAgICAgICAgIHhtYXggPSBib3R0b21TZW50cnksCiAgICAgICAgICAgIHltYXggPSBib3R0b21TZW50cnk7CgogICAgICAgIGZvciAoaiA9IDA7IGogPCBwb2ludHMubGVuZ3RoOyBqICs9IHBzKSB7CiAgICAgICAgICBpZiAocG9pbnRzW2pdID09IG51bGwpIGNvbnRpbnVlOwoKICAgICAgICAgIGZvciAobSA9IDA7IG0gPCBwczsgKyttKSB7CiAgICAgICAgICAgIHZhbCA9IHBvaW50c1tqICsgbV07CiAgICAgICAgICAgIGYgPSBmb3JtYXRbbV07CiAgICAgICAgICAgIGlmICghZiB8fCBmLmF1dG9zY2FsZSA9PT0gZmFsc2UgfHwgdmFsID09IGZha2VJbmZpbml0eSB8fCB2YWwgPT0gLWZha2VJbmZpbml0eSkgY29udGludWU7CgogICAgICAgICAgICBpZiAoZi54KSB7CiAgICAgICAgICAgICAgaWYgKHZhbCA8IHhtaW4pIHhtaW4gPSB2YWw7CiAgICAgICAgICAgICAgaWYgKHZhbCA+IHhtYXgpIHhtYXggPSB2YWw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChmLnkpIHsKICAgICAgICAgICAgICBpZiAodmFsIDwgeW1pbikgeW1pbiA9IHZhbDsKICAgICAgICAgICAgICBpZiAodmFsID4geW1heCkgeW1heCA9IHZhbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHMuYmFycy5zaG93KSB7CiAgICAgICAgICAvLyBtYWtlIHN1cmUgd2UgZ290IHJvb20gZm9yIHRoZSBiYXIgb24gdGhlIGRhbmNpbmcgZmxvb3IKICAgICAgICAgIHZhciBkZWx0YTsKCiAgICAgICAgICBzd2l0Y2ggKHMuYmFycy5hbGlnbikgewogICAgICAgICAgICBjYXNlICJsZWZ0IjoKICAgICAgICAgICAgICBkZWx0YSA9IDA7CiAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlICJyaWdodCI6CiAgICAgICAgICAgICAgZGVsdGEgPSAtcy5iYXJzLmJhcldpZHRoOwogICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBkZWx0YSA9IC1zLmJhcnMuYmFyV2lkdGggLyAyOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChzLmJhcnMuaG9yaXpvbnRhbCkgewogICAgICAgICAgICB5bWluICs9IGRlbHRhOwogICAgICAgICAgICB5bWF4ICs9IGRlbHRhICsgcy5iYXJzLmJhcldpZHRoOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgeG1pbiArPSBkZWx0YTsKICAgICAgICAgICAgeG1heCArPSBkZWx0YSArIHMuYmFycy5iYXJXaWR0aDsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHVwZGF0ZUF4aXMocy54YXhpcywgeG1pbiwgeG1heCk7CiAgICAgICAgdXBkYXRlQXhpcyhzLnlheGlzLCB5bWluLCB5bWF4KTsKICAgICAgfQoKICAgICAgJC5lYWNoKGFsbEF4ZXMoKSwgZnVuY3Rpb24gKF8sIGF4aXMpIHsKICAgICAgICBpZiAoYXhpcy5kYXRhbWluID09IHRvcFNlbnRyeSkgYXhpcy5kYXRhbWluID0gbnVsbDsKICAgICAgICBpZiAoYXhpcy5kYXRhbWF4ID09IGJvdHRvbVNlbnRyeSkgYXhpcy5kYXRhbWF4ID0gbnVsbDsKICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gc2V0dXBDYW52YXNlcygpIHsKICAgICAgLy8gTWFrZSBzdXJlIHRoZSBwbGFjZWhvbGRlciBpcyBjbGVhciBvZiBldmVyeXRoaW5nIGV4Y2VwdCBjYW52YXNlcwogICAgICAvLyBmcm9tIGEgcHJldmlvdXMgcGxvdCBpbiB0aGlzIGNvbnRhaW5lciB0aGF0IHdlJ2xsIHRyeSB0byByZS11c2UuCiAgICAgIHBsYWNlaG9sZGVyLmNzcygicGFkZGluZyIsIDApIC8vIHBhZGRpbmcgbWVzc2VzIHVwIHRoZSBwb3NpdGlvbmluZwogICAgICAuY2hpbGRyZW4oKS5maWx0ZXIoZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAhJCh0aGlzKS5oYXNDbGFzcygiZmxvdC1vdmVybGF5IikgJiYgISQodGhpcykuaGFzQ2xhc3MoJ2Zsb3QtYmFzZScpOwogICAgICB9KS5yZW1vdmUoKTsKICAgICAgaWYgKHBsYWNlaG9sZGVyLmNzcygicG9zaXRpb24iKSA9PSAnc3RhdGljJykgcGxhY2Vob2xkZXIuY3NzKCJwb3NpdGlvbiIsICJyZWxhdGl2ZSIpOyAvLyBmb3IgcG9zaXRpb25pbmcgbGFiZWxzIGFuZCBvdmVybGF5CgogICAgICBzdXJmYWNlID0gbmV3IENhbnZhcygiZmxvdC1iYXNlIiwgcGxhY2Vob2xkZXIpOwogICAgICBvdmVybGF5ID0gbmV3IENhbnZhcygiZmxvdC1vdmVybGF5IiwgcGxhY2Vob2xkZXIpOyAvLyBvdmVybGF5IGNhbnZhcyBmb3IgaW50ZXJhY3RpdmUgZmVhdHVyZXMKCiAgICAgIGN0eCA9IHN1cmZhY2UuY29udGV4dDsKICAgICAgb2N0eCA9IG92ZXJsYXkuY29udGV4dDsgLy8gZGVmaW5lIHdoaWNoIGVsZW1lbnQgd2UncmUgbGlzdGVuaW5nIGZvciBldmVudHMgb24KCiAgICAgIGV2ZW50SG9sZGVyID0gJChvdmVybGF5LmVsZW1lbnQpLnVuYmluZCgpOyAvLyBJZiB3ZSdyZSByZS11c2luZyBhIHBsb3Qgb2JqZWN0LCBzaHV0IGRvd24gdGhlIG9sZCBvbmUKCiAgICAgIHZhciBleGlzdGluZyA9IHBsYWNlaG9sZGVyLmRhdGEoInBsb3QiKTsKCiAgICAgIGlmIChleGlzdGluZykgewogICAgICAgIGV4aXN0aW5nLnNodXRkb3duKCk7CiAgICAgICAgb3ZlcmxheS5jbGVhcigpOwogICAgICB9IC8vIHNhdmUgaW4gY2FzZSB3ZSBnZXQgcmVwbG90dGVkCgoKICAgICAgcGxhY2Vob2xkZXIuZGF0YSgicGxvdCIsIHBsb3QpOwogICAgfQoKICAgIGZ1bmN0aW9uIGJpbmRFdmVudHMoKSB7CiAgICAgIC8vIGJpbmQgZXZlbnRzCiAgICAgIGlmIChvcHRpb25zLmdyaWQuaG92ZXJhYmxlKSB7CiAgICAgICAgZXZlbnRIb2xkZXIubW91c2Vtb3ZlKG9uTW91c2VNb3ZlKTsgLy8gVXNlIGJpbmQsIHJhdGhlciB0aGFuIC5tb3VzZWxlYXZlLCBiZWNhdXNlIHdlIG9mZmljaWFsbHkKICAgICAgICAvLyBzdGlsbCBzdXBwb3J0IGpRdWVyeSAxLjIuNiwgd2hpY2ggZG9lc24ndCBkZWZpbmUgYSBzaG9ydGN1dAogICAgICAgIC8vIGZvciBtb3VzZWVudGVyIG9yIG1vdXNlbGVhdmUuICBUaGlzIHdhcyBhIGJ1Zy9vdmVyc2lnaHQgdGhhdAogICAgICAgIC8vIHdhcyBmaXhlZCBzb21ld2hlcmUgYXJvdW5kIDEuMy54LiAgV2UgY2FuIHJldHVybiB0byB1c2luZwogICAgICAgIC8vIC5tb3VzZWxlYXZlIHdoZW4gd2UgZHJvcCBzdXBwb3J0IGZvciAxLjIuNi4KCiAgICAgICAgZXZlbnRIb2xkZXIuYmluZCgibW91c2VsZWF2ZSIsIG9uTW91c2VMZWF2ZSk7CiAgICAgIH0KCiAgICAgIGlmIChvcHRpb25zLmdyaWQuY2xpY2thYmxlKSBldmVudEhvbGRlci5jbGljayhvbkNsaWNrKTsKICAgICAgZXhlY3V0ZUhvb2tzKGhvb2tzLmJpbmRFdmVudHMsIFtldmVudEhvbGRlcl0pOwogICAgfQoKICAgIGZ1bmN0aW9uIHNodXRkb3duKCkgewogICAgICBpZiAocmVkcmF3VGltZW91dCkgY2xlYXJUaW1lb3V0KHJlZHJhd1RpbWVvdXQpOwogICAgICBldmVudEhvbGRlci51bmJpbmQoIm1vdXNlbW92ZSIsIG9uTW91c2VNb3ZlKTsKICAgICAgZXZlbnRIb2xkZXIudW5iaW5kKCJtb3VzZWxlYXZlIiwgb25Nb3VzZUxlYXZlKTsKICAgICAgZXZlbnRIb2xkZXIudW5iaW5kKCJjbGljayIsIG9uQ2xpY2spOwogICAgICBleGVjdXRlSG9va3MoaG9va3Muc2h1dGRvd24sIFtldmVudEhvbGRlcl0pOwogICAgfQoKICAgIGZ1bmN0aW9uIHNldFRyYW5zZm9ybWF0aW9uSGVscGVycyhheGlzKSB7CiAgICAgIC8vIHNldCBoZWxwZXIgZnVuY3Rpb25zIG9uIHRoZSBheGlzLCBhc3N1bWVzIHBsb3QgYXJlYQogICAgICAvLyBoYXMgYmVlbiBjb21wdXRlZCBhbHJlYWR5CiAgICAgIGZ1bmN0aW9uIGlkZW50aXR5KHgpIHsKICAgICAgICByZXR1cm4geDsKICAgICAgfQoKICAgICAgdmFyIHMsCiAgICAgICAgICBtLAogICAgICAgICAgdCA9IGF4aXMub3B0aW9ucy50cmFuc2Zvcm0gfHwgaWRlbnRpdHksCiAgICAgICAgICBpdCA9IGF4aXMub3B0aW9ucy5pbnZlcnNlVHJhbnNmb3JtOyAvLyBwcmVjb21wdXRlIGhvdyBtdWNoIHRoZSBheGlzIGlzIHNjYWxpbmcgYSBwb2ludAogICAgICAvLyBpbiBjYW52YXMgc3BhY2UKCiAgICAgIGlmIChheGlzLmRpcmVjdGlvbiA9PSAieCIpIHsKICAgICAgICBzID0gYXhpcy5zY2FsZSA9IHBsb3RXaWR0aCAvIE1hdGguYWJzKHQoYXhpcy5tYXgpIC0gdChheGlzLm1pbikpOwogICAgICAgIG0gPSBNYXRoLm1pbih0KGF4aXMubWF4KSwgdChheGlzLm1pbikpOwogICAgICB9IGVsc2UgewogICAgICAgIHMgPSBheGlzLnNjYWxlID0gcGxvdEhlaWdodCAvIE1hdGguYWJzKHQoYXhpcy5tYXgpIC0gdChheGlzLm1pbikpOwogICAgICAgIHMgPSAtczsKICAgICAgICBtID0gTWF0aC5tYXgodChheGlzLm1heCksIHQoYXhpcy5taW4pKTsKICAgICAgfSAvLyBkYXRhIHBvaW50IHRvIGNhbnZhcyBjb29yZGluYXRlCgoKICAgICAgaWYgKHQgPT0gaWRlbnRpdHkpIC8vIHNsaWdodCBvcHRpbWl6YXRpb24KICAgICAgICBheGlzLnAyYyA9IGZ1bmN0aW9uIChwKSB7CiAgICAgICAgICByZXR1cm4gKHAgLSBtKSAqIHM7CiAgICAgICAgfTtlbHNlIGF4aXMucDJjID0gZnVuY3Rpb24gKHApIHsKICAgICAgICByZXR1cm4gKHQocCkgLSBtKSAqIHM7CiAgICAgIH07IC8vIGNhbnZhcyBjb29yZGluYXRlIHRvIGRhdGEgcG9pbnQKCiAgICAgIGlmICghaXQpIGF4aXMuYzJwID0gZnVuY3Rpb24gKGMpIHsKICAgICAgICByZXR1cm4gbSArIGMgLyBzOwogICAgICB9O2Vsc2UgYXhpcy5jMnAgPSBmdW5jdGlvbiAoYykgewogICAgICAgIHJldHVybiBpdChtICsgYyAvIHMpOwogICAgICB9OwogICAgfQoKICAgIGZ1bmN0aW9uIG1lYXN1cmVUaWNrTGFiZWxzKGF4aXMpIHsKICAgICAgdmFyIG9wdHMgPSBheGlzLm9wdGlvbnMsCiAgICAgICAgICB0aWNrcyA9IGF4aXMudGlja3MgfHwgW10sCiAgICAgICAgICBsYWJlbFdpZHRoID0gb3B0cy5sYWJlbFdpZHRoIHx8IDAsCiAgICAgICAgICBsYWJlbEhlaWdodCA9IG9wdHMubGFiZWxIZWlnaHQgfHwgMCwKICAgICAgICAgIG1heFdpZHRoID0gbGFiZWxXaWR0aCB8fCAoYXhpcy5kaXJlY3Rpb24gPT0gIngiID8gTWF0aC5mbG9vcihzdXJmYWNlLndpZHRoIC8gKHRpY2tzLmxlbmd0aCB8fCAxKSkgOiBudWxsKSwKICAgICAgICAgIGxlZ2FjeVN0eWxlcyA9IGF4aXMuZGlyZWN0aW9uICsgIkF4aXMgIiArIGF4aXMuZGlyZWN0aW9uICsgYXhpcy5uICsgIkF4aXMiLAogICAgICAgICAgbGF5ZXIgPSAiZmxvdC0iICsgYXhpcy5kaXJlY3Rpb24gKyAiLWF4aXMgZmxvdC0iICsgYXhpcy5kaXJlY3Rpb24gKyBheGlzLm4gKyAiLWF4aXMgIiArIGxlZ2FjeVN0eWxlcywKICAgICAgICAgIGZvbnQgPSBvcHRzLmZvbnQgfHwgImZsb3QtdGljay1sYWJlbCB0aWNrTGFiZWwiOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aWNrcy5sZW5ndGg7ICsraSkgewogICAgICAgIHZhciB0ID0gdGlja3NbaV07CiAgICAgICAgaWYgKCF0LmxhYmVsKSBjb250aW51ZTsKICAgICAgICB2YXIgaW5mbyA9IHN1cmZhY2UuZ2V0VGV4dEluZm8obGF5ZXIsIHQubGFiZWwsIGZvbnQsIG51bGwsIG1heFdpZHRoKTsKICAgICAgICBsYWJlbFdpZHRoID0gTWF0aC5tYXgobGFiZWxXaWR0aCwgaW5mby53aWR0aCk7CiAgICAgICAgbGFiZWxIZWlnaHQgPSBNYXRoLm1heChsYWJlbEhlaWdodCwgaW5mby5oZWlnaHQpOwogICAgICB9CgogICAgICBheGlzLmxhYmVsV2lkdGggPSBvcHRzLmxhYmVsV2lkdGggfHwgbGFiZWxXaWR0aDsKICAgICAgYXhpcy5sYWJlbEhlaWdodCA9IG9wdHMubGFiZWxIZWlnaHQgfHwgbGFiZWxIZWlnaHQ7CiAgICB9CgogICAgZnVuY3Rpb24gYWxsb2NhdGVBeGlzQm94Rmlyc3RQaGFzZShheGlzKSB7CiAgICAgIC8vIGZpbmQgdGhlIGJvdW5kaW5nIGJveCBvZiB0aGUgYXhpcyBieSBsb29raW5nIGF0IGxhYmVsCiAgICAgIC8vIHdpZHRocy9oZWlnaHRzIGFuZCB0aWNrcywgbWFrZSByb29tIGJ5IGRpbWluaXNoaW5nIHRoZQogICAgICAvLyBwbG90T2Zmc2V0OyB0aGlzIGZpcnN0IHBoYXNlIG9ubHkgbG9va3MgYXQgb25lCiAgICAgIC8vIGRpbWVuc2lvbiBwZXIgYXhpcywgdGhlIG90aGVyIGRpbWVuc2lvbiBkZXBlbmRzIG9uIHRoZQogICAgICAvLyBvdGhlciBheGVzIHNvIHdpbGwgaGF2ZSB0byB3YWl0CiAgICAgIHZhciBsdyA9IGF4aXMubGFiZWxXaWR0aCwKICAgICAgICAgIGxoID0gYXhpcy5sYWJlbEhlaWdodCwKICAgICAgICAgIHBvcyA9IGF4aXMub3B0aW9ucy5wb3NpdGlvbiwKICAgICAgICAgIGlzWEF4aXMgPSBheGlzLmRpcmVjdGlvbiA9PT0gIngiLAogICAgICAgICAgdGlja0xlbmd0aCA9IGF4aXMub3B0aW9ucy50aWNrTGVuZ3RoLAogICAgICAgICAgYXhpc01hcmdpbiA9IG9wdGlvbnMuZ3JpZC5heGlzTWFyZ2luLAogICAgICAgICAgcGFkZGluZyA9IG9wdGlvbnMuZ3JpZC5sYWJlbE1hcmdpbiwKICAgICAgICAgIGlubmVybW9zdCA9IHRydWUsCiAgICAgICAgICBvdXRlcm1vc3QgPSB0cnVlLAogICAgICAgICAgZmlyc3QgPSB0cnVlLAogICAgICAgICAgZm91bmQgPSBmYWxzZTsgLy8gRGV0ZXJtaW5lIHRoZSBheGlzJ3MgcG9zaXRpb24gaW4gaXRzIGRpcmVjdGlvbiBhbmQgb24gaXRzIHNpZGUKCiAgICAgICQuZWFjaChpc1hBeGlzID8geGF4ZXMgOiB5YXhlcywgZnVuY3Rpb24gKGksIGEpIHsKICAgICAgICBpZiAoYSAmJiAoYS5zaG93IHx8IGEucmVzZXJ2ZVNwYWNlKSkgewogICAgICAgICAgaWYgKGEgPT09IGF4aXMpIHsKICAgICAgICAgICAgZm91bmQgPSB0cnVlOwogICAgICAgICAgfSBlbHNlIGlmIChhLm9wdGlvbnMucG9zaXRpb24gPT09IHBvcykgewogICAgICAgICAgICBpZiAoZm91bmQpIHsKICAgICAgICAgICAgICBvdXRlcm1vc3QgPSBmYWxzZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpbm5lcm1vc3QgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGlmICghZm91bmQpIHsKICAgICAgICAgICAgZmlyc3QgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOyAvLyBUaGUgb3V0ZXJtb3N0IGF4aXMgb24gZWFjaCBzaWRlIGhhcyBubyBtYXJnaW4KCiAgICAgIGlmIChvdXRlcm1vc3QpIHsKICAgICAgICBheGlzTWFyZ2luID0gMDsKICAgICAgfSAvLyBUaGUgdGlja3MgZm9yIHRoZSBmaXJzdCBheGlzIGluIGVhY2ggZGlyZWN0aW9uIHN0cmV0Y2ggYWNyb3NzCgoKICAgICAgaWYgKHRpY2tMZW5ndGggPT0gbnVsbCkgewogICAgICAgIHRpY2tMZW5ndGggPSBmaXJzdCA/ICJmdWxsIiA6IDU7CiAgICAgIH0KCiAgICAgIGlmICghaXNOYU4oK3RpY2tMZW5ndGgpKSBwYWRkaW5nICs9ICt0aWNrTGVuZ3RoOwoKICAgICAgaWYgKGlzWEF4aXMpIHsKICAgICAgICBsaCArPSBwYWRkaW5nOwoKICAgICAgICBpZiAocG9zID09ICJib3R0b20iKSB7CiAgICAgICAgICBwbG90T2Zmc2V0LmJvdHRvbSArPSBsaCArIGF4aXNNYXJnaW47CiAgICAgICAgICBheGlzLmJveCA9IHsKICAgICAgICAgICAgdG9wOiBzdXJmYWNlLmhlaWdodCAtIHBsb3RPZmZzZXQuYm90dG9tLAogICAgICAgICAgICBoZWlnaHQ6IGxoCiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBheGlzLmJveCA9IHsKICAgICAgICAgICAgdG9wOiBwbG90T2Zmc2V0LnRvcCArIGF4aXNNYXJnaW4sCiAgICAgICAgICAgIGhlaWdodDogbGgKICAgICAgICAgIH07CiAgICAgICAgICBwbG90T2Zmc2V0LnRvcCArPSBsaCArIGF4aXNNYXJnaW47CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGx3ICs9IHBhZGRpbmc7CgogICAgICAgIGlmIChwb3MgPT0gImxlZnQiKSB7CiAgICAgICAgICBheGlzLmJveCA9IHsKICAgICAgICAgICAgbGVmdDogcGxvdE9mZnNldC5sZWZ0ICsgYXhpc01hcmdpbiwKICAgICAgICAgICAgd2lkdGg6IGx3CiAgICAgICAgICB9OwogICAgICAgICAgcGxvdE9mZnNldC5sZWZ0ICs9IGx3ICsgYXhpc01hcmdpbjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcGxvdE9mZnNldC5yaWdodCArPSBsdyArIGF4aXNNYXJnaW47CiAgICAgICAgICBheGlzLmJveCA9IHsKICAgICAgICAgICAgbGVmdDogc3VyZmFjZS53aWR0aCAtIHBsb3RPZmZzZXQucmlnaHQsCiAgICAgICAgICAgIHdpZHRoOiBsdwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH0gLy8gc2F2ZSBmb3IgZnV0dXJlIHJlZmVyZW5jZQoKCiAgICAgIGF4aXMucG9zaXRpb24gPSBwb3M7CiAgICAgIGF4aXMudGlja0xlbmd0aCA9IHRpY2tMZW5ndGg7CiAgICAgIGF4aXMuYm94LnBhZGRpbmcgPSBwYWRkaW5nOwogICAgICBheGlzLmlubmVybW9zdCA9IGlubmVybW9zdDsKICAgIH0KCiAgICBmdW5jdGlvbiBhbGxvY2F0ZUF4aXNCb3hTZWNvbmRQaGFzZShheGlzKSB7CiAgICAgIC8vIG5vdyB0aGF0IGFsbCBheGlzIGJveGVzIGhhdmUgYmVlbiBwbGFjZWQgaW4gb25lCiAgICAgIC8vIGRpbWVuc2lvbiwgd2UgY2FuIHNldCB0aGUgcmVtYWluaW5nIGRpbWVuc2lvbiBjb29yZGluYXRlcwogICAgICBpZiAoYXhpcy5kaXJlY3Rpb24gPT0gIngiKSB7CiAgICAgICAgYXhpcy5ib3gubGVmdCA9IHBsb3RPZmZzZXQubGVmdCAtIGF4aXMubGFiZWxXaWR0aCAvIDI7CiAgICAgICAgYXhpcy5ib3gud2lkdGggPSBzdXJmYWNlLndpZHRoIC0gcGxvdE9mZnNldC5sZWZ0IC0gcGxvdE9mZnNldC5yaWdodCArIGF4aXMubGFiZWxXaWR0aDsKICAgICAgfSBlbHNlIHsKICAgICAgICBheGlzLmJveC50b3AgPSBwbG90T2Zmc2V0LnRvcCAtIGF4aXMubGFiZWxIZWlnaHQgLyAyOwogICAgICAgIGF4aXMuYm94LmhlaWdodCA9IHN1cmZhY2UuaGVpZ2h0IC0gcGxvdE9mZnNldC5ib3R0b20gLSBwbG90T2Zmc2V0LnRvcCArIGF4aXMubGFiZWxIZWlnaHQ7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBhZGp1c3RMYXlvdXRGb3JUaGluZ3NTdGlja2luZ091dCgpIHsKICAgICAgLy8gcG9zc2libHkgYWRqdXN0IHBsb3Qgb2Zmc2V0IHRvIGVuc3VyZSBldmVyeXRoaW5nIHN0YXlzCiAgICAgIC8vIGluc2lkZSB0aGUgY2FudmFzIGFuZCBpc24ndCBjbGlwcGVkIG9mZgogICAgICB2YXIgbWluTWFyZ2luID0gb3B0aW9ucy5ncmlkLm1pbkJvcmRlck1hcmdpbiwKICAgICAgICAgIGF4aXMsCiAgICAgICAgICBpOyAvLyBjaGVjayBzdHVmZiBmcm9tIHRoZSBwbG90IChGSVhNRTogdGhpcyBzaG91bGQganVzdCByZWFkCiAgICAgIC8vIGEgdmFsdWUgZnJvbSB0aGUgc2VyaWVzLCBvdGhlcndpc2UgaXQncyBpbXBvc3NpYmxlIHRvCiAgICAgIC8vIGN1c3RvbWl6ZSkKCiAgICAgIGlmIChtaW5NYXJnaW4gPT0gbnVsbCkgewogICAgICAgIG1pbk1hcmdpbiA9IDA7CgogICAgICAgIGZvciAoaSA9IDA7IGkgPCBzZXJpZXMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgIG1pbk1hcmdpbiA9IE1hdGgubWF4KG1pbk1hcmdpbiwgMiAqIChzZXJpZXNbaV0ucG9pbnRzLnJhZGl1cyArIHNlcmllc1tpXS5wb2ludHMubGluZVdpZHRoIC8gMikpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdmFyIG1hcmdpbnMgPSB7CiAgICAgICAgbGVmdDogbWluTWFyZ2luLAogICAgICAgIHJpZ2h0OiBtaW5NYXJnaW4sCiAgICAgICAgdG9wOiBtaW5NYXJnaW4sCiAgICAgICAgYm90dG9tOiBtaW5NYXJnaW4KICAgICAgfTsgLy8gY2hlY2sgYXhpcyBsYWJlbHMsIG5vdGUgd2UgZG9uJ3QgY2hlY2sgdGhlIGFjdHVhbAogICAgICAvLyBsYWJlbHMgYnV0IGluc3RlYWQgdXNlIHRoZSBvdmVyYWxsIHdpZHRoL2hlaWdodCB0byBub3QKICAgICAgLy8ganVtcCBhcyBtdWNoIGFyb3VuZCB3aXRoIHJlcGxvdHMKCiAgICAgICQuZWFjaChhbGxBeGVzKCksIGZ1bmN0aW9uIChfLCBheGlzKSB7CiAgICAgICAgaWYgKGF4aXMucmVzZXJ2ZVNwYWNlICYmIGF4aXMudGlja3MgJiYgYXhpcy50aWNrcy5sZW5ndGgpIHsKICAgICAgICAgIGlmIChheGlzLmRpcmVjdGlvbiA9PT0gIngiKSB7CiAgICAgICAgICAgIG1hcmdpbnMubGVmdCA9IE1hdGgubWF4KG1hcmdpbnMubGVmdCwgYXhpcy5sYWJlbFdpZHRoIC8gMik7CiAgICAgICAgICAgIG1hcmdpbnMucmlnaHQgPSBNYXRoLm1heChtYXJnaW5zLnJpZ2h0LCBheGlzLmxhYmVsV2lkdGggLyAyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG1hcmdpbnMuYm90dG9tID0gTWF0aC5tYXgobWFyZ2lucy5ib3R0b20sIGF4aXMubGFiZWxIZWlnaHQgLyAyKTsKICAgICAgICAgICAgbWFyZ2lucy50b3AgPSBNYXRoLm1heChtYXJnaW5zLnRvcCwgYXhpcy5sYWJlbEhlaWdodCAvIDIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHBsb3RPZmZzZXQubGVmdCA9IE1hdGguY2VpbChNYXRoLm1heChtYXJnaW5zLmxlZnQsIHBsb3RPZmZzZXQubGVmdCkpOwogICAgICBwbG90T2Zmc2V0LnJpZ2h0ID0gTWF0aC5jZWlsKE1hdGgubWF4KG1hcmdpbnMucmlnaHQsIHBsb3RPZmZzZXQucmlnaHQpKTsKICAgICAgcGxvdE9mZnNldC50b3AgPSBNYXRoLmNlaWwoTWF0aC5tYXgobWFyZ2lucy50b3AsIHBsb3RPZmZzZXQudG9wKSk7CiAgICAgIHBsb3RPZmZzZXQuYm90dG9tID0gTWF0aC5jZWlsKE1hdGgubWF4KG1hcmdpbnMuYm90dG9tLCBwbG90T2Zmc2V0LmJvdHRvbSkpOwogICAgfQoKICAgIGZ1bmN0aW9uIHNldHVwR3JpZCgpIHsKICAgICAgdmFyIGksCiAgICAgICAgICBheGVzID0gYWxsQXhlcygpLAogICAgICAgICAgc2hvd0dyaWQgPSBvcHRpb25zLmdyaWQuc2hvdzsgLy8gSW5pdGlhbGl6ZSB0aGUgcGxvdCdzIG9mZnNldCBmcm9tIHRoZSBlZGdlIG9mIHRoZSBjYW52YXMKCiAgICAgIGZvciAodmFyIGEgaW4gcGxvdE9mZnNldCkgewogICAgICAgIHZhciBtYXJnaW4gPSBvcHRpb25zLmdyaWQubWFyZ2luIHx8IDA7CiAgICAgICAgcGxvdE9mZnNldFthXSA9IHR5cGVvZiBtYXJnaW4gPT0gIm51bWJlciIgPyBtYXJnaW4gOiBtYXJnaW5bYV0gfHwgMDsKICAgICAgfQoKICAgICAgZXhlY3V0ZUhvb2tzKGhvb2tzLnByb2Nlc3NPZmZzZXQsIFtwbG90T2Zmc2V0XSk7IC8vIElmIHRoZSBncmlkIGlzIHZpc2libGUsIGFkZCBpdHMgYm9yZGVyIHdpZHRoIHRvIHRoZSBvZmZzZXQKCiAgICAgIGZvciAodmFyIGEgaW4gcGxvdE9mZnNldCkgewogICAgICAgIGlmIChfdHlwZW9mKG9wdGlvbnMuZ3JpZC5ib3JkZXJXaWR0aCkgPT0gIm9iamVjdCIpIHsKICAgICAgICAgIHBsb3RPZmZzZXRbYV0gKz0gc2hvd0dyaWQgPyBvcHRpb25zLmdyaWQuYm9yZGVyV2lkdGhbYV0gOiAwOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBwbG90T2Zmc2V0W2FdICs9IHNob3dHcmlkID8gb3B0aW9ucy5ncmlkLmJvcmRlcldpZHRoIDogMDsKICAgICAgICB9CiAgICAgIH0KCiAgICAgICQuZWFjaChheGVzLCBmdW5jdGlvbiAoXywgYXhpcykgewogICAgICAgIHZhciBheGlzT3B0cyA9IGF4aXMub3B0aW9uczsKICAgICAgICBheGlzLnNob3cgPSBheGlzT3B0cy5zaG93ID09IG51bGwgPyBheGlzLnVzZWQgOiBheGlzT3B0cy5zaG93OwogICAgICAgIGF4aXMucmVzZXJ2ZVNwYWNlID0gYXhpc09wdHMucmVzZXJ2ZVNwYWNlID09IG51bGwgPyBheGlzLnNob3cgOiBheGlzT3B0cy5yZXNlcnZlU3BhY2U7CiAgICAgICAgc2V0UmFuZ2UoYXhpcyk7CiAgICAgIH0pOwoKICAgICAgaWYgKHNob3dHcmlkKSB7CiAgICAgICAgdmFyIGFsbG9jYXRlZEF4ZXMgPSAkLmdyZXAoYXhlcywgZnVuY3Rpb24gKGF4aXMpIHsKICAgICAgICAgIHJldHVybiBheGlzLnNob3cgfHwgYXhpcy5yZXNlcnZlU3BhY2U7CiAgICAgICAgfSk7CiAgICAgICAgJC5lYWNoKGFsbG9jYXRlZEF4ZXMsIGZ1bmN0aW9uIChfLCBheGlzKSB7CiAgICAgICAgICAvLyBtYWtlIHRoZSB0aWNrcwogICAgICAgICAgc2V0dXBUaWNrR2VuZXJhdGlvbihheGlzKTsKICAgICAgICAgIHNldFRpY2tzKGF4aXMpOwogICAgICAgICAgc25hcFJhbmdlVG9UaWNrcyhheGlzLCBheGlzLnRpY2tzKTsgLy8gZmluZCBsYWJlbFdpZHRoL0hlaWdodCBmb3IgYXhpcwoKICAgICAgICAgIG1lYXN1cmVUaWNrTGFiZWxzKGF4aXMpOwogICAgICAgIH0pOyAvLyB3aXRoIGFsbCBkaW1lbnNpb25zIGNhbGN1bGF0ZWQsIHdlIGNhbiBjb21wdXRlIHRoZQogICAgICAgIC8vIGF4aXMgYm91bmRpbmcgYm94ZXMsIHN0YXJ0IGZyb20gdGhlIG91dHNpZGUKICAgICAgICAvLyAocmV2ZXJzZSBvcmRlcikKCiAgICAgICAgZm9yIChpID0gYWxsb2NhdGVkQXhlcy5sZW5ndGggLSAxOyBpID49IDA7IC0taSkgewogICAgICAgICAgYWxsb2NhdGVBeGlzQm94Rmlyc3RQaGFzZShhbGxvY2F0ZWRBeGVzW2ldKTsKICAgICAgICB9IC8vIG1ha2Ugc3VyZSB3ZSd2ZSBnb3QgZW5vdWdoIHNwYWNlIGZvciB0aGluZ3MgdGhhdAogICAgICAgIC8vIG1pZ2h0IHN0aWNrIG91dAoKCiAgICAgICAgYWRqdXN0TGF5b3V0Rm9yVGhpbmdzU3RpY2tpbmdPdXQoKTsKICAgICAgICAkLmVhY2goYWxsb2NhdGVkQXhlcywgZnVuY3Rpb24gKF8sIGF4aXMpIHsKICAgICAgICAgIGFsbG9jYXRlQXhpc0JveFNlY29uZFBoYXNlKGF4aXMpOwogICAgICAgIH0pOwogICAgICB9CgogICAgICBwbG90V2lkdGggPSBzdXJmYWNlLndpZHRoIC0gcGxvdE9mZnNldC5sZWZ0IC0gcGxvdE9mZnNldC5yaWdodDsKICAgICAgcGxvdEhlaWdodCA9IHN1cmZhY2UuaGVpZ2h0IC0gcGxvdE9mZnNldC5ib3R0b20gLSBwbG90T2Zmc2V0LnRvcDsgLy8gbm93IHdlIGdvdCB0aGUgcHJvcGVyIHBsb3QgZGltZW5zaW9ucywgd2UgY2FuIGNvbXB1dGUgdGhlIHNjYWxpbmcKCiAgICAgICQuZWFjaChheGVzLCBmdW5jdGlvbiAoXywgYXhpcykgewogICAgICAgIHNldFRyYW5zZm9ybWF0aW9uSGVscGVycyhheGlzKTsKICAgICAgfSk7CgogICAgICBpZiAoc2hvd0dyaWQpIHsKICAgICAgICBkcmF3QXhpc0xhYmVscygpOwogICAgICB9CgogICAgICBpbnNlcnRMZWdlbmQoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXRSYW5nZShheGlzKSB7CiAgICAgIHZhciBvcHRzID0gYXhpcy5vcHRpb25zLAogICAgICAgICAgbWluID0gKyhvcHRzLm1pbiAhPSBudWxsID8gb3B0cy5taW4gOiBheGlzLmRhdGFtaW4pLAogICAgICAgICAgbWF4ID0gKyhvcHRzLm1heCAhPSBudWxsID8gb3B0cy5tYXggOiBheGlzLmRhdGFtYXgpLAogICAgICAgICAgZGVsdGEgPSBtYXggLSBtaW47CgogICAgICBpZiAoZGVsdGEgPT0gMC4wKSB7CiAgICAgICAgLy8gZGVnZW5lcmF0ZSBjYXNlCiAgICAgICAgdmFyIHdpZGVuID0gbWF4ID09IDAgPyAxIDogMC4wMTsKICAgICAgICBpZiAob3B0cy5taW4gPT0gbnVsbCkgbWluIC09IHdpZGVuOyAvLyBhbHdheXMgd2lkZW4gbWF4IGlmIHdlIGNvdWxkbid0IHdpZGVuIG1pbiB0byBlbnN1cmUgd2UKICAgICAgICAvLyBkb24ndCBmYWxsIGludG8gbWluID09IG1heCB3aGljaCBkb2Vzbid0IHdvcmsKCiAgICAgICAgaWYgKG9wdHMubWF4ID09IG51bGwgfHwgb3B0cy5taW4gIT0gbnVsbCkgbWF4ICs9IHdpZGVuOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIGNvbnNpZGVyIGF1dG9zY2FsaW5nCiAgICAgICAgdmFyIG1hcmdpbiA9IG9wdHMuYXV0b3NjYWxlTWFyZ2luOwoKICAgICAgICBpZiAobWFyZ2luICE9IG51bGwpIHsKICAgICAgICAgIGlmIChvcHRzLm1pbiA9PSBudWxsKSB7CiAgICAgICAgICAgIG1pbiAtPSBkZWx0YSAqIG1hcmdpbjsgLy8gbWFrZSBzdXJlIHdlIGRvbid0IGdvIGJlbG93IHplcm8gaWYgYWxsIHZhbHVlcwogICAgICAgICAgICAvLyBhcmUgcG9zaXRpdmUKCiAgICAgICAgICAgIGlmIChtaW4gPCAwICYmIGF4aXMuZGF0YW1pbiAhPSBudWxsICYmIGF4aXMuZGF0YW1pbiA+PSAwKSBtaW4gPSAwOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChvcHRzLm1heCA9PSBudWxsKSB7CiAgICAgICAgICAgIG1heCArPSBkZWx0YSAqIG1hcmdpbjsKICAgICAgICAgICAgaWYgKG1heCA+IDAgJiYgYXhpcy5kYXRhbWF4ICE9IG51bGwgJiYgYXhpcy5kYXRhbWF4IDw9IDApIG1heCA9IDA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBheGlzLm1pbiA9IG1pbjsKICAgICAgYXhpcy5tYXggPSBtYXg7CiAgICB9CgogICAgZnVuY3Rpb24gc2V0dXBUaWNrR2VuZXJhdGlvbihheGlzKSB7CiAgICAgIHZhciBvcHRzID0gYXhpcy5vcHRpb25zOyAvLyBlc3RpbWF0ZSBudW1iZXIgb2YgdGlja3MKCiAgICAgIHZhciBub1RpY2tzOwogICAgICBpZiAodHlwZW9mIG9wdHMudGlja3MgPT0gIm51bWJlciIgJiYgb3B0cy50aWNrcyA+IDApIG5vVGlja3MgPSBvcHRzLnRpY2tzO2Vsc2UgLy8gaGV1cmlzdGljIGJhc2VkIG9uIHRoZSBtb2RlbCBhKnNxcnQoeCkgZml0dGVkIHRvCiAgICAgICAgLy8gc29tZSBkYXRhIHBvaW50cyB0aGF0IHNlZW1lZCByZWFzb25hYmxlCiAgICAgICAgbm9UaWNrcyA9IDAuMyAqIE1hdGguc3FydChheGlzLmRpcmVjdGlvbiA9PSAieCIgPyBzdXJmYWNlLndpZHRoIDogc3VyZmFjZS5oZWlnaHQpOwogICAgICB2YXIgZGVsdGEgPSAoYXhpcy5tYXggLSBheGlzLm1pbikgLyBub1RpY2tzLAogICAgICAgICAgZGVjID0gLU1hdGguZmxvb3IoTWF0aC5sb2coZGVsdGEpIC8gTWF0aC5MTjEwKSwKICAgICAgICAgIG1heERlYyA9IG9wdHMudGlja0RlY2ltYWxzOwoKICAgICAgaWYgKG1heERlYyAhPSBudWxsICYmIGRlYyA+IG1heERlYykgewogICAgICAgIGRlYyA9IG1heERlYzsKICAgICAgfQoKICAgICAgdmFyIG1hZ24gPSBNYXRoLnBvdygxMCwgLWRlYyksCiAgICAgICAgICBub3JtID0gZGVsdGEgLyBtYWduLAogICAgICAgICAgLy8gbm9ybSBpcyBiZXR3ZWVuIDEuMCBhbmQgMTAuMAogICAgICBzaXplOwoKICAgICAgaWYgKG5vcm0gPCAxLjUpIHsKICAgICAgICBzaXplID0gMTsKICAgICAgfSBlbHNlIGlmIChub3JtIDwgMykgewogICAgICAgIHNpemUgPSAyOyAvLyBzcGVjaWFsIGNhc2UgZm9yIDIuNSwgcmVxdWlyZXMgYW4gZXh0cmEgZGVjaW1hbAoKICAgICAgICBpZiAobm9ybSA+IDIuMjUgJiYgKG1heERlYyA9PSBudWxsIHx8IGRlYyArIDEgPD0gbWF4RGVjKSkgewogICAgICAgICAgc2l6ZSA9IDIuNTsKICAgICAgICAgICsrZGVjOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChub3JtIDwgNy41KSB7CiAgICAgICAgc2l6ZSA9IDU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2l6ZSA9IDEwOwogICAgICB9CgogICAgICBzaXplICo9IG1hZ247CgogICAgICBpZiAob3B0cy5taW5UaWNrU2l6ZSAhPSBudWxsICYmIHNpemUgPCBvcHRzLm1pblRpY2tTaXplKSB7CiAgICAgICAgc2l6ZSA9IG9wdHMubWluVGlja1NpemU7CiAgICAgIH0KCiAgICAgIGF4aXMuZGVsdGEgPSBkZWx0YTsKICAgICAgYXhpcy50aWNrRGVjaW1hbHMgPSBNYXRoLm1heCgwLCBtYXhEZWMgIT0gbnVsbCA/IG1heERlYyA6IGRlYyk7CiAgICAgIGF4aXMudGlja1NpemUgPSBvcHRzLnRpY2tTaXplIHx8IHNpemU7IC8vIFRpbWUgbW9kZSB3YXMgbW92ZWQgdG8gYSBwbHVnLWluIGluIDAuOCwgYW5kIHNpbmNlIHNvIG1hbnkgcGVvcGxlIHVzZSBpdAogICAgICAvLyB3ZSdsbCBhZGQgYW4gZXNwZWNpYWxseSBmcmllbmRseSByZW1pbmRlciB0byBtYWtlIHN1cmUgdGhleSBpbmNsdWRlZCBpdC4KCiAgICAgIGlmIChvcHRzLm1vZGUgPT0gInRpbWUiICYmICFheGlzLnRpY2tHZW5lcmF0b3IpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRpbWUgbW9kZSByZXF1aXJlcyB0aGUgZmxvdC50aW1lIHBsdWdpbi4iKTsKICAgICAgfSAvLyBGbG90IHN1cHBvcnRzIGJhc2UtMTAgYXhlczsgYW55IG90aGVyIG1vZGUgZWxzZSBpcyBoYW5kbGVkIGJ5IGEgcGx1Zy1pbiwKICAgICAgLy8gbGlrZSBmbG90LnRpbWUuanMuCgoKICAgICAgaWYgKCFheGlzLnRpY2tHZW5lcmF0b3IpIHsKICAgICAgICBheGlzLnRpY2tHZW5lcmF0b3IgPSBmdW5jdGlvbiAoYXhpcykgewogICAgICAgICAgdmFyIHRpY2tzID0gW10sCiAgICAgICAgICAgICAgc3RhcnQgPSBmbG9vckluQmFzZShheGlzLm1pbiwgYXhpcy50aWNrU2l6ZSksCiAgICAgICAgICAgICAgaSA9IDAsCiAgICAgICAgICAgICAgdiA9IE51bWJlci5OYU4sCiAgICAgICAgICAgICAgcHJldjsKCiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIHByZXYgPSB2OwogICAgICAgICAgICB2ID0gc3RhcnQgKyBpICogYXhpcy50aWNrU2l6ZTsKICAgICAgICAgICAgdGlja3MucHVzaCh2KTsKICAgICAgICAgICAgKytpOwogICAgICAgICAgfSB3aGlsZSAodiA8IGF4aXMubWF4ICYmIHYgIT0gcHJldik7CgogICAgICAgICAgcmV0dXJuIHRpY2tzOwogICAgICAgIH07CgogICAgICAgIGF4aXMudGlja0Zvcm1hdHRlciA9IGZ1bmN0aW9uICh2YWx1ZSwgYXhpcykgewogICAgICAgICAgdmFyIGZhY3RvciA9IGF4aXMudGlja0RlY2ltYWxzID8gTWF0aC5wb3coMTAsIGF4aXMudGlja0RlY2ltYWxzKSA6IDE7CiAgICAgICAgICB2YXIgZm9ybWF0dGVkID0gIiIgKyBNYXRoLnJvdW5kKHZhbHVlICogZmFjdG9yKSAvIGZhY3RvcjsgLy8gSWYgdGlja0RlY2ltYWxzIHdhcyBzcGVjaWZpZWQsIGVuc3VyZSB0aGF0IHdlIGhhdmUgZXhhY3RseSB0aGF0CiAgICAgICAgICAvLyBtdWNoIHByZWNpc2lvbjsgb3RoZXJ3aXNlIGRlZmF1bHQgdG8gdGhlIHZhbHVlJ3Mgb3duIHByZWNpc2lvbi4KCiAgICAgICAgICBpZiAoYXhpcy50aWNrRGVjaW1hbHMgIT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZGVjaW1hbCA9IGZvcm1hdHRlZC5pbmRleE9mKCIuIik7CiAgICAgICAgICAgIHZhciBwcmVjaXNpb24gPSBkZWNpbWFsID09IC0xID8gMCA6IGZvcm1hdHRlZC5sZW5ndGggLSBkZWNpbWFsIC0gMTsKCiAgICAgICAgICAgIGlmIChwcmVjaXNpb24gPCBheGlzLnRpY2tEZWNpbWFscykgewogICAgICAgICAgICAgIHJldHVybiAocHJlY2lzaW9uID8gZm9ybWF0dGVkIDogZm9ybWF0dGVkICsgIi4iKSArICgiIiArIGZhY3Rvcikuc3Vic3RyKDEsIGF4aXMudGlja0RlY2ltYWxzIC0gcHJlY2lzaW9uKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBmb3JtYXR0ZWQ7CiAgICAgICAgfTsKICAgICAgfQoKICAgICAgaWYgKCQuaXNGdW5jdGlvbihvcHRzLnRpY2tGb3JtYXR0ZXIpKSBheGlzLnRpY2tGb3JtYXR0ZXIgPSBmdW5jdGlvbiAodiwgYXhpcykgewogICAgICAgIHJldHVybiAiIiArIG9wdHMudGlja0Zvcm1hdHRlcih2LCBheGlzKTsKICAgICAgfTsKCiAgICAgIGlmIChvcHRzLmFsaWduVGlja3NXaXRoQXhpcyAhPSBudWxsKSB7CiAgICAgICAgdmFyIG90aGVyQXhpcyA9IChheGlzLmRpcmVjdGlvbiA9PSAieCIgPyB4YXhlcyA6IHlheGVzKVtvcHRzLmFsaWduVGlja3NXaXRoQXhpcyAtIDFdOwoKICAgICAgICBpZiAob3RoZXJBeGlzICYmIG90aGVyQXhpcy51c2VkICYmIG90aGVyQXhpcyAhPSBheGlzKSB7CiAgICAgICAgICAvLyBjb25zaWRlciBzbmFwcGluZyBtaW4vbWF4IHRvIG91dGVybW9zdCBuaWNlIHRpY2tzCiAgICAgICAgICB2YXIgbmljZVRpY2tzID0gYXhpcy50aWNrR2VuZXJhdG9yKGF4aXMpOwoKICAgICAgICAgIGlmIChuaWNlVGlja3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICBpZiAob3B0cy5taW4gPT0gbnVsbCkgYXhpcy5taW4gPSBNYXRoLm1pbihheGlzLm1pbiwgbmljZVRpY2tzWzBdKTsKICAgICAgICAgICAgaWYgKG9wdHMubWF4ID09IG51bGwgJiYgbmljZVRpY2tzLmxlbmd0aCA+IDEpIGF4aXMubWF4ID0gTWF0aC5tYXgoYXhpcy5tYXgsIG5pY2VUaWNrc1tuaWNlVGlja3MubGVuZ3RoIC0gMV0pOwogICAgICAgICAgfQoKICAgICAgICAgIGF4aXMudGlja0dlbmVyYXRvciA9IGZ1bmN0aW9uIChheGlzKSB7CiAgICAgICAgICAgIC8vIGNvcHkgdGlja3MsIHNjYWxlZCB0byB0aGlzIGF4aXMKICAgICAgICAgICAgdmFyIHRpY2tzID0gW10sCiAgICAgICAgICAgICAgICB2LAogICAgICAgICAgICAgICAgaTsKCiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBvdGhlckF4aXMudGlja3MubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICB2ID0gKG90aGVyQXhpcy50aWNrc1tpXS52IC0gb3RoZXJBeGlzLm1pbikgLyAob3RoZXJBeGlzLm1heCAtIG90aGVyQXhpcy5taW4pOwogICAgICAgICAgICAgIHYgPSBheGlzLm1pbiArIHYgKiAoYXhpcy5tYXggLSBheGlzLm1pbik7CiAgICAgICAgICAgICAgdGlja3MucHVzaCh2KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRpY2tzOwogICAgICAgICAgfTsgLy8gd2UgbWlnaHQgbmVlZCBhbiBleHRyYSBkZWNpbWFsIHNpbmNlIGZvcmNlZAogICAgICAgICAgLy8gdGlja3MgZG9uJ3QgbmVjZXNzYXJpbHkgZml0IG5hdHVyYWxseQoKCiAgICAgICAgICBpZiAoIWF4aXMubW9kZSAmJiBvcHRzLnRpY2tEZWNpbWFscyA9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBleHRyYURlYyA9IE1hdGgubWF4KDAsIC1NYXRoLmZsb29yKE1hdGgubG9nKGF4aXMuZGVsdGEpIC8gTWF0aC5MTjEwKSArIDEpLAogICAgICAgICAgICAgICAgdHMgPSBheGlzLnRpY2tHZW5lcmF0b3IoYXhpcyk7IC8vIG9ubHkgcHJvY2VlZCBpZiB0aGUgdGljayBpbnRlcnZhbCByb3VuZGVkCiAgICAgICAgICAgIC8vIHdpdGggYW4gZXh0cmEgZGVjaW1hbCBkb2Vzbid0IGdpdmUgdXMgYQogICAgICAgICAgICAvLyB6ZXJvIGF0IGVuZAoKICAgICAgICAgICAgaWYgKCEodHMubGVuZ3RoID4gMSAmJiAvXC4uKjAkLy50ZXN0KCh0c1sxXSAtIHRzWzBdKS50b0ZpeGVkKGV4dHJhRGVjKSkpKSBheGlzLnRpY2tEZWNpbWFscyA9IGV4dHJhRGVjOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHNldFRpY2tzKGF4aXMpIHsKICAgICAgdmFyIG90aWNrcyA9IGF4aXMub3B0aW9ucy50aWNrcywKICAgICAgICAgIHRpY2tzID0gW107CiAgICAgIGlmIChvdGlja3MgPT0gbnVsbCB8fCB0eXBlb2Ygb3RpY2tzID09ICJudW1iZXIiICYmIG90aWNrcyA+IDApIHRpY2tzID0gYXhpcy50aWNrR2VuZXJhdG9yKGF4aXMpO2Vsc2UgaWYgKG90aWNrcykgewogICAgICAgIGlmICgkLmlzRnVuY3Rpb24ob3RpY2tzKSkgLy8gZ2VuZXJhdGUgdGhlIHRpY2tzCiAgICAgICAgICB0aWNrcyA9IG90aWNrcyhheGlzKTtlbHNlIHRpY2tzID0gb3RpY2tzOwogICAgICB9IC8vIGNsZWFuIHVwL2xhYmVsaWZ5IHRoZSBzdXBwbGllZCB0aWNrcywgY29weSB0aGVtIG92ZXIKCiAgICAgIHZhciBpLCB2OwogICAgICBheGlzLnRpY2tzID0gW107CgogICAgICBmb3IgKGkgPSAwOyBpIDwgdGlja3MubGVuZ3RoOyArK2kpIHsKICAgICAgICB2YXIgbGFiZWwgPSBudWxsOwogICAgICAgIHZhciB0ID0gdGlja3NbaV07CgogICAgICAgIGlmIChfdHlwZW9mKHQpID09ICJvYmplY3QiKSB7CiAgICAgICAgICB2ID0gK3RbMF07CiAgICAgICAgICBpZiAodC5sZW5ndGggPiAxKSBsYWJlbCA9IHRbMV07CiAgICAgICAgfSBlbHNlIHYgPSArdDsKCiAgICAgICAgaWYgKGxhYmVsID09IG51bGwpIGxhYmVsID0gYXhpcy50aWNrRm9ybWF0dGVyKHYsIGF4aXMpOwogICAgICAgIGlmICghaXNOYU4odikpIGF4aXMudGlja3MucHVzaCh7CiAgICAgICAgICB2OiB2LAogICAgICAgICAgbGFiZWw6IGxhYmVsCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBzbmFwUmFuZ2VUb1RpY2tzKGF4aXMsIHRpY2tzKSB7CiAgICAgIGlmIChheGlzLm9wdGlvbnMuYXV0b3NjYWxlTWFyZ2luICYmIHRpY2tzLmxlbmd0aCA+IDApIHsKICAgICAgICAvLyBzbmFwIHRvIHRpY2tzCiAgICAgICAgaWYgKGF4aXMub3B0aW9ucy5taW4gPT0gbnVsbCkgYXhpcy5taW4gPSBNYXRoLm1pbihheGlzLm1pbiwgdGlja3NbMF0udik7CiAgICAgICAgaWYgKGF4aXMub3B0aW9ucy5tYXggPT0gbnVsbCAmJiB0aWNrcy5sZW5ndGggPiAxKSBheGlzLm1heCA9IE1hdGgubWF4KGF4aXMubWF4LCB0aWNrc1t0aWNrcy5sZW5ndGggLSAxXS52KTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGRyYXcoKSB7CiAgICAgIHN1cmZhY2UuY2xlYXIoKTsKICAgICAgZXhlY3V0ZUhvb2tzKGhvb2tzLmRyYXdCYWNrZ3JvdW5kLCBbY3R4XSk7CiAgICAgIHZhciBncmlkID0gb3B0aW9ucy5ncmlkOyAvLyBkcmF3IGJhY2tncm91bmQsIGlmIGFueQoKICAgICAgaWYgKGdyaWQuc2hvdyAmJiBncmlkLmJhY2tncm91bmRDb2xvcikgZHJhd0JhY2tncm91bmQoKTsKCiAgICAgIGlmIChncmlkLnNob3cgJiYgIWdyaWQuYWJvdmVEYXRhKSB7CiAgICAgICAgZHJhd0dyaWQoKTsKICAgICAgfQoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzZXJpZXMubGVuZ3RoOyArK2kpIHsKICAgICAgICBleGVjdXRlSG9va3MoaG9va3MuZHJhd1NlcmllcywgW2N0eCwgc2VyaWVzW2ldXSk7CiAgICAgICAgZHJhd1NlcmllcyhzZXJpZXNbaV0pOwogICAgICB9CgogICAgICBleGVjdXRlSG9va3MoaG9va3MuZHJhdywgW2N0eF0pOwoKICAgICAgaWYgKGdyaWQuc2hvdyAmJiBncmlkLmFib3ZlRGF0YSkgewogICAgICAgIGRyYXdHcmlkKCk7CiAgICAgIH0KCiAgICAgIHN1cmZhY2UucmVuZGVyKCk7IC8vIEEgZHJhdyBpbXBsaWVzIHRoYXQgZWl0aGVyIHRoZSBheGVzIG9yIGRhdGEgaGF2ZSBjaGFuZ2VkLCBzbyB3ZQogICAgICAvLyBzaG91bGQgcHJvYmFibHkgdXBkYXRlIHRoZSBvdmVybGF5IGhpZ2hsaWdodHMgYXMgd2VsbC4KCiAgICAgIHRyaWdnZXJSZWRyYXdPdmVybGF5KCk7CiAgICB9CgogICAgZnVuY3Rpb24gZXh0cmFjdFJhbmdlKHJhbmdlcywgY29vcmQpIHsKICAgICAgdmFyIGF4aXMsCiAgICAgICAgICBmcm9tLAogICAgICAgICAgdG8sCiAgICAgICAgICBrZXksCiAgICAgICAgICBheGVzID0gYWxsQXhlcygpOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBheGVzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgYXhpcyA9IGF4ZXNbaV07CgogICAgICAgIGlmIChheGlzLmRpcmVjdGlvbiA9PSBjb29yZCkgewogICAgICAgICAga2V5ID0gY29vcmQgKyBheGlzLm4gKyAiYXhpcyI7CiAgICAgICAgICBpZiAoIXJhbmdlc1trZXldICYmIGF4aXMubiA9PSAxKSBrZXkgPSBjb29yZCArICJheGlzIjsgLy8gc3VwcG9ydCB4MWF4aXMgYXMgeGF4aXMKCiAgICAgICAgICBpZiAocmFuZ2VzW2tleV0pIHsKICAgICAgICAgICAgZnJvbSA9IHJhbmdlc1trZXldLmZyb207CiAgICAgICAgICAgIHRvID0gcmFuZ2VzW2tleV0udG87CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSAvLyBiYWNrd2FyZHMtY29tcGF0IHN0dWZmIC0gdG8gYmUgcmVtb3ZlZCBpbiBmdXR1cmUKCgogICAgICBpZiAoIXJhbmdlc1trZXldKSB7CiAgICAgICAgYXhpcyA9IGNvb3JkID09ICJ4IiA/IHhheGVzWzBdIDogeWF4ZXNbMF07CiAgICAgICAgZnJvbSA9IHJhbmdlc1tjb29yZCArICIxIl07CiAgICAgICAgdG8gPSByYW5nZXNbY29vcmQgKyAiMiJdOwogICAgICB9IC8vIGF1dG8tcmV2ZXJzZSBhcyBhbiBhZGRlZCBib251cwoKCiAgICAgIGlmIChmcm9tICE9IG51bGwgJiYgdG8gIT0gbnVsbCAmJiBmcm9tID4gdG8pIHsKICAgICAgICB2YXIgdG1wID0gZnJvbTsKICAgICAgICBmcm9tID0gdG87CiAgICAgICAgdG8gPSB0bXA7CiAgICAgIH0KCiAgICAgIHJldHVybiB7CiAgICAgICAgZnJvbTogZnJvbSwKICAgICAgICB0bzogdG8sCiAgICAgICAgYXhpczogYXhpcwogICAgICB9OwogICAgfQoKICAgIGZ1bmN0aW9uIGRyYXdCYWNrZ3JvdW5kKCkgewogICAgICBjdHguc2F2ZSgpOwogICAgICBjdHgudHJhbnNsYXRlKHBsb3RPZmZzZXQubGVmdCwgcGxvdE9mZnNldC50b3ApOwogICAgICBjdHguZmlsbFN0eWxlID0gZ2V0Q29sb3JPckdyYWRpZW50KG9wdGlvbnMuZ3JpZC5iYWNrZ3JvdW5kQ29sb3IsIHBsb3RIZWlnaHQsIDAsICJyZ2JhKDI1NSwgMjU1LCAyNTUsIDApIik7CiAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCBwbG90V2lkdGgsIHBsb3RIZWlnaHQpOwogICAgICBjdHgucmVzdG9yZSgpOwogICAgfQoKICAgIGZ1bmN0aW9uIGRyYXdHcmlkKCkgewogICAgICB2YXIgaSwgYXhlcywgYncsIGJjOwogICAgICBjdHguc2F2ZSgpOwogICAgICBjdHgudHJhbnNsYXRlKHBsb3RPZmZzZXQubGVmdCwgcGxvdE9mZnNldC50b3ApOyAvLyBkcmF3IG1hcmtpbmdzCgogICAgICB2YXIgbWFya2luZ3MgPSBvcHRpb25zLmdyaWQubWFya2luZ3M7CgogICAgICBpZiAobWFya2luZ3MpIHsKICAgICAgICBpZiAoJC5pc0Z1bmN0aW9uKG1hcmtpbmdzKSkgewogICAgICAgICAgYXhlcyA9IHBsb3QuZ2V0QXhlcygpOyAvLyB4bWluIGV0Yy4gaXMgYmFja3dhcmRzIGNvbXBhdGliaWxpdHksIHRvIGJlCiAgICAgICAgICAvLyByZW1vdmVkIGluIHRoZSBmdXR1cmUKCiAgICAgICAgICBheGVzLnhtaW4gPSBheGVzLnhheGlzLm1pbjsKICAgICAgICAgIGF4ZXMueG1heCA9IGF4ZXMueGF4aXMubWF4OwogICAgICAgICAgYXhlcy55bWluID0gYXhlcy55YXhpcy5taW47CiAgICAgICAgICBheGVzLnltYXggPSBheGVzLnlheGlzLm1heDsKICAgICAgICAgIG1hcmtpbmdzID0gbWFya2luZ3MoYXhlcyk7CiAgICAgICAgfQoKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbWFya2luZ3MubGVuZ3RoOyArK2kpIHsKICAgICAgICAgIHZhciBtID0gbWFya2luZ3NbaV0sCiAgICAgICAgICAgICAgeHJhbmdlID0gZXh0cmFjdFJhbmdlKG0sICJ4IiksCiAgICAgICAgICAgICAgeXJhbmdlID0gZXh0cmFjdFJhbmdlKG0sICJ5Iik7IC8vIGZpbGwgaW4gbWlzc2luZwoKICAgICAgICAgIGlmICh4cmFuZ2UuZnJvbSA9PSBudWxsKSB4cmFuZ2UuZnJvbSA9IHhyYW5nZS5heGlzLm1pbjsKICAgICAgICAgIGlmICh4cmFuZ2UudG8gPT0gbnVsbCkgeHJhbmdlLnRvID0geHJhbmdlLmF4aXMubWF4OwogICAgICAgICAgaWYgKHlyYW5nZS5mcm9tID09IG51bGwpIHlyYW5nZS5mcm9tID0geXJhbmdlLmF4aXMubWluOwogICAgICAgICAgaWYgKHlyYW5nZS50byA9PSBudWxsKSB5cmFuZ2UudG8gPSB5cmFuZ2UuYXhpcy5tYXg7IC8vIGNsaXAKCiAgICAgICAgICBpZiAoeHJhbmdlLnRvIDwgeHJhbmdlLmF4aXMubWluIHx8IHhyYW5nZS5mcm9tID4geHJhbmdlLmF4aXMubWF4IHx8IHlyYW5nZS50byA8IHlyYW5nZS5heGlzLm1pbiB8fCB5cmFuZ2UuZnJvbSA+IHlyYW5nZS5heGlzLm1heCkgY29udGludWU7CiAgICAgICAgICB4cmFuZ2UuZnJvbSA9IE1hdGgubWF4KHhyYW5nZS5mcm9tLCB4cmFuZ2UuYXhpcy5taW4pOwogICAgICAgICAgeHJhbmdlLnRvID0gTWF0aC5taW4oeHJhbmdlLnRvLCB4cmFuZ2UuYXhpcy5tYXgpOwogICAgICAgICAgeXJhbmdlLmZyb20gPSBNYXRoLm1heCh5cmFuZ2UuZnJvbSwgeXJhbmdlLmF4aXMubWluKTsKICAgICAgICAgIHlyYW5nZS50byA9IE1hdGgubWluKHlyYW5nZS50bywgeXJhbmdlLmF4aXMubWF4KTsKICAgICAgICAgIHZhciB4ZXF1YWwgPSB4cmFuZ2UuZnJvbSA9PT0geHJhbmdlLnRvLAogICAgICAgICAgICAgIHllcXVhbCA9IHlyYW5nZS5mcm9tID09PSB5cmFuZ2UudG87CgogICAgICAgICAgaWYgKHhlcXVhbCAmJiB5ZXF1YWwpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9IC8vIHRoZW4gZHJhdwoKCiAgICAgICAgICB4cmFuZ2UuZnJvbSA9IE1hdGguZmxvb3IoeHJhbmdlLmF4aXMucDJjKHhyYW5nZS5mcm9tKSk7CiAgICAgICAgICB4cmFuZ2UudG8gPSBNYXRoLmZsb29yKHhyYW5nZS5heGlzLnAyYyh4cmFuZ2UudG8pKTsKICAgICAgICAgIHlyYW5nZS5mcm9tID0gTWF0aC5mbG9vcih5cmFuZ2UuYXhpcy5wMmMoeXJhbmdlLmZyb20pKTsKICAgICAgICAgIHlyYW5nZS50byA9IE1hdGguZmxvb3IoeXJhbmdlLmF4aXMucDJjKHlyYW5nZS50bykpOwoKICAgICAgICAgIGlmICh4ZXF1YWwgfHwgeWVxdWFsKSB7CiAgICAgICAgICAgIHZhciBsaW5lV2lkdGggPSBtLmxpbmVXaWR0aCB8fCBvcHRpb25zLmdyaWQubWFya2luZ3NMaW5lV2lkdGgsCiAgICAgICAgICAgICAgICBzdWJQaXhlbCA9IGxpbmVXaWR0aCAlIDIgPyAwLjUgOiAwOwogICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9IG0uY29sb3IgfHwgb3B0aW9ucy5ncmlkLm1hcmtpbmdzQ29sb3I7CiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSBsaW5lV2lkdGg7CgogICAgICAgICAgICBpZiAoeGVxdWFsKSB7CiAgICAgICAgICAgICAgY3R4Lm1vdmVUbyh4cmFuZ2UudG8gKyBzdWJQaXhlbCwgeXJhbmdlLmZyb20pOwogICAgICAgICAgICAgIGN0eC5saW5lVG8oeHJhbmdlLnRvICsgc3ViUGl4ZWwsIHlyYW5nZS50byk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY3R4Lm1vdmVUbyh4cmFuZ2UuZnJvbSwgeXJhbmdlLnRvICsgc3ViUGl4ZWwpOwogICAgICAgICAgICAgIGN0eC5saW5lVG8oeHJhbmdlLnRvLCB5cmFuZ2UudG8gKyBzdWJQaXhlbCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSBtLmNvbG9yIHx8IG9wdGlvbnMuZ3JpZC5tYXJraW5nc0NvbG9yOwogICAgICAgICAgICBjdHguZmlsbFJlY3QoeHJhbmdlLmZyb20sIHlyYW5nZS50bywgeHJhbmdlLnRvIC0geHJhbmdlLmZyb20sIHlyYW5nZS5mcm9tIC0geXJhbmdlLnRvKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gLy8gZHJhdyB0aGUgdGlja3MKCgogICAgICBheGVzID0gYWxsQXhlcygpOwogICAgICBidyA9IG9wdGlvbnMuZ3JpZC5ib3JkZXJXaWR0aDsKCiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgYXhlcy5sZW5ndGg7ICsraikgewogICAgICAgIHZhciBheGlzID0gYXhlc1tqXSwKICAgICAgICAgICAgYm94ID0gYXhpcy5ib3gsCiAgICAgICAgICAgIHQgPSBheGlzLnRpY2tMZW5ndGgsCiAgICAgICAgICAgIHgsCiAgICAgICAgICAgIHksCiAgICAgICAgICAgIHhvZmYsCiAgICAgICAgICAgIHlvZmY7CiAgICAgICAgaWYgKCFheGlzLnNob3cgfHwgYXhpcy50aWNrcy5sZW5ndGggPT0gMCkgY29udGludWU7CiAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDE7IC8vIGZpbmQgdGhlIGVkZ2VzCgogICAgICAgIGlmIChheGlzLmRpcmVjdGlvbiA9PSAieCIpIHsKICAgICAgICAgIHggPSAwOwogICAgICAgICAgaWYgKHQgPT0gImZ1bGwiKSB5ID0gYXhpcy5wb3NpdGlvbiA9PSAidG9wIiA/IDAgOiBwbG90SGVpZ2h0O2Vsc2UgeSA9IGJveC50b3AgLSBwbG90T2Zmc2V0LnRvcCArIChheGlzLnBvc2l0aW9uID09ICJ0b3AiID8gYm94LmhlaWdodCA6IDApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB5ID0gMDsKICAgICAgICAgIGlmICh0ID09ICJmdWxsIikgeCA9IGF4aXMucG9zaXRpb24gPT0gImxlZnQiID8gMCA6IHBsb3RXaWR0aDtlbHNlIHggPSBib3gubGVmdCAtIHBsb3RPZmZzZXQubGVmdCArIChheGlzLnBvc2l0aW9uID09ICJsZWZ0IiA/IGJveC53aWR0aCA6IDApOwogICAgICAgIH0gLy8gZHJhdyB0aWNrIGJhcgoKCiAgICAgICAgaWYgKCFheGlzLmlubmVybW9zdCkgewogICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gYXhpcy5vcHRpb25zLmNvbG9yOwogICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgeG9mZiA9IHlvZmYgPSAwOwogICAgICAgICAgaWYgKGF4aXMuZGlyZWN0aW9uID09ICJ4IikgeG9mZiA9IHBsb3RXaWR0aCArIDE7ZWxzZSB5b2ZmID0gcGxvdEhlaWdodCArIDE7CgogICAgICAgICAgaWYgKGN0eC5saW5lV2lkdGggPT0gMSkgewogICAgICAgICAgICBpZiAoYXhpcy5kaXJlY3Rpb24gPT0gIngiKSB7CiAgICAgICAgICAgICAgeSA9IE1hdGguZmxvb3IoeSkgKyAwLjU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgeCA9IE1hdGguZmxvb3IoeCkgKyAwLjU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBjdHgubW92ZVRvKHgsIHkpOwogICAgICAgICAgY3R4LmxpbmVUbyh4ICsgeG9mZiwgeSArIHlvZmYpOwogICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgIH0gLy8gZHJhdyB0aWNrcwoKCiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gYXhpcy5vcHRpb25zLnRpY2tDb2xvcjsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7CgogICAgICAgIGZvciAoaSA9IDA7IGkgPCBheGlzLnRpY2tzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICB2YXIgdiA9IGF4aXMudGlja3NbaV0udjsKICAgICAgICAgIHhvZmYgPSB5b2ZmID0gMDsKICAgICAgICAgIGlmIChpc05hTih2KSB8fCB2IDwgYXhpcy5taW4gfHwgdiA+IGF4aXMubWF4IC8vIHNraXAgdGhvc2UgbHlpbmcgb24gdGhlIGF4ZXMgaWYgd2UgZ290IGEgYm9yZGVyCiAgICAgICAgICB8fCB0ID09ICJmdWxsIiAmJiAoX3R5cGVvZihidykgPT0gIm9iamVjdCIgJiYgYndbYXhpcy5wb3NpdGlvbl0gPiAwIHx8IGJ3ID4gMCkgJiYgKHYgPT0gYXhpcy5taW4gfHwgdiA9PSBheGlzLm1heCkpIGNvbnRpbnVlOwoKICAgICAgICAgIGlmIChheGlzLmRpcmVjdGlvbiA9PSAieCIpIHsKICAgICAgICAgICAgeCA9IGF4aXMucDJjKHYpOwogICAgICAgICAgICB5b2ZmID0gdCA9PSAiZnVsbCIgPyAtcGxvdEhlaWdodCA6IHQ7CiAgICAgICAgICAgIGlmIChheGlzLnBvc2l0aW9uID09ICJ0b3AiKSB5b2ZmID0gLXlvZmY7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB5ID0gYXhpcy5wMmModik7CiAgICAgICAgICAgIHhvZmYgPSB0ID09ICJmdWxsIiA/IC1wbG90V2lkdGggOiB0OwogICAgICAgICAgICBpZiAoYXhpcy5wb3NpdGlvbiA9PSAibGVmdCIpIHhvZmYgPSAteG9mZjsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoY3R4LmxpbmVXaWR0aCA9PSAxKSB7CiAgICAgICAgICAgIGlmIChheGlzLmRpcmVjdGlvbiA9PSAieCIpIHggPSBNYXRoLmZsb29yKHgpICsgMC41O2Vsc2UgeSA9IE1hdGguZmxvb3IoeSkgKyAwLjU7CiAgICAgICAgICB9CgogICAgICAgICAgY3R4Lm1vdmVUbyh4LCB5KTsKICAgICAgICAgIGN0eC5saW5lVG8oeCArIHhvZmYsIHkgKyB5b2ZmKTsKICAgICAgICB9CgogICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgfSAvLyBkcmF3IGJvcmRlcgoKCiAgICAgIGlmIChidykgewogICAgICAgIC8vIElmIGVpdGhlciBib3JkZXJXaWR0aCBvciBib3JkZXJDb2xvciBpcyBhbiBvYmplY3QsIHRoZW4gZHJhdyB0aGUgYm9yZGVyCiAgICAgICAgLy8gbGluZSBieSBsaW5lIGluc3RlYWQgb2YgYXMgb25lIHJlY3RhbmdsZQogICAgICAgIGJjID0gb3B0aW9ucy5ncmlkLmJvcmRlckNvbG9yOwoKICAgICAgICBpZiAoX3R5cGVvZihidykgPT0gIm9iamVjdCIgfHwgX3R5cGVvZihiYykgPT0gIm9iamVjdCIpIHsKICAgICAgICAgIGlmIChfdHlwZW9mKGJ3KSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgYncgPSB7CiAgICAgICAgICAgICAgdG9wOiBidywKICAgICAgICAgICAgICByaWdodDogYncsCiAgICAgICAgICAgICAgYm90dG9tOiBidywKICAgICAgICAgICAgICBsZWZ0OiBidwogICAgICAgICAgICB9OwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChfdHlwZW9mKGJjKSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgYmMgPSB7CiAgICAgICAgICAgICAgdG9wOiBiYywKICAgICAgICAgICAgICByaWdodDogYmMsCiAgICAgICAgICAgICAgYm90dG9tOiBiYywKICAgICAgICAgICAgICBsZWZ0OiBiYwogICAgICAgICAgICB9OwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChidy50b3AgPiAwKSB7CiAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9IGJjLnRvcDsKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IGJ3LnRvcDsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHgubW92ZVRvKDAgLSBidy5sZWZ0LCAwIC0gYncudG9wIC8gMik7CiAgICAgICAgICAgIGN0eC5saW5lVG8ocGxvdFdpZHRoLCAwIC0gYncudG9wIC8gMik7CiAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoYncucmlnaHQgPiAwKSB7CiAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9IGJjLnJpZ2h0OwogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gYncucmlnaHQ7CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4Lm1vdmVUbyhwbG90V2lkdGggKyBidy5yaWdodCAvIDIsIDAgLSBidy50b3ApOwogICAgICAgICAgICBjdHgubGluZVRvKHBsb3RXaWR0aCArIGJ3LnJpZ2h0IC8gMiwgcGxvdEhlaWdodCk7CiAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoYncuYm90dG9tID4gMCkgewogICAgICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSBiYy5ib3R0b207CiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSBidy5ib3R0b207CiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4Lm1vdmVUbyhwbG90V2lkdGggKyBidy5yaWdodCwgcGxvdEhlaWdodCArIGJ3LmJvdHRvbSAvIDIpOwogICAgICAgICAgICBjdHgubGluZVRvKDAsIHBsb3RIZWlnaHQgKyBidy5ib3R0b20gLyAyKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChidy5sZWZ0ID4gMCkgewogICAgICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSBiYy5sZWZ0OwogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gYncubGVmdDsKICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBjdHgubW92ZVRvKDAgLSBidy5sZWZ0IC8gMiwgcGxvdEhlaWdodCArIGJ3LmJvdHRvbSk7CiAgICAgICAgICAgIGN0eC5saW5lVG8oMCAtIGJ3LmxlZnQgLyAyLCAwKTsKICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjdHgubGluZVdpZHRoID0gYnc7CiAgICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSBvcHRpb25zLmdyaWQuYm9yZGVyQ29sb3I7CiAgICAgICAgICBjdHguc3Ryb2tlUmVjdCgtYncgLyAyLCAtYncgLyAyLCBwbG90V2lkdGggKyBidywgcGxvdEhlaWdodCArIGJ3KTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICB9CgogICAgZnVuY3Rpb24gZHJhd0F4aXNMYWJlbHMoKSB7CiAgICAgICQuZWFjaChhbGxBeGVzKCksIGZ1bmN0aW9uIChfLCBheGlzKSB7CiAgICAgICAgdmFyIGJveCA9IGF4aXMuYm94LAogICAgICAgICAgICBsZWdhY3lTdHlsZXMgPSBheGlzLmRpcmVjdGlvbiArICJBeGlzICIgKyBheGlzLmRpcmVjdGlvbiArIGF4aXMubiArICJBeGlzIiwKICAgICAgICAgICAgbGF5ZXIgPSAiZmxvdC0iICsgYXhpcy5kaXJlY3Rpb24gKyAiLWF4aXMgZmxvdC0iICsgYXhpcy5kaXJlY3Rpb24gKyBheGlzLm4gKyAiLWF4aXMgIiArIGxlZ2FjeVN0eWxlcywKICAgICAgICAgICAgZm9udCA9IGF4aXMub3B0aW9ucy5mb250IHx8ICJmbG90LXRpY2stbGFiZWwgdGlja0xhYmVsIiwKICAgICAgICAgICAgdGljaywKICAgICAgICAgICAgeCwKICAgICAgICAgICAgeSwKICAgICAgICAgICAgaGFsaWduLAogICAgICAgICAgICB2YWxpZ247IC8vIFJlbW92ZSB0ZXh0IGJlZm9yZSBjaGVja2luZyBmb3IgYXhpcy5zaG93IGFuZCB0aWNrcy5sZW5ndGg7CiAgICAgICAgLy8gb3RoZXJ3aXNlIHBsdWdpbnMsIGxpa2UgZmxvdC10aWNrcm90b3IsIHRoYXQgZHJhdyB0aGVpciBvd24KICAgICAgICAvLyB0aWNrIGxhYmVscyB3aWxsIGVuZCB1cCB3aXRoIGJvdGggdGhlaXJzIGFuZCB0aGUgZGVmYXVsdHMuCgogICAgICAgIHN1cmZhY2UucmVtb3ZlVGV4dChsYXllcik7CiAgICAgICAgaWYgKCFheGlzLnNob3cgfHwgYXhpcy50aWNrcy5sZW5ndGggPT0gMCkgcmV0dXJuOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGF4aXMudGlja3MubGVuZ3RoOyArK2kpIHsKICAgICAgICAgIHRpY2sgPSBheGlzLnRpY2tzW2ldOwogICAgICAgICAgaWYgKCF0aWNrLmxhYmVsIHx8IHRpY2sudiA8IGF4aXMubWluIHx8IHRpY2sudiA+IGF4aXMubWF4KSBjb250aW51ZTsKCiAgICAgICAgICBpZiAoYXhpcy5kaXJlY3Rpb24gPT0gIngiKSB7CiAgICAgICAgICAgIGhhbGlnbiA9ICJjZW50ZXIiOwogICAgICAgICAgICB4ID0gcGxvdE9mZnNldC5sZWZ0ICsgYXhpcy5wMmModGljay52KTsKCiAgICAgICAgICAgIGlmIChheGlzLnBvc2l0aW9uID09ICJib3R0b20iKSB7CiAgICAgICAgICAgICAgeSA9IGJveC50b3AgKyBib3gucGFkZGluZzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB5ID0gYm94LnRvcCArIGJveC5oZWlnaHQgLSBib3gucGFkZGluZzsKICAgICAgICAgICAgICB2YWxpZ24gPSAiYm90dG9tIjsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFsaWduID0gIm1pZGRsZSI7CiAgICAgICAgICAgIHkgPSBwbG90T2Zmc2V0LnRvcCArIGF4aXMucDJjKHRpY2sudik7CgogICAgICAgICAgICBpZiAoYXhpcy5wb3NpdGlvbiA9PSAibGVmdCIpIHsKICAgICAgICAgICAgICB4ID0gYm94LmxlZnQgKyBib3gud2lkdGggLSBib3gucGFkZGluZzsKICAgICAgICAgICAgICBoYWxpZ24gPSAicmlnaHQiOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHggPSBib3gubGVmdCArIGJveC5wYWRkaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgc3VyZmFjZS5hZGRUZXh0KGxheWVyLCB4LCB5LCB0aWNrLmxhYmVsLCBmb250LCBudWxsLCBudWxsLCBoYWxpZ24sIHZhbGlnbik7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCiAgICBmdW5jdGlvbiBkcmF3U2VyaWVzKHNlcmllcykgewogICAgICBpZiAoc2VyaWVzLmxpbmVzLnNob3cpIGRyYXdTZXJpZXNMaW5lcyhzZXJpZXMpOwogICAgICBpZiAoc2VyaWVzLmJhcnMuc2hvdykgZHJhd1Nlcmllc0JhcnMoc2VyaWVzKTsKICAgICAgaWYgKHNlcmllcy5wb2ludHMuc2hvdykgZHJhd1Nlcmllc1BvaW50cyhzZXJpZXMpOwogICAgfQoKICAgIGZ1bmN0aW9uIGRyYXdTZXJpZXNMaW5lcyhzZXJpZXMpIHsKICAgICAgZnVuY3Rpb24gcGxvdExpbmUoZGF0YXBvaW50cywgeG9mZnNldCwgeW9mZnNldCwgYXhpc3gsIGF4aXN5KSB7CiAgICAgICAgdmFyIHBvaW50cyA9IGRhdGFwb2ludHMucG9pbnRzLAogICAgICAgICAgICBwcyA9IGRhdGFwb2ludHMucG9pbnRzaXplLAogICAgICAgICAgICBwcmV2eCA9IG51bGwsCiAgICAgICAgICAgIHByZXZ5ID0gbnVsbDsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7CgogICAgICAgIGZvciAodmFyIGkgPSBwczsgaSA8IHBvaW50cy5sZW5ndGg7IGkgKz0gcHMpIHsKICAgICAgICAgIHZhciB4MSA9IHBvaW50c1tpIC0gcHNdLAogICAgICAgICAgICAgIHkxID0gcG9pbnRzW2kgLSBwcyArIDFdLAogICAgICAgICAgICAgIHgyID0gcG9pbnRzW2ldLAogICAgICAgICAgICAgIHkyID0gcG9pbnRzW2kgKyAxXTsKICAgICAgICAgIGlmICh4MSA9PSBudWxsIHx8IHgyID09IG51bGwpIGNvbnRpbnVlOyAvLyBjbGlwIHdpdGggeW1pbgoKICAgICAgICAgIGlmICh5MSA8PSB5MiAmJiB5MSA8IGF4aXN5Lm1pbikgewogICAgICAgICAgICBpZiAoeTIgPCBheGlzeS5taW4pIGNvbnRpbnVlOyAvLyBsaW5lIHNlZ21lbnQgaXMgb3V0c2lkZQogICAgICAgICAgICAvLyBjb21wdXRlIG5ldyBpbnRlcnNlY3Rpb24gcG9pbnQKCiAgICAgICAgICAgIHgxID0gKGF4aXN5Lm1pbiAtIHkxKSAvICh5MiAtIHkxKSAqICh4MiAtIHgxKSArIHgxOwogICAgICAgICAgICB5MSA9IGF4aXN5Lm1pbjsKICAgICAgICAgIH0gZWxzZSBpZiAoeTIgPD0geTEgJiYgeTIgPCBheGlzeS5taW4pIHsKICAgICAgICAgICAgaWYgKHkxIDwgYXhpc3kubWluKSBjb250aW51ZTsKICAgICAgICAgICAgeDIgPSAoYXhpc3kubWluIC0geTEpIC8gKHkyIC0geTEpICogKHgyIC0geDEpICsgeDE7CiAgICAgICAgICAgIHkyID0gYXhpc3kubWluOwogICAgICAgICAgfSAvLyBjbGlwIHdpdGggeW1heAoKCiAgICAgICAgICBpZiAoeTEgPj0geTIgJiYgeTEgPiBheGlzeS5tYXgpIHsKICAgICAgICAgICAgaWYgKHkyID4gYXhpc3kubWF4KSBjb250aW51ZTsKICAgICAgICAgICAgeDEgPSAoYXhpc3kubWF4IC0geTEpIC8gKHkyIC0geTEpICogKHgyIC0geDEpICsgeDE7CiAgICAgICAgICAgIHkxID0gYXhpc3kubWF4OwogICAgICAgICAgfSBlbHNlIGlmICh5MiA+PSB5MSAmJiB5MiA+IGF4aXN5Lm1heCkgewogICAgICAgICAgICBpZiAoeTEgPiBheGlzeS5tYXgpIGNvbnRpbnVlOwogICAgICAgICAgICB4MiA9IChheGlzeS5tYXggLSB5MSkgLyAoeTIgLSB5MSkgKiAoeDIgLSB4MSkgKyB4MTsKICAgICAgICAgICAgeTIgPSBheGlzeS5tYXg7CiAgICAgICAgICB9IC8vIGNsaXAgd2l0aCB4bWluCgoKICAgICAgICAgIGlmICh4MSA8PSB4MiAmJiB4MSA8IGF4aXN4Lm1pbikgewogICAgICAgICAgICBpZiAoeDIgPCBheGlzeC5taW4pIGNvbnRpbnVlOwogICAgICAgICAgICB5MSA9IChheGlzeC5taW4gLSB4MSkgLyAoeDIgLSB4MSkgKiAoeTIgLSB5MSkgKyB5MTsKICAgICAgICAgICAgeDEgPSBheGlzeC5taW47CiAgICAgICAgICB9IGVsc2UgaWYgKHgyIDw9IHgxICYmIHgyIDwgYXhpc3gubWluKSB7CiAgICAgICAgICAgIGlmICh4MSA8IGF4aXN4Lm1pbikgY29udGludWU7CiAgICAgICAgICAgIHkyID0gKGF4aXN4Lm1pbiAtIHgxKSAvICh4MiAtIHgxKSAqICh5MiAtIHkxKSArIHkxOwogICAgICAgICAgICB4MiA9IGF4aXN4Lm1pbjsKICAgICAgICAgIH0gLy8gY2xpcCB3aXRoIHhtYXgKCgogICAgICAgICAgaWYgKHgxID49IHgyICYmIHgxID4gYXhpc3gubWF4KSB7CiAgICAgICAgICAgIGlmICh4MiA+IGF4aXN4Lm1heCkgY29udGludWU7CiAgICAgICAgICAgIHkxID0gKGF4aXN4Lm1heCAtIHgxKSAvICh4MiAtIHgxKSAqICh5MiAtIHkxKSArIHkxOwogICAgICAgICAgICB4MSA9IGF4aXN4Lm1heDsKICAgICAgICAgIH0gZWxzZSBpZiAoeDIgPj0geDEgJiYgeDIgPiBheGlzeC5tYXgpIHsKICAgICAgICAgICAgaWYgKHgxID4gYXhpc3gubWF4KSBjb250aW51ZTsKICAgICAgICAgICAgeTIgPSAoYXhpc3gubWF4IC0geDEpIC8gKHgyIC0geDEpICogKHkyIC0geTEpICsgeTE7CiAgICAgICAgICAgIHgyID0gYXhpc3gubWF4OwogICAgICAgICAgfQoKICAgICAgICAgIGlmICh4MSAhPSBwcmV2eCB8fCB5MSAhPSBwcmV2eSkgY3R4Lm1vdmVUbyhheGlzeC5wMmMoeDEpICsgeG9mZnNldCwgYXhpc3kucDJjKHkxKSArIHlvZmZzZXQpOwogICAgICAgICAgcHJldnggPSB4MjsKICAgICAgICAgIHByZXZ5ID0geTI7CiAgICAgICAgICBjdHgubGluZVRvKGF4aXN4LnAyYyh4MikgKyB4b2Zmc2V0LCBheGlzeS5wMmMoeTIpICsgeW9mZnNldCk7CiAgICAgICAgfQoKICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHBsb3RMaW5lQXJlYShkYXRhcG9pbnRzLCBheGlzeCwgYXhpc3kpIHsKICAgICAgICB2YXIgcG9pbnRzID0gZGF0YXBvaW50cy5wb2ludHMsCiAgICAgICAgICAgIHBzID0gZGF0YXBvaW50cy5wb2ludHNpemUsCiAgICAgICAgICAgIGJvdHRvbSA9IE1hdGgubWluKE1hdGgubWF4KDAsIGF4aXN5Lm1pbiksIGF4aXN5Lm1heCksCiAgICAgICAgICAgIGkgPSAwLAogICAgICAgICAgICB0b3AsCiAgICAgICAgICAgIGFyZWFPcGVuID0gZmFsc2UsCiAgICAgICAgICAgIHlwb3MgPSAxLAogICAgICAgICAgICBzZWdtZW50U3RhcnQgPSAwLAogICAgICAgICAgICBzZWdtZW50RW5kID0gMDsgLy8gd2UgcHJvY2VzcyBlYWNoIHNlZ21lbnQgaW4gdHdvIHR1cm5zLCBmaXJzdCBmb3J3YXJkCiAgICAgICAgLy8gZGlyZWN0aW9uIHRvIHNrZXRjaCBvdXQgdG9wLCB0aGVuIG9uY2Ugd2UgaGl0IHRoZQogICAgICAgIC8vIGVuZCB3ZSBnbyBiYWNrd2FyZHMgdG8gc2tldGNoIHRoZSBib3R0b20KCiAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgIGlmIChwcyA+IDAgJiYgaSA+IHBvaW50cy5sZW5ndGggKyBwcykgYnJlYWs7CiAgICAgICAgICBpICs9IHBzOyAvLyBwcyBpcyBuZWdhdGl2ZSBpZiBnb2luZyBiYWNrd2FyZHMKCiAgICAgICAgICB2YXIgeDEgPSBwb2ludHNbaSAtIHBzXSwKICAgICAgICAgICAgICB5MSA9IHBvaW50c1tpIC0gcHMgKyB5cG9zXSwKICAgICAgICAgICAgICB4MiA9IHBvaW50c1tpXSwKICAgICAgICAgICAgICB5MiA9IHBvaW50c1tpICsgeXBvc107CgogICAgICAgICAgaWYgKGFyZWFPcGVuKSB7CiAgICAgICAgICAgIGlmIChwcyA+IDAgJiYgeDEgIT0gbnVsbCAmJiB4MiA9PSBudWxsKSB7CiAgICAgICAgICAgICAgLy8gYXQgdHVybmluZyBwb2ludAogICAgICAgICAgICAgIHNlZ21lbnRFbmQgPSBpOwogICAgICAgICAgICAgIHBzID0gLXBzOwogICAgICAgICAgICAgIHlwb3MgPSAyOwogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAocHMgPCAwICYmIGkgPT0gc2VnbWVudFN0YXJ0ICsgcHMpIHsKICAgICAgICAgICAgICAvLyBkb25lIHdpdGggdGhlIHJldmVyc2Ugc3dlZXAKICAgICAgICAgICAgICBjdHguZmlsbCgpOwogICAgICAgICAgICAgIGFyZWFPcGVuID0gZmFsc2U7CiAgICAgICAgICAgICAgcHMgPSAtcHM7CiAgICAgICAgICAgICAgeXBvcyA9IDE7CiAgICAgICAgICAgICAgaSA9IHNlZ21lbnRTdGFydCA9IHNlZ21lbnRFbmQgKyBwczsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGlmICh4MSA9PSBudWxsIHx8IHgyID09IG51bGwpIGNvbnRpbnVlOyAvLyBjbGlwIHggdmFsdWVzCiAgICAgICAgICAvLyBjbGlwIHdpdGggeG1pbgoKICAgICAgICAgIGlmICh4MSA8PSB4MiAmJiB4MSA8IGF4aXN4Lm1pbikgewogICAgICAgICAgICBpZiAoeDIgPCBheGlzeC5taW4pIGNvbnRpbnVlOwogICAgICAgICAgICB5MSA9IChheGlzeC5taW4gLSB4MSkgLyAoeDIgLSB4MSkgKiAoeTIgLSB5MSkgKyB5MTsKICAgICAgICAgICAgeDEgPSBheGlzeC5taW47CiAgICAgICAgICB9IGVsc2UgaWYgKHgyIDw9IHgxICYmIHgyIDwgYXhpc3gubWluKSB7CiAgICAgICAgICAgIGlmICh4MSA8IGF4aXN4Lm1pbikgY29udGludWU7CiAgICAgICAgICAgIHkyID0gKGF4aXN4Lm1pbiAtIHgxKSAvICh4MiAtIHgxKSAqICh5MiAtIHkxKSArIHkxOwogICAgICAgICAgICB4MiA9IGF4aXN4Lm1pbjsKICAgICAgICAgIH0gLy8gY2xpcCB3aXRoIHhtYXgKCgogICAgICAgICAgaWYgKHgxID49IHgyICYmIHgxID4gYXhpc3gubWF4KSB7CiAgICAgICAgICAgIGlmICh4MiA+IGF4aXN4Lm1heCkgY29udGludWU7CiAgICAgICAgICAgIHkxID0gKGF4aXN4Lm1heCAtIHgxKSAvICh4MiAtIHgxKSAqICh5MiAtIHkxKSArIHkxOwogICAgICAgICAgICB4MSA9IGF4aXN4Lm1heDsKICAgICAgICAgIH0gZWxzZSBpZiAoeDIgPj0geDEgJiYgeDIgPiBheGlzeC5tYXgpIHsKICAgICAgICAgICAgaWYgKHgxID4gYXhpc3gubWF4KSBjb250aW51ZTsKICAgICAgICAgICAgeTIgPSAoYXhpc3gubWF4IC0geDEpIC8gKHgyIC0geDEpICogKHkyIC0geTEpICsgeTE7CiAgICAgICAgICAgIHgyID0gYXhpc3gubWF4OwogICAgICAgICAgfQoKICAgICAgICAgIGlmICghYXJlYU9wZW4pIHsKICAgICAgICAgICAgLy8gb3BlbiBhcmVhCiAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgY3R4Lm1vdmVUbyhheGlzeC5wMmMoeDEpLCBheGlzeS5wMmMoYm90dG9tKSk7CiAgICAgICAgICAgIGFyZWFPcGVuID0gdHJ1ZTsKICAgICAgICAgIH0gLy8gbm93IGZpcnN0IGNoZWNrIHRoZSBjYXNlIHdoZXJlIGJvdGggaXMgb3V0c2lkZQoKCiAgICAgICAgICBpZiAoeTEgPj0gYXhpc3kubWF4ICYmIHkyID49IGF4aXN5Lm1heCkgewogICAgICAgICAgICBjdHgubGluZVRvKGF4aXN4LnAyYyh4MSksIGF4aXN5LnAyYyhheGlzeS5tYXgpKTsKICAgICAgICAgICAgY3R4LmxpbmVUbyhheGlzeC5wMmMoeDIpLCBheGlzeS5wMmMoYXhpc3kubWF4KSk7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfSBlbHNlIGlmICh5MSA8PSBheGlzeS5taW4gJiYgeTIgPD0gYXhpc3kubWluKSB7CiAgICAgICAgICAgIGN0eC5saW5lVG8oYXhpc3gucDJjKHgxKSwgYXhpc3kucDJjKGF4aXN5Lm1pbikpOwogICAgICAgICAgICBjdHgubGluZVRvKGF4aXN4LnAyYyh4MiksIGF4aXN5LnAyYyhheGlzeS5taW4pKTsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9IC8vIGVsc2UgaXQncyBhIGJpdCBtb3JlIGNvbXBsaWNhdGVkLCB0aGVyZSBtaWdodAogICAgICAgICAgLy8gYmUgYSBmbGF0IG1heGVkIG91dCByZWN0YW5nbGUgZmlyc3QsIHRoZW4gYQogICAgICAgICAgLy8gdHJpYW5ndWxhciBjdXRvdXQgb3IgcmV2ZXJzZTsgdG8gZmluZCB0aGVzZQogICAgICAgICAgLy8ga2VlcCB0cmFjayBvZiB0aGUgY3VycmVudCB4IHZhbHVlcwoKCiAgICAgICAgICB2YXIgeDFvbGQgPSB4MSwKICAgICAgICAgICAgICB4Mm9sZCA9IHgyOyAvLyBjbGlwIHRoZSB5IHZhbHVlcywgd2l0aG91dCBzaG9ydGN1dHRpbmcsIHdlCiAgICAgICAgICAvLyBnbyB0aHJvdWdoIGFsbCBjYXNlcyBpbiB0dXJuCiAgICAgICAgICAvLyBjbGlwIHdpdGggeW1pbgoKICAgICAgICAgIGlmICh5MSA8PSB5MiAmJiB5MSA8IGF4aXN5Lm1pbiAmJiB5MiA+PSBheGlzeS5taW4pIHsKICAgICAgICAgICAgeDEgPSAoYXhpc3kubWluIC0geTEpIC8gKHkyIC0geTEpICogKHgyIC0geDEpICsgeDE7CiAgICAgICAgICAgIHkxID0gYXhpc3kubWluOwogICAgICAgICAgfSBlbHNlIGlmICh5MiA8PSB5MSAmJiB5MiA8IGF4aXN5Lm1pbiAmJiB5MSA+PSBheGlzeS5taW4pIHsKICAgICAgICAgICAgeDIgPSAoYXhpc3kubWluIC0geTEpIC8gKHkyIC0geTEpICogKHgyIC0geDEpICsgeDE7CiAgICAgICAgICAgIHkyID0gYXhpc3kubWluOwogICAgICAgICAgfSAvLyBjbGlwIHdpdGggeW1heAoKCiAgICAgICAgICBpZiAoeTEgPj0geTIgJiYgeTEgPiBheGlzeS5tYXggJiYgeTIgPD0gYXhpc3kubWF4KSB7CiAgICAgICAgICAgIHgxID0gKGF4aXN5Lm1heCAtIHkxKSAvICh5MiAtIHkxKSAqICh4MiAtIHgxKSArIHgxOwogICAgICAgICAgICB5MSA9IGF4aXN5Lm1heDsKICAgICAgICAgIH0gZWxzZSBpZiAoeTIgPj0geTEgJiYgeTIgPiBheGlzeS5tYXggJiYgeTEgPD0gYXhpc3kubWF4KSB7CiAgICAgICAgICAgIHgyID0gKGF4aXN5Lm1heCAtIHkxKSAvICh5MiAtIHkxKSAqICh4MiAtIHgxKSArIHgxOwogICAgICAgICAgICB5MiA9IGF4aXN5Lm1heDsKICAgICAgICAgIH0gLy8gaWYgdGhlIHggdmFsdWUgd2FzIGNoYW5nZWQgd2UgZ290IGEgcmVjdGFuZ2xlCiAgICAgICAgICAvLyB0byBmaWxsCgoKICAgICAgICAgIGlmICh4MSAhPSB4MW9sZCkgewogICAgICAgICAgICBjdHgubGluZVRvKGF4aXN4LnAyYyh4MW9sZCksIGF4aXN5LnAyYyh5MSkpOyAvLyBpdCBnb2VzIHRvICh4MSwgeTEpLCBidXQgd2UgZmlsbCB0aGF0IGJlbG93CiAgICAgICAgICB9IC8vIGZpbGwgdHJpYW5ndWxhciBzZWN0aW9uLCB0aGlzIHNvbWV0aW1lcyByZXN1bHQKICAgICAgICAgIC8vIGluIHJlZHVuZGFudCBwb2ludHMgaWYgKHgxLCB5MSkgaGFzbid0IGNoYW5nZWQKICAgICAgICAgIC8vIGZyb20gcHJldmlvdXMgbGluZSB0bywgYnV0IHdlIGp1c3QgaWdub3JlIHRoYXQKCgogICAgICAgICAgY3R4LmxpbmVUbyhheGlzeC5wMmMoeDEpLCBheGlzeS5wMmMoeTEpKTsKICAgICAgICAgIGN0eC5saW5lVG8oYXhpc3gucDJjKHgyKSwgYXhpc3kucDJjKHkyKSk7IC8vIGZpbGwgdGhlIG90aGVyIHJlY3RhbmdsZSBpZiBpdCdzIHRoZXJlCgogICAgICAgICAgaWYgKHgyICE9IHgyb2xkKSB7CiAgICAgICAgICAgIGN0eC5saW5lVG8oYXhpc3gucDJjKHgyKSwgYXhpc3kucDJjKHkyKSk7CiAgICAgICAgICAgIGN0eC5saW5lVG8oYXhpc3gucDJjKHgyb2xkKSwgYXhpc3kucDJjKHkyKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBjdHguc2F2ZSgpOwogICAgICBjdHgudHJhbnNsYXRlKHBsb3RPZmZzZXQubGVmdCwgcGxvdE9mZnNldC50b3ApOwogICAgICBjdHgubGluZUpvaW4gPSAicm91bmQiOwogICAgICB2YXIgbHcgPSBzZXJpZXMubGluZXMubGluZVdpZHRoLAogICAgICAgICAgc3cgPSBzZXJpZXMuc2hhZG93U2l6ZTsgLy8gRklYTUU6IGNvbnNpZGVyIGFub3RoZXIgZm9ybSBvZiBzaGFkb3cgd2hlbiBmaWxsaW5nIGlzIHR1cm5lZCBvbgoKICAgICAgaWYgKGx3ID4gMCAmJiBzdyA+IDApIHsKICAgICAgICAvLyBkcmF3IHNoYWRvdyBhcyBhIHRoaWNrIGFuZCB0aGluIGxpbmUgd2l0aCB0cmFuc3BhcmVuY3kKICAgICAgICBjdHgubGluZVdpZHRoID0gc3c7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gInJnYmEoMCwwLDAsMC4xKSI7IC8vIHBvc2l0aW9uIHNoYWRvdyBhdCBhbmdsZSBmcm9tIHRoZSBtaWQgb2YgbGluZQoKICAgICAgICB2YXIgYW5nbGUgPSBNYXRoLlBJIC8gMTg7CiAgICAgICAgcGxvdExpbmUoc2VyaWVzLmRhdGFwb2ludHMsIE1hdGguc2luKGFuZ2xlKSAqIChsdyAvIDIgKyBzdyAvIDIpLCBNYXRoLmNvcyhhbmdsZSkgKiAobHcgLyAyICsgc3cgLyAyKSwgc2VyaWVzLnhheGlzLCBzZXJpZXMueWF4aXMpOwogICAgICAgIGN0eC5saW5lV2lkdGggPSBzdyAvIDI7CiAgICAgICAgcGxvdExpbmUoc2VyaWVzLmRhdGFwb2ludHMsIE1hdGguc2luKGFuZ2xlKSAqIChsdyAvIDIgKyBzdyAvIDQpLCBNYXRoLmNvcyhhbmdsZSkgKiAobHcgLyAyICsgc3cgLyA0KSwgc2VyaWVzLnhheGlzLCBzZXJpZXMueWF4aXMpOwogICAgICB9CgogICAgICBjdHgubGluZVdpZHRoID0gbHc7CiAgICAgIGN0eC5zdHJva2VTdHlsZSA9IHNlcmllcy5jb2xvcjsKICAgICAgdmFyIGZpbGxTdHlsZSA9IGdldEZpbGxTdHlsZShzZXJpZXMubGluZXMsIHNlcmllcy5jb2xvciwgMCwgcGxvdEhlaWdodCk7CgogICAgICBpZiAoZmlsbFN0eWxlKSB7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGZpbGxTdHlsZTsKICAgICAgICBwbG90TGluZUFyZWEoc2VyaWVzLmRhdGFwb2ludHMsIHNlcmllcy54YXhpcywgc2VyaWVzLnlheGlzKTsKICAgICAgfQoKICAgICAgaWYgKGx3ID4gMCkgcGxvdExpbmUoc2VyaWVzLmRhdGFwb2ludHMsIDAsIDAsIHNlcmllcy54YXhpcywgc2VyaWVzLnlheGlzKTsKICAgICAgY3R4LnJlc3RvcmUoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBkcmF3U2VyaWVzUG9pbnRzKHNlcmllcykgewogICAgICBmdW5jdGlvbiBwbG90UG9pbnRzKGRhdGFwb2ludHMsIHJhZGl1cywgZmlsbFN0eWxlLCBvZmZzZXQsIHNoYWRvdywgYXhpc3gsIGF4aXN5LCBzeW1ib2wpIHsKICAgICAgICB2YXIgcG9pbnRzID0gZGF0YXBvaW50cy5wb2ludHMsCiAgICAgICAgICAgIHBzID0gZGF0YXBvaW50cy5wb2ludHNpemU7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcG9pbnRzLmxlbmd0aDsgaSArPSBwcykgewogICAgICAgICAgdmFyIHggPSBwb2ludHNbaV0sCiAgICAgICAgICAgICAgeSA9IHBvaW50c1tpICsgMV07CiAgICAgICAgICBpZiAoeCA9PSBudWxsIHx8IHggPCBheGlzeC5taW4gfHwgeCA+IGF4aXN4Lm1heCB8fCB5IDwgYXhpc3kubWluIHx8IHkgPiBheGlzeS5tYXgpIGNvbnRpbnVlOwogICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgeCA9IGF4aXN4LnAyYyh4KTsKICAgICAgICAgIHkgPSBheGlzeS5wMmMoeSkgKyBvZmZzZXQ7CiAgICAgICAgICBpZiAoc3ltYm9sID09ICJjaXJjbGUiKSBjdHguYXJjKHgsIHksIHJhZGl1cywgMCwgc2hhZG93ID8gTWF0aC5QSSA6IE1hdGguUEkgKiAyLCBmYWxzZSk7ZWxzZSBzeW1ib2woY3R4LCB4LCB5LCByYWRpdXMsIHNoYWRvdyk7CiAgICAgICAgICBjdHguY2xvc2VQYXRoKCk7CgogICAgICAgICAgaWYgKGZpbGxTdHlsZSkgewogICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZmlsbFN0eWxlOwogICAgICAgICAgICBjdHguZmlsbCgpOwogICAgICAgICAgfQoKICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGN0eC5zYXZlKCk7CiAgICAgIGN0eC50cmFuc2xhdGUocGxvdE9mZnNldC5sZWZ0LCBwbG90T2Zmc2V0LnRvcCk7CiAgICAgIHZhciBsdyA9IHNlcmllcy5wb2ludHMubGluZVdpZHRoLAogICAgICAgICAgc3cgPSBzZXJpZXMuc2hhZG93U2l6ZSwKICAgICAgICAgIHJhZGl1cyA9IHNlcmllcy5wb2ludHMucmFkaXVzLAogICAgICAgICAgc3ltYm9sID0gc2VyaWVzLnBvaW50cy5zeW1ib2w7IC8vIElmIHRoZSB1c2VyIHNldHMgdGhlIGxpbmUgd2lkdGggdG8gMCwgd2UgY2hhbmdlIGl0IHRvIGEgdmVyeSAKICAgICAgLy8gc21hbGwgdmFsdWUuIEEgbGluZSB3aWR0aCBvZiAwIHNlZW1zIHRvIGZvcmNlIHRoZSBkZWZhdWx0IG9mIDEuCiAgICAgIC8vIERvaW5nIHRoZSBjb25kaXRpb25hbCBoZXJlIGFsbG93cyB0aGUgc2hhZG93IHNldHRpbmcgdG8gc3RpbGwgYmUgCiAgICAgIC8vIG9wdGlvbmFsIGV2ZW4gd2l0aCBhIGxpbmVXaWR0aCBvZiAwLgoKICAgICAgaWYgKGx3ID09IDApIGx3ID0gMC4wMDAxOwoKICAgICAgaWYgKGx3ID4gMCAmJiBzdyA+IDApIHsKICAgICAgICAvLyBkcmF3IHNoYWRvdyBpbiB0d28gc3RlcHMKICAgICAgICB2YXIgdyA9IHN3IC8gMjsKICAgICAgICBjdHgubGluZVdpZHRoID0gdzsKICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAicmdiYSgwLDAsMCwwLjEpIjsKICAgICAgICBwbG90UG9pbnRzKHNlcmllcy5kYXRhcG9pbnRzLCByYWRpdXMsIG51bGwsIHcgKyB3IC8gMiwgdHJ1ZSwgc2VyaWVzLnhheGlzLCBzZXJpZXMueWF4aXMsIHN5bWJvbCk7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gInJnYmEoMCwwLDAsMC4yKSI7CiAgICAgICAgcGxvdFBvaW50cyhzZXJpZXMuZGF0YXBvaW50cywgcmFkaXVzLCBudWxsLCB3IC8gMiwgdHJ1ZSwgc2VyaWVzLnhheGlzLCBzZXJpZXMueWF4aXMsIHN5bWJvbCk7CiAgICAgIH0KCiAgICAgIGN0eC5saW5lV2lkdGggPSBsdzsKICAgICAgY3R4LnN0cm9rZVN0eWxlID0gc2VyaWVzLmNvbG9yOwogICAgICBwbG90UG9pbnRzKHNlcmllcy5kYXRhcG9pbnRzLCByYWRpdXMsIGdldEZpbGxTdHlsZShzZXJpZXMucG9pbnRzLCBzZXJpZXMuY29sb3IpLCAwLCBmYWxzZSwgc2VyaWVzLnhheGlzLCBzZXJpZXMueWF4aXMsIHN5bWJvbCk7CiAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICB9CgogICAgZnVuY3Rpb24gZHJhd0Jhcih4LCB5LCBiLCBiYXJMZWZ0LCBiYXJSaWdodCwgZmlsbFN0eWxlQ2FsbGJhY2ssIGF4aXN4LCBheGlzeSwgYywgaG9yaXpvbnRhbCwgbGluZVdpZHRoKSB7CiAgICAgIHZhciBsZWZ0LCByaWdodCwgYm90dG9tLCB0b3AsIGRyYXdMZWZ0LCBkcmF3UmlnaHQsIGRyYXdUb3AsIGRyYXdCb3R0b20sIHRtcDsgLy8gaW4gaG9yaXpvbnRhbCBtb2RlLCB3ZSBzdGFydCB0aGUgYmFyIGZyb20gdGhlIGxlZnQKICAgICAgLy8gaW5zdGVhZCBvZiBmcm9tIHRoZSBib3R0b20gc28gaXQgYXBwZWFycyB0byBiZQogICAgICAvLyBob3Jpem9udGFsIHJhdGhlciB0aGFuIHZlcnRpY2FsCgogICAgICBpZiAoaG9yaXpvbnRhbCkgewogICAgICAgIGRyYXdCb3R0b20gPSBkcmF3UmlnaHQgPSBkcmF3VG9wID0gdHJ1ZTsKICAgICAgICBkcmF3TGVmdCA9IGZhbHNlOwogICAgICAgIGxlZnQgPSBiOwogICAgICAgIHJpZ2h0ID0geDsKICAgICAgICB0b3AgPSB5ICsgYmFyTGVmdDsKICAgICAgICBib3R0b20gPSB5ICsgYmFyUmlnaHQ7IC8vIGFjY291bnQgZm9yIG5lZ2F0aXZlIGJhcnMKCiAgICAgICAgaWYgKHJpZ2h0IDwgbGVmdCkgewogICAgICAgICAgdG1wID0gcmlnaHQ7CiAgICAgICAgICByaWdodCA9IGxlZnQ7CiAgICAgICAgICBsZWZ0ID0gdG1wOwogICAgICAgICAgZHJhd0xlZnQgPSB0cnVlOwogICAgICAgICAgZHJhd1JpZ2h0ID0gZmFsc2U7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGRyYXdMZWZ0ID0gZHJhd1JpZ2h0ID0gZHJhd1RvcCA9IHRydWU7CiAgICAgICAgZHJhd0JvdHRvbSA9IGZhbHNlOwogICAgICAgIGxlZnQgPSB4ICsgYmFyTGVmdDsKICAgICAgICByaWdodCA9IHggKyBiYXJSaWdodDsKICAgICAgICBib3R0b20gPSBiOwogICAgICAgIHRvcCA9IHk7IC8vIGFjY291bnQgZm9yIG5lZ2F0aXZlIGJhcnMKCiAgICAgICAgaWYgKHRvcCA8IGJvdHRvbSkgewogICAgICAgICAgdG1wID0gdG9wOwogICAgICAgICAgdG9wID0gYm90dG9tOwogICAgICAgICAgYm90dG9tID0gdG1wOwogICAgICAgICAgZHJhd0JvdHRvbSA9IHRydWU7CiAgICAgICAgICBkcmF3VG9wID0gZmFsc2U7CiAgICAgICAgfQogICAgICB9IC8vIGNsaXAKCgogICAgICBpZiAocmlnaHQgPCBheGlzeC5taW4gfHwgbGVmdCA+IGF4aXN4Lm1heCB8fCB0b3AgPCBheGlzeS5taW4gfHwgYm90dG9tID4gYXhpc3kubWF4KSByZXR1cm47CgogICAgICBpZiAobGVmdCA8IGF4aXN4Lm1pbikgewogICAgICAgIGxlZnQgPSBheGlzeC5taW47CiAgICAgICAgZHJhd0xlZnQgPSBmYWxzZTsKICAgICAgfQoKICAgICAgaWYgKHJpZ2h0ID4gYXhpc3gubWF4KSB7CiAgICAgICAgcmlnaHQgPSBheGlzeC5tYXg7CiAgICAgICAgZHJhd1JpZ2h0ID0gZmFsc2U7CiAgICAgIH0KCiAgICAgIGlmIChib3R0b20gPCBheGlzeS5taW4pIHsKICAgICAgICBib3R0b20gPSBheGlzeS5taW47CiAgICAgICAgZHJhd0JvdHRvbSA9IGZhbHNlOwogICAgICB9CgogICAgICBpZiAodG9wID4gYXhpc3kubWF4KSB7CiAgICAgICAgdG9wID0gYXhpc3kubWF4OwogICAgICAgIGRyYXdUb3AgPSBmYWxzZTsKICAgICAgfQoKICAgICAgbGVmdCA9IGF4aXN4LnAyYyhsZWZ0KTsKICAgICAgYm90dG9tID0gYXhpc3kucDJjKGJvdHRvbSk7CiAgICAgIHJpZ2h0ID0gYXhpc3gucDJjKHJpZ2h0KTsKICAgICAgdG9wID0gYXhpc3kucDJjKHRvcCk7IC8vIGZpbGwgdGhlIGJhcgoKICAgICAgaWYgKGZpbGxTdHlsZUNhbGxiYWNrKSB7CiAgICAgICAgYy5maWxsU3R5bGUgPSBmaWxsU3R5bGVDYWxsYmFjayhib3R0b20sIHRvcCk7CiAgICAgICAgYy5maWxsUmVjdChsZWZ0LCB0b3AsIHJpZ2h0IC0gbGVmdCwgYm90dG9tIC0gdG9wKTsKICAgICAgfSAvLyBkcmF3IG91dGxpbmUKCgogICAgICBpZiAobGluZVdpZHRoID4gMCAmJiAoZHJhd0xlZnQgfHwgZHJhd1JpZ2h0IHx8IGRyYXdUb3AgfHwgZHJhd0JvdHRvbSkpIHsKICAgICAgICBjLmJlZ2luUGF0aCgpOyAvLyBGSVhNRTogaW5saW5lIG1vdmVUbyBpcyBidWdneSB3aXRoIGV4Y2FudmFzCgogICAgICAgIGMubW92ZVRvKGxlZnQsIGJvdHRvbSk7CiAgICAgICAgaWYgKGRyYXdMZWZ0KSBjLmxpbmVUbyhsZWZ0LCB0b3ApO2Vsc2UgYy5tb3ZlVG8obGVmdCwgdG9wKTsKICAgICAgICBpZiAoZHJhd1RvcCkgYy5saW5lVG8ocmlnaHQsIHRvcCk7ZWxzZSBjLm1vdmVUbyhyaWdodCwgdG9wKTsKICAgICAgICBpZiAoZHJhd1JpZ2h0KSBjLmxpbmVUbyhyaWdodCwgYm90dG9tKTtlbHNlIGMubW92ZVRvKHJpZ2h0LCBib3R0b20pOwogICAgICAgIGlmIChkcmF3Qm90dG9tKSBjLmxpbmVUbyhsZWZ0LCBib3R0b20pO2Vsc2UgYy5tb3ZlVG8obGVmdCwgYm90dG9tKTsKICAgICAgICBjLnN0cm9rZSgpOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gZHJhd1Nlcmllc0JhcnMoc2VyaWVzKSB7CiAgICAgIGZ1bmN0aW9uIHBsb3RCYXJzKGRhdGFwb2ludHMsIGJhckxlZnQsIGJhclJpZ2h0LCBmaWxsU3R5bGVDYWxsYmFjaywgYXhpc3gsIGF4aXN5KSB7CiAgICAgICAgdmFyIHBvaW50cyA9IGRhdGFwb2ludHMucG9pbnRzLAogICAgICAgICAgICBwcyA9IGRhdGFwb2ludHMucG9pbnRzaXplOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBvaW50cy5sZW5ndGg7IGkgKz0gcHMpIHsKICAgICAgICAgIGlmIChwb2ludHNbaV0gPT0gbnVsbCkgY29udGludWU7CiAgICAgICAgICBkcmF3QmFyKHBvaW50c1tpXSwgcG9pbnRzW2kgKyAxXSwgcG9pbnRzW2kgKyAyXSwgYmFyTGVmdCwgYmFyUmlnaHQsIGZpbGxTdHlsZUNhbGxiYWNrLCBheGlzeCwgYXhpc3ksIGN0eCwgc2VyaWVzLmJhcnMuaG9yaXpvbnRhbCwgc2VyaWVzLmJhcnMubGluZVdpZHRoKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGN0eC5zYXZlKCk7CiAgICAgIGN0eC50cmFuc2xhdGUocGxvdE9mZnNldC5sZWZ0LCBwbG90T2Zmc2V0LnRvcCk7IC8vIEZJWE1FOiBmaWd1cmUgb3V0IGEgd2F5IHRvIGFkZCBzaGFkb3dzIChmb3IgaW5zdGFuY2UgYWxvbmcgdGhlIHJpZ2h0IGVkZ2UpCgogICAgICBjdHgubGluZVdpZHRoID0gc2VyaWVzLmJhcnMubGluZVdpZHRoOwogICAgICBjdHguc3Ryb2tlU3R5bGUgPSBzZXJpZXMuY29sb3I7CiAgICAgIHZhciBiYXJMZWZ0OwoKICAgICAgc3dpdGNoIChzZXJpZXMuYmFycy5hbGlnbikgewogICAgICAgIGNhc2UgImxlZnQiOgogICAgICAgICAgYmFyTGVmdCA9IDA7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAicmlnaHQiOgogICAgICAgICAgYmFyTGVmdCA9IC1zZXJpZXMuYmFycy5iYXJXaWR0aDsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgYmFyTGVmdCA9IC1zZXJpZXMuYmFycy5iYXJXaWR0aCAvIDI7CiAgICAgIH0KCiAgICAgIHZhciBmaWxsU3R5bGVDYWxsYmFjayA9IHNlcmllcy5iYXJzLmZpbGwgPyBmdW5jdGlvbiAoYm90dG9tLCB0b3ApIHsKICAgICAgICByZXR1cm4gZ2V0RmlsbFN0eWxlKHNlcmllcy5iYXJzLCBzZXJpZXMuY29sb3IsIGJvdHRvbSwgdG9wKTsKICAgICAgfSA6IG51bGw7CiAgICAgIHBsb3RCYXJzKHNlcmllcy5kYXRhcG9pbnRzLCBiYXJMZWZ0LCBiYXJMZWZ0ICsgc2VyaWVzLmJhcnMuYmFyV2lkdGgsIGZpbGxTdHlsZUNhbGxiYWNrLCBzZXJpZXMueGF4aXMsIHNlcmllcy55YXhpcyk7CiAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0RmlsbFN0eWxlKGZpbGxvcHRpb25zLCBzZXJpZXNDb2xvciwgYm90dG9tLCB0b3ApIHsKICAgICAgdmFyIGZpbGwgPSBmaWxsb3B0aW9ucy5maWxsOwogICAgICBpZiAoIWZpbGwpIHJldHVybiBudWxsOwogICAgICBpZiAoZmlsbG9wdGlvbnMuZmlsbENvbG9yKSByZXR1cm4gZ2V0Q29sb3JPckdyYWRpZW50KGZpbGxvcHRpb25zLmZpbGxDb2xvciwgYm90dG9tLCB0b3AsIHNlcmllc0NvbG9yKTsKICAgICAgdmFyIGMgPSAkLmNvbG9yLnBhcnNlKHNlcmllc0NvbG9yKTsKICAgICAgYy5hID0gdHlwZW9mIGZpbGwgPT0gIm51bWJlciIgPyBmaWxsIDogMC40OwogICAgICBjLm5vcm1hbGl6ZSgpOwogICAgICByZXR1cm4gYy50b1N0cmluZygpOwogICAgfQoKICAgIGZ1bmN0aW9uIGluc2VydExlZ2VuZCgpIHsKICAgICAgaWYgKG9wdGlvbnMubGVnZW5kLmNvbnRhaW5lciAhPSBudWxsKSB7CiAgICAgICAgJChvcHRpb25zLmxlZ2VuZC5jb250YWluZXIpLmh0bWwoIiIpOwogICAgICB9IGVsc2UgewogICAgICAgIHBsYWNlaG9sZGVyLmZpbmQoIi5sZWdlbmQiKS5yZW1vdmUoKTsKICAgICAgfQoKICAgICAgaWYgKCFvcHRpb25zLmxlZ2VuZC5zaG93KSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgZnJhZ21lbnRzID0gW10sCiAgICAgICAgICBlbnRyaWVzID0gW10sCiAgICAgICAgICByb3dTdGFydGVkID0gZmFsc2UsCiAgICAgICAgICBsZiA9IG9wdGlvbnMubGVnZW5kLmxhYmVsRm9ybWF0dGVyLAogICAgICAgICAgcywKICAgICAgICAgIGxhYmVsOyAvLyBCdWlsZCBhIGxpc3Qgb2YgbGVnZW5kIGVudHJpZXMsIHdpdGggZWFjaCBoYXZpbmcgYSBsYWJlbCBhbmQgYSBjb2xvcgoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzZXJpZXMubGVuZ3RoOyArK2kpIHsKICAgICAgICBzID0gc2VyaWVzW2ldOwoKICAgICAgICBpZiAocy5sYWJlbCkgewogICAgICAgICAgbGFiZWwgPSBsZiA/IGxmKHMubGFiZWwsIHMpIDogcy5sYWJlbDsKCiAgICAgICAgICBpZiAobGFiZWwpIHsKICAgICAgICAgICAgZW50cmllcy5wdXNoKHsKICAgICAgICAgICAgICBsYWJlbDogbGFiZWwsCiAgICAgICAgICAgICAgY29sb3I6IHMuY29sb3IKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IC8vIFNvcnQgdGhlIGxlZ2VuZCB1c2luZyBlaXRoZXIgdGhlIGRlZmF1bHQgb3IgYSBjdXN0b20gY29tcGFyYXRvcgoKCiAgICAgIGlmIChvcHRpb25zLmxlZ2VuZC5zb3J0ZWQpIHsKICAgICAgICBpZiAoJC5pc0Z1bmN0aW9uKG9wdGlvbnMubGVnZW5kLnNvcnRlZCkpIHsKICAgICAgICAgIGVudHJpZXMuc29ydChvcHRpb25zLmxlZ2VuZC5zb3J0ZWQpOwogICAgICAgIH0gZWxzZSBpZiAob3B0aW9ucy5sZWdlbmQuc29ydGVkID09ICJyZXZlcnNlIikgewogICAgICAgICAgZW50cmllcy5yZXZlcnNlKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBhc2NlbmRpbmcgPSBvcHRpb25zLmxlZ2VuZC5zb3J0ZWQgIT0gImRlc2NlbmRpbmciOwogICAgICAgICAgZW50cmllcy5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgIHJldHVybiBhLmxhYmVsID09IGIubGFiZWwgPyAwIDogYS5sYWJlbCA8IGIubGFiZWwgIT0gYXNjZW5kaW5nID8gMSA6IC0xIC8vIExvZ2ljYWwgWE9SCiAgICAgICAgICAgIDsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSAvLyBHZW5lcmF0ZSBtYXJrdXAgZm9yIHRoZSBsaXN0IG9mIGVudHJpZXMsIGluIHRoZWlyIGZpbmFsIG9yZGVyCgoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbnRyaWVzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgdmFyIGVudHJ5ID0gZW50cmllc1tpXTsKCiAgICAgICAgaWYgKGkgJSBvcHRpb25zLmxlZ2VuZC5ub0NvbHVtbnMgPT0gMCkgewogICAgICAgICAgaWYgKHJvd1N0YXJ0ZWQpIGZyYWdtZW50cy5wdXNoKCc8L3RyPicpOwogICAgICAgICAgZnJhZ21lbnRzLnB1c2goJzx0cj4nKTsKICAgICAgICAgIHJvd1N0YXJ0ZWQgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgZnJhZ21lbnRzLnB1c2goJzx0ZCBjbGFzcz0ibGVnZW5kQ29sb3JCb3giPjxkaXYgc3R5bGU9ImJvcmRlcjoxcHggc29saWQgJyArIG9wdGlvbnMubGVnZW5kLmxhYmVsQm94Qm9yZGVyQ29sb3IgKyAnO3BhZGRpbmc6MXB4Ij48ZGl2IHN0eWxlPSJ3aWR0aDo0cHg7aGVpZ2h0OjA7Ym9yZGVyOjVweCBzb2xpZCAnICsgZW50cnkuY29sb3IgKyAnO292ZXJmbG93OmhpZGRlbiI+PC9kaXY+PC9kaXY+PC90ZD4nICsgJzx0ZCBjbGFzcz0ibGVnZW5kTGFiZWwiPicgKyBlbnRyeS5sYWJlbCArICc8L3RkPicpOwogICAgICB9CgogICAgICBpZiAocm93U3RhcnRlZCkgZnJhZ21lbnRzLnB1c2goJzwvdHI+Jyk7CiAgICAgIGlmIChmcmFnbWVudHMubGVuZ3RoID09IDApIHJldHVybjsKICAgICAgdmFyIHRhYmxlID0gJzx0YWJsZSBzdHlsZT0iZm9udC1zaXplOnNtYWxsZXI7Y29sb3I6JyArIG9wdGlvbnMuZ3JpZC5jb2xvciArICciPicgKyBmcmFnbWVudHMuam9pbigiIikgKyAnPC90YWJsZT4nOwogICAgICBpZiAob3B0aW9ucy5sZWdlbmQuY29udGFpbmVyICE9IG51bGwpICQob3B0aW9ucy5sZWdlbmQuY29udGFpbmVyKS5odG1sKHRhYmxlKTtlbHNlIHsKICAgICAgICB2YXIgcG9zID0gIiIsCiAgICAgICAgICAgIHAgPSBvcHRpb25zLmxlZ2VuZC5wb3NpdGlvbiwKICAgICAgICAgICAgbSA9IG9wdGlvbnMubGVnZW5kLm1hcmdpbjsKICAgICAgICBpZiAobVswXSA9PSBudWxsKSBtID0gW20sIG1dOwogICAgICAgIGlmIChwLmNoYXJBdCgwKSA9PSAibiIpIHBvcyArPSAndG9wOicgKyAobVsxXSArIHBsb3RPZmZzZXQudG9wKSArICdweDsnO2Vsc2UgaWYgKHAuY2hhckF0KDApID09ICJzIikgcG9zICs9ICdib3R0b206JyArIChtWzFdICsgcGxvdE9mZnNldC5ib3R0b20pICsgJ3B4Oyc7CiAgICAgICAgaWYgKHAuY2hhckF0KDEpID09ICJlIikgcG9zICs9ICdyaWdodDonICsgKG1bMF0gKyBwbG90T2Zmc2V0LnJpZ2h0KSArICdweDsnO2Vsc2UgaWYgKHAuY2hhckF0KDEpID09ICJ3IikgcG9zICs9ICdsZWZ0OicgKyAobVswXSArIHBsb3RPZmZzZXQubGVmdCkgKyAncHg7JzsKICAgICAgICB2YXIgbGVnZW5kID0gJCgnPGRpdiBjbGFzcz0ibGVnZW5kIj4nICsgdGFibGUucmVwbGFjZSgnc3R5bGU9IicsICdzdHlsZT0icG9zaXRpb246YWJzb2x1dGU7JyArIHBvcyArICc7JykgKyAnPC9kaXY+JykuYXBwZW5kVG8ocGxhY2Vob2xkZXIpOwoKICAgICAgICBpZiAob3B0aW9ucy5sZWdlbmQuYmFja2dyb3VuZE9wYWNpdHkgIT0gMC4wKSB7CiAgICAgICAgICAvLyBwdXQgaW4gdGhlIHRyYW5zcGFyZW50IGJhY2tncm91bmQKICAgICAgICAgIC8vIHNlcGFyYXRlbHkgdG8gYXZvaWQgYmxlbmRlZCBsYWJlbHMgYW5kCiAgICAgICAgICAvLyBsYWJlbCBib3hlcwogICAgICAgICAgdmFyIGMgPSBvcHRpb25zLmxlZ2VuZC5iYWNrZ3JvdW5kQ29sb3I7CgogICAgICAgICAgaWYgKGMgPT0gbnVsbCkgewogICAgICAgICAgICBjID0gb3B0aW9ucy5ncmlkLmJhY2tncm91bmRDb2xvcjsKICAgICAgICAgICAgaWYgKGMgJiYgdHlwZW9mIGMgPT0gInN0cmluZyIpIGMgPSAkLmNvbG9yLnBhcnNlKGMpO2Vsc2UgYyA9ICQuY29sb3IuZXh0cmFjdChsZWdlbmQsICdiYWNrZ3JvdW5kLWNvbG9yJyk7CiAgICAgICAgICAgIGMuYSA9IDE7CiAgICAgICAgICAgIGMgPSBjLnRvU3RyaW5nKCk7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIGRpdiA9IGxlZ2VuZC5jaGlsZHJlbigpOwogICAgICAgICAgJCgnPGRpdiBzdHlsZT0icG9zaXRpb246YWJzb2x1dGU7d2lkdGg6JyArIGRpdi53aWR0aCgpICsgJ3B4O2hlaWdodDonICsgZGl2LmhlaWdodCgpICsgJ3B4OycgKyBwb3MgKyAnYmFja2dyb3VuZC1jb2xvcjonICsgYyArICc7Ij4gPC9kaXY+JykucHJlcGVuZFRvKGxlZ2VuZCkuY3NzKCdvcGFjaXR5Jywgb3B0aW9ucy5sZWdlbmQuYmFja2dyb3VuZE9wYWNpdHkpOwogICAgICAgIH0KICAgICAgfQogICAgfSAvLyBpbnRlcmFjdGl2ZSBmZWF0dXJlcwoKCiAgICB2YXIgaGlnaGxpZ2h0cyA9IFtdLAogICAgICAgIHJlZHJhd1RpbWVvdXQgPSBudWxsOyAvLyByZXR1cm5zIHRoZSBkYXRhIGl0ZW0gdGhlIG1vdXNlIGlzIG92ZXIsIG9yIG51bGwgaWYgbm9uZSBpcyBmb3VuZAoKICAgIGZ1bmN0aW9uIGZpbmROZWFyYnlJdGVtKG1vdXNlWCwgbW91c2VZLCBzZXJpZXNGaWx0ZXIpIHsKICAgICAgdmFyIG1heERpc3RhbmNlID0gb3B0aW9ucy5ncmlkLm1vdXNlQWN0aXZlUmFkaXVzLAogICAgICAgICAgc21hbGxlc3REaXN0YW5jZSA9IG1heERpc3RhbmNlICogbWF4RGlzdGFuY2UgKyAxLAogICAgICAgICAgaXRlbSA9IG51bGwsCiAgICAgICAgICBmb3VuZFBvaW50ID0gZmFsc2UsCiAgICAgICAgICBpLAogICAgICAgICAgaiwKICAgICAgICAgIHBzOwoKICAgICAgZm9yIChpID0gc2VyaWVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7CiAgICAgICAgaWYgKCFzZXJpZXNGaWx0ZXIoc2VyaWVzW2ldKSkgY29udGludWU7CiAgICAgICAgdmFyIHMgPSBzZXJpZXNbaV0sCiAgICAgICAgICAgIGF4aXN4ID0gcy54YXhpcywKICAgICAgICAgICAgYXhpc3kgPSBzLnlheGlzLAogICAgICAgICAgICBwb2ludHMgPSBzLmRhdGFwb2ludHMucG9pbnRzLAogICAgICAgICAgICBteCA9IGF4aXN4LmMycChtb3VzZVgpLAogICAgICAgICAgICAvLyBwcmVjb21wdXRlIHNvbWUgc3R1ZmYgdG8gbWFrZSB0aGUgbG9vcCBmYXN0ZXIKICAgICAgICBteSA9IGF4aXN5LmMycChtb3VzZVkpLAogICAgICAgICAgICBtYXh4ID0gbWF4RGlzdGFuY2UgLyBheGlzeC5zY2FsZSwKICAgICAgICAgICAgbWF4eSA9IG1heERpc3RhbmNlIC8gYXhpc3kuc2NhbGU7CiAgICAgICAgcHMgPSBzLmRhdGFwb2ludHMucG9pbnRzaXplOyAvLyB3aXRoIGludmVyc2UgdHJhbnNmb3Jtcywgd2UgY2FuJ3QgdXNlIHRoZSBtYXh4L21heHkKICAgICAgICAvLyBvcHRpbWl6YXRpb24sIHNhZGx5CgogICAgICAgIGlmIChheGlzeC5vcHRpb25zLmludmVyc2VUcmFuc2Zvcm0pIG1heHggPSBOdW1iZXIuTUFYX1ZBTFVFOwogICAgICAgIGlmIChheGlzeS5vcHRpb25zLmludmVyc2VUcmFuc2Zvcm0pIG1heHkgPSBOdW1iZXIuTUFYX1ZBTFVFOwoKICAgICAgICBpZiAocy5saW5lcy5zaG93IHx8IHMucG9pbnRzLnNob3cpIHsKICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBwb2ludHMubGVuZ3RoOyBqICs9IHBzKSB7CiAgICAgICAgICAgIHZhciB4ID0gcG9pbnRzW2pdLAogICAgICAgICAgICAgICAgeSA9IHBvaW50c1tqICsgMV07CiAgICAgICAgICAgIGlmICh4ID09IG51bGwpIGNvbnRpbnVlOyAvLyBGb3IgcG9pbnRzIGFuZCBsaW5lcywgdGhlIGN1cnNvciBtdXN0IGJlIHdpdGhpbiBhCiAgICAgICAgICAgIC8vIGNlcnRhaW4gZGlzdGFuY2UgdG8gdGhlIGRhdGEgcG9pbnQKCiAgICAgICAgICAgIGlmICh4IC0gbXggPiBtYXh4IHx8IHggLSBteCA8IC1tYXh4IHx8IHkgLSBteSA+IG1heHkgfHwgeSAtIG15IDwgLW1heHkpIGNvbnRpbnVlOyAvLyBXZSBoYXZlIHRvIGNhbGN1bGF0ZSBkaXN0YW5jZXMgaW4gcGl4ZWxzLCBub3QgaW4KICAgICAgICAgICAgLy8gZGF0YSB1bml0cywgYmVjYXVzZSB0aGUgc2NhbGVzIG9mIHRoZSBheGVzIG1heSBiZSBkaWZmZXJlbnQKCiAgICAgICAgICAgIHZhciBkeCA9IE1hdGguYWJzKGF4aXN4LnAyYyh4KSAtIG1vdXNlWCksCiAgICAgICAgICAgICAgICBkeSA9IE1hdGguYWJzKGF4aXN5LnAyYyh5KSAtIG1vdXNlWSksCiAgICAgICAgICAgICAgICBkaXN0ID0gZHggKiBkeCArIGR5ICogZHk7IC8vIHdlIHNhdmUgdGhlIHNxcnQKICAgICAgICAgICAgLy8gdXNlIDw9IHRvIGVuc3VyZSBsYXN0IHBvaW50IHRha2VzIHByZWNlZGVuY2UKICAgICAgICAgICAgLy8gKGxhc3QgZ2VuZXJhbGx5IG1lYW5zIG9uIHRvcCBvZikKCiAgICAgICAgICAgIGlmIChkaXN0IDwgc21hbGxlc3REaXN0YW5jZSkgewogICAgICAgICAgICAgIHNtYWxsZXN0RGlzdGFuY2UgPSBkaXN0OwogICAgICAgICAgICAgIGl0ZW0gPSBbaSwgaiAvIHBzXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHMuYmFycy5zaG93ICYmICFpdGVtKSB7CiAgICAgICAgICAvLyBubyBvdGhlciBwb2ludCBjYW4gYmUgbmVhcmJ5CiAgICAgICAgICB2YXIgYmFyTGVmdCwgYmFyUmlnaHQ7CgogICAgICAgICAgc3dpdGNoIChzLmJhcnMuYWxpZ24pIHsKICAgICAgICAgICAgY2FzZSAibGVmdCI6CiAgICAgICAgICAgICAgYmFyTGVmdCA9IDA7CiAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlICJyaWdodCI6CiAgICAgICAgICAgICAgYmFyTGVmdCA9IC1zLmJhcnMuYmFyV2lkdGg7CiAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIGJhckxlZnQgPSAtcy5iYXJzLmJhcldpZHRoIC8gMjsKICAgICAgICAgIH0KCiAgICAgICAgICBiYXJSaWdodCA9IGJhckxlZnQgKyBzLmJhcnMuYmFyV2lkdGg7CgogICAgICAgICAgZm9yIChqID0gMDsgaiA8IHBvaW50cy5sZW5ndGg7IGogKz0gcHMpIHsKICAgICAgICAgICAgdmFyIHggPSBwb2ludHNbal0sCiAgICAgICAgICAgICAgICB5ID0gcG9pbnRzW2ogKyAxXSwKICAgICAgICAgICAgICAgIGIgPSBwb2ludHNbaiArIDJdOwogICAgICAgICAgICBpZiAoeCA9PSBudWxsKSBjb250aW51ZTsgLy8gZm9yIGEgYmFyIGdyYXBoLCB0aGUgY3Vyc29yIG11c3QgYmUgaW5zaWRlIHRoZSBiYXIKCiAgICAgICAgICAgIGlmIChzZXJpZXNbaV0uYmFycy5ob3Jpem9udGFsID8gbXggPD0gTWF0aC5tYXgoYiwgeCkgJiYgbXggPj0gTWF0aC5taW4oYiwgeCkgJiYgbXkgPj0geSArIGJhckxlZnQgJiYgbXkgPD0geSArIGJhclJpZ2h0IDogbXggPj0geCArIGJhckxlZnQgJiYgbXggPD0geCArIGJhclJpZ2h0ICYmIG15ID49IE1hdGgubWluKGIsIHkpICYmIG15IDw9IE1hdGgubWF4KGIsIHkpKSBpdGVtID0gW2ksIGogLyBwc107CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoaXRlbSkgewogICAgICAgIGkgPSBpdGVtWzBdOwogICAgICAgIGogPSBpdGVtWzFdOwogICAgICAgIHBzID0gc2VyaWVzW2ldLmRhdGFwb2ludHMucG9pbnRzaXplOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICBkYXRhcG9pbnQ6IHNlcmllc1tpXS5kYXRhcG9pbnRzLnBvaW50cy5zbGljZShqICogcHMsIChqICsgMSkgKiBwcyksCiAgICAgICAgICBkYXRhSW5kZXg6IGosCiAgICAgICAgICBzZXJpZXM6IHNlcmllc1tpXSwKICAgICAgICAgIHNlcmllc0luZGV4OiBpCiAgICAgICAgfTsKICAgICAgfQoKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgZnVuY3Rpb24gb25Nb3VzZU1vdmUoZSkgewogICAgICBpZiAob3B0aW9ucy5ncmlkLmhvdmVyYWJsZSkgdHJpZ2dlckNsaWNrSG92ZXJFdmVudCgicGxvdGhvdmVyIiwgZSwgZnVuY3Rpb24gKHMpIHsKICAgICAgICByZXR1cm4gc1siaG92ZXJhYmxlIl0gIT0gZmFsc2U7CiAgICAgIH0pOwogICAgfQoKICAgIGZ1bmN0aW9uIG9uTW91c2VMZWF2ZShlKSB7CiAgICAgIGlmIChvcHRpb25zLmdyaWQuaG92ZXJhYmxlKSB0cmlnZ2VyQ2xpY2tIb3ZlckV2ZW50KCJwbG90aG92ZXIiLCBlLCBmdW5jdGlvbiAocykgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gb25DbGljayhlKSB7CiAgICAgIHRyaWdnZXJDbGlja0hvdmVyRXZlbnQoInBsb3RjbGljayIsIGUsIGZ1bmN0aW9uIChzKSB7CiAgICAgICAgcmV0dXJuIHNbImNsaWNrYWJsZSJdICE9IGZhbHNlOwogICAgICB9KTsKICAgIH0gLy8gdHJpZ2dlciBjbGljayBvciBob3ZlciBldmVudCAodGhleSBzZW5kIHRoZSBzYW1lIHBhcmFtZXRlcnMKICAgIC8vIHNvIHdlIHNoYXJlIHRoZWlyIGNvZGUpCgoKICAgIGZ1bmN0aW9uIHRyaWdnZXJDbGlja0hvdmVyRXZlbnQoZXZlbnRuYW1lLCBldmVudCwgc2VyaWVzRmlsdGVyKSB7CiAgICAgIHZhciBvZmZzZXQgPSBldmVudEhvbGRlci5vZmZzZXQoKSwKICAgICAgICAgIGNhbnZhc1ggPSBldmVudC5wYWdlWCAtIG9mZnNldC5sZWZ0IC0gcGxvdE9mZnNldC5sZWZ0LAogICAgICAgICAgY2FudmFzWSA9IGV2ZW50LnBhZ2VZIC0gb2Zmc2V0LnRvcCAtIHBsb3RPZmZzZXQudG9wLAogICAgICAgICAgcG9zID0gY2FudmFzVG9BeGlzQ29vcmRzKHsKICAgICAgICBsZWZ0OiBjYW52YXNYLAogICAgICAgIHRvcDogY2FudmFzWQogICAgICB9KTsKICAgICAgcG9zLnBhZ2VYID0gZXZlbnQucGFnZVg7CiAgICAgIHBvcy5wYWdlWSA9IGV2ZW50LnBhZ2VZOwogICAgICB2YXIgaXRlbSA9IGZpbmROZWFyYnlJdGVtKGNhbnZhc1gsIGNhbnZhc1ksIHNlcmllc0ZpbHRlcik7CgogICAgICBpZiAoaXRlbSkgewogICAgICAgIC8vIGZpbGwgaW4gbW91c2UgcG9zIGZvciBhbnkgbGlzdGVuZXJzIG91dCB0aGVyZQogICAgICAgIGl0ZW0ucGFnZVggPSBwYXJzZUludChpdGVtLnNlcmllcy54YXhpcy5wMmMoaXRlbS5kYXRhcG9pbnRbMF0pICsgb2Zmc2V0LmxlZnQgKyBwbG90T2Zmc2V0LmxlZnQsIDEwKTsKICAgICAgICBpdGVtLnBhZ2VZID0gcGFyc2VJbnQoaXRlbS5zZXJpZXMueWF4aXMucDJjKGl0ZW0uZGF0YXBvaW50WzFdKSArIG9mZnNldC50b3AgKyBwbG90T2Zmc2V0LnRvcCwgMTApOwogICAgICB9CgogICAgICBpZiAob3B0aW9ucy5ncmlkLmF1dG9IaWdobGlnaHQpIHsKICAgICAgICAvLyBjbGVhciBhdXRvLWhpZ2hsaWdodHMKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGhpZ2hsaWdodHMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgIHZhciBoID0gaGlnaGxpZ2h0c1tpXTsKICAgICAgICAgIGlmIChoLmF1dG8gPT0gZXZlbnRuYW1lICYmICEoaXRlbSAmJiBoLnNlcmllcyA9PSBpdGVtLnNlcmllcyAmJiBoLnBvaW50WzBdID09IGl0ZW0uZGF0YXBvaW50WzBdICYmIGgucG9pbnRbMV0gPT0gaXRlbS5kYXRhcG9pbnRbMV0pKSB1bmhpZ2hsaWdodChoLnNlcmllcywgaC5wb2ludCk7CiAgICAgICAgfQoKICAgICAgICBpZiAoaXRlbSkgaGlnaGxpZ2h0KGl0ZW0uc2VyaWVzLCBpdGVtLmRhdGFwb2ludCwgZXZlbnRuYW1lKTsKICAgICAgfQoKICAgICAgcGxhY2Vob2xkZXIudHJpZ2dlcihldmVudG5hbWUsIFtwb3MsIGl0ZW1dKTsKICAgIH0KCiAgICBmdW5jdGlvbiB0cmlnZ2VyUmVkcmF3T3ZlcmxheSgpIHsKICAgICAgdmFyIHQgPSBvcHRpb25zLmludGVyYWN0aW9uLnJlZHJhd092ZXJsYXlJbnRlcnZhbDsKCiAgICAgIGlmICh0ID09IC0xKSB7CiAgICAgICAgLy8gc2tpcCBldmVudCBxdWV1ZQogICAgICAgIGRyYXdPdmVybGF5KCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoIXJlZHJhd1RpbWVvdXQpIHJlZHJhd1RpbWVvdXQgPSBzZXRUaW1lb3V0KGRyYXdPdmVybGF5LCB0KTsKICAgIH0KCiAgICBmdW5jdGlvbiBkcmF3T3ZlcmxheSgpIHsKICAgICAgcmVkcmF3VGltZW91dCA9IG51bGw7IC8vIGRyYXcgaGlnaGxpZ2h0cwoKICAgICAgb2N0eC5zYXZlKCk7CiAgICAgIG92ZXJsYXkuY2xlYXIoKTsKICAgICAgb2N0eC50cmFuc2xhdGUocGxvdE9mZnNldC5sZWZ0LCBwbG90T2Zmc2V0LnRvcCk7CiAgICAgIHZhciBpLCBoaTsKCiAgICAgIGZvciAoaSA9IDA7IGkgPCBoaWdobGlnaHRzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgaGkgPSBoaWdobGlnaHRzW2ldOwogICAgICAgIGlmIChoaS5zZXJpZXMuYmFycy5zaG93KSBkcmF3QmFySGlnaGxpZ2h0KGhpLnNlcmllcywgaGkucG9pbnQpO2Vsc2UgZHJhd1BvaW50SGlnaGxpZ2h0KGhpLnNlcmllcywgaGkucG9pbnQpOwogICAgICB9CgogICAgICBvY3R4LnJlc3RvcmUoKTsKICAgICAgZXhlY3V0ZUhvb2tzKGhvb2tzLmRyYXdPdmVybGF5LCBbb2N0eF0pOwogICAgfQoKICAgIGZ1bmN0aW9uIGhpZ2hsaWdodChzLCBwb2ludCwgYXV0bykgewogICAgICBpZiAodHlwZW9mIHMgPT0gIm51bWJlciIpIHMgPSBzZXJpZXNbc107CgogICAgICBpZiAodHlwZW9mIHBvaW50ID09ICJudW1iZXIiKSB7CiAgICAgICAgdmFyIHBzID0gcy5kYXRhcG9pbnRzLnBvaW50c2l6ZTsKICAgICAgICBwb2ludCA9IHMuZGF0YXBvaW50cy5wb2ludHMuc2xpY2UocHMgKiBwb2ludCwgcHMgKiAocG9pbnQgKyAxKSk7CiAgICAgIH0KCiAgICAgIHZhciBpID0gaW5kZXhPZkhpZ2hsaWdodChzLCBwb2ludCk7CgogICAgICBpZiAoaSA9PSAtMSkgewogICAgICAgIGhpZ2hsaWdodHMucHVzaCh7CiAgICAgICAgICBzZXJpZXM6IHMsCiAgICAgICAgICBwb2ludDogcG9pbnQsCiAgICAgICAgICBhdXRvOiBhdXRvCiAgICAgICAgfSk7CiAgICAgICAgdHJpZ2dlclJlZHJhd092ZXJsYXkoKTsKICAgICAgfSBlbHNlIGlmICghYXV0bykgaGlnaGxpZ2h0c1tpXS5hdXRvID0gZmFsc2U7CiAgICB9CgogICAgZnVuY3Rpb24gdW5oaWdobGlnaHQocywgcG9pbnQpIHsKICAgICAgaWYgKHMgPT0gbnVsbCAmJiBwb2ludCA9PSBudWxsKSB7CiAgICAgICAgaGlnaGxpZ2h0cyA9IFtdOwogICAgICAgIHRyaWdnZXJSZWRyYXdPdmVybGF5KCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAodHlwZW9mIHMgPT0gIm51bWJlciIpIHMgPSBzZXJpZXNbc107CgogICAgICBpZiAodHlwZW9mIHBvaW50ID09ICJudW1iZXIiKSB7CiAgICAgICAgdmFyIHBzID0gcy5kYXRhcG9pbnRzLnBvaW50c2l6ZTsKICAgICAgICBwb2ludCA9IHMuZGF0YXBvaW50cy5wb2ludHMuc2xpY2UocHMgKiBwb2ludCwgcHMgKiAocG9pbnQgKyAxKSk7CiAgICAgIH0KCiAgICAgIHZhciBpID0gaW5kZXhPZkhpZ2hsaWdodChzLCBwb2ludCk7CgogICAgICBpZiAoaSAhPSAtMSkgewogICAgICAgIGhpZ2hsaWdodHMuc3BsaWNlKGksIDEpOwogICAgICAgIHRyaWdnZXJSZWRyYXdPdmVybGF5KCk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBpbmRleE9mSGlnaGxpZ2h0KHMsIHApIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBoaWdobGlnaHRzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgdmFyIGggPSBoaWdobGlnaHRzW2ldOwogICAgICAgIGlmIChoLnNlcmllcyA9PSBzICYmIGgucG9pbnRbMF0gPT0gcFswXSAmJiBoLnBvaW50WzFdID09IHBbMV0pIHJldHVybiBpOwogICAgICB9CgogICAgICByZXR1cm4gLTE7CiAgICB9CgogICAgZnVuY3Rpb24gZHJhd1BvaW50SGlnaGxpZ2h0KHNlcmllcywgcG9pbnQpIHsKICAgICAgdmFyIHggPSBwb2ludFswXSwKICAgICAgICAgIHkgPSBwb2ludFsxXSwKICAgICAgICAgIGF4aXN4ID0gc2VyaWVzLnhheGlzLAogICAgICAgICAgYXhpc3kgPSBzZXJpZXMueWF4aXMsCiAgICAgICAgICBoaWdobGlnaHRDb2xvciA9IHR5cGVvZiBzZXJpZXMuaGlnaGxpZ2h0Q29sb3IgPT09ICJzdHJpbmciID8gc2VyaWVzLmhpZ2hsaWdodENvbG9yIDogJC5jb2xvci5wYXJzZShzZXJpZXMuY29sb3IpLnNjYWxlKCdhJywgMC41KS50b1N0cmluZygpOwogICAgICBpZiAoeCA8IGF4aXN4Lm1pbiB8fCB4ID4gYXhpc3gubWF4IHx8IHkgPCBheGlzeS5taW4gfHwgeSA+IGF4aXN5Lm1heCkgcmV0dXJuOwogICAgICB2YXIgcG9pbnRSYWRpdXMgPSBzZXJpZXMucG9pbnRzLnJhZGl1cyArIHNlcmllcy5wb2ludHMubGluZVdpZHRoIC8gMjsKICAgICAgb2N0eC5saW5lV2lkdGggPSBwb2ludFJhZGl1czsKICAgICAgb2N0eC5zdHJva2VTdHlsZSA9IGhpZ2hsaWdodENvbG9yOwogICAgICB2YXIgcmFkaXVzID0gMS41ICogcG9pbnRSYWRpdXM7CiAgICAgIHggPSBheGlzeC5wMmMoeCk7CiAgICAgIHkgPSBheGlzeS5wMmMoeSk7CiAgICAgIG9jdHguYmVnaW5QYXRoKCk7CiAgICAgIGlmIChzZXJpZXMucG9pbnRzLnN5bWJvbCA9PSAiY2lyY2xlIikgb2N0eC5hcmMoeCwgeSwgcmFkaXVzLCAwLCAyICogTWF0aC5QSSwgZmFsc2UpO2Vsc2Ugc2VyaWVzLnBvaW50cy5zeW1ib2wob2N0eCwgeCwgeSwgcmFkaXVzLCBmYWxzZSk7CiAgICAgIG9jdHguY2xvc2VQYXRoKCk7CiAgICAgIG9jdHguc3Ryb2tlKCk7CiAgICB9CgogICAgZnVuY3Rpb24gZHJhd0JhckhpZ2hsaWdodChzZXJpZXMsIHBvaW50KSB7CiAgICAgIHZhciBoaWdobGlnaHRDb2xvciA9IHR5cGVvZiBzZXJpZXMuaGlnaGxpZ2h0Q29sb3IgPT09ICJzdHJpbmciID8gc2VyaWVzLmhpZ2hsaWdodENvbG9yIDogJC5jb2xvci5wYXJzZShzZXJpZXMuY29sb3IpLnNjYWxlKCdhJywgMC41KS50b1N0cmluZygpLAogICAgICAgICAgZmlsbFN0eWxlID0gaGlnaGxpZ2h0Q29sb3IsCiAgICAgICAgICBiYXJMZWZ0OwoKICAgICAgc3dpdGNoIChzZXJpZXMuYmFycy5hbGlnbikgewogICAgICAgIGNhc2UgImxlZnQiOgogICAgICAgICAgYmFyTGVmdCA9IDA7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAicmlnaHQiOgogICAgICAgICAgYmFyTGVmdCA9IC1zZXJpZXMuYmFycy5iYXJXaWR0aDsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgYmFyTGVmdCA9IC1zZXJpZXMuYmFycy5iYXJXaWR0aCAvIDI7CiAgICAgIH0KCiAgICAgIG9jdHgubGluZVdpZHRoID0gc2VyaWVzLmJhcnMubGluZVdpZHRoOwogICAgICBvY3R4LnN0cm9rZVN0eWxlID0gaGlnaGxpZ2h0Q29sb3I7CiAgICAgIGRyYXdCYXIocG9pbnRbMF0sIHBvaW50WzFdLCBwb2ludFsyXSB8fCAwLCBiYXJMZWZ0LCBiYXJMZWZ0ICsgc2VyaWVzLmJhcnMuYmFyV2lkdGgsIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gZmlsbFN0eWxlOwogICAgICB9LCBzZXJpZXMueGF4aXMsIHNlcmllcy55YXhpcywgb2N0eCwgc2VyaWVzLmJhcnMuaG9yaXpvbnRhbCwgc2VyaWVzLmJhcnMubGluZVdpZHRoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRDb2xvck9yR3JhZGllbnQoc3BlYywgYm90dG9tLCB0b3AsIGRlZmF1bHRDb2xvcikgewogICAgICBpZiAodHlwZW9mIHNwZWMgPT0gInN0cmluZyIpIHJldHVybiBzcGVjO2Vsc2UgewogICAgICAgIC8vIGFzc3VtZSB0aGlzIGlzIGEgZ3JhZGllbnQgc3BlYzsgSUUgY3VycmVudGx5IG9ubHkKICAgICAgICAvLyBzdXBwb3J0cyBhIHNpbXBsZSB2ZXJ0aWNhbCBncmFkaWVudCBwcm9wZXJseSwgc28gdGhhdCdzCiAgICAgICAgLy8gd2hhdCB3ZSBzdXBwb3J0IHRvbwogICAgICAgIHZhciBncmFkaWVudCA9IGN0eC5jcmVhdGVMaW5lYXJHcmFkaWVudCgwLCB0b3AsIDAsIGJvdHRvbSk7CgogICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gc3BlYy5jb2xvcnMubGVuZ3RoOyBpIDwgbDsgKytpKSB7CiAgICAgICAgICB2YXIgYyA9IHNwZWMuY29sb3JzW2ldOwoKICAgICAgICAgIGlmICh0eXBlb2YgYyAhPSAic3RyaW5nIikgewogICAgICAgICAgICB2YXIgY28gPSAkLmNvbG9yLnBhcnNlKGRlZmF1bHRDb2xvcik7CiAgICAgICAgICAgIGlmIChjLmJyaWdodG5lc3MgIT0gbnVsbCkgY28gPSBjby5zY2FsZSgncmdiJywgYy5icmlnaHRuZXNzKTsKICAgICAgICAgICAgaWYgKGMub3BhY2l0eSAhPSBudWxsKSBjby5hICo9IGMub3BhY2l0eTsKICAgICAgICAgICAgYyA9IGNvLnRvU3RyaW5nKCk7CiAgICAgICAgICB9CgogICAgICAgICAgZ3JhZGllbnQuYWRkQ29sb3JTdG9wKGkgLyAobCAtIDEpLCBjKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBncmFkaWVudDsKICAgICAgfQogICAgfQogIH0gLy8gQWRkIHRoZSBwbG90IGZ1bmN0aW9uIHRvIHRoZSB0b3AgbGV2ZWwgb2YgdGhlIGpRdWVyeSBvYmplY3QKCgogICQucGxvdCA9IGZ1bmN0aW9uIChwbGFjZWhvbGRlciwgZGF0YSwgb3B0aW9ucykgewogICAgLy92YXIgdDAgPSBuZXcgRGF0ZSgpOwogICAgdmFyIHBsb3QgPSBuZXcgUGxvdCgkKHBsYWNlaG9sZGVyKSwgZGF0YSwgb3B0aW9ucywgJC5wbG90LnBsdWdpbnMpOyAvLyh3aW5kb3cuY29uc29sZSA/IGNvbnNvbGUubG9nIDogYWxlcnQpKCJ0aW1lIHVzZWQgKG1zZWNzKTogIiArICgobmV3IERhdGUoKSkuZ2V0VGltZSgpIC0gdDAuZ2V0VGltZSgpKSk7CgogICAgcmV0dXJuIHBsb3Q7CiAgfTsKCiAgJC5wbG90LnZlcnNpb24gPSAiMC44LjMiOwogICQucGxvdC5wbHVnaW5zID0gW107IC8vIEFsc28gYWRkIHRoZSBwbG90IGZ1bmN0aW9uIGFzIGEgY2hhaW5hYmxlIHByb3BlcnR5CgogICQuZm4ucGxvdCA9IGZ1bmN0aW9uIChkYXRhLCBvcHRpb25zKSB7CiAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgJC5wbG90KHRoaXMsIGRhdGEsIG9wdGlvbnMpOwogICAgfSk7CiAgfTsgLy8gcm91bmQgdG8gbmVhcmJ5IGxvd2VyIG11bHRpcGxlIG9mIGJhc2UKCgogIGZ1bmN0aW9uIGZsb29ySW5CYXNlKG4sIGJhc2UpIHsKICAgIHJldHVybiBiYXNlICogTWF0aC5mbG9vcihuIC8gYmFzZSk7CiAgfQp9KShqUXVlcnkpOw=="},null]}